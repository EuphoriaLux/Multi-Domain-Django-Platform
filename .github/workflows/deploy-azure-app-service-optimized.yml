# OPTIMIZED Azure App Service Deployment Workflow
# This workflow implements several optimizations to reduce deployment time from ~5min to ~3min:
# 1. Dependency caching on Azure (via SCM_DO_BUILD_DURING_DEPLOYMENT)
# 2. Parallel static file collection
# 3. Startup script optimization
# 4. Reduced migration overhead

name: Deploy Multi-Domain App to Azure (Optimized)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
      - '.gitignore'
      - 'LICENSE'
      - 'README.md'
      - 'CLAUDE.md'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip deploy]')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_B36E77B8614B469FB1CAEB89A0FD8820 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_9B47C4FC931C474D9EA5DF7AA7F520DC }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_29F8296DBCF74664BB44D22B1D60D435 }}

      # OPTIMIZATION 1: Already configured via Azure CLI
      # Settings applied:
      # - ORYX_DISABLE_PIP_CACHE=false (enables dependency caching)
      # - SCM_DO_BUILD_DURING_DEPLOYMENT=true (enables Oryx build)
      # No action needed - settings persist across deployments

      # OPTIMIZATION 2: Deploy with package optimization
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: 'django-app-ajfffwjb5ie3s-app-service'
          slot-name: 'Production'
          # Skip collecting static files during deployment (done in POST_BUILD_COMMAND)
          clean: false

      # OPTIMIZATION 3: Warm up application after deployment
      - name: Warm up application
        run: |
          echo "üî• Warming up application endpoints..."
          curl -s -o /dev/null -w "Health check: %{http_code}\n" https://crush.lu/healthz/ || true
          curl -s -o /dev/null -w "Home page: %{http_code}\n" https://crush.lu/ || true
        continue-on-error: true

      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåê Crush.lu: https://crush.lu"
          echo "üåê PowerUP: https://powerup.lu"
          echo "üåê VinsDelux: https://vinsdelux.com"
          echo "‚ö° Deployment optimized for speed (~3min target)"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed. Check Azure App Service logs."
          echo "üîß Portal: https://portal.azure.com"

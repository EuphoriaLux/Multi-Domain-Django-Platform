name: Python check

on:
  # Only run on pull requests - not on every main push
  pull_request:
    branches: [ main ]
  # Allow manual triggering
  workflow_dispatch:
  # Run on pushes that modify Python code
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/python-test.yaml'

jobs:
  test_package:
    name: Test Python ${{ matrix.python_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true  # Stop on first failure to save time
      matrix:
        # Only test Python 3.11 (your prod version) for faster CI
        # Add 3.10 back if you need multi-version support
        python_version: ["3.11"]
    services:
      postgres:
        image: postgres:14  # Updated from 12 for better performance
        env:
          POSTGRES_PASSWORD: postgres
        ports:
        - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
        - uses: actions/checkout@v4

        - name: Setup python
          uses: actions/setup-python@v5
          with:
            python-version: ${{ matrix.python_version }}
            architecture: x64
            cache: 'pip'  # Cache pip dependencies for faster installs

        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install flake8

        - name: Look for syntax errors with flake8
          run: |
            # Stop the build if there are Python syntax errors or undefined names
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=migrations,venv,env,.venv,.git,__pycache__

        - name: Check Python code compilation
          run: |
            python -m compileall azureproject entreprinder vinsdelux crush_lu matching -f -q

        - name: Run migrations and tests
          run: |
            python manage.py migrate --noinput
            python manage.py test --keepdb
          env:
            DBNAME: postgres
            DBHOST: localhost
            DBUSER: postgres
            DBPASS: postgres
            SECRET_KEY: django-insecure-key-${{ github.run_id }}-${{ github.run_attempt }}
            DEBUG: 'False'
            SERVER_NAME: 'testserver'
            SITE_ID: '1'

{% extends "admin/base_site.html" %}
{% load static math_filters %}

{% block title %}Crush.lu Analytics Dashboard{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .dashboard-container {
        padding: 20px;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .metric-card.purple {
        border-left: 4px solid #9B59B6;
    }

    .metric-card.pink {
        border-left: 4px solid #FF6B9D;
    }

    .metric-card.green {
        border-left: 4px solid #28a745;
    }

    .metric-card.blue {
        border-left: 4px solid #007bff;
    }

    .metric-card.orange {
        border-left: 4px solid #ffc107;
    }

    .metric-value {
        font-size: 36px;
        font-weight: bold;
        color: #333;
        margin: 10px 0;
    }

    .metric-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-subtitle {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
    }

    .section-header {
        font-size: 24px;
        font-weight: 600;
        margin: 30px 0 20px 0;
        color: #333;
        border-bottom: 2px solid #9B59B6;
        padding-bottom: 10px;
    }

    .table-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow-x: auto;
    }

    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }

    .stats-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    .stats-table td {
        padding: 12px;
        border-bottom: 1px solid #dee2e6;
    }

    .stats-table tr:hover {
        background: #f8f9fa;
    }

    .progress-bar-container {
        background: #e9ecef;
        border-radius: 4px;
        height: 20px;
        overflow: hidden;
        margin-top: 10px;
    }

    .progress-bar {
        background: linear-gradient(90deg, #9B59B6, #FF6B9D);
        height: 100%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }

    .quick-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .quick-action-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #9B59B6, #FF6B9D);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(155, 89, 182, 0.3);
        color: white;
    }

    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .funnel-step {
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
        border-left: 4px solid #9B59B6;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .funnel-step-name {
        font-weight: 600;
        font-size: 16px;
    }

    .funnel-step-value {
        font-size: 24px;
        font-weight: bold;
        color: #9B59B6;
    }

    .icon-large {
        font-size: 48px;
        opacity: 0.1;
        position: absolute;
        right: 20px;
        top: 20px;
    }

    .metric-card {
        position: relative;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 style="font-size: 32px; margin-bottom: 10px; color: #9B59B6;">üíï Crush.lu Analytics Dashboard</h1>
    <p style="color: #666; margin-bottom: 30px;">Real-time insights and metrics for the Crush.lu platform</p>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}" class="quick-action-btn">üë§ View All Profiles</a>
        <a href="{% url 'crush_admin:crush_lu_profilesubmission_changelist' %}?status__exact=pending" class="quick-action-btn">üìù Pending Approvals ({{ pending_reviews }})</a>
        <a href="{% url 'crush_admin:crush_lu_meetupevent_changelist' %}" class="quick-action-btn">üéâ Manage Events</a>
        <a href="{% url 'crush_admin:crush_lu_specialuserexperience_changelist' %}" class="quick-action-btn">‚ú® Special Experiences</a>
    </div>

    <!-- User Metrics Section -->
    <h2 class="section-header">üë• User Metrics</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">üë§</div>
            <div class="metric-label">Total Profiles</div>
            <div class="metric-value">{{ total_profiles }}</div>
            <div class="metric-subtitle">{{ active_profiles }} active</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">‚úÖ</div>
            <div class="metric-label">Approved Profiles</div>
            <div class="metric-value">{{ approved_profiles }}</div>
            <div class="metric-subtitle">{{ approval_rate }}% approval rate</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">‚è≥</div>
            <div class="metric-label">Pending Approval</div>
            <div class="metric-value">{{ pending_approval }}</div>
            <div class="metric-subtitle">Awaiting review</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">üìà</div>
            <div class="metric-label">New This Month</div>
            <div class="metric-value">{{ recent_signups }}</div>
            <div class="metric-subtitle">Last 30 days</div>
        </div>
    </div>

    <!-- Profile Completion Funnel -->
    <div class="chart-container">
        <h3 style="margin-top: 0; color: #333;">Profile Creation Funnel</h3>
        <div class="funnel-step">
            <span class="funnel-step-name">Step 1: Basic Info</span>
            <span class="funnel-step-value">{{ step1_completed }}</span>
        </div>
        <div class="funnel-step">
            <span class="funnel-step-name">Step 2: Photos & Bio</span>
            <span class="funnel-step-value">{{ step2_completed }}</span>
        </div>
        <div class="funnel-step">
            <span class="funnel-step-name">Step 3: Privacy Settings</span>
            <span class="funnel-step-value">{{ step3_completed }}</span>
        </div>
        <div class="funnel-step">
            <span class="funnel-step-name">Submitted for Review</span>
            <span class="funnel-step-value">{{ submitted }}</span>
        </div>
    </div>

    <!-- Demographics -->
    <div class="dashboard-grid">
        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Gender Distribution</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Gender</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in gender_stats %}
                    <tr>
                        <td>{{ stat.gender|default:"Not specified" }}</td>
                        <td>{{ stat.count }}</td>
                        <td>{{ stat.count|floatformat:0|add:"0"|mul:100|div:total_profiles|floatformat:1 }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Top Locations</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Location</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in location_stats %}
                    <tr>
                        <td>{{ stat.location|default:"Not specified" }}</td>
                        <td>{{ stat.count }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Coach Metrics Section -->
    <h2 class="section-header">üéØ Coach Performance</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">üë®‚Äçüè´</div>
            <div class="metric-label">Active Coaches</div>
            <div class="metric-value">{{ active_coaches }}</div>
            <div class="metric-subtitle">Out of {{ total_coaches }} total</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">‚è∞</div>
            <div class="metric-label">Avg Review Time</div>
            <div class="metric-value">{{ avg_review_hours }}h</div>
            <div class="metric-subtitle">Per profile</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">üìã</div>
            <div class="metric-label">Pending Reviews</div>
            <div class="metric-value">{{ pending_reviews }}</div>
            <div class="metric-subtitle">Across all coaches</div>
        </div>
    </div>

    <!-- Top Coaches -->
    <div class="table-container">
        <h3 style="margin-top: 0; color: #333;">Top Coach Performance</h3>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Coach</th>
                    <th>Total Reviews</th>
                    <th>Pending</th>
                    <th>Approved</th>
                    <th>Rejected</th>
                </tr>
            </thead>
            <tbody>
                {% for coach in coach_performance %}
                <tr>
                    <td>{{ coach.user.get_full_name|default:coach.user.username }}</td>
                    <td>{{ coach.total_reviews }}</td>
                    <td><span class="badge badge-warning">{{ coach.pending_count }}</span></td>
                    <td><span class="badge badge-success">{{ coach.approved_count }}</span></td>
                    <td><span class="badge badge-danger">{{ coach.rejected_count }}</span></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">No coach performance data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Event Metrics Section -->
    <h2 class="section-header">üéâ Event Metrics</h2>
    <div class="dashboard-grid">
        <div class="metric-card blue">
            <div class="icon-large">üìÖ</div>
            <div class="metric-label">Upcoming Events</div>
            <div class="metric-value">{{ upcoming_events }}</div>
            <div class="metric-subtitle">{{ total_events }} total events</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">‚úÖ</div>
            <div class="metric-label">Confirmed Registrations</div>
            <div class="metric-value">{{ confirmed_registrations }}</div>
            <div class="metric-subtitle">{{ total_registrations }} total</div>
        </div>

        <div class="metric-card purple">
            <div class="icon-large">üí∞</div>
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value">‚Ç¨{{ total_revenue }}</div>
            <div class="metric-subtitle">From confirmed payments</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">üìä</div>
            <div class="metric-label">Attendance Rate</div>
            <div class="metric-value">{{ attendance_rate }}%</div>
            <div class="metric-subtitle">Show-up rate</div>
        </div>
    </div>

    <!-- Popular Events -->
    <div class="table-container">
        <h3 style="margin-top: 0; color: #333;">Most Popular Events</h3>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Registrations</th>
                </tr>
            </thead>
            <tbody>
                {% for event in popular_events %}
                <tr>
                    <td><a href="{% url 'crush_admin:crush_lu_meetupevent_change' event.id %}">{{ event.title }}</a></td>
                    <td>{{ event.get_event_type_display }}</td>
                    <td>{{ event.date_time|date:"M d, Y" }}</td>
                    <td>{{ event.registration_count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No events available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Connection Metrics Section -->
    <h2 class="section-header">üíï Connection Metrics</h2>
    <div class="dashboard-grid">
        <div class="metric-card pink">
            <div class="icon-large">üíë</div>
            <div class="metric-label">Mutual Connections</div>
            <div class="metric-value">{{ mutual_connections }}</div>
            <div class="metric-subtitle">{{ connection_rate }}% match rate</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">üîó</div>
            <div class="metric-label">Total Connections</div>
            <div class="metric-value">{{ total_connections }}</div>
            <div class="metric-subtitle">All connection requests</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">‚è≥</div>
            <div class="metric-label">Pending Connections</div>
            <div class="metric-value">{{ pending_connections }}</div>
            <div class="metric-subtitle">Awaiting response</div>
        </div>
    </div>

    <!-- Journey System Metrics -->
    <h2 class="section-header">‚ú® Special Journey System</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">üé≠</div>
            <div class="metric-label">Active Special Experiences</div>
            <div class="metric-value">{{ active_special_experiences }}</div>
            <div class="metric-subtitle">{{ total_special_experiences }} total</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">üó∫Ô∏è</div>
            <div class="metric-label">Active Journeys</div>
            <div class="metric-value">{{ total_journeys }}</div>
            <div class="metric-subtitle">{{ completed_journeys }} completed</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">üèÜ</div>
            <div class="metric-label">Avg Points Earned</div>
            <div class="metric-value">{{ avg_points }}</div>
            <div class="metric-subtitle">Per journey</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">‚è±Ô∏è</div>
            <div class="metric-label">Avg Time Spent</div>
            <div class="metric-value">{{ avg_time_minutes }}m</div>
            <div class="metric-subtitle">Per journey</div>
        </div>
    </div>

    <!-- Journey Completion Rate -->
    <div class="chart-container">
        <h3 style="margin-top: 0; color: #333;">Journey Completion Rate</h3>
        <div class="progress-bar-container">
            <div class="progress-bar" style="width: {{ journey_completion_rate }}%;">
                {{ journey_completion_rate }}% Complete
            </div>
        </div>
        <p style="margin-top: 10px; color: #666; font-size: 14px;">
            {{ completed_journeys }} out of {{ total_journeys }} journeys completed
        </p>
    </div>

    <!-- Email Preferences Section -->
    <h2 class="section-header">üìß Email Preferences</h2>
    <div class="dashboard-grid">
        <div class="metric-card blue">
            <div class="icon-large">üì¨</div>
            <div class="metric-label">Active Email Users</div>
            <div class="metric-value">{{ email_active_users }}</div>
            <div class="metric-subtitle">{{ total_email_preferences }} total preferences</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">üì¢</div>
            <div class="metric-label">Marketing Opt-ins</div>
            <div class="metric-value">{{ marketing_opted_in }}</div>
            <div class="metric-subtitle">{{ marketing_opt_in_rate }}% opt-in rate</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">üö´</div>
            <div class="metric-label">Unsubscribed All</div>
            <div class="metric-value">{{ unsubscribed_all }}</div>
            <div class="metric-subtitle">Opted out of all emails</div>
        </div>
    </div>

    <!-- Email Category Stats -->
    <div class="table-container">
        <h3 style="margin-top: 0; color: #333;">Email Category Subscriptions</h3>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Subscribed</th>
                    <th>Opt-in Rate</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>üìù Profile Updates</td>
                    <td>{{ email_category_stats.profile_updates }}</td>
                    <td>{% widthratio email_category_stats.profile_updates email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>üéâ Event Reminders</td>
                    <td>{{ email_category_stats.event_reminders }}</td>
                    <td>{% widthratio email_category_stats.event_reminders email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>üíï New Connections</td>
                    <td>{{ email_category_stats.new_connections }}</td>
                    <td>{% widthratio email_category_stats.new_connections email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>üí¨ New Messages</td>
                    <td>{{ email_category_stats.new_messages }}</td>
                    <td>{% widthratio email_category_stats.new_messages email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>üì¢ Marketing</td>
                    <td>{{ email_category_stats.marketing }}</td>
                    <td>{{ marketing_opt_in_rate }}%</td>
                </tr>
            </tbody>
        </table>
        <p style="margin-top: 15px;">
            <a href="{% url 'crush_admin:crush_lu_emailpreference_changelist' %}" class="quick-action-btn" style="display: inline-block;">
                Manage Email Preferences
            </a>
        </p>
    </div>

    <!-- Recent Activity Section -->
    <h2 class="section-header">üìä Recent Activity</h2>

    <div class="dashboard-grid">
        <!-- Recent Profile Submissions -->
        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Recent Profile Submissions</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Status</th>
                        <th>Submitted</th>
                    </tr>
                </thead>
                <tbody>
                    {% for submission in recent_submissions %}
                    <tr>
                        <td><a href="{% url 'crush_admin:crush_lu_profilesubmission_change' submission.id %}">{{ submission.profile.user.get_full_name|default:submission.profile.user.username }}</a></td>
                        <td><span class="badge badge-warning">{{ submission.get_status_display }}</span></td>
                        <td>{{ submission.submitted_at|timesince }} ago</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No recent submissions</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Recent Event Registrations -->
        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Recent Event Registrations</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Event</th>
                        <th>Registered</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registration in recent_event_registrations %}
                    <tr>
                        <td>{{ registration.user.get_full_name|default:registration.user.username }}</td>
                        <td><a href="{% url 'crush_admin:crush_lu_meetupevent_change' registration.event.id %}">{{ registration.event.title }}</a></td>
                        <td>{{ registration.registered_at|timesince }} ago</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No recent registrations</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

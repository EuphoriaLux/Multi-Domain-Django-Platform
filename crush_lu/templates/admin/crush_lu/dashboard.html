{% extends "admin/base_site.html" %}
{% load static math_filters %}

{% block title %}Crush.lu Analytics Dashboard{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* Theme-aware CSS variables */
    :root {
        --card-bg: #ffffff;
        --card-shadow: rgba(0,0,0,0.1);
        --text-primary: #333333;
        --text-secondary: #666666;
        --text-muted: #999999;
        --table-header-bg: #f8f9fa;
        --table-border: #dee2e6;
        --table-hover: #f8f9fa;
        --progress-bg: #e9ecef;
        --funnel-bg: #f8f9fa;
    }

    /* Dark mode overrides - Django admin uses prefers-color-scheme or data-theme */
    @media (prefers-color-scheme: dark) {
        :root {
            --card-bg: #1e1e2e;
            --card-shadow: rgba(0,0,0,0.3);
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #888888;
            --table-header-bg: #2a2a3e;
            --table-border: #3a3a4e;
            --table-hover: #2a2a3e;
            --progress-bg: #2a2a3e;
            --funnel-bg: #2a2a3e;
        }
    }

    /* Also support Django's theme toggle via data attribute */
    [data-theme="dark"] {
        --card-bg: #1e1e2e;
        --card-shadow: rgba(0,0,0,0.3);
        --text-primary: #e0e0e0;
        --text-secondary: #b0b0b0;
        --text-muted: #888888;
        --table-header-bg: #2a2a3e;
        --table-border: #3a3a4e;
        --table-hover: #2a2a3e;
        --progress-bg: #2a2a3e;
        --funnel-bg: #2a2a3e;
    }

    .dashboard-container {
        padding: 20px;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px var(--card-shadow);
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        overflow: hidden;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px var(--card-shadow);
    }

    .metric-card.purple {
        border-left: 4px solid #9B59B6;
    }

    .metric-card.pink {
        border-left: 4px solid #FF6B9D;
    }

    .metric-card.green {
        border-left: 4px solid #28a745;
    }

    .metric-card.blue {
        border-left: 4px solid #007bff;
    }

    .metric-card.orange {
        border-left: 4px solid #ffc107;
    }

    .metric-value {
        font-size: 36px;
        font-weight: bold;
        color: var(--text-primary);
        margin: 10px 0;
    }

    .metric-label {
        font-size: 14px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
    }

    .section-header {
        font-size: 24px;
        font-weight: 600;
        margin: 30px 0 20px 0;
        color: var(--text-primary);
        border-bottom: 2px solid #9B59B6;
        padding-bottom: 10px;
    }

    .table-container {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px var(--card-shadow);
        margin-bottom: 20px;
        overflow-x: auto;
    }

    .table-container h3 {
        color: var(--text-primary);
    }

    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }

    .stats-table th {
        background: var(--table-header-bg);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--table-border);
        color: var(--text-primary);
    }

    .stats-table td {
        padding: 12px;
        border-bottom: 1px solid var(--table-border);
        color: var(--text-secondary);
    }

    .stats-table td a {
        color: #9B59B6;
    }

    .stats-table tr:hover {
        background: var(--table-hover);
    }

    .progress-bar-container {
        background: var(--progress-bg);
        border-radius: 4px;
        height: 20px;
        overflow: hidden;
        margin-top: 10px;
    }

    .progress-bar {
        background: linear-gradient(90deg, #9B59B6, #FF6B9D);
        height: 100%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }

    .badge-success {
        background: #28a74533;
        color: #28a745;
    }

    .badge-warning {
        background: #ffc10733;
        color: #ffc107;
    }

    .badge-danger {
        background: #dc354533;
        color: #dc3545;
    }

    .badge-info {
        background: #17a2b833;
        color: #17a2b8;
    }

    .quick-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .quick-action-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #9B59B6, #FF6B9D);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(155, 89, 182, 0.3);
        color: white;
    }

    .chart-container {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px var(--card-shadow);
        margin-bottom: 20px;
    }

    .chart-container h3 {
        color: var(--text-primary);
    }

    .chart-container p {
        color: var(--text-secondary);
    }

    .funnel-step {
        padding: 15px;
        margin: 10px 0;
        background: var(--funnel-bg);
        border-left: 4px solid #9B59B6;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .funnel-step-name {
        font-weight: 600;
        font-size: 16px;
        color: var(--text-primary);
    }

    .funnel-step-value {
        font-size: 24px;
        font-weight: bold;
        color: #9B59B6;
    }

    .icon-large {
        font-size: 48px;
        opacity: 0.1;
        position: absolute;
        right: 20px;
        top: 20px;
    }

    /* Dashboard header styling */
    .dashboard-container > h1 {
        color: #9B59B6 !important;
    }

    .dashboard-container > p {
        color: var(--text-secondary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1 style="font-size: 32px; margin-bottom: 10px; color: #9B59B6;">ğŸ’• Crush.lu Analytics Dashboard</h1>
    <p style="color: #666; margin-bottom: 30px;">Real-time insights and metrics for the Crush.lu platform</p>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}" class="quick-action-btn">ğŸ‘¤ View All Profiles</a>
        <a href="{% url 'crush_admin:crush_lu_profilesubmission_changelist' %}?status__exact=pending" class="quick-action-btn">ğŸ“ Pending Approvals ({{ pending_reviews }})</a>
        <a href="{% url 'crush_admin:crush_lu_meetupevent_changelist' %}" class="quick-action-btn">ğŸ‰ Manage Events</a>
        <a href="{% url 'crush_admin:crush_lu_specialuserexperience_changelist' %}" class="quick-action-btn">âœ¨ Special Experiences</a>
        <a href="{% url 'user_segments_dashboard' %}" class="quick-action-btn">ğŸ¯ User Segments</a>
    </div>

    <!-- Pending Actions Alert Box -->
    {% if pending_actions.total_pending > 0 %}
    <div class="chart-container" style="margin-top: 20px; border-left: 4px solid #dc3545;">
        <h3 style="margin-top: 0; color: #dc3545;">âš¡ Pending Actions</h3>
        <p style="color: var(--text-secondary); margin-bottom: 15px;">Quick links to submissions that need your attention</p>

        <div class="dashboard-grid" style="gap: 15px;">
            {% if pending_actions.urgent_reviews > 0 %}
            <a href="{% url 'crush_admin:crush_lu_profilesubmission_changelist' %}?pending_time=24h"
               style="text-decoration: none;" class="metric-card"
               style="background: #dc354515; border-left: 4px solid #dc3545; cursor: pointer;">
                <div class="metric-label" style="color: #dc3545;">ğŸš¨ Urgent Reviews</div>
                <div class="metric-value" style="color: #dc3545;">{{ pending_actions.urgent_reviews }}</div>
                <div class="metric-subtitle">Pending > 24 hours</div>
            </a>
            {% endif %}

            {% if pending_actions.unassigned > 0 %}
            <a href="{% url 'crush_admin:crush_lu_profilesubmission_changelist' %}?coach__isnull=True&status__exact=pending"
               style="text-decoration: none;" class="metric-card"
               style="background: #ffc10715; border-left: 4px solid #ffc107; cursor: pointer;">
                <div class="metric-label" style="color: #ffc107;">ğŸ‘¤ Needs Coach</div>
                <div class="metric-value" style="color: #ffc107;">{{ pending_actions.unassigned }}</div>
                <div class="metric-subtitle">No coach assigned</div>
            </a>
            {% endif %}

            {% if pending_actions.awaiting_call > 0 %}
            <a href="{% url 'crush_admin:crush_lu_profilesubmission_changelist' %}?workflow=awaiting_call"
               style="text-decoration: none;" class="metric-card"
               style="background: #17a2b815; border-left: 4px solid #17a2b8; cursor: pointer;">
                <div class="metric-label" style="color: #17a2b8;">ğŸ“ Awaiting Call</div>
                <div class="metric-value" style="color: #17a2b8;">{{ pending_actions.awaiting_call }}</div>
                <div class="metric-subtitle">Screening call needed</div>
            </a>
            {% endif %}

            {% if pending_actions.ready_to_approve > 0 %}
            <a href="{% url 'crush_admin:crush_lu_profilesubmission_changelist' %}?workflow=ready_approve"
               style="text-decoration: none;" class="metric-card"
               style="background: #28a74515; border-left: 4px solid #28a745; cursor: pointer;">
                <div class="metric-label" style="color: #28a745;">âœ… Ready to Approve</div>
                <div class="metric-value" style="color: #28a745;">{{ pending_actions.ready_to_approve }}</div>
                <div class="metric-subtitle">Call completed, ready!</div>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- User Metrics Section -->
    <h2 class="section-header">ğŸ‘¥ User Metrics</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">ğŸ‘¤</div>
            <div class="metric-label">Total Profiles</div>
            <div class="metric-value">{{ total_profiles }}</div>
            <div class="metric-subtitle">{{ active_profiles }} active</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">âœ…</div>
            <div class="metric-label">Approved Profiles</div>
            <div class="metric-value">{{ approved_profiles }}</div>
            <div class="metric-subtitle">{{ approval_rate }}% approval rate</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">â³</div>
            <div class="metric-label">Pending Approval</div>
            <div class="metric-value">{{ pending_approval }}</div>
            <div class="metric-subtitle">Awaiting review</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">ğŸ“ˆ</div>
            <div class="metric-label">New This Month</div>
            <div class="metric-value">{{ recent_signups }}</div>
            <div class="metric-subtitle">Last 30 days</div>
        </div>
    </div>

    <!-- Profile Completion Funnel - Shows users CURRENTLY at each step -->
    <div class="chart-container">
        <h3 style="margin-top: 0;">Profile Completion Status</h3>
        <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
            Shows where users are currently stuck in the profile creation process
        </p>

        <!-- Not Started -->
        <div class="funnel-step" style="border-left-color: #dc3545;">
            <div>
                <span class="funnel-step-name">âŒ Not Started</span>
                <div class="progress-bar-container" style="width: 200px; height: 8px; margin-top: 5px;">
                    <div class="progress-bar" style="width: {{ funnel_not_started_pct }}%; background: linear-gradient(90deg, #dc3545, #ff6b6b);"></div>
                </div>
            </div>
            <div style="text-align: right;">
                <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}?completion_status__exact=not_started"
                   class="funnel-step-value" style="color: #dc3545; text-decoration: none;"
                   title="View users who haven't started their profile">{{ funnel_not_started }}</a>
                <div style="font-size: 12px; color: var(--text-muted);">{{ funnel_not_started_pct }}%</div>
            </div>
        </div>

        <!-- Step 1 -->
        <div class="funnel-step" style="border-left-color: #ffc107;">
            <div>
                <span class="funnel-step-name">ğŸ“ Step 1: Basic Info</span>
                <div class="progress-bar-container" style="width: 200px; height: 8px; margin-top: 5px;">
                    <div class="progress-bar" style="width: {{ funnel_step1_pct }}%; background: linear-gradient(90deg, #ffc107, #ffda6a);"></div>
                </div>
            </div>
            <div style="text-align: right;">
                <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}?completion_status__exact=step1"
                   class="funnel-step-value" style="color: #ffc107; text-decoration: none;"
                   title="View users stuck at Step 1 (Basic Info)">{{ funnel_step1 }}</a>
                <div style="font-size: 12px; color: var(--text-muted);">{{ funnel_step1_pct }}%</div>
            </div>
        </div>

        <!-- Step 2 -->
        <div class="funnel-step" style="border-left-color: #17a2b8;">
            <div>
                <span class="funnel-step-name">ğŸ“· Step 2: Photos & Bio</span>
                <div class="progress-bar-container" style="width: 200px; height: 8px; margin-top: 5px;">
                    <div class="progress-bar" style="width: {{ funnel_step2_pct }}%; background: linear-gradient(90deg, #17a2b8, #63d5eb);"></div>
                </div>
            </div>
            <div style="text-align: right;">
                <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}?completion_status__exact=step2"
                   class="funnel-step-value" style="color: #17a2b8; text-decoration: none;"
                   title="View users stuck at Step 2 (Photos & Bio)">{{ funnel_step2 }}</a>
                <div style="font-size: 12px; color: var(--text-muted);">{{ funnel_step2_pct }}%</div>
            </div>
        </div>

        <!-- Step 3 -->
        <div class="funnel-step" style="border-left-color: #6f42c1;">
            <div>
                <span class="funnel-step-name">ğŸ”’ Step 3: Privacy Settings</span>
                <div class="progress-bar-container" style="width: 200px; height: 8px; margin-top: 5px;">
                    <div class="progress-bar" style="width: {{ funnel_step3_pct }}%; background: linear-gradient(90deg, #6f42c1, #a855f7);"></div>
                </div>
            </div>
            <div style="text-align: right;">
                <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}?completion_status__exact=step3"
                   class="funnel-step-value" style="color: #6f42c1; text-decoration: none;"
                   title="View users stuck at Step 3 (Privacy Settings)">{{ funnel_step3 }}</a>
                <div style="font-size: 12px; color: var(--text-muted);">{{ funnel_step3_pct }}%</div>
            </div>
        </div>

        <!-- Completed but not submitted -->
        <div class="funnel-step" style="border-left-color: #fd7e14;">
            <div>
                <span class="funnel-step-name">âœï¸ Completed (Not Submitted)</span>
                <div class="progress-bar-container" style="width: 200px; height: 8px; margin-top: 5px;">
                    <div class="progress-bar" style="width: {{ funnel_completed_pct }}%; background: linear-gradient(90deg, #fd7e14, #ffb347);"></div>
                </div>
            </div>
            <div style="text-align: right;">
                <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}?completion_status__exact=completed"
                   class="funnel-step-value" style="color: #fd7e14; text-decoration: none;"
                   title="View users who completed but haven't submitted">{{ funnel_completed }}</a>
                <div style="font-size: 12px; color: var(--text-muted);">{{ funnel_completed_pct }}%</div>
            </div>
        </div>

        <!-- Submitted for review -->
        <div class="funnel-step" style="border-left-color: #28a745;">
            <div>
                <span class="funnel-step-name">âœ… Submitted for Review</span>
                <div class="progress-bar-container" style="width: 200px; height: 8px; margin-top: 5px;">
                    <div class="progress-bar" style="width: {{ funnel_submitted_pct }}%; background: linear-gradient(90deg, #28a745, #5cb85c);"></div>
                </div>
            </div>
            <div style="text-align: right;">
                <a href="{% url 'crush_admin:crush_lu_crushprofile_changelist' %}?completion_status__exact=submitted"
                   class="funnel-step-value" style="color: #28a745; text-decoration: none;"
                   title="View users who submitted for review">{{ funnel_submitted }}</a>
                <div style="font-size: 12px; color: var(--text-muted);">{{ funnel_submitted_pct }}%</div>
            </div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: var(--funnel-bg); border-radius: 8px;">
            <strong style="color: var(--text-primary);">ğŸ’¡ Insight:</strong>
            <span style="color: var(--text-secondary);">
                {% if funnel_not_started > funnel_submitted %}
                    {{ funnel_not_started }} users haven't started their profile yet - consider sending reminder emails.
                {% elif funnel_step1 > 0 or funnel_step2 > 0 %}
                    {{ funnel_step1|add:funnel_step2 }} users are stuck in steps 1-2 - they may need help with photos or bio.
                {% else %}
                    Great progress! Most users are completing their profiles.
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Demographics -->
    <div class="dashboard-grid">
        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Gender Distribution</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Gender</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in gender_stats %}
                    <tr>
                        <td>{{ stat.gender|default:"Not specified" }}</td>
                        <td>{{ stat.count }}</td>
                        <td>{{ stat.count|floatformat:0|add:"0"|mul:100|div:total_profiles|floatformat:1 }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Top Locations</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Location</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in location_stats %}
                    <tr>
                        <td>{{ stat.location|default:"Not specified" }}</td>
                        <td>{{ stat.count }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Coach Metrics Section -->
    <h2 class="section-header">ğŸ¯ Coach Performance</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">ğŸ‘¨â€ğŸ«</div>
            <div class="metric-label">Active Coaches</div>
            <div class="metric-value">{{ active_coaches }}</div>
            <div class="metric-subtitle">Out of {{ total_coaches }} total</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">â°</div>
            <div class="metric-label">Avg Review Time</div>
            <div class="metric-value">{{ avg_review_hours }}h</div>
            <div class="metric-subtitle">Per profile</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">ğŸ“‹</div>
            <div class="metric-label">Pending Reviews</div>
            <div class="metric-value">{{ pending_reviews }}</div>
            <div class="metric-subtitle">Across all coaches</div>
        </div>
    </div>

    <!-- Top Coaches -->
    <div class="table-container">
        <h3 style="margin-top: 0; color: #333;">Top Coach Performance</h3>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Coach</th>
                    <th>Total Reviews</th>
                    <th>Pending</th>
                    <th>Approved</th>
                    <th>Rejected</th>
                </tr>
            </thead>
            <tbody>
                {% for coach in coach_performance %}
                <tr>
                    <td>{{ coach.user.get_full_name|default:coach.user.username }}</td>
                    <td>{{ coach.total_reviews }}</td>
                    <td><span class="badge badge-warning">{{ coach.pending_count }}</span></td>
                    <td><span class="badge badge-success">{{ coach.approved_count }}</span></td>
                    <td><span class="badge badge-danger">{{ coach.rejected_count }}</span></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5">No coach performance data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Event Metrics Section -->
    <h2 class="section-header">ğŸ‰ Event Metrics</h2>
    <div class="dashboard-grid">
        <div class="metric-card blue">
            <div class="icon-large">ğŸ“…</div>
            <div class="metric-label">Upcoming Events</div>
            <div class="metric-value">{{ upcoming_events }}</div>
            <div class="metric-subtitle">{{ total_events }} total events</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">âœ…</div>
            <div class="metric-label">Confirmed Registrations</div>
            <div class="metric-value">{{ confirmed_registrations }}</div>
            <div class="metric-subtitle">{{ total_registrations }} total</div>
        </div>

        <div class="metric-card purple">
            <div class="icon-large">ğŸ’°</div>
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value">â‚¬{{ total_revenue }}</div>
            <div class="metric-subtitle">From confirmed payments</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">ğŸ“Š</div>
            <div class="metric-label">Attendance Rate</div>
            <div class="metric-value">{{ attendance_rate }}%</div>
            <div class="metric-subtitle">Show-up rate</div>
        </div>
    </div>

    <!-- Popular Events -->
    <div class="table-container">
        <h3 style="margin-top: 0; color: #333;">Most Popular Events</h3>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Registrations</th>
                </tr>
            </thead>
            <tbody>
                {% for event in popular_events %}
                <tr>
                    <td><a href="{% url 'crush_admin:crush_lu_meetupevent_change' event.id %}">{{ event.title }}</a></td>
                    <td>{{ event.get_event_type_display }}</td>
                    <td>{{ event.date_time|date:"M d, Y" }}</td>
                    <td>{{ event.registration_count }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No events available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Connection Metrics Section -->
    <h2 class="section-header">ğŸ’• Connection Metrics</h2>
    <div class="dashboard-grid">
        <div class="metric-card pink">
            <div class="icon-large">ğŸ’‘</div>
            <div class="metric-label">Mutual Connections</div>
            <div class="metric-value">{{ mutual_connections }}</div>
            <div class="metric-subtitle">{{ connection_rate }}% match rate</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">ğŸ”—</div>
            <div class="metric-label">Total Connections</div>
            <div class="metric-value">{{ total_connections }}</div>
            <div class="metric-subtitle">All connection requests</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">â³</div>
            <div class="metric-label">Pending Connections</div>
            <div class="metric-value">{{ pending_connections }}</div>
            <div class="metric-subtitle">Awaiting response</div>
        </div>
    </div>

    <!-- Journey System Metrics -->
    <h2 class="section-header">âœ¨ Special Journey System</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">ğŸ­</div>
            <div class="metric-label">Active Special Experiences</div>
            <div class="metric-value">{{ active_special_experiences }}</div>
            <div class="metric-subtitle">{{ total_special_experiences }} total</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">ğŸ—ºï¸</div>
            <div class="metric-label">Active Journeys</div>
            <div class="metric-value">{{ total_journeys }}</div>
            <div class="metric-subtitle">{{ completed_journeys }} completed</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">ğŸ†</div>
            <div class="metric-label">Avg Points Earned</div>
            <div class="metric-value">{{ avg_points }}</div>
            <div class="metric-subtitle">Per journey</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">â±ï¸</div>
            <div class="metric-label">Avg Time Spent</div>
            <div class="metric-value">{{ avg_time_minutes }}m</div>
            <div class="metric-subtitle">Per journey</div>
        </div>
    </div>

    <!-- Journey Completion Rate -->
    <div class="chart-container">
        <h3 style="margin-top: 0; color: #333;">Journey Completion Rate</h3>
        <div class="progress-bar-container">
            <div class="progress-bar" style="width: {{ journey_completion_rate }}%;">
                {{ journey_completion_rate }}% Complete
            </div>
        </div>
        <p style="margin-top: 10px; color: #666; font-size: 14px;">
            {{ completed_journeys }} out of {{ total_journeys }} journeys completed
        </p>
    </div>

    <!-- Email Preferences Section -->
    <h2 class="section-header">ğŸ“§ Email Preferences</h2>
    <div class="dashboard-grid">
        <div class="metric-card blue">
            <div class="icon-large">ğŸ“¬</div>
            <div class="metric-label">Active Email Users</div>
            <div class="metric-value">{{ email_active_users }}</div>
            <div class="metric-subtitle">{{ total_email_preferences }} total preferences</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">ğŸ“¢</div>
            <div class="metric-label">Marketing Opt-ins</div>
            <div class="metric-value">{{ marketing_opted_in }}</div>
            <div class="metric-subtitle">{{ marketing_opt_in_rate }}% opt-in rate</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">ğŸš«</div>
            <div class="metric-label">Unsubscribed All</div>
            <div class="metric-value">{{ unsubscribed_all }}</div>
            <div class="metric-subtitle">Opted out of all emails</div>
        </div>
    </div>

    <!-- Email Category Stats -->
    <div class="table-container">
        <h3 style="margin-top: 0; color: #333;">Email Category Subscriptions</h3>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Subscribed</th>
                    <th>Opt-in Rate</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>ğŸ“ Profile Updates</td>
                    <td>{{ email_category_stats.profile_updates }}</td>
                    <td>{% widthratio email_category_stats.profile_updates email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>ğŸ‰ Event Reminders</td>
                    <td>{{ email_category_stats.event_reminders }}</td>
                    <td>{% widthratio email_category_stats.event_reminders email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>ğŸ’• New Connections</td>
                    <td>{{ email_category_stats.new_connections }}</td>
                    <td>{% widthratio email_category_stats.new_connections email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>ğŸ’¬ New Messages</td>
                    <td>{{ email_category_stats.new_messages }}</td>
                    <td>{% widthratio email_category_stats.new_messages email_active_users 100 %}%</td>
                </tr>
                <tr>
                    <td>ğŸ“¢ Marketing</td>
                    <td>{{ email_category_stats.marketing }}</td>
                    <td>{{ marketing_opt_in_rate }}%</td>
                </tr>
            </tbody>
        </table>
        <p style="margin-top: 15px;">
            <a href="{% url 'crush_admin:crush_lu_emailpreference_changelist' %}" class="quick-action-btn" style="display: inline-block;">
                Manage Email Preferences
            </a>
        </p>
    </div>

    <!-- PWA Analytics Section -->
    <h2 class="section-header">ğŸ“± PWA Analytics</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">ğŸ“²</div>
            <div class="metric-label">Total Installations</div>
            <div class="metric-value">{{ pwa_metrics.total_installations }}</div>
            <div class="metric-subtitle">{{ pwa_metrics.unique_users }} unique users</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">âœ…</div>
            <div class="metric-label">Active (7 Days)</div>
            <div class="metric-value">{{ pwa_metrics.active_7d }}</div>
            <div class="metric-subtitle">Recently active</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">ğŸ“´</div>
            <div class="metric-label">Likely Uninstalled</div>
            <div class="metric-value">{{ pwa_metrics.inactive_7d }}</div>
            <div class="metric-subtitle">No activity 7+ days</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">ğŸ“ˆ</div>
            <div class="metric-label">New This Month</div>
            <div class="metric-value">{{ pwa_metrics.new_this_month }}</div>
            <div class="metric-subtitle">Last 30 days</div>
        </div>
    </div>

    <!-- Platform & Browser Distribution -->
    <div class="dashboard-grid">
        <div class="table-container">
            <h3 style="margin-top: 0;">ğŸ“Š Platform Distribution</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Platform</th>
                        <th>Count</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pwa_metrics.os_distribution %}
                    <tr>
                        <td>
                            {% if item.os_type == 'ios' %}ğŸ iOS
                            {% elif item.os_type == 'android' %}ğŸ¤– Android
                            {% elif item.os_type == 'windows' %}ğŸªŸ Windows
                            {% elif item.os_type == 'macos' %}ğŸ macOS
                            {% elif item.os_type == 'linux' %}ğŸ§ Linux
                            {% elif item.os_type == 'chromeos' %}ğŸ’» ChromeOS
                            {% else %}â“ {{ item.os_type|title }}
                            {% endif %}
                        </td>
                        <td>{{ item.count }}</td>
                        <td>{% if pwa_metrics.total_installations > 0 %}{% widthratio item.count pwa_metrics.total_installations 100 %}%{% else %}0%{% endif %}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--text-muted);">No PWA installations yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h3 style="margin-top: 0;">ğŸŒ Browser Distribution</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>Browser</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in pwa_metrics.browser_distribution %}
                    <tr>
                        <td>
                            {% if item.browser == 'Chrome' %}ğŸŸ¢ Chrome
                            {% elif item.browser == 'Safari' %}ğŸ”µ Safari
                            {% elif item.browser == 'Edge' %}ğŸ”· Edge
                            {% elif item.browser == 'Firefox' %}ğŸ¦Š Firefox
                            {% elif item.browser == 'Samsung Internet' %}ğŸŸ£ Samsung
                            {% else %}{{ item.browser|default:"Unknown" }}
                            {% endif %}
                        </td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="2" style="text-align: center; color: var(--text-muted);">No data</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Installations & Inactive Devices -->
    <div class="dashboard-grid">
        <div class="table-container">
            <h3 style="margin-top: 0;">ğŸ†• Recent Installations</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Device</th>
                        <th>Installed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in pwa_metrics.recent_installations %}
                    <tr>
                        <td>{{ device.user.first_name|default:device.user.username }}</td>
                        <td>{{ device.device_category }}</td>
                        <td>{{ device.installed_at|timesince }} ago</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--text-muted);">No installations yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="table-container">
            <h3 style="margin-top: 0; color: #ffc107;">âš ï¸ Likely Uninstalled (7+ days inactive)</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Device</th>
                        <th>Last Active</th>
                        <th>Days</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in pwa_metrics.inactive_devices %}
                    <tr>
                        <td>{{ device.user.first_name|default:device.user.username }}</td>
                        <td>{{ device.device_category }}</td>
                        <td>{{ device.last_used_at|date:"M d, Y" }}</td>
                        <td style="color: #dc3545; font-weight: bold;">{{ device.days_since_last_use }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #28a745;">âœ… No inactive devices - all PWA users are active!</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <p style="margin-bottom: 30px;">
        <a href="{% url 'crush_admin:crush_lu_pwadeviceinstallation_changelist' %}" class="quick-action-btn" style="display: inline-block;">
            View All PWA Devices
        </a>
    </p>

    <!-- OAuth State Section (Technical/Debugging) -->
    {% if oauth_metrics.total_states > 0 %}
    <h2 class="section-header">ğŸ” OAuth State (Debugging)</h2>
    <div class="dashboard-grid">
        <div class="metric-card blue">
            <div class="icon-large">ğŸ”„</div>
            <div class="metric-label">Active States</div>
            <div class="metric-value">{{ oauth_metrics.active_states }}</div>
            <div class="metric-subtitle">Unused, not expired</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">âœ…</div>
            <div class="metric-label">Completed Auth</div>
            <div class="metric-value">{{ oauth_metrics.completed_auth }}</div>
            <div class="metric-subtitle">Successful authentications</div>
        </div>

        <div class="metric-card orange">
            <div class="icon-large">â°</div>
            <div class="metric-label">Expired States</div>
            <div class="metric-value">{{ oauth_metrics.expired_states }}</div>
            <div class="metric-subtitle">Should be cleaned up</div>
        </div>

        <div class="metric-card purple">
            <div class="icon-large">ğŸ•</div>
            <div class="metric-label">Recent (1h)</div>
            <div class="metric-value">{{ oauth_metrics.recent_states }}</div>
            <div class="metric-subtitle">Created in last hour</div>
        </div>
    </div>

    {% if oauth_metrics.provider_distribution %}
    <div class="table-container">
        <h3 style="margin-top: 0;">OAuth Provider Distribution</h3>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Provider</th>
                    <th>Count</th>
                </tr>
            </thead>
            <tbody>
                {% for item in oauth_metrics.provider_distribution %}
                <tr>
                    <td>
                        {% if item.provider == 'facebook' %}ğŸ“˜ Facebook
                        {% elif item.provider == 'google' %}ğŸ”µ Google
                        {% elif item.provider == 'apple' %}ğŸ Apple
                        {% else %}{{ item.provider|title }}
                        {% endif %}
                    </td>
                    <td>{{ item.count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <p style="margin-bottom: 30px;">
        <a href="{% url 'crush_admin:crush_lu_oauthstate_changelist' %}" class="quick-action-btn" style="display: inline-block;">
            View OAuth States
        </a>
    </p>
    {% endif %}

    <!-- PassKit Device Registration Section (Apple Wallet) -->
    {% if passkit_metrics.total_registrations > 0 %}
    <h2 class="section-header">ğŸ Apple Wallet Devices</h2>
    <div class="dashboard-grid">
        <div class="metric-card purple">
            <div class="icon-large">ğŸ“²</div>
            <div class="metric-label">Total Registrations</div>
            <div class="metric-value">{{ passkit_metrics.total_registrations }}</div>
            <div class="metric-subtitle">Device-pass pairings</div>
        </div>

        <div class="metric-card blue">
            <div class="icon-large">ğŸ“±</div>
            <div class="metric-label">Unique Devices</div>
            <div class="metric-value">{{ passkit_metrics.unique_devices }}</div>
            <div class="metric-subtitle">Apple Wallet devices</div>
        </div>

        <div class="metric-card pink">
            <div class="icon-large">ğŸ«</div>
            <div class="metric-label">Unique Passes</div>
            <div class="metric-value">{{ passkit_metrics.unique_passes }}</div>
            <div class="metric-subtitle">Installed passes</div>
        </div>

        <div class="metric-card green">
            <div class="icon-large">ğŸ†•</div>
            <div class="metric-label">New This Month</div>
            <div class="metric-value">{{ passkit_metrics.recent_registrations }}</div>
            <div class="metric-subtitle">Last 30 days</div>
        </div>
    </div>

    <p style="margin-bottom: 30px;">
        <a href="{% url 'crush_admin:crush_lu_passkitdeviceregistration_changelist' %}" class="quick-action-btn" style="display: inline-block;">
            View PassKit Devices
        </a>
    </p>
    {% endif %}

    <!-- Recent Activity Section -->
    <h2 class="section-header">ğŸ“Š Recent Activity</h2>

    <div class="dashboard-grid">
        <!-- Recent Profile Submissions -->
        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Recent Profile Submissions</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Status</th>
                        <th>Submitted</th>
                    </tr>
                </thead>
                <tbody>
                    {% for submission in recent_submissions %}
                    <tr>
                        <td><a href="{% url 'crush_admin:crush_lu_profilesubmission_change' submission.id %}">{{ submission.profile.user.get_full_name|default:submission.profile.user.username }}</a></td>
                        <td><span class="badge badge-warning">{{ submission.get_status_display }}</span></td>
                        <td>{{ submission.submitted_at|timesince }} ago</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No recent submissions</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Recent Event Registrations -->
        <div class="table-container">
            <h3 style="margin-top: 0; color: #333;">Recent Event Registrations</h3>
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Event</th>
                        <th>Registered</th>
                    </tr>
                </thead>
                <tbody>
                    {% for registration in recent_event_registrations %}
                    <tr>
                        <td>{{ registration.user.get_full_name|default:registration.user.username }}</td>
                        <td><a href="{% url 'crush_admin:crush_lu_meetupevent_change' registration.event.id %}">{{ registration.event.title }}</a></td>
                        <td>{{ registration.registered_at|timesince }} ago</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No recent registrations</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

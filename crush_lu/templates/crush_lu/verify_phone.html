{% extends 'crush_lu/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Verify Your Phone" %} - Crush.lu{% endblock %}

{% block extra_css %}
<!-- intl-tel-input CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.3/build/css/intlTelInput.css"
      integrity="sha384-BmygXwA0e3FeMPv5eKPsAq5JZncm8qElyxhy0qDhzY2cvcZTtTF0O3lG9n+M6JeL"
      crossorigin="anonymous">
<!-- Custom intl-tel-input styling for Crush.lu -->
<link rel="stylesheet" href="{% static 'crush_lu/css/components/intl-tel-input.css' %}">
<style>
    /* Force padding-left to prevent dial code overlap */
    .iti input[type="tel"],
    .iti input.iti__tel-input,
    .phone-input-wrapper .iti input {
        padding-left: var(--intl-tel-input-padding, 110px) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-10"
     x-data="standalonePhoneVerification"
     data-phone-input-id="phone_number"
     data-current-phone="{{ current_phone }}"
     data-next-url="{{ next_url }}">
    <div class="flex justify-center">
        <div class="w-full max-w-md">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg dark:shadow-gray-900/20">
                <div class="p-6">
                    <!-- Header -->
                    <div class="text-center mb-6">
                        <div class="mb-4">
                            <div class="w-16 h-16 mx-auto bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                {% include "shared/icons/phone.html" with class="w-8 h-8 text-white" %}
                            </div>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">{% trans "Verify Your Phone Number" %}</h2>
                        <p class="text-gray-500 dark:text-gray-400 mt-2">
                            {% trans "We'll send a verification code via SMS to confirm your phone number." %}
                        </p>
                    </div>

                    <!-- Step 1: Phone Input -->
                    <div x-show="isPhoneStep" x-cloak>
                        <div class="mb-4">
                            <label for="phone_number" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                {% trans "Phone Number" %}
                            </label>
                            <div class="phone-input-wrapper">
                                <input type="tel"
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 dark:bg-gray-700 dark:text-white"
                                       id="phone_number"
                                       name="phone_number"
                                       required>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                {% trans "Select your country and enter your phone number" %}
                            </p>
                        </div>

                        <button type="button"
                                @click="sendCode"
                                x-bind:disabled="isLoading"
                                class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2">
                            <template x-if="isNotLoading">
                                <span class="flex items-center gap-2">
                                    {% include "shared/icons/paper-airplane.html" with class="w-5 h-5" %}
                                    {% trans "Send Verification Code" %}
                                </span>
                            </template>
                            <template x-if="isLoading">
                                <span class="flex items-center gap-2">
                                    <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    {% trans "Sending..." %}
                                </span>
                            </template>
                        </button>
                    </div>

                    <!-- Step 2: OTP Input -->
                    <div x-show="isOtpStep" x-cloak>
                        <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-700 text-blue-800 dark:text-blue-300 rounded-lg p-4 mb-4 flex items-start gap-2">
                            {% include "shared/icons/information-circle.html" with class="w-5 h-5 flex-shrink-0 mt-0.5" %}
                            <span>{% trans "A 6-digit code has been sent to" %} <strong x-text="displayPhone"></strong></span>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                                {% trans "Verification Code" %}
                            </label>
                            <div class="flex justify-center gap-2">
                                <input type="text" id="otp-0" maxlength="1" inputmode="numeric"
                                       class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:bg-gray-700 dark:text-white"
                                       :value="otp0"
                                       @input="handleOtpInput(0, $event)"
                                       @keydown="handleOtpKeydown(0, $event)">
                                <input type="text" id="otp-1" maxlength="1" inputmode="numeric"
                                       class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:bg-gray-700 dark:text-white"
                                       :value="otp1"
                                       @input="handleOtpInput(1, $event)"
                                       @keydown="handleOtpKeydown(1, $event)">
                                <input type="text" id="otp-2" maxlength="1" inputmode="numeric"
                                       class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:bg-gray-700 dark:text-white"
                                       :value="otp2"
                                       @input="handleOtpInput(2, $event)"
                                       @keydown="handleOtpKeydown(2, $event)">
                                <input type="text" id="otp-3" maxlength="1" inputmode="numeric"
                                       class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:bg-gray-700 dark:text-white"
                                       :value="otp3"
                                       @input="handleOtpInput(3, $event)"
                                       @keydown="handleOtpKeydown(3, $event)">
                                <input type="text" id="otp-4" maxlength="1" inputmode="numeric"
                                       class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:bg-gray-700 dark:text-white"
                                       :value="otp4"
                                       @input="handleOtpInput(4, $event)"
                                       @keydown="handleOtpKeydown(4, $event)">
                                <input type="text" id="otp-5" maxlength="1" inputmode="numeric"
                                       class="w-12 h-14 text-center text-2xl font-bold border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 dark:bg-gray-700 dark:text-white"
                                       :value="otp5"
                                       @input="handleOtpInput(5, $event)"
                                       @keydown="handleOtpKeydown(5, $event)">
                            </div>
                        </div>

                        <button type="button"
                                @click="verifyCode"
                                x-bind:disabled="isLoading"
                                class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2 mb-4">
                            <template x-if="isNotLoading">
                                <span class="flex items-center gap-2">
                                    {% include "shared/icons/check-circle.html" with class="w-5 h-5" %}
                                    {% trans "Verify Code" %}
                                </span>
                            </template>
                            <template x-if="isLoading">
                                <span class="flex items-center gap-2">
                                    <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    {% trans "Verifying..." %}
                                </span>
                            </template>
                        </button>

                        <div class="text-center space-y-3">
                            <button type="button"
                                    @click="resendCode"
                                    x-bind:disabled="cannotResend"
                                    class="text-purple-600 hover:text-purple-800 disabled:text-gray-400 disabled:cursor-not-allowed">
                                <span x-show="cannotResend">{% trans "Resend code in" %} <span x-text="resendCountdown"></span>s</span>
                                <span x-show="canResend" class="flex items-center justify-center gap-1">
                                    {% include "shared/icons/arrow-path.html" with class="w-4 h-4" %}
                                    {% trans "Resend Code" %}
                                </span>
                            </button>

                            <div>
                                <button type="button"
                                        @click="changePhone"
                                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm inline-flex items-center gap-1">
                                    {% include "shared/icons/arrow-left.html" with class="w-4 h-4" %}
                                    {% trans "Change Phone Number" %}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Success -->
                    <div x-show="isSuccessStep" x-cloak>
                        <div class="text-center">
                            <div class="mb-4">
                                <div class="w-16 h-16 mx-auto bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                                    {% include "shared/icons/check-circle.html" with class="w-10 h-10 text-green-500 dark:text-green-400" %}
                                </div>
                            </div>
                            <h3 class="text-xl font-semibold text-green-600 dark:text-green-400 mb-2">{% trans "Phone Verified!" %}</h3>
                            <p class="text-gray-500 dark:text-gray-400 mb-4">
                                {% trans "Your number" %} <strong x-text="verifiedPhone"></strong> {% trans "has been verified." %}
                            </p>
                            {% if next_url %}
                            <a href="{{ next_url }}" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-200">
                                {% trans "Continue" %}
                                {% include "shared/icons/arrow-right.html" with class="w-5 h-5" %}
                            </a>
                            {% else %}
                            <a href="{% url 'crush_lu:dashboard' %}" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-200">
                                {% include "shared/icons/home.html" with class="w-5 h-5" %}
                                {% trans "Back to Dashboard" %}
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div x-show="hasError" x-cloak
                         class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 text-red-800 dark:text-red-300 rounded-lg p-4 mt-4 flex items-start gap-2">
                        {% include "shared/icons/exclamation-circle.html" with class="w-5 h-5 flex-shrink-0 mt-0.5" %}
                        <span x-text="error"></span>
                    </div>

                    <!-- reCAPTCHA container (invisible) -->
                    <div id="recaptcha-container"></div>
                </div>
            </div>

            <!-- Back Link -->
            <div class="text-center mt-6">
                {% if next_url %}
                <a href="{{ next_url }}" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center gap-1">
                    {% include "shared/icons/arrow-left.html" with class="w-4 h-4" %}
                    {% trans "Back" %}
                </a>
                {% else %}
                <a href="{% url 'crush_lu:dashboard' %}" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 inline-flex items-center gap-1">
                    {% include "shared/icons/arrow-left.html" with class="w-4 h-4" %}
                    {% trans "Back to Dashboard" %}
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Firebase SDK for Phone Authentication -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- intl-tel-input JS -->
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.3/build/js/intlTelInput.min.js"></script>

<!-- Firebase Configuration -->
<script nonce="{{ request.csp_nonce }}">
    window.FIREBASE_API_KEY = "{{ firebase_api_key }}";
    window.FIREBASE_AUTH_DOMAIN = "{{ firebase_auth_domain }}";
    window.FIREBASE_PROJECT_ID = "{{ firebase_project_id }}";
    window.FIREBASE_LANGUAGE = "{{ firebase_language|default:'en' }}";
</script>

<!-- Phone Verification Module -->
<script src="{% static 'crush_lu/js/phone-verification.js' %}"></script>

<script nonce="{{ request.csp_nonce }}">
// Initialize PhoneVerification instance for Alpine component to use
document.addEventListener('DOMContentLoaded', function() {
    window.phoneVerification = new PhoneVerification({
        phoneInputId: 'phone_number',
        recaptchaContainerId: 'recaptcha-container',
        csrfToken: '{{ csrf_token }}',
        onVerified: function(phoneNumber) {
            window.dispatchEvent(new CustomEvent('phone-verified', { detail: phoneNumber }));
        },
        onError: function(error) {
            console.error('Phone verification error:', error);
        }
    });
});
</script>
{% endblock %}

{% extends 'crush_lu/base.html' %}
{% load socialaccount i18n %}

{% block title %}Account Settings - Crush.lu{% endblock %}
{% block meta_robots %}noindex, nofollow{% endblock %}

{% block content %}
<div class="flex justify-center">
    <div class="w-full max-w-3xl">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Account Settings</h1>

        <!-- Account Info Card -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/user-circle.html" with class="w-5 h-5 text-purple-600" %}Account Information
                </h5>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div class="text-gray-500">Email</div>
                    <div class="sm:col-span-2 text-gray-900">{{ user.email }}</div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div class="text-gray-500">Name</div>
                    <div class="sm:col-span-2 text-gray-900">{{ user.first_name }} {{ user.last_name }}</div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div class="text-gray-500">Member since</div>
                    <div class="sm:col-span-2 text-gray-900">{{ user.date_joined|date:"F j, Y" }}</div>
                </div>
                {% if crush_social_accounts %}
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="text-gray-500">Connected accounts</div>
                    <div class="sm:col-span-2">
                        {% for social in crush_social_accounts %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mr-1">
                            {% if social.provider == 'facebook' %}
                            <i class="fab fa-facebook mr-1"></i>
                            {% elif social.provider == 'google' %}
                            <i class="fab fa-google mr-1"></i>
                            {% elif social.provider == 'microsoft' %}
                            <i class="fab fa-microsoft mr-1"></i>
                            {% endif %}
                            {{ social.provider|title }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Linked Accounts Card -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/link.html" with class="w-5 h-5 text-purple-600" %}Linked Accounts
                </h5>
            </div>
            <div class="p-6">
                <p class="text-gray-500 mb-6">
                    Connect additional social accounts for easier login. You can use any connected account to log in.
                </p>

                {% get_providers as socialaccount_providers %}

                <!-- Currently Connected Accounts (Crush.lu providers only) -->
                {% if crush_social_accounts %}
                <h6 class="text-sm font-semibold text-gray-700 mb-3">Connected</h6>
                <div class="divide-y divide-gray-100 mb-6">
                    {% for social in crush_social_accounts %}
                    <div class="py-4 flex justify-between items-center">
                        <div class="flex items-center">
                            {% if social.provider == 'facebook' %}
                            <i class="fab fa-facebook text-blue-600 mr-3 text-2xl"></i>
                            <span class="font-semibold">Facebook</span>
                            {% elif social.provider == 'google' %}
                            <i class="fab fa-google text-red-500 mr-3 text-2xl"></i>
                            <span class="font-semibold">Google</span>
                            {% elif social.provider == 'microsoft' %}
                            <i class="fab fa-microsoft text-blue-400 mr-3 text-2xl"></i>
                            <span class="font-semibold">Microsoft</span>
                            {% else %}
                            {% include "crush_lu/icons/link.html" with class="w-7 h-7" %}
                            <span class="font-semibold">{{ social.provider|title }}</span>
                            {% endif %}
                            {% if social.extra_data.email %}
                            <small class="text-gray-500 ml-2">{{ social.extra_data.email }}</small>
                            {% endif %}
                        </div>
                        {% if crush_social_accounts.count > 1 or user.has_usable_password %}
                        <form method="post" action="{% url 'crush_lu:disconnect_social_account' social.id %}"
                              onsubmit="return confirm('Are you sure you want to disconnect this {{ social.provider|title }} account?');">
                            {% csrf_token %}
                            <button type="submit" class="border border-red-300 text-red-600 hover:bg-red-50 px-3 py-1.5 rounded-lg text-sm transition-colors flex items-center">
                                {% include "crush_lu/icons/x-mark.html" with class="w-5 h-5" %}Disconnect
                            </button>
                        </form>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600" title="You need at least one login method">
                            {% include "crush_lu/icons/lock-closed.html" with class="w-5 h-5" %}Required
                        </span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Available Providers to Connect -->
                {% if google_available and not google_connected or facebook_available and not facebook_connected or microsoft_available and not microsoft_connected %}
                <h6 class="text-sm font-semibold text-gray-700 mb-3">Connect More Accounts</h6>
                <div class="flex flex-wrap gap-2">
                    {% if google_available and not google_connected %}
                    <a href="{% provider_login_url 'google' process='connect' %}" class="border border-red-300 text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fab fa-google mr-2"></i>Connect Google
                    </a>
                    {% endif %}
                    {% if facebook_available and not facebook_connected %}
                    <a href="{% provider_login_url 'facebook' process='connect' %}" class="border border-blue-300 text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fab fa-facebook mr-2"></i>Connect Facebook
                    </a>
                    {% endif %}
                    {% if microsoft_available and not microsoft_connected %}
                    <a href="{% provider_login_url 'microsoft' process='connect' %}" class="border border-sky-300 text-sky-600 hover:bg-sky-50 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fab fa-microsoft mr-2"></i>Connect Microsoft
                    </a>
                    {% endif %}
                </div>
                {% endif %}

                {% if not crush_social_accounts %}
                <p class="text-gray-500 mb-4">
                    You don't have any social accounts connected yet.
                </p>
                {% if google_available or facebook_available or microsoft_available %}
                <div class="flex flex-wrap gap-2">
                    {% if google_available %}
                    <a href="{% provider_login_url 'google' process='connect' %}" class="border border-red-300 text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fab fa-google mr-2"></i>Connect Google
                    </a>
                    {% endif %}
                    {% if facebook_available %}
                    <a href="{% provider_login_url 'facebook' process='connect' %}" class="border border-blue-300 text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fab fa-facebook mr-2"></i>Connect Facebook
                    </a>
                    {% endif %}
                    {% if microsoft_available %}
                    <a href="{% provider_login_url 'microsoft' process='connect' %}" class="border border-sky-300 text-sky-600 hover:bg-sky-50 px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fab fa-microsoft mr-2"></i>Connect Microsoft
                    </a>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-gray-400 text-sm">Social login providers are not configured for this site.</p>
                {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Social Account Photos Card (Display Only) -->
        {% if social_photos %}
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/camera.html" with class="w-5 h-5 text-purple-600" %}Social Account Photos
                </h5>
            </div>
            <div class="p-6">
                <p class="text-gray-500 mb-4">
                    Photos from your connected social accounts. To use these photos on your dating profile,
                    go to <a href="{% url 'crush_lu:edit_profile' %}" class="text-purple-600 hover:text-purple-800">Edit Profile</a>.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {% for photo in social_photos %}
                    <div class="social-photo-card">
                        <div class="provider-badge">
                            {% if photo.provider == 'facebook' %}
                            <i class="fab fa-facebook text-blue-600"></i>
                            {% elif photo.provider == 'google' %}
                            <i class="fab fa-google text-red-500"></i>
                            {% elif photo.provider == 'microsoft' %}
                            <i class="fab fa-microsoft text-sky-500"></i>
                            {% endif %}
                            {{ photo.provider_display }}
                        </div>

                        {% if photo.available %}
                        <div class="social-photo-preview">
                            <img src="{{ photo.photo_url }}" alt="{{ photo.provider_display }} photo">
                        </div>
                        <small class="text-green-600 mt-2 block">
                            {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %} Available
                        </small>
                        {% else %}
                        <div class="no-photo-placeholder">
                            {% include "crush_lu/icons/photo.html" with class="w-5 h-5" %}
                            <span>{{ photo.reason }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                {% if user.crushprofile %}
                <div class="text-center mt-6">
                    <a href="{% url 'crush_lu:edit_profile' %}" class="border border-purple-300 text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-lg transition-colors inline-flex items-center">
                        {% include "crush_lu/icons/cloud-arrow-down.html" with class="w-5 h-5" %}Import Photos to Profile
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Password Management Card -->
        {% if crush_social_accounts and not user.has_usable_password %}
        <!-- Set Password Card (for social login users without password) -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/key.html" with class="w-5 h-5 text-purple-600" %}Password Login
                </h5>
            </div>
            <div class="p-6">
                <p class="text-gray-500 mb-4">
                    You can set a password to enable login with your email ({{ user.email }})
                    in addition to your
                    {% for social in crush_social_accounts %}
                        {{ social.provider|title }}{% if not forloop.last %}, {% endif %}
                    {% endfor %} account.
                </p>
                <a href="{% url 'crush_lu:set_password' %}" class="border border-purple-300 text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-lg transition-colors inline-flex items-center">
                    {% include "crush_lu/icons/key.html" with class="w-5 h-5" %}Set Password
                </a>
            </div>
        </div>
        {% elif user.has_usable_password %}
        <!-- Change Password Card (for users with password) -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/key.html" with class="w-5 h-5 text-purple-600" %}Password
                </h5>
            </div>
            <div class="p-6">
                <p class="text-gray-500 mb-4">
                    You have a password set for email login.
                    {% if crush_social_accounts %}
                    You can also login with your connected social accounts.
                    {% endif %}
                </p>
                <a href="{% url 'account_change_password' %}" class="border border-purple-300 text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-lg transition-colors inline-flex items-center">
                    {% include "crush_lu/icons/pencil.html" with class="w-5 h-5" %}Change Password
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Profile Link Card -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/heart.html" with class="w-5 h-5 text-purple-600" %}Dating Profile
                </h5>
            </div>
            <div class="p-6">
                {% if user.crushprofile %}
                <p class="mb-4">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium {% if user.crushprofile.is_approved %}bg-green-100 text-green-800{% else %}bg-amber-100 text-amber-800{% endif %}">
                        {% if user.crushprofile.is_approved %}Approved{% else %}Pending Review{% endif %}
                    </span>
                </p>
                <a href="{% url 'crush_lu:edit_profile' %}" class="border border-purple-300 text-purple-600 hover:bg-purple-50 px-4 py-2 rounded-lg transition-colors inline-flex items-center">
                    {% include "crush_lu/icons/pencil.html" with class="w-5 h-5" %}Edit Profile
                </a>
                {% else %}
                <p class="text-gray-500 mb-4">You haven't created a dating profile yet.</p>
                <a href="{% url 'crush_lu:create_profile' %}" class="btn-crush-primary px-4 py-2 rounded-lg inline-flex items-center">
                    {% include "crush_lu/icons/plus-circle.html" with class="w-5 h-5" %}Create Profile
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Email Notifications Card -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/bell.html" with class="w-5 h-5 text-purple-600" %}Email Notifications
                </h5>
            </div>
            <div class="p-6">
                <form method="post" action="{% url 'crush_lu:update_email_preferences' %}" x-data="emailPreferences" data-unsubscribed="{{ email_prefs.unsubscribed_all|yesno:'true,false' }}">
                    {% csrf_token %}

                    {% if email_prefs.unsubscribed_all %}
                    <div class="bg-amber-50 border border-amber-200 text-amber-800 rounded-lg p-4 mb-4">
                        {% include "crush_lu/icons/exclamation-triangle.html" with class="w-5 h-5" %}
                        You have unsubscribed from all emails. Toggle the switch below to re-enable notifications.
                    </div>
                    {% endif %}

                    <div class="mb-6">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" name="unsubscribed_all"
                                   x-model="unsubscribeAll"
                                   {% if email_prefs.unsubscribed_all %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                            <span class="ml-3 text-sm font-bold text-red-600">Unsubscribe from ALL emails</span>
                        </label>
                    </div>

                    <hr class="my-6 border-gray-200">

                    <div :class="{ 'opacity-50 pointer-events-none': unsubscribeAll }">
                        <p class="text-gray-500 text-sm mb-4">Choose which emails you'd like to receive:</p>

                        <div class="space-y-4">
                            <label class="flex items-start cursor-pointer">
                                <div class="relative mt-0.5">
                                    <input type="checkbox" class="sr-only peer" name="email_profile_updates"
                                           {% if email_prefs.email_profile_updates %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </div>
                                <div class="ml-3">
                                    <strong class="text-gray-900">Profile Updates</strong>
                                    <p class="text-gray-500 text-sm">Emails about profile approval, revision requests</p>
                                </div>
                            </label>

                            <label class="flex items-start cursor-pointer">
                                <div class="relative mt-0.5">
                                    <input type="checkbox" class="sr-only peer" name="email_event_reminders"
                                           {% if email_prefs.email_event_reminders %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </div>
                                <div class="ml-3">
                                    <strong class="text-gray-900">Event Reminders</strong>
                                    <p class="text-gray-500 text-sm">Reminders about upcoming events you're registered for</p>
                                </div>
                            </label>

                            <label class="flex items-start cursor-pointer">
                                <div class="relative mt-0.5">
                                    <input type="checkbox" class="sr-only peer" name="email_new_connections"
                                           {% if email_prefs.email_new_connections %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </div>
                                <div class="ml-3">
                                    <strong class="text-gray-900">New Connections</strong>
                                    <p class="text-gray-500 text-sm">Notifications about new connection requests</p>
                                </div>
                            </label>

                            <label class="flex items-start cursor-pointer">
                                <div class="relative mt-0.5">
                                    <input type="checkbox" class="sr-only peer" name="email_new_messages"
                                           {% if email_prefs.email_new_messages %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </div>
                                <div class="ml-3">
                                    <strong class="text-gray-900">New Messages</strong>
                                    <p class="text-gray-500 text-sm">Notifications about new messages from connections</p>
                                </div>
                            </label>

                            <hr class="my-4 border-gray-200">

                            <label class="flex items-start cursor-pointer">
                                <div class="relative mt-0.5">
                                    <input type="checkbox" class="sr-only peer" name="email_marketing"
                                           {% if email_prefs.email_marketing %}checked{% endif %}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                </div>
                                <div class="ml-3">
                                    <strong class="text-gray-900">Marketing & Promotions</strong>
                                    <p class="text-gray-500 text-sm">Newsletters, special offers, and promotions</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button type="submit" class="btn-crush-primary px-6 py-2 rounded-lg inline-flex items-center">
                            {% include "crush_lu/icons/check.html" with class="w-5 h-5" %}Save Preferences
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Push Notifications Card (shown to all, JS detects browser support) -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden"
             x-data="pushPreferences"
             data-subscriptions='{{ push_subscriptions_json }}'
             data-i18n-never-used="{% trans "Never used" %}"
             data-i18n-just-now="{% trans "Just now" %}"
             data-i18n-last-active="{% trans "Last active:" %}"
             data-i18n-minutes-ago="{% trans "m ago" %}"
             data-i18n-hours-ago="{% trans "h ago" %}"
             data-i18n-days-ago="{% trans "d ago" %}"
             data-i18n-months-ago="{% trans "mo ago" %}">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/bell.html" with class="w-5 h-5 text-purple-600 mr-2" %}
                    Push Notifications
                </h5>
            </div>
            <div class="p-6">
                <!-- State: Loading (checking push support) -->
                <template x-if="showLoading">
                    <div class="flex items-center justify-center py-4">
                        <span class="animate-spin inline-block w-5 h-5 border-2 border-purple-600 border-t-transparent rounded-full mr-2"></span>
                        <span class="text-gray-500">Checking notification support...</span>
                    </div>
                </template>

                <!-- State: Push not supported -->
                <template x-if="showNotSupported">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start">
                            {% include "crush_lu/icons/information-circle.html" with class="w-5 h-5 text-gray-400 mr-2 flex-shrink-0 mt-0.5" %}
                            <div>
                                <p class="font-medium text-gray-700">Push notifications not available</p>
                                <p class="text-sm text-gray-500 mt-1">
                                    Your browser doesn't support push notifications. Try opening Crush.lu in Chrome, Firefox, Edge, or Safari on iOS 16.4+.
                                </p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- State: Permission denied -->
                <template x-if="showPermissionDenied">
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <div class="flex items-start">
                            {% include "crush_lu/icons/exclamation-triangle.html" with class="w-5 h-5 text-amber-500 mr-2 flex-shrink-0 mt-0.5" %}
                            <div>
                                <p class="font-medium text-amber-800">Notifications blocked</p>
                                <p class="text-sm text-amber-700 mt-1">
                                    You've blocked notifications for this site. To enable them, click the lock icon in your browser's address bar and allow notifications.
                                </p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- State: Not subscribed - show enable button -->
                <template x-if="showEnableButton">
                    <div>
                        <p class="text-gray-500 text-sm mb-4">
                            Get instant notifications about new messages, event reminders, and connections on this device.
                        </p>

                        <button type="button"
                                class="enable-push-btn btn-crush-primary inline-flex items-center gap-2 px-4 py-2"
                                x-bind:disabled="isEnabling">
                            <template x-if="isEnabling">
                                <span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                            </template>
                            <template x-if="!isEnabling">
                                <span>{% include "crush_lu/icons/bell.html" with class="w-4 h-4" %}</span>
                            </template>
                            <span x-text="isEnabling ? 'Enabling...' : 'Enable Push Notifications'"></span>
                        </button>

                        <template x-if="errorMessage">
                            <p class="mt-3 text-sm text-red-600" x-text="errorMessage"></p>
                        </template>
                    </div>
                </template>

                <!-- State: Subscribed - show preferences -->
                <template x-if="showPreferences">
                    <div>
                        <p class="text-gray-500 text-sm mb-4">
                            Configure which notifications you receive on your devices. Changes are saved automatically.
                        </p>

                        <template x-for="(subscription, index) in subscriptions" :key="subscription.id">
                            <div :class="{ 'mt-6 pt-6 border-t border-gray-200': index > 0 }">
                                <!-- Device Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center flex-wrap gap-2">
                                        <!-- Device Icon -->
                                        <template x-if="subscription.device_type === 'mobile'">
                                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
                                            </svg>
                                        </template>
                                        <template x-if="subscription.device_type !== 'mobile'">
                                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                                            </svg>
                                        </template>
                                        <span class="font-medium text-gray-900" x-text="subscription.device_name"></span>
                                        <!-- "This device" badge -->
                                        <template x-if="isCurrentDevice(subscription)">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                {% trans "This device" %}
                                            </span>
                                        </template>
                                    </div>
                                    <button type="button"
                                            class="disable-push-btn text-sm text-gray-500 hover:text-red-600 transition-colors"
                                            x-bind:disabled="isDisabling">
                                        <span x-text="isDisabling ? 'Disabling...' : 'Disable'"></span>
                                    </button>
                                </div>
                                <!-- Last active timestamp -->
                                <p class="text-xs text-gray-400 mb-4 pl-7" x-text="i18n.lastActive + ' ' + formatRelativeTime(subscription.last_used_at)"></p>

                                <div class="space-y-4 pl-7">
                                    <!-- New Messages Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="newMessages"
                                                   :checked="subscription.notify_new_messages">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">New Messages</strong>
                                            <p class="text-gray-500 text-sm">Get notified when you receive a new message</p>
                                        </div>
                                    </label>

                                    <!-- Event Reminders Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="eventReminders"
                                                   :checked="subscription.notify_event_reminders">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">Event Reminders</strong>
                                            <p class="text-gray-500 text-sm">Reminders about upcoming events</p>
                                        </div>
                                    </label>

                                    <!-- New Connections Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="newConnections"
                                                   :checked="subscription.notify_new_connections">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">New Connections</strong>
                                            <p class="text-gray-500 text-sm">Get notified when someone connects with you</p>
                                        </div>
                                    </label>

                                    <!-- Profile Updates Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="profileUpdates"
                                                   :checked="subscription.notify_profile_updates">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">Profile Updates</strong>
                                            <p class="text-gray-500 text-sm">Notifications about your profile status</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </template>

                        <!-- Fallback when no subscriptions (shouldn't happen in showPreferences state) -->
                        <template x-if="subscriptions.length === 0">
                            <div class="text-center py-4">
                                <p class="text-gray-500">Loading your devices...</p>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>

        <!-- Coach Push Notifications Card (for coaches only) -->
        {% if is_coach %}
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden"
             x-data="coachPushPreferences"
             data-subscriptions='{{ coach_push_subscriptions_json }}'
             data-i18n-never-used="{% trans "Never used" %}"
             data-i18n-just-now="{% trans "Just now" %}"
             data-i18n-last-active="{% trans "Last active:" %}"
             data-i18n-minutes-ago="{% trans "m ago" %}"
             data-i18n-hours-ago="{% trans "h ago" %}"
             data-i18n-days-ago="{% trans "d ago" %}"
             data-i18n-months-ago="{% trans "mo ago" %}">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/bell.html" with class="w-5 h-5 text-purple-600 mr-2" %}
                    Coach Notifications
                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                        Coach
                    </span>
                </h5>
            </div>
            <div class="p-6">
                <!-- State: Loading (checking push support) -->
                <template x-if="showLoading">
                    <div class="flex items-center justify-center py-4">
                        <span class="animate-spin inline-block w-5 h-5 border-2 border-purple-600 border-t-transparent rounded-full mr-2"></span>
                        <span class="text-gray-500">Checking notification support...</span>
                    </div>
                </template>

                <!-- State: Push not supported -->
                <template x-if="showNotSupported">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start">
                            {% include "crush_lu/icons/information-circle.html" with class="w-5 h-5 text-gray-400 mr-2 flex-shrink-0 mt-0.5" %}
                            <div>
                                <p class="font-medium text-gray-700">Push notifications not available</p>
                                <p class="text-sm text-gray-500 mt-1">
                                    Your browser doesn't support push notifications.
                                </p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- State: Permission denied -->
                <template x-if="showPermissionDenied">
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                        <div class="flex items-start">
                            {% include "crush_lu/icons/exclamation-triangle.html" with class="w-5 h-5 text-amber-500 mr-2 flex-shrink-0 mt-0.5" %}
                            <div>
                                <p class="font-medium text-amber-800">Notifications blocked</p>
                                <p class="text-sm text-amber-700 mt-1">
                                    Allow notifications in your browser settings to receive coach alerts.
                                </p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- State: Not subscribed - show enable button -->
                <template x-if="showEnableButton">
                    <div>
                        <p class="text-gray-500 text-sm mb-4">
                            Get instant notifications about new profile submissions, screening reminders, and user responses.
                        </p>

                        <button type="button"
                                class="enable-coach-push-btn btn-crush-primary inline-flex items-center gap-2 px-4 py-2"
                                x-bind:disabled="isEnabling">
                            <template x-if="isEnabling">
                                <span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
                            </template>
                            <template x-if="!isEnabling">
                                <span>{% include "crush_lu/icons/bell.html" with class="w-4 h-4" %}</span>
                            </template>
                            <span x-text="isEnabling ? 'Enabling...' : 'Enable Coach Notifications'"></span>
                        </button>

                        <template x-if="errorMessage">
                            <p class="mt-3 text-sm text-red-600" x-text="errorMessage"></p>
                        </template>
                    </div>
                </template>

                <!-- State: Subscribed - show preferences -->
                <template x-if="showPreferences">
                    <div>
                        <p class="text-gray-500 text-sm mb-4">
                            Configure which coach notifications you receive on your devices. Changes are saved automatically.
                        </p>

                        <template x-for="(subscription, index) in subscriptions" :key="subscription.id">
                            <div :class="{ 'mt-6 pt-6 border-t border-gray-200': index > 0 }">
                                <!-- Device Header -->
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center flex-wrap gap-2">
                                        <!-- Device Icon -->
                                        <template x-if="subscription.device_type === 'mobile'">
                                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
                                            </svg>
                                        </template>
                                        <template x-if="subscription.device_type !== 'mobile'">
                                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0 1 15 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25m18 0A2.25 2.25 0 0 0 18.75 3H5.25A2.25 2.25 0 0 0 3 5.25m18 0V12a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 12V5.25" />
                                            </svg>
                                        </template>
                                        <span class="font-medium text-gray-900" x-text="subscription.device_name"></span>
                                        <!-- "This device" badge -->
                                        <template x-if="isCurrentDevice(subscription)">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                {% trans "This device" %}
                                            </span>
                                        </template>
                                    </div>
                                    <button type="button"
                                            class="disable-coach-push-btn text-sm text-gray-500 hover:text-red-600 transition-colors"
                                            x-bind:disabled="isDisabling">
                                        <span x-text="isDisabling ? 'Disabling...' : 'Disable'"></span>
                                    </button>
                                </div>
                                <!-- Last active timestamp -->
                                <p class="text-xs text-gray-400 mb-4 pl-7" x-text="i18n.lastActive + ' ' + formatRelativeTime(subscription.last_used_at)"></p>

                                <div class="space-y-4 pl-7">
                                    <!-- New Submissions Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer coach-push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="newSubmissions"
                                                   :checked="subscription.notify_new_submissions">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">New Profile Submissions</strong>
                                            <p class="text-gray-500 text-sm">Get notified when new profiles need review</p>
                                        </div>
                                    </label>

                                    <!-- Screening Reminders Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer coach-push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="screeningReminders"
                                                   :checked="subscription.notify_screening_reminders">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">Screening Reminders</strong>
                                            <p class="text-gray-500 text-sm">Reminders about pending screening calls</p>
                                        </div>
                                    </label>

                                    <!-- User Responses Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer coach-push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="userResponses"
                                                   :checked="subscription.notify_user_responses">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">User Revisions</strong>
                                            <p class="text-gray-500 text-sm">Get notified when users submit profile revisions</p>
                                        </div>
                                    </label>

                                    <!-- System Alerts Toggle -->
                                    <label class="flex items-start cursor-pointer">
                                        <div class="relative mt-0.5">
                                            <input type="checkbox"
                                                   class="sr-only peer coach-push-pref-toggle"
                                                   :data-subscription-id="subscription.id"
                                                   data-pref-key="systemAlerts"
                                                   :checked="subscription.notify_system_alerts">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                        </div>
                                        <div class="ml-3 flex-1">
                                            <strong class="text-gray-900">System Alerts</strong>
                                            <p class="text-gray-500 text-sm">Important system notifications and alerts</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </template>

                        <!-- Fallback when no subscriptions -->
                        <template x-if="subscriptions.length === 0">
                            <div class="text-center py-4">
                                <p class="text-gray-500">Loading your devices...</p>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
        {% endif %}

        <!-- Privacy Card -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100">
                <h5 class="text-lg font-semibold text-gray-900 flex items-center">
                    {% include "crush_lu/icons/shield-check.html" with class="w-5 h-5 text-purple-600" %}Privacy & Data
                </h5>
            </div>
            <div class="p-6">
                <div class="flex flex-col gap-3">
                    <a href="{% url 'crush_lu:privacy_policy' %}" class="text-purple-600 hover:text-purple-800 flex items-center">
                        {% include "crush_lu/icons/document-text.html" with class="w-5 h-5" %}Privacy Policy
                    </a>
                    <a href="{% url 'crush_lu:data_deletion' %}" class="text-purple-600 hover:text-purple-800 flex items-center">
                        {% include "crush_lu/icons/information-circle.html" with class="w-5 h-5" %}Data Deletion Information
                    </a>
                </div>
            </div>
        </div>

        <!-- Danger Zone Card -->
        <div class="bg-white rounded-xl shadow-lg mb-6 overflow-hidden border-2 border-red-500">
            <div class="bg-red-500 text-white px-6 py-4">
                <h5 class="text-lg font-semibold flex items-center">
                    {% include "crush_lu/icons/exclamation-triangle.html" with class="w-5 h-5" %}Danger Zone
                </h5>
            </div>
            <div class="p-6">
                <h6 class="font-semibold text-red-600 mb-2">Delete Account</h6>
                <p class="text-gray-500 text-sm mb-4">
                    Once you delete your account, there is no going back. All your data including
                    your profile, photos, event registrations, connections, and messages will be
                    permanently deleted.
                </p>
                <a href="{% url 'crush_lu:delete_account' %}" class="border border-red-300 text-red-600 hover:bg-red-50 px-4 py-2 rounded-lg transition-colors inline-flex items-center">
                    {% include "crush_lu/icons/trash.html" with class="w-5 h-5" %}Delete My Account
                </a>
            </div>
        </div>

        <div class="text-center mt-6">
            <a href="{% url 'crush_lu:dashboard' %}" class="border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg transition-colors inline-flex items-center">
                {% include "crush_lu/icons/arrow-left.html" with class="w-5 h-5" %}Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Styles are in static/crush_lu/css/components/social-photos.css -->
{% endblock %}
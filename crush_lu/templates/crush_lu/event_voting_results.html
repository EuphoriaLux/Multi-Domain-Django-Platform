{% extends 'crush_lu/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Voting Results" %} - {{ event.title }} - Crush.lu{% endblock %}

{% block extra_css %}
{# Styles moved to static/crush_lu/css/pages/voting.css #}
{% endblock %}

{% block content %}
<!-- Hidden data for JavaScript -->
<div id="event-id-data" data-event-id="{{ event.id }}" data-results-url="{% url 'crush_lu:event_voting_results' event.id %}" style="display: none;"></div>

<div class="flex justify-center">
    <div class="w-full max-w-4xl px-4">
        <a href="{% url 'crush_lu:event_detail' event.id %}" class="inline-flex items-center gap-2 px-4 py-2 mb-4 border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium rounded-lg transition-colors">
            {% include "shared/icons/arrow-left.html" with class="w-4 h-4" %} {% trans "Back to Event" %}
        </a>

        <div class="bg-white rounded-xl shadow-sm">
            <div class="p-8">
                <div class="text-center mb-4">
                    <h1 class="display-5">{% trans "Voting Results" %}</h1>
                    <p class="text-lg text-gray-500">{{ event.title }}</p>
                    {% if voting_session.is_voting_open %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">{% trans "Voting Still Open" %}</span>
                    {% else %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">{% trans "Voting Closed" %}</span>
                    {% endif %}
                </div>

                {% if winner %}
                <div class="winner-banner">
                    <div class="winner-icon">üèÜ</div>
                    <h2 class="mb-3">{% trans "The Winner Is:" %}</h2>
                    <h1 class="display-4 mb-0">{{ winner.display_name }}</h1>
                </div>

                <div class="bg-green-50 border border-green-200 text-green-800 rounded-lg p-4">
                    <h5 class="font-semibold mb-2">{% trans "What happens next?" %}</h5>
                    <p class="mb-0">{{ winner.description }}</p>
                </div>
                {% else %}
                <div class="bg-blue-50 border border-blue-200 text-blue-800 rounded-lg p-4 text-center">
                    <h5 class="font-semibold mb-2">{% trans "Voting in Progress" %}</h5>
                    <p class="mb-0">{% trans "Results will be final when voting closes. Keep checking back!" %}</p>
                    {% if voting_session.is_voting_open %}
                    <div class="mt-3">
                        <strong>{% trans "Time Remaining:" %}</strong>
                        <div class="text-xl text-purple-600" id="time-remaining">
                            {{ voting_session.time_remaining|floatformat:0 }}s
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="stats-card">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h2 id="total-votes-display">{{ total_votes }}</h2>
                            <p class="mb-0">{% trans "Total Votes" %}</p>
                        </div>
                        <div>
                            <h2>{{ activity_options|length }}</h2>
                            <p class="mb-0">{% trans "Activity Options" %}</p>
                        </div>
                    </div>
                </div>

                <h3 class="mb-4">{% trans "Detailed Results" %}</h3>

                <div id="voting-results-container">
                    {% for option in activity_options %}
                    <div class="result-option-card {% if option.is_winner %}winner-option{% endif %} {% if user_vote and user_vote.selected_option.id == option.id %}user-voted{% endif %}"
                         id="option-{{ option.id }}-card">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h5 class="mb-1">
                                    {% if option.activity_type == 'presentation_style' %}üé§
                                    {% elif option.activity_type == 'speed_dating_twist' %}üíï
                                    {% endif %}
                                    {{ option.display_name }}
                                </h5>
                                <p class="text-gray-500 text-sm mb-0">{{ option.description }}</p>
                            </div>
                            <div class="text-end">
                                {% if option.is_winner %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">{% trans "Winner üèÜ" %}</span>
                                {% endif %}
                                {% if user_vote and user_vote.selected_option.id == option.id %}
                                <span class="badge-user-vote">{% trans "Your Vote ‚úì" %}</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="vote-progress">
                            <div class="vote-progress-bar"
                                 id="option-{{ option.id }}-progress"
                                 role="progressbar"
                                 style="width: {% if total_votes > 0 %}{{ option.vote_count|floatformat:0|add:"0" }}{% else %}0{% endif %}%"
                                 aria-valuenow="{% if total_votes > 0 %}{{ option.vote_count|floatformat:0 }}{% else %}0{% endif %}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span id="option-{{ option.id }}-count">{{ option.vote_count }}</span> {% trans "votes" %}
                                <span id="option-{{ option.id }}-percent" class="ml-2">
                                    ({% if total_votes > 0 %}{{ option.vote_count|floatformat:0|add:"0" }}{% else %}0{% endif %}%)
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if voting_session.is_voting_open and not user_vote %}
                <div class="text-center mt-6">
                    <a href="{% url 'crush_lu:event_activity_vote' event.id %}" class="btn-crush-primary inline-flex items-center gap-2 px-6 py-3 text-lg">
                        {% trans "Cast Your Vote Now" %}
                    </a>
                </div>
                {% elif voting_session.is_voting_open and user_vote %}
                <div class="text-center mt-6">
                    <a href="{% url 'crush_lu:event_activity_vote' event.id %}" class="inline-flex items-center gap-2 px-6 py-3 border border-purple-500 text-purple-600 hover:bg-purple-50 font-medium rounded-lg transition-colors text-lg">
                        {% trans "Change Your Vote" %}
                    </a>
                </div>
                {% endif %}

                {% if not voting_session.is_voting_open and winner %}
                <div class="text-center mt-6">
                    <a href="{% url 'crush_lu:event_attendees' event.id %}" class="btn-crush-primary inline-flex items-center gap-2 px-6 py-3 text-lg">
                        {% trans "View Event Attendees" %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'crush_lu/js/event-voting.js' %}"></script>
{% if redirect_to_presentations %}
<script nonce="{{ request.csp_nonce }}">
// Auto-redirect to presentations after 5 seconds
setTimeout(() => {
    window.location.href = '{% url "crush_lu:event_presentations" event.id %}';
}, 5000);

// Show countdown
let countdown = 5;
const countdownInterval = setInterval(() => {
    countdown--;
    if (countdown <= 0) {
        clearInterval(countdownInterval);
    }
}, 1000);
</script>
{% endif %}
{% endblock %}

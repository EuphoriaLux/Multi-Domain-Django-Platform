{% extends 'crush_lu/base.html' %}
{% load i18n crush_media %}

{% block title %}{% if profile %}{{ profile.display_name }}{% else %}{{ member.first_name|default:member.username }}{% endif %} - {% trans "Member Overview" %} - Crush.lu{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-6">
    <a href="{% url 'crush_lu:coach_event_list' %}" class="hover:text-crush-purple transition-colors">{% trans "Events" %}</a>
    <span>/</span>
    <span class="text-gray-700 dark:text-gray-300">{% if profile %}{{ profile.display_name }}{% else %}{{ member.first_name|default:member.username }}{% endif %}</span>
</div>

{% if profile %}
<!-- ===================== -->
<!-- PROFILE HEADER CARD   -->
<!-- ===================== -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 mb-6 overflow-hidden">
    <div class="p-6">
        <div class="flex flex-col sm:flex-row items-start gap-5">
            <!-- Photos (coaches always see unblurred) -->
            <div class="flex flex-wrap gap-2 flex-shrink-0">
                {% if profile|has_photo:'photo_1' %}
                    <img src="{% profile_photo_url profile 'photo_1' %}"
                         class="w-24 h-24 rounded-xl object-cover border-2 border-white dark:border-gray-700 shadow-md dark:shadow-gray-900/20"
                         alt="" loading="lazy">
                {% else %}
                    <div class="w-24 h-24 rounded-xl bg-gradient-to-br from-crush-purple/20 to-crush-pink/20 dark:from-crush-purple/30 dark:to-crush-pink/30 flex items-center justify-center border-2 border-white dark:border-gray-700 shadow-md">
                        <span class="text-3xl font-semibold text-crush-purple dark:text-crush-pink">{{ member.first_name|first|upper }}</span>
                    </div>
                {% endif %}
                {% if profile|has_photo:'photo_2' %}
                    <img src="{% profile_photo_url profile 'photo_2' %}"
                         class="w-24 h-24 rounded-xl object-cover border-2 border-white dark:border-gray-700 shadow-md dark:shadow-gray-900/20"
                         alt="" loading="lazy">
                {% endif %}
                {% if profile|has_photo:'photo_3' %}
                    <img src="{% profile_photo_url profile 'photo_3' %}"
                         class="w-24 h-24 rounded-xl object-cover border-2 border-white dark:border-gray-700 shadow-md dark:shadow-gray-900/20"
                         alt="" loading="lazy">
                {% endif %}
            </div>

            <!-- Info -->
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">{{ profile.display_name }}</h2>
                    <!-- Gender icon -->
                    {% if profile.gender == 'F' %}
                        <span class="text-pink-500" title="{% trans 'Female' %}">&#9792;</span>
                    {% elif profile.gender == 'M' %}
                        <span class="text-blue-500" title="{% trans 'Male' %}">&#9794;</span>
                    {% elif profile.gender %}
                        <span class="text-purple-500" title="{{ profile.get_gender_display }}">&#9898;</span>
                    {% endif %}
                    <!-- Language -->
                    <span class="text-lg">
                        {% if profile.preferred_language == 'en' %}ðŸ‡¬ðŸ‡§{% elif profile.preferred_language == 'de' %}ðŸ‡©ðŸ‡ª{% elif profile.preferred_language == 'fr' %}ðŸ‡«ðŸ‡·{% endif %}
                    </span>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-1 text-sm text-gray-600 dark:text-gray-300 mt-2">
                    {% if profile.age %}
                        <p class="flex items-center gap-1.5">
                            {% include "shared/icons/user.html" with class="w-4 h-4 text-gray-400" %}
                            {% if profile.show_exact_age %}{{ profile.age }} {% trans "years old" %}{% else %}{{ profile.age_range }}{% endif %}
                            &middot; {{ profile.get_gender_display }}
                        </p>
                    {% endif %}
                    {% if profile.location %}
                        <p class="flex items-center gap-1.5">
                            {% include "shared/icons/map-pin.html" with class="w-4 h-4 text-gray-400" %}
                            {{ profile.location }}
                        </p>
                    {% endif %}
                    {% if profile.phone_number %}
                        <p class="flex items-center gap-1.5">
                            {% include "shared/icons/phone.html" with class="w-4 h-4 text-gray-400" %}
                            {{ profile.phone_number }}
                            {% if profile.phone_verified %}
                                <span class="text-green-500" title="{% trans 'Verified' %}">{% include "shared/icons/check-circle.html" with class="w-3.5 h-3.5" %}</span>
                            {% endif %}
                        </p>
                    {% endif %}
                    <p class="flex items-center gap-1.5">
                        {% include "shared/icons/envelope.html" with class="w-4 h-4 text-gray-400" %}
                        {{ member.email }}
                    </p>
                    {% if profile.looking_for %}
                        <p class="flex items-center gap-1.5">
                            {% include "shared/icons/heart.html" with class="w-4 h-4 text-gray-400" %}
                            {{ profile.get_looking_for_display }}
                        </p>
                    {% endif %}
                    <p class="flex items-center gap-1.5">
                        {% include "shared/icons/calendar.html" with class="w-4 h-4 text-gray-400" %}
                        {% trans "Joined" %} {{ profile.created_at|date:"M j, Y" }}
                    </p>
                </div>

                <!-- Status badges -->
                <div class="flex flex-wrap gap-2 mt-3">
                    {% if profile.is_approved %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full">
                            {% include "shared/icons/check-circle.html" with class="w-3.5 h-3.5" %}
                            {% trans "Approved" %}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 text-xs font-medium bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-full">
                            {% include "shared/icons/clock.html" with class="w-3.5 h-3.5" %}
                            {% trans "Not Approved" %}
                        </span>
                    {% endif %}
                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-full">
                        {{ profile.get_membership_tier_display }}
                    </span>
                    {% if profile.blur_photos %}
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full">
                            {% include "shared/icons/eye.html" with class="w-3.5 h-3.5" %}
                            {% trans "Photos Blurred" %}
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Bio -->
        {% if profile.bio %}
            <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">{% trans "Bio" %}</h4>
                <p class="text-sm text-gray-700 dark:text-gray-300">{{ profile.bio }}</p>
            </div>
        {% endif %}

        <!-- Interests -->
        {% if profile.interests %}
            <div class="mt-3">
                <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">{% trans "Interests" %}</h4>
                <p class="text-sm text-gray-700 dark:text-gray-300">{{ profile.interests }}</p>
            </div>
        {% endif %}
    </div>
</div>

{% else %}
<!-- No profile - minimal header -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 mb-6 p-6">
    <div class="flex items-center gap-4">
        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-crush-purple/20 to-crush-pink/20 dark:from-crush-purple/30 dark:to-crush-pink/30 flex items-center justify-center">
            <span class="text-2xl font-semibold text-crush-purple dark:text-crush-pink">{{ member.first_name|first|upper|default:"?" }}</span>
        </div>
        <div>
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">{{ member.first_name }} {{ member.last_name }}</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400">{{ member.email }}</p>
            <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded-full mt-1">{% trans "No Crush Profile" %}</span>
        </div>
    </div>
</div>
{% endif %}

<!-- ===================== -->
<!-- REVIEW & COACH ASSIGN -->
<!-- ===================== -->
{% if latest_submission %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 mb-6">
    <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
        <h3 class="font-semibold dark:text-white flex items-center gap-2">
            {% include "shared/icons/clipboard-document-check.html" with class="w-5 h-5 text-crush-purple" %}
            {% trans "Profile Review" %}
        </h3>
    </div>
    <div class="p-6">
        <!-- Status Row -->
        <div class="flex flex-wrap items-center gap-3 text-sm">
            <div>
                <span class="text-gray-500 dark:text-gray-400">{% trans "Status" %}:</span>
                {% if latest_submission.status == 'approved' %}
                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full">{% trans "Approved" %}</span>
                {% elif latest_submission.status == 'pending' %}
                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-full">{% trans "Pending" %}</span>
                {% elif latest_submission.status == 'rejected' %}
                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full">{% trans "Rejected" %}</span>
                {% elif latest_submission.status == 'revision' %}
                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full">{% trans "Revision Requested" %}</span>
                {% elif latest_submission.status == 'recontact_coach' %}
                    <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-full">{% trans "Recontact Coach" %}</span>
                {% endif %}
            </div>
            {% if latest_submission.reviewed_at %}
                <div>
                    <span class="text-gray-500 dark:text-gray-400">{% trans "Reviewed" %}:</span>
                    <span class="text-gray-700 dark:text-gray-300">{{ latest_submission.reviewed_at|date:"M j, Y" }}</span>
                </div>
            {% endif %}
            {% if latest_submission.review_call_completed %}
                <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full">
                    {% include "shared/icons/phone.html" with class="w-3 h-3" %}
                    {% trans "Call Completed" %}
                </span>
            {% endif %}
        </div>

        <!-- Coach Assignment Section -->
        <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <!-- Current coach display -->
                <div class="flex items-center gap-2 flex-1">
                    {% include "shared/icons/user-circle.html" with class="w-5 h-5 text-gray-400" %}
                    <span class="text-sm text-gray-500 dark:text-gray-400">{% trans "Assigned Coach" %}:</span>
                    {% if latest_submission.coach %}
                        <span class="text-sm font-medium text-gray-900 dark:text-white">{{ latest_submission.coach.user.get_full_name }}</span>
                        {% if latest_submission.coach == coach %}
                            <span class="inline-flex items-center px-1.5 py-0.5 text-xs bg-crush-purple/10 dark:bg-crush-purple/20 text-crush-purple rounded">{% trans "You" %}</span>
                        {% endif %}
                    {% else %}
                        <span class="text-sm text-amber-600 dark:text-amber-400 font-medium">{% trans "Unassigned" %}</span>
                    {% endif %}
                </div>

                <!-- Action buttons -->
                <div class="flex items-center gap-2 flex-shrink-0">
                    {% if latest_submission.coach != coach %}
                        <!-- Claim button: visible when assigned to someone else or unassigned -->
                        <form method="post" action="{% url 'crush_lu:coach_reassign_submission' latest_submission.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="claim">
                            <button type="submit" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium bg-crush-purple text-white hover:bg-crush-purple/90 rounded-lg transition-colors">
                                {% include "shared/icons/hand-raised.html" with class="w-4 h-4" %}
                                {% trans "Claim Review" %}
                            </button>
                        </form>
                    {% endif %}

                    <!-- Reassign dropdown -->
                    <form method="post" action="{% url 'crush_lu:coach_reassign_submission' latest_submission.id %}" class="flex items-center gap-1.5">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reassign">
                        <select name="target_coach_id" class="text-sm border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg px-2 py-1.5 focus:ring-crush-purple focus:border-crush-purple">
                            <option value="">{% trans "Reassign to..." %}</option>
                            {% for c in all_coaches %}
                                {% if c != latest_submission.coach %}
                                    <option value="{{ c.id }}">{{ c.user.get_full_name }}{% if not c.can_accept_reviews %} ({% trans "full" %}){% endif %}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button type="submit" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            {% include "shared/icons/arrows-right-left.html" with class="w-4 h-4" %}
                            {% trans "Reassign" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>

        {% if latest_submission.coach_notes %}
            <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">{% trans "Coach Notes" %}</p>
                <p class="text-sm text-gray-700 dark:text-gray-300">{{ latest_submission.coach_notes }}</p>
            </div>
        {% endif %}

        <!-- Review action: only if assigned to current coach and pending -->
        {% if latest_submission.status == 'pending' %}
            <div class="mt-3">
                {% if latest_submission.coach == coach %}
                    <a href="{% url 'crush_lu:coach_review_profile' latest_submission.id %}" class="btn-crush-primary inline-flex items-center gap-1 text-sm px-3 py-1.5">
                        {% include "shared/icons/arrow-right.html" with class="w-4 h-4" %}
                        <span>{% trans "Review Profile" %}</span>
                    </a>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400 italic">
                        {% if latest_submission.coach %}
                            {% blocktrans with name=latest_submission.coach.user.get_full_name %}Assigned to {{ name }}. Claim the review or reassign to yourself to review this profile.{% endblocktrans %}
                        {% else %}
                            {% trans "No coach assigned. Claim this review to start." %}
                        {% endif %}
                    </p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- ===================== -->
<!-- EVENT HISTORY         -->
<!-- ===================== -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 mb-6">
    <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
        <h3 class="font-semibold dark:text-white flex items-center gap-2">
            {% include "shared/icons/calendar.html" with class="w-5 h-5 text-crush-purple" %}
            {% trans "Event History" %}
            <span class="inline-flex items-center justify-center min-w-[1.5rem] h-6 px-2 text-xs font-semibold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">{{ event_registrations|length }}</span>
        </h3>
    </div>
    <div class="p-6">
        {% if event_registrations %}
            <div class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for reg in event_registrations %}
                    <div class="py-3 first:pt-0 last:pb-0 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <a href="{% url 'crush_lu:coach_event_detail' reg.event.id %}" class="font-medium text-gray-900 dark:text-white hover:text-crush-purple transition-colors">{{ reg.event.title }}</a>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                                {{ reg.event.date_time|date:"D, M j, Y \a\t g:i A" }}
                                &middot; {{ reg.event.location }}
                            </p>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            {% if reg.status == 'confirmed' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full">{% trans "Confirmed" %}</span>
                            {% elif reg.status == 'attended' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 rounded-full">{% trans "Attended" %}</span>
                            {% elif reg.status == 'waitlist' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-full">{% trans "Waitlist" %}</span>
                            {% elif reg.status == 'pending' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full">{% trans "Pending" %}</span>
                            {% elif reg.status == 'cancelled' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded-full">{% trans "Cancelled" %}</span>
                            {% elif reg.status == 'no_show' %}
                                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full">{% trans "No Show" %}</span>
                            {% endif %}
                            {% if reg.dietary_restrictions %}
                                <span class="text-xs text-orange-600 dark:text-orange-400" title="{{ reg.dietary_restrictions }}">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>
                                </span>
                            {% endif %}
                            {% if reg.bringing_guest %}
                                <span class="text-xs text-purple-600 dark:text-purple-400" title="+1: {{ reg.guest_name|default:_('Guest') }}">
                                    {% include "shared/icons/user-plus.html" with class="w-4 h-4" %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-500 dark:text-gray-400 text-center py-4 text-sm">{% trans "No event registrations yet." %}</p>
        {% endif %}
    </div>
</div>

<!-- ===================== -->
<!-- CONNECTIONS            -->
<!-- ===================== -->
{% if connections %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 mb-6">
    <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700">
        <h3 class="font-semibold dark:text-white flex items-center gap-2">
            {% include "shared/icons/users.html" with class="w-5 h-5 text-crush-purple" %}
            {% trans "Connections" %}
            <span class="inline-flex items-center justify-center min-w-[1.5rem] h-6 px-2 text-xs font-semibold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">{{ connections|length }}</span>
        </h3>
    </div>
    <div class="p-6">
        <div class="divide-y divide-gray-100 dark:divide-gray-700">
            {% for conn in connections %}
                <div class="py-3 first:pt-0 last:pb-0 flex items-center justify-between gap-3">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-gray-900 dark:text-white">
                            {% if conn.requester == member %}
                                {% trans "Requested" %} &rarr; {{ conn.recipient.first_name|default:conn.recipient.username }}
                            {% else %}
                                {{ conn.requester.first_name|default:conn.requester.username }} &rarr; {% trans "Received" %}
                            {% endif %}
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            {{ conn.event.title }} &middot; {{ conn.requested_at|date:"M j, Y" }}
                        </p>
                    </div>
                    {% if conn.status == 'accepted' %}
                        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full">{% trans "Accepted" %}</span>
                    {% elif conn.status == 'pending' %}
                        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 rounded-full">{% trans "Pending" %}</span>
                    {% elif conn.status == 'declined' %}
                        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full">{% trans "Declined" %}</span>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% extends 'crush_lu/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Manage Invitations" %} - {{ event.title }} - Crush.lu{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Dashboard Header -->
    <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-2xl mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-2">
                    {% include "shared/icons/envelope.html" with class="w-5 h-5" %} {% trans "Manage Private Invitations" %}
                </h2>
                <h4 class="text-xl mb-2">{{ event.title }}</h4>
                <p class="text-white/80">
                    {% include "shared/icons/calendar-days.html" with class="w-5 h-5" %} {{ event.date_time|date:"F j, Y \a\t g:i A" }}
                    <span class="mx-2">|</span>
                    {% include "shared/icons/map-pin.html" with class="w-5 h-5" %} {{ event.location }}
                </p>
            </div>
            <div class="mt-4 md:mt-0">
                <a href="{% url 'crush_lu:event_detail' event_id=event.id %}"
                   class="inline-flex items-center gap-2 bg-white text-gray-800 px-5 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
                    {% include "shared/icons/arrow-left.html" with class="w-5 h-5" %} {% trans "Back to Event" %}
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-2xl p-6 shadow-sm text-center hover:-translate-y-1 transition-transform">
            <div class="text-4xl font-bold text-purple-600">{{ invitations.count }}</div>
            <div class="text-gray-500 text-sm uppercase tracking-wide mt-1">{% trans "Total Invitations" %}</div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm text-center hover:-translate-y-1 transition-transform">
            <div class="text-4xl font-bold text-amber-500">{{ pending_approvals.count }}</div>
            <div class="text-gray-500 text-sm uppercase tracking-wide mt-1">{% trans "Pending Approval" %}</div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm text-center hover:-translate-y-1 transition-transform">
            <div class="text-4xl font-bold text-green-500">{{ approved_guests.count }}</div>
            <div class="text-gray-500 text-sm uppercase tracking-wide mt-1">{% trans "Approved" %}</div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm text-center hover:-translate-y-1 transition-transform">
            <div class="text-4xl font-bold text-blue-500">{{ pending_invitations.count }}</div>
            <div class="text-gray-500 text-sm uppercase tracking-wide mt-1">{% trans "Not Accepted" %}</div>
        </div>
    </div>

    <!-- Send New Invitation Card -->
    <div class="bg-white rounded-2xl shadow-sm mb-8 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100">
            <h5 class="font-semibold flex items-center gap-2">
                {% include "shared/icons/plus-circle.html" with class="w-5 h-5" %} {% trans "Send New Invitation" %}
            </h5>
        </div>
        <div class="p-6">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="send_invitation">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-3">
                        <label for="invite_first_name" class="block text-sm font-medium text-gray-700 mb-1">{% trans "First Name *" %}</label>
                        <input type="text" name="first_name" id="invite_first_name" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="md:col-span-3">
                        <label for="invite_last_name" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Last Name *" %}</label>
                        <input type="text" name="last_name" id="invite_last_name" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="md:col-span-4">
                        <label for="invite_email" class="block text-sm font-medium text-gray-700 mb-1">{% trans "Email Address *" %}</label>
                        <input type="email" name="email" id="invite_email" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="btn-crush-primary w-full py-2">
                            {% include "shared/icons/paper-airplane.html" with class="w-5 h-5" %} {% trans "Send" %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Pending Approvals Section -->
    {% if pending_approvals.exists %}
    <div class="mb-8">
        <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
            {% include "shared/icons/clock.html" with class="w-5 h-5 text-amber-500" %} {% blocktrans count counter=pending_approvals.count %}Pending Approval ({{ counter }}){% plural %}Pending Approvals ({{ counter }}){% endblocktrans %}
        </h4>
        {% for invitation in pending_approvals %}
        <div x-data="invitationRow" class="bg-white rounded-2xl p-5 shadow-sm mb-3 border-l-4 border-amber-400">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="md:flex-1">
                    <h6 class="font-semibold">{{ invitation.guest_first_name }} {{ invitation.guest_last_name }}</h6>
                    <p class="text-gray-500 text-sm flex items-center gap-1">
                        {% include "shared/icons/envelope.html" with class="w-5 h-5" %} {{ invitation.guest_email }}
                    </p>
                </div>
                <div class="md:w-40">
                    <span class="text-gray-500 text-sm block">{% trans "Accepted" %}</span>
                    <strong class="text-sm">{{ invitation.accepted_at|date:"M j, Y g:i A" }}</strong>
                </div>
                <div class="md:w-28">
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-amber-100 text-amber-800">
                        {% include "shared/icons/hourglass.html" with class="w-5 h-5" %} {% trans "Pending" %}
                    </span>
                </div>
                <div class="flex gap-2">
                    <form method="post" class="inline" onsubmit="return confirm('{% trans "Approve this guest?" %}');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="approve_guest">
                        <input type="hidden" name="invitation_id" value="{{ invitation.id }}">
                        <button type="submit" class="inline-flex items-center gap-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded-lg transition-colors">
                            {% include "shared/icons/check-circle.html" with class="w-5 h-5" %} {% trans "Approve" %}
                        </button>
                    </form>
                    <button @click="openRejectModal"
                            class="inline-flex items-center gap-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold rounded-lg transition-colors">
                        {% include "shared/icons/x-circle.html" with class="w-5 h-5" %} {% trans "Reject" %}
                    </button>
                </div>
            </div>

            <!-- Alpine.js Reject Modal -->
            <div x-show="showRejectModal"
                 x-cloak
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
                 @click.self="closeRejectModal">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 scale-100"
                     x-transition:leave-end="opacity-0 scale-95">
                    <div class="flex items-center justify-between p-5 border-b border-gray-100">
                        <h5 class="font-semibold">{% trans "Reject Guest" %}</h5>
                        <button @click="closeRejectModal" class="text-gray-400 hover:text-gray-600">
                            {% include "shared/icons/x-mark.html" with class="w-5 h-5" %}
                        </button>
                    </div>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="reject_guest">
                        <input type="hidden" name="invitation_id" value="{{ invitation.id }}">
                        <div class="p-5">
                            <p class="mb-4">{% blocktrans with first_name=invitation.guest_first_name last_name=invitation.guest_last_name %}Are you sure you want to reject <strong>{{ first_name }} {{ last_name }}</strong>?{% endblocktrans %}</p>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{% trans "Rejection Notes (Optional)" %}</label>
                                <textarea name="rejection_notes" rows="3"
                                          placeholder="{% trans 'Internal notes about this decision...' %}"
                                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 p-5 border-t border-gray-100">
                            <button type="button" @click="closeRejectModal"
                                    class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                {% trans "Cancel" %}
                            </button>
                            <button type="submit"
                                    class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition-colors">
                                {% trans "Reject Guest" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Approved Guests Section -->
    {% if approved_guests.exists %}
    <div class="mb-8">
        <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
            {% include "shared/icons/check-circle.html" with class="w-5 h-5 text-green-500" %} {% blocktrans count counter=approved_guests.count %}Approved Guests ({{ counter }}){% plural %}Approved Guests ({{ counter }}){% endblocktrans %}
        </h4>
        {% for invitation in approved_guests %}
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-3 border-l-4 border-green-400">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="md:flex-1">
                    <h6 class="font-semibold">{{ invitation.guest_first_name }} {{ invitation.guest_last_name }}</h6>
                    <p class="text-gray-500 text-sm flex items-center gap-1">
                        {% include "shared/icons/envelope.html" with class="w-5 h-5" %} {{ invitation.guest_email }}
                    </p>
                </div>
                <div class="md:w-40">
                    <span class="text-gray-500 text-sm block">{% trans "Approved" %}</span>
                    <strong class="text-sm">{{ invitation.approved_at|date:"M j, Y g:i A" }}</strong>
                </div>
                <div class="md:w-28">
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800">
                        {% include "shared/icons/check-circle.html" with class="w-5 h-5" %} {% trans "Approved" %}
                    </span>
                </div>
                <div class="md:w-32 text-right">
                    {% if invitation.created_user %}
                    <span class="text-gray-400 text-sm">{% trans "User ID:" %} {{ invitation.created_user.id }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Pending Invitations (Not Yet Accepted) -->
    {% if pending_invitations.exists %}
    <div class="mb-8">
        <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
            {% include "shared/icons/envelope.html" with class="w-5 h-5 text-blue-500" %} {% blocktrans count counter=pending_invitations.count %}Sent Invitations ({{ counter }}){% plural %}Sent Invitations ({{ counter }}){% endblocktrans %}
        </h4>
        {% for invitation in pending_invitations %}
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-3 border-l-4 border-blue-400">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="md:flex-1">
                    <h6 class="font-semibold">{{ invitation.guest_first_name }} {{ invitation.guest_last_name }}</h6>
                    <p class="text-gray-500 text-sm flex items-center gap-1">
                        {% include "shared/icons/envelope.html" with class="w-5 h-5" %} {{ invitation.guest_email }}
                    </p>
                </div>
                <div class="md:flex-1">
                    <span class="text-gray-500 text-sm block">{% trans "Invitation Link:" %}</span>
                    <code class="inline-block bg-gray-100 px-3 py-1 rounded text-sm font-mono mt-1 break-all">
                        {{ request.scheme }}://{{ request.get_host }}{% url 'crush_lu:invitation_landing' code=invitation.invitation_code %}
                    </code>
                </div>
                <div class="md:w-24">
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
                        {% include "shared/icons/envelope.html" with class="w-5 h-5" %} {% trans "Sent" %}
                    </span>
                </div>
                <div>
                    <button data-copy-url="{{ request.scheme }}://{{ request.get_host }}{% url 'crush_lu:invitation_landing' code=invitation.invitation_code %}"
                            class="copy-invitation-btn inline-flex items-center gap-1 px-3 py-2 border border-purple-500 text-purple-600 text-sm font-semibold rounded-lg hover:bg-purple-50 transition-colors">
                        {% include "shared/icons/clipboard.html" with class="w-5 h-5" %} {% trans "Copy Link" %}
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Rejected Guests -->
    {% if rejected_guests.exists %}
    <div class="mb-8">
        <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
            {% include "shared/icons/x-circle.html" with class="w-5 h-5 text-red-500" %} {% blocktrans count counter=rejected_guests.count %}Rejected ({{ counter }}){% plural %}Rejected ({{ counter }}){% endblocktrans %}
        </h4>
        {% for invitation in rejected_guests %}
        <div class="bg-white rounded-2xl p-5 shadow-sm mb-3 border-l-4 border-red-400">
            <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="md:flex-1">
                    <h6 class="font-semibold">{{ invitation.guest_first_name }} {{ invitation.guest_last_name }}</h6>
                    <p class="text-gray-500 text-sm flex items-center gap-1">
                        {% include "shared/icons/envelope.html" with class="w-5 h-5" %} {{ invitation.guest_email }}
                    </p>
                </div>
                <div class="md:flex-1">
                    {% if invitation.approval_notes %}
                    <span class="text-gray-500 text-sm block">{% trans "Notes:" %}</span>
                    <p class="text-sm">{{ invitation.approval_notes }}</p>
                    {% endif %}
                </div>
                <div class="md:w-28">
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                        {% include "shared/icons/x-circle.html" with class="w-5 h-5" %} {% trans "Rejected" %}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not invitations.exists %}
    <div class="text-center py-16">
        <div class="text-6xl opacity-30 mb-4">ðŸ“­</div>
        <h4 class="text-xl text-gray-500 mb-2">{% trans "No Invitations Yet" %}</h4>
        <p class="text-gray-400">{% trans "Send your first invitation using the form above!" %}</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.copy-invitation-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const url = btn.dataset.copyUrl;
            const originalHTML = btn.innerHTML;

            navigator.clipboard.writeText(url).then(function() {
                btn.innerHTML = `{% include "shared/icons/check.html" with class="w-5 h-5" %} Copied!`;
                btn.classList.add('bg-green-500', 'text-white', 'border-green-500');
                btn.classList.remove('text-purple-600', 'border-purple-500');

                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-green-500', 'text-white', 'border-green-500');
                    btn.classList.add('text-purple-600', 'border-purple-500');
                }, 2000);
            }, function(err) {
                alert('Failed to copy link. Please copy manually.');
            });
        });
    });
});
</script>
{% endblock %}

{% extends 'crush_lu/base.html' %}

{% block title %}Dashboard - Crush.lu{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Welcome back, {{ user.first_name }}! üëã</h2>
    <a href="{% url 'crush_lu:account_settings' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-gear"></i> Settings
    </a>
</div>

<div class="row g-4 mb-4">
    <!-- Profile Status Card -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Profile Status</h5>
                {% if profile.is_approved %}
                    <div class="alert alert-success">
                        ‚úÖ Your profile is approved and active!
                    </div>
                {% elif submission %}
                    {% if submission.status == 'pending' %}
                        <div class="alert alert-warning">
                            ‚è≥ Your profile is currently under review by {{ submission.coach }}
                        </div>
                    {% elif submission.status == 'revision' %}
                        <div class="alert alert-info">
                            üìù Your coach has requested some revisions
                            <p class="mt-2 mb-0"><strong>Feedback:</strong> {{ submission.feedback_to_user }}</p>
                        </div>
                    {% elif submission.status == 'rejected' %}
                        <div class="alert alert-danger">
                            ‚ùå Your profile was not approved
                            <p class="mt-2 mb-0"><strong>Feedback:</strong> {{ submission.feedback_to_user }}</p>
                        </div>
                    {% endif %}
                {% endif %}

                <div class="mt-3">
                    <a href="{% url 'crush_lu:edit_profile' %}" class="btn btn-outline-primary">
                        Edit Profile
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Push Notifications Card -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">üîî Push Notifications</h5>
                <p class="text-muted">Get notified about events, messages, and connections</p>

                <div id="push-status" class="mb-3">
                    <p class="text-muted">
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        Checking notification status...
                    </p>
                </div>

                <button id="enable-push-btn" class="btn btn-crush-primary" style="display:none;">
                    <i class="bi bi-bell"></i> Enable Notifications
                </button>

                <button id="disable-push-btn" class="btn btn-outline-secondary" style="display:none;">
                    <i class="bi bi-bell-slash"></i> Disable
                </button>

                <button id="test-push-btn" class="btn btn-crush-outline mt-2" style="display:none;">
                    <i class="bi bi-send"></i> Send Test
                </button>

                <div id="push-not-supported" style="display:none;">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Push notifications not available</strong>
                        <p class="mb-0 mt-2" style="font-size: 0.9rem;">
                            To receive push notifications, try opening Crush.lu in:
                            <br>‚Ä¢ Chrome or Edge on Android
                            <br>‚Ä¢ Chrome, Firefox, or Edge on Desktop
                            <br>‚Ä¢ Safari on iOS 16.4+ or macOS 16.4+
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Quick Stats Card -->
    <div class="col-md-12">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Your Activity</h5>
                <div class="row text-center mt-3">
                    <div class="col-4">
                        <h3>{{ registrations|length }}</h3>
                        <p class="text-muted mb-0">Events</p>
                    </div>
                    <div class="col-4">
                        <h3>{{ profile.age|default:"‚Äî" }}</h3>
                        <p class="text-muted mb-0">Age</p>
                    </div>
                    <div class="col-4">
                        <a href="{% url 'crush_lu:my_connections' %}" class="text-decoration-none">
                            <h3 class="text-primary">{{ connection_count|default:0 }}</h3>
                            <p class="text-muted mb-0">Connections</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Events Section -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Your Events</h5>

        {% if registrations %}
            <div class="list-group list-group-flush">
                {% for registration in registrations %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ registration.event.title }}</h6>
                                <p class="mb-1 text-muted">
                                    <small>
                                        üìÖ {{ registration.event.date_time|date:"D, M j, Y" }} at {{ registration.event.date_time|date:"g:i A" }}<br>
                                        üìç {{ registration.event.location }}
                                    </small>
                                </p>
                            </div>
                            <div>
                                {% if registration.status == 'confirmed' %}
                                    <span class="badge bg-success">Confirmed</span>
                                {% elif registration.status == 'waitlist' %}
                                    <span class="badge bg-warning">Waitlist</span>
                                {% elif registration.status == 'cancelled' %}
                                    <span class="badge bg-secondary">Cancelled</span>
                                {% elif registration.status == 'attended' %}
                                    <span class="badge bg-info">Attended</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-2">
                            <a href="{% url 'crush_lu:event_detail' registration.event.id %}" class="btn btn-sm btn-outline-primary">
                                View Event
                            </a>
                            {% if registration.status == 'attended' %}
                                <a href="{% url 'crush_lu:event_attendees' registration.event.id %}" class="btn btn-sm btn-gradient-primary">
                                    <i class="bi bi-people"></i> Make Connections
                                </a>
                            {% elif registration.status == 'confirmed' or registration.status == 'waitlist' %}
                                <a href="{% url 'crush_lu:event_cancel' registration.event.id %}" class="btn btn-sm btn-outline-danger">
                                    Cancel Registration
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">You haven't registered for any events yet.</p>
            <a href="{% url 'crush_lu:event_list' %}" class="btn btn-crush-primary">
                Browse Events
            </a>
        {% endif %}
    </div>
</div>

<!-- Call to Action -->
{% if profile.is_approved and not registrations %}
<div class="card" style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.1), rgba(255, 107, 157, 0.1));">
    <div class="card-body text-center p-5">
        <h4>Ready to Meet New People?</h4>
        <p class="text-muted">Check out our upcoming events and start making connections!</p>
        <a href="{% url 'crush_lu:event_list' %}" class="btn btn-crush-primary">
            View Upcoming Events
        </a>
    </div>
</div>
{% endif %}

<style>
.btn-gradient-primary {
    background: linear-gradient(135deg, #9B59B6, #FF6B9D);
    border: none;
    color: white;
}

.btn-gradient-primary:hover {
    background: linear-gradient(135deg, #8E44AD, #E74C3C);
    color: white;
}
</style>

<script>
// Push Notification UI Handler
(function() {
    const statusDiv = document.getElementById('push-status');
    const enableBtn = document.getElementById('enable-push-btn');
    const disableBtn = document.getElementById('disable-push-btn');
    const testBtn = document.getElementById('test-push-btn');
    const notSupportedDiv = document.getElementById('push-not-supported');

    // Check if push notifications are supported
    if (!window.CrushPush || !window.CrushPush.isSupported) {
        statusDiv.style.display = 'none';
        notSupportedDiv.style.display = 'block';
        return;
    }

    // Check current subscription status
    window.CrushPush.isSubscribed().then(subscribed => {
        statusDiv.innerHTML = subscribed
            ? '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Notifications enabled</div>'
            : '<div class="alert alert-warning"><i class="bi bi-exclamation-circle"></i> Notifications disabled</div>';

        if (subscribed) {
            disableBtn.style.display = 'inline-block';
            testBtn.style.display = 'inline-block';
        } else {
            enableBtn.style.display = 'inline-block';
        }
    });

    // Enable push notifications
    enableBtn.addEventListener('click', async function() {
        enableBtn.disabled = true;
        enableBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enabling...';

        const result = await window.CrushPush.subscribe();

        if (result.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Notifications enabled!</div>';
            enableBtn.style.display = 'none';
            disableBtn.style.display = 'inline-block';
            testBtn.style.display = 'inline-block';

            // Send test notification
            await window.CrushPush.sendTest();
        } else {
            alert('Failed to enable notifications: ' + result.error);
            enableBtn.disabled = false;
            enableBtn.innerHTML = '<i class="bi bi-bell"></i> Enable Notifications';
        }
    });

    // Disable push notifications
    disableBtn.addEventListener('click', async function() {
        if (!confirm('Are you sure you want to disable push notifications?')) {
            return;
        }

        disableBtn.disabled = true;
        const result = await window.CrushPush.unsubscribe();

        if (result.success) {
            statusDiv.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-circle"></i> Notifications disabled</div>';
            disableBtn.style.display = 'none';
            testBtn.style.display = 'none';
            enableBtn.style.display = 'inline-block';
        } else {
            alert('Failed to disable notifications');
        }

        disableBtn.disabled = false;
    });

    // Test notification
    testBtn.addEventListener('click', async function() {
        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

        const result = await window.CrushPush.sendTest();

        if (result.success) {
            alert('Test notification sent! Check your notifications.');
        } else {
            alert('Failed to send test: ' + (result.error || 'Unknown error'));
        }

        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="bi bi-send"></i> Send Test';
    });
})();
</script>
{% endblock %}

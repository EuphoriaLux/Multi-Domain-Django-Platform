{% extends 'crush_lu/base.html' %}
{% load analytics %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Dashboard - Crush.lu" %}{% endblock %}
{% block meta_robots %}noindex, nofollow{% endblock %}

{% block content %}
{# Track dashboard view with profile status in Application Insights #}
{% if profile %}{% appinsights_event "dashboard_viewed" profile_approved=profile.is_approved %}{% else %}{% appinsights_event "dashboard_viewed" profile_approved="no_profile" %}{% endif %}
<div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6">
    <h2 class="text-2xl font-bold">{% blocktrans with name=user.first_name %}Welcome back, {{ name }}! üëã{% endblocktrans %}</h2>
    <a href="{% url 'crush_lu:account_settings' %}" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors w-full sm:w-auto">
        {% include "shared/icons/cog.html" with class="w-5 h-5" %} {% trans "Settings" %}
    </a>
</div>

{# Profile Completion Banner - encourages users to finish their profile #}
{% include "crush_lu/partials/profile_completion_banner.html" %}

{% if profile and not profile.phone_verified %}
<!-- Phone Verification Banner -->
<div class="alert alert-warning mb-6 flex-col sm:flex-row sm:justify-between gap-3" role="alert">
    <div class="flex items-center">
        {% include "shared/icons/exclamation-triangle.html" with class="w-5 h-5 mr-2 flex-shrink-0" %}
        <span><strong>{% trans "Phone verification required!" %}</strong> {% trans "Please verify your phone number to access all features." %}</span>
    </div>
    <a href="{% url 'crush_lu:verify_phone' %}" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 font-medium bg-yellow-500 text-white hover:bg-yellow-600 rounded-lg transition-colors w-full sm:w-auto">
        {% include "shared/icons/phone.html" with class="w-5 h-5" %} {% trans "Verify Now" %}
    </a>
</div>
{% endif %}

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Profile Status Card -->
    <div class="status-card">
        <div class="status-card-body">
            <h5 class="font-semibold text-lg mb-4">{% trans "Profile Status" %}</h5>
            {% if profile.is_approved %}
                <div class="alert alert-success">
                    {% trans "‚úÖ Your profile is approved and active!" %}
                </div>
            {% elif submission %}
                {% if submission.status == 'pending' %}
                    <div class="alert alert-warning">
                        {% blocktrans with coach=submission.coach %}‚è≥ Your profile is currently under review by {{ coach }}{% endblocktrans %}
                    </div>
                {% elif submission.status == 'revision' %}
                    <div class="alert alert-info">
                        {% trans "üìù Your coach has requested some revisions" %}
                        <p class="mt-2 mb-0"><strong>{% trans "Feedback:" %}</strong> {{ submission.feedback_to_user }}</p>
                    </div>
                {% elif submission.status == 'rejected' %}
                    <div class="alert alert-danger">
                        {% trans "‚ùå Your profile was not approved" %}
                        <p class="mt-2 mb-0"><strong>{% trans "Feedback:" %}</strong> {{ submission.feedback_to_user }}</p>
                    </div>
                {% endif %}
            {% endif %}

            <div class="mt-4">
                {% if profile.is_approved %}
                <a href="{% url 'crush_lu:edit_profile' %}" class="btn-crush-outline inline-flex items-center gap-2 text-sm">
                    {% include "shared/icons/pencil.html" with class="w-4 h-4" %}
                    {% trans "Edit Profile" %}
                </a>
                {% elif profile.completion_status == 'submitted' and submission and submission.status in 'pending,under_review' %}
                {# Profile under review - no edit allowed #}
                <span class="text-gray-400 dark:text-gray-500 text-sm">{% trans "Profile under review" %}</span>
                {% else %}
                {# Incomplete or needs revision - link to create_profile wizard #}
                <a href="{% url 'crush_lu:create_profile' %}" class="btn-crush-primary inline-flex items-center gap-2 text-sm">
                    {% include "shared/icons/arrow-right.html" with class="w-4 h-4" %}
                    {% trans "Complete Profile" %}
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- PWA Install Card -->
    <div class="status-card">
        <div class="status-card-body">
            {% if is_pwa_user %}
            <!-- User has installed PWA - show success and link to settings -->
            <h5 class="font-semibold text-lg mb-2">{% trans "üì≤ Crush.lu App" %}</h5>
            <div class="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 text-green-800 dark:text-green-300 rounded-lg p-4 mb-4">
                {% include "shared/icons/check-circle.html" with class="w-5 h-5 inline mr-1" %}
                <strong>{% trans "App installed!" %}</strong>
            </div>
            <p class="text-gray-500 dark:text-gray-400 mb-4">{% trans "Manage your push notifications in account settings." %}</p>
            <a href="{% url 'crush_lu:account_settings' %}#push-notifications" class="btn-crush-outline inline-flex items-center gap-2 text-sm">
                {% include "shared/icons/bell.html" with class="w-4 h-4" %} {% trans "Notification Settings" %}
            </a>
            {% else %}
            <!-- User hasn't installed PWA - show install prompt -->
            <div id="pwa-install-prompt">
                <h5 class="font-semibold text-lg mb-2">{% trans "üì≤ Install Crush.lu App" %}</h5>
                <p class="text-gray-500 dark:text-gray-400 mb-4">{% trans "Install our app to get push notifications about events, messages, and connections!" %}</p>

                <div id="pwa-install-container">
                    <button id="pwa-install-btn" class="hidden btn-crush-primary items-center gap-2 px-4 py-2">
                        {% include "shared/icons/arrow-down-tray.html" with class="w-4 h-4" %} {% trans "Install App" %}
                    </button>

                    <div id="pwa-installed-msg" class="hidden">
                        <div class="alert alert-success">
                            {% include "shared/icons/check-circle.html" with class="w-5 h-5 inline mr-1" %}
                            <strong>{% trans "App installed!" %}</strong>
                            <p class="mb-0 mt-2 text-sm">
                                {% trans "Refresh this page to enable push notifications." %}
                            </p>
                        </div>
                    </div>

                    <div id="pwa-install-instructions" class="hidden">
                        <div class="alert alert-info">
                            {% include "shared/icons/information-circle.html" with class="w-5 h-5 inline mr-1" %}
                            <strong>{% trans "How to install" %}</strong>
                            <p class="mb-0 mt-2 text-sm" id="install-instructions-text">
                                <!-- Instructions will be filled by JavaScript based on browser/device -->
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Membership Card - PWA Gated -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 h-full">
        <div class="p-6">
            <h5 class="font-semibold text-lg mb-2">{% trans "Membership Card" %}</h5>

            {% if is_pwa_user %}
            {# User has installed PWA - show full membership card #}
            <p class="text-gray-500 dark:text-gray-400 mb-4">{% trans "Save your Crush.lu membership card to your mobile wallet and share your referral link." %}</p>
            <div class="flex flex-col sm:flex-row gap-3 flex-wrap">
                {# Apple Wallet - Coming Soon #}
                <button type="button" disabled class="inline-flex items-center gap-2 text-sm px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500 rounded-lg cursor-not-allowed" title="{% trans 'Coming soon' %}">
                    {% include "shared/icons/arrow-down-tray.html" with class="w-4 h-4" %}
                    {% trans "Apple Wallet" %}
                    <span class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-0.5 rounded-full">{% trans "Soon" %}</span>
                </button>
                {% comment %}
                    Google Wallet Button - Using official Google brand assets
                    Brand guidelines: https://developers.google.com/wallet/generic/resources/brand-guidelines
                {% endcomment %}
                <button type="button" id="save-google-wallet-btn" data-jwt-url="/wallet/google/jwt/" class="google-wallet-btn p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    {% get_current_language as LANGUAGE_CODE %}
                    {% if LANGUAGE_CODE == 'de' %}
                    <img src="{% static 'crush_lu/img/wallet/de_add_to_google_wallet.svg' %}" alt="{% trans 'Add to Google Wallet' %}" class="h-12 w-auto" id="google-wallet-img">
                    {% elif LANGUAGE_CODE == 'fr' %}
                    <img src="{% static 'crush_lu/img/wallet/fr_add_to_google_wallet.svg' %}" alt="{% trans 'Add to Google Wallet' %}" class="h-12 w-auto" id="google-wallet-img">
                    {% else %}
                    <img src="{% static 'crush_lu/img/wallet/en_add_to_google_wallet.svg' %}" alt="{% trans 'Add to Google Wallet' %}" class="h-12 w-auto" id="google-wallet-img">
                    {% endif %}
                    <span id="google-wallet-loading" class="hidden text-sm text-gray-500 dark:text-gray-400">{% trans "Loading..." %}</span>
                </button>
            </div>
            <div class="mt-4">
                <button type="button" id="share-referral-btn" data-referral-url="{{ referral_url }}" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium border border-purple-300 dark:border-purple-600 text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded-lg transition-colors">
                    {% include "shared/icons/link.html" with class="w-4 h-4" %}
                    {% trans "Share Referral Link" %}
                </button>
                <p id="share-referral-status" class="text-sm text-green-600 dark:text-green-300 mt-2 hidden" role="status" aria-live="polite"></p>
            </div>

            {% else %}
            {# User has NOT installed PWA - show locked card with blur and CTA #}
            <div class="relative min-h-[140px]">
                {# Blurred preview #}
                <div class="filter blur-sm pointer-events-none select-none opacity-60" aria-hidden="true">
                    <p class="text-gray-500 dark:text-gray-400 mb-4">{% trans "Save your membership card to your wallet..." %}</p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <span class="btn-crush-primary inline-flex items-center gap-2 text-sm">{% trans "Add to Apple Wallet" %}</span>
                        <span class="bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg text-sm">{% trans "Add to Google Wallet" %}</span>
                    </div>
                    <div class="mt-3">
                        <span class="inline-flex items-center gap-2 px-4 py-2 text-sm border border-purple-300 dark:border-purple-600 text-purple-600 dark:text-purple-400 rounded-lg">{% trans "Share Referral Link" %}</span>
                    </div>
                </div>

                {# Lock overlay #}
                <div class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-lg">
                    <div class="text-center p-4">
                        {% include "shared/icons/lock-closed.html" with class="w-10 h-10 text-crush-purple mx-auto mb-3" %}
                        <h6 class="font-semibold text-gray-900 dark:text-white mb-2">{% trans "Install App to Unlock" %}</h6>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">{% trans "Get your membership card and exclusive features" %}</p>
                        <a href="{% url 'crush_lu:membership' %}" class="btn-crush-primary inline-flex items-center gap-2 px-4 py-2 text-sm">
                            {% include "shared/icons/arrow-down-tray.html" with class="w-4 h-4" %}
                            {% trans "Learn More" %}
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="grid grid-cols-1 gap-6 mb-6">
    <!-- Quick Stats Card -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 h-full">
        <div class="p-6">
            <h5 class="font-semibold text-lg mb-4">{% trans "Your Activity" %}</h5>
            <div class="grid grid-cols-3 text-center mt-4">
                <div>
                    <h3 class="text-3xl font-bold">{{ registrations|length }}</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-0">{% trans "Events" %}</p>
                </div>
                <div>
                    <h3 class="text-3xl font-bold">{{ profile.age|default:"‚Äî" }}</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-0">{% trans "Age" %}</p>
                </div>
                <div>
                    <a href="{% url 'crush_lu:my_connections' %}" class="no-underline">
                        <h3 class="text-3xl font-bold text-crush-purple">{{ connection_count|default:0 }}</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-0">{% trans "Connections" %}</p>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Events Section -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 mb-6">
    <div class="p-6">
        <h5 class="font-semibold text-lg mb-4">{% trans "Your Events" %}</h5>

        {% if registrations %}
            <div class="divide-y divide-gray-100 dark:divide-gray-700">
                {% for registration in registrations %}
                    <div class="py-4 first:pt-0 last:pb-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <h6 class="font-semibold mb-1">{{ registration.event.title }}</h6>
                                <p class="mb-1 text-gray-500 dark:text-gray-400 text-sm">
                                    üìÖ {{ registration.event.date_time|date:"D, M j, Y" }} at {{ registration.event.date_time|date:"g:i A" }}<br>
                                    üìç {{ registration.event.location }}
                                </p>
                            </div>
                            <div>
                                {% if registration.status == 'confirmed' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-full">{% trans "Confirmed" %}</span>
                                {% elif registration.status == 'waitlist' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 rounded-full">{% trans "Waitlist" %}</span>
                                {% elif registration.status == 'cancelled' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-full">{% trans "Cancelled" %}</span>
                                {% elif registration.status == 'attended' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full">{% trans "Attended" %}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-3 flex flex-col sm:flex-row gap-2">
                            <a href="{% url 'crush_lu:event_detail' registration.event.id %}" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium border border-purple-500 dark:border-purple-600 text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded-lg transition-colors">
                                {% trans "View Event" %}
                            </a>
                            {% if registration.status == 'attended' %}
                                <a href="{% url 'crush_lu:event_attendees' registration.event.id %}" class="btn-crush-primary inline-flex items-center justify-center gap-2 text-sm px-4 py-2.5">
                                    {% include "shared/icons/users.html" with class="w-4 h-4" %} {% trans "Make Connections" %}
                                </a>
                            {% elif registration.status == 'confirmed' or registration.status == 'waitlist' %}
                                <a href="{% url 'crush_lu:event_cancel' registration.event.id %}" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium border border-red-500 dark:border-red-600 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                                    {% trans "Cancel Registration" %}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-500 dark:text-gray-400 mb-4">{% trans "You haven't registered for any events yet." %}</p>
            <a href="{% url 'crush_lu:event_list' %}" class="btn-crush-primary inline-flex items-center justify-center gap-2 px-4 py-2">
                {% trans "Browse Events" %}
            </a>
        {% endif %}
    </div>
</div>

<!-- Call to Action -->
{% if profile.is_approved and not registrations %}
<div class="bg-gradient-to-br from-crush-purple/10 to-crush-pink/10 rounded-xl shadow-sm dark:shadow-gray-900/20">
    <div class="text-center p-10">
        <h4 class="text-xl font-bold mb-2">{% trans "Ready to Meet New People?" %}</h4>
        <p class="text-gray-500 dark:text-gray-400 mb-4">{% trans "Check out our upcoming events and start making connections!" %}</p>
        <a href="{% url 'crush_lu:event_list' %}" class="btn-crush-primary inline-flex items-center justify-center gap-2 px-6 py-3">
            {% trans "View Upcoming Events" %}
        </a>
    </div>
</div>
{% endif %}

{% trans "Crush.lu" as referral_share_title %}
{% trans "Join me on Crush.lu" as referral_share_text %}
{% trans "Referral link shared!" as referral_shared_message %}
{% trans "Referral link copied to clipboard." as referral_copied_message %}
{% trans "Unable to copy referral link." as referral_copy_failed_message %}
{% trans "Referral link unavailable." as referral_unavailable_message %}
<script nonce="{{ request.csp_nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
        const shareButton = document.getElementById('share-referral-btn');
        if (!shareButton) {
            return;
        }

        const statusElement = document.getElementById('share-referral-status');
        const referralUrl = shareButton.dataset.referralUrl;
        const shareTitle = "{{ referral_share_title|escapejs }}";
        const shareText = "{{ referral_share_text|escapejs }}";
        const sharedMessage = "{{ referral_shared_message|escapejs }}";
        const copiedMessage = "{{ referral_copied_message|escapejs }}";
        const copyFailedMessage = "{{ referral_copy_failed_message|escapejs }}";
        const unavailableMessage = "{{ referral_unavailable_message|escapejs }}";

        const setStatus = (message, isError = false) => {
            if (!statusElement) {
                return;
            }
            statusElement.textContent = message;
            statusElement.classList.remove('hidden');
            statusElement.classList.toggle('text-green-600', !isError);
            statusElement.classList.toggle('text-red-600', isError);
        };

        shareButton.addEventListener('click', async () => {
            if (!referralUrl) {
                setStatus(unavailableMessage, true);
                return;
            }

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: shareTitle,
                        text: shareText,
                        url: referralUrl,
                    });
                    setStatus(sharedMessage);
                    return;
                } catch (error) {
                    if (error && error.name === 'AbortError') {
                        return;
                    }
                }
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(referralUrl);
                    setStatus(copiedMessage);
                    return;
                } catch (error) {
                    // Fall back to legacy copy below.
                }
            }

            const tempInput = document.createElement('input');
            tempInput.value = referralUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            const copied = document.execCommand('copy');
            document.body.removeChild(tempInput);
            if (copied) {
                setStatus(copiedMessage);
            } else {
                setStatus(copyFailedMessage, true);
            }
        });

        // Google Wallet handler
        const googleWalletBtn = document.getElementById('save-google-wallet-btn');
        if (googleWalletBtn) {
            const googleWalletImg = document.getElementById('google-wallet-img');
            const googleWalletLoading = document.getElementById('google-wallet-loading');
            const jwtUrl = googleWalletBtn.dataset.jwtUrl;

            const setLoading = (isLoading) => {
                googleWalletBtn.disabled = isLoading;
                if (googleWalletImg) {
                    googleWalletImg.classList.toggle('hidden', isLoading);
                }
                if (googleWalletLoading) {
                    googleWalletLoading.classList.toggle('hidden', !isLoading);
                }
            };

            googleWalletBtn.addEventListener('click', async () => {
                setLoading(true);

                try {
                    const response = await fetch(jwtUrl);
                    const data = await response.json();

                    if (data.jwt) {
                        // Redirect to Google Wallet save URL
                        window.location.href = 'https://pay.google.com/gp/v/save/' + data.jwt;
                    } else if (data.error) {
                        alert(data.error);
                        setLoading(false);
                    }
                } catch (error) {
                    alert('{% trans "Failed to generate wallet pass. Please try again." %}');
                    setLoading(false);
                }
            });
        }
    });
</script>

<!-- Styles are in static/crush_lu/css/pages/dashboard.css -->
{% endblock %}

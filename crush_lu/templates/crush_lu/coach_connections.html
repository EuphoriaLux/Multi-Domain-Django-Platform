{% extends 'crush_lu/base.html' %}
{% load i18n %}

{% block title %}{% trans "Connections" %} - {% trans "Coach" %} - Crush.lu{% endblock %}
{% block meta_robots %}noindex, nofollow{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Breadcrumb -->
    <div class="mb-6">
        <a href="{% url 'crush_lu:coach_dashboard' %}" class="text-purple-600 dark:text-purple-400 hover:underline text-sm">
            &larr; {% trans "Back to Dashboard" %}
        </a>
    </div>

    <div class="mb-6">
        <h2 class="text-2xl font-bold dark:text-white">{% trans "Connection Management" %}</h2>
        <p class="text-gray-500 dark:text-gray-400">{% trans "Review, facilitate, and approve post-event connections between members." %}</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 p-4 text-center">
            <p class="text-2xl font-bold text-amber-600 dark:text-amber-400">{{ needs_review_count }}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{% trans "Needs Review" %}</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 p-4 text-center">
            <p class="text-2xl font-bold text-green-600 dark:text-green-400">{{ approved_count }}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{% trans "Coach Approved" %}</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 p-4 text-center">
            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ shared_count }}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{% trans "Contacts Shared" %}</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 p-4 mb-6">
        <div class="flex flex-wrap gap-3 items-center">
            <!-- Status Filter Tabs -->
            <div class="flex flex-wrap gap-2">
                <a href="?status=needs_review{% if event_id %}&event={{ event_id }}{% endif %}{% if mine_filter %}&mine=1{% endif %}"
                   class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg transition-colors {% if status_filter == 'needs_review' %}bg-amber-600 text-white{% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600{% endif %}">
                    {% trans "Needs Review" %}
                    {% if needs_review_count %}<span class="ml-1.5 inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1 text-xs rounded-full {% if status_filter == 'needs_review' %}bg-white/20{% else %}bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300{% endif %}">{{ needs_review_count }}</span>{% endif %}
                </a>
                <a href="?status=approved{% if event_id %}&event={{ event_id }}{% endif %}{% if mine_filter %}&mine=1{% endif %}"
                   class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg transition-colors {% if status_filter == 'approved' %}bg-green-600 text-white{% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600{% endif %}">
                    {% trans "Approved" %}
                </a>
                <a href="?status=shared{% if event_id %}&event={{ event_id }}{% endif %}{% if mine_filter %}&mine=1{% endif %}"
                   class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg transition-colors {% if status_filter == 'shared' %}bg-blue-600 text-white{% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600{% endif %}">
                    {% trans "Shared" %}
                </a>
                <a href="?status=all{% if event_id %}&event={{ event_id }}{% endif %}{% if mine_filter %}&mine=1{% endif %}"
                   class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-lg transition-colors {% if status_filter == 'all' %}bg-gray-600 text-white{% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600{% endif %}">
                    {% trans "All" %}
                </a>
            </div>

            <!-- Event Filter -->
            {% if events_with_connections %}
            <form method="get" class="ml-auto">
                <input type="hidden" name="status" value="{{ status_filter }}">
                {% if mine_filter %}<input type="hidden" name="mine" value="1">{% endif %}
                <select name="event"
                        class="text-sm border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-1.5 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                        x-data="autoSubmitSelect" @change="submit">
                    <option value="">{% trans "All Events" %}</option>
                    {% for ev in events_with_connections %}
                        <option value="{{ ev.id }}" {% if event_id == ev.id|stringformat:"d" %}selected{% endif %}>
                            {{ ev.title|truncatechars:30 }} ({{ ev.date_time|date:"M j" }})
                        </option>
                    {% endfor %}
                </select>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Connections List -->
    {% if page_obj %}
        <div class="space-y-4">
            {% for conn in page_obj %}
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 overflow-hidden hover:shadow-md dark:hover:shadow-gray-900/40 transition-shadow">
                    <div class="p-4 sm:p-5">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                            <!-- Connection Pair -->
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 flex-wrap">
                                    <!-- Requester -->
                                    <div class="flex items-center gap-2">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-crush-purple/20 to-crush-pink/20 dark:from-crush-purple/30 dark:to-crush-pink/30 flex items-center justify-center flex-shrink-0">
                                            <span class="text-sm font-semibold text-crush-purple dark:text-crush-pink">{{ conn.requester.first_name|first|upper }}</span>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-sm text-gray-900 dark:text-white">{{ conn.requester.get_full_name|truncatechars:20 }}</p>
                                            {% with profile=conn.requester.crushprofile %}
                                                {% if profile.gender == 'F' %}
                                                    <span class="text-pink-500 text-xs">&#9792;</span>
                                                {% elif profile.gender == 'M' %}
                                                    <span class="text-blue-500 text-xs">&#9794;</span>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    </div>

                                    <!-- Arrow -->
                                    <div class="flex items-center">
                                        {% if conn.is_mutual_annotated %}
                                            <span class="text-green-500 dark:text-green-400 text-lg" title="{% trans 'Mutual connection' %}">&harr;</span>
                                        {% else %}
                                            <span class="text-gray-400 dark:text-gray-500 text-lg">&rarr;</span>
                                        {% endif %}
                                    </div>

                                    <!-- Recipient -->
                                    <div class="flex items-center gap-2">
                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-crush-purple/20 to-crush-pink/20 dark:from-crush-purple/30 dark:to-crush-pink/30 flex items-center justify-center flex-shrink-0">
                                            <span class="text-sm font-semibold text-crush-purple dark:text-crush-pink">{{ conn.recipient.first_name|first|upper }}</span>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-sm text-gray-900 dark:text-white">{{ conn.recipient.get_full_name|truncatechars:20 }}</p>
                                            {% with profile=conn.recipient.crushprofile %}
                                                {% if profile.gender == 'F' %}
                                                    <span class="text-pink-500 text-xs">&#9792;</span>
                                                {% elif profile.gender == 'M' %}
                                                    <span class="text-blue-500 text-xs">&#9794;</span>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Event & Meta -->
                                <div class="mt-2 flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-gray-500 dark:text-gray-400">
                                    <span class="inline-flex items-center gap-1">
                                        {% include "shared/icons/calendar.html" with class="w-3 h-3" %}
                                        {{ conn.event.title|truncatechars:25 }} &middot; {{ conn.event.date_time|date:"M j" }}
                                    </span>
                                    <span>{{ conn.requested_at|timesince }} {% trans "ago" %}</span>
                                    {% if conn.assigned_coach %}
                                        <span class="inline-flex items-center gap-1">
                                            {% include "shared/icons/user.html" with class="w-3 h-3" %}
                                            {{ conn.assigned_coach.user.first_name }}
                                        </span>
                                    {% else %}
                                        <span class="text-amber-600 dark:text-amber-400 font-medium">{% trans "Unassigned" %}</span>
                                    {% endif %}
                                </div>

                                <!-- Note preview -->
                                {% if conn.requester_note %}
                                    <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400 italic truncate">"{{ conn.requester_note|truncatechars:80 }}"</p>
                                {% endif %}
                            </div>

                            <!-- Status & Action -->
                            <div class="flex items-center gap-3 sm:flex-col sm:items-end">
                                {% if conn.status == 'accepted' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300 rounded-full">{% trans "Needs Review" %}</span>
                                {% elif conn.status == 'coach_reviewing' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full">{% trans "Reviewing" %}</span>
                                {% elif conn.status == 'coach_approved' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 rounded-full">{% trans "Approved" %}</span>
                                {% elif conn.status == 'shared' %}
                                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold bg-indigo-100 dark:bg-indigo-900/30 text-indigo-800 dark:text-indigo-300 rounded-full">{% trans "Shared" %}</span>
                                {% endif %}

                                <a href="{% url 'crush_lu:coach_connection_review' conn.id %}" class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium bg-crush-purple text-white hover:bg-crush-purple/90 rounded-lg transition-colors">
                                    {% if conn.status == 'accepted' %}
                                        {% trans "Review" %}
                                    {% else %}
                                        {% trans "View" %}
                                    {% endif %}
                                    {% include "shared/icons/arrow-right.html" with class="w-4 h-4" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
            <div class="flex justify-center mt-8 gap-2">
                {% if page_obj.has_previous %}
                    <a href="?status={{ status_filter }}&page={{ page_obj.previous_page_number }}{% if event_id %}&event={{ event_id }}{% endif %}"
                       class="px-3 py-1.5 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                        &larr; {% trans "Previous" %}
                    </a>
                {% endif %}
                <span class="px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400">
                    {% blocktrans with current=page_obj.number total=page_obj.paginator.num_pages %}Page {{ current }} of {{ total }}{% endblocktrans %}
                </span>
                {% if page_obj.has_next %}
                    <a href="?status={{ status_filter }}&page={{ page_obj.next_page_number }}{% if event_id %}&event={{ event_id }}{% endif %}"
                       class="px-3 py-1.5 text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                        {% trans "Next" %} &rarr;
                    </a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-gray-900/20 p-8 text-center">
            <div class="text-gray-400 dark:text-gray-500 mb-3">
                {% include "shared/icons/heart.html" with class="w-10 h-10 mx-auto" %}
            </div>
            <p class="text-gray-500 dark:text-gray-400">
                {% if status_filter == 'needs_review' %}
                    {% trans "No connections need review right now." %}
                {% else %}
                    {% trans "No connections found matching the selected filters." %}
                {% endif %}
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}

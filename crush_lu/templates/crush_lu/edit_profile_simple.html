{% extends 'crush_lu/base.html' %}
{% load static %}

{% block title %}Edit Your Profile - Crush.lu{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h1 class="h3 mb-2">Edit Your Profile</h1>
                        <p class="text-muted">Update your information below</p>
                        {% if profile.is_approved %}
                            <span class="badge bg-success">Profile Approved</span>
                        {% endif %}
                    </div>

                    <form method="post"
                          enctype="multipart/form-data"
                          id="editProfileForm"
                          hx-post="{% url 'crush_lu:edit_profile' %}"
                          hx-target="#form-container"
                          hx-swap="innerHTML"
                          hx-indicator="#submit-indicator">
                        {% csrf_token %}

                        <div id="form-container">
                            {% include 'crush_lu/partials/edit_profile_form.html' %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Styles are in static/crush_lu/css/components/social-photos.css and profile-creation.css -->

{% endblock %}

{% block extra_js %}
<script src="{% static 'crush_lu/js/photo-preview.js' %}"></script>
<script>
// Character counters - reinitialize after HTMX swaps
function initCharacterCounters() {
    const bioField = document.getElementById('id_bio');
    const interestsField = document.getElementById('id_interests');

    if (bioField) {
        bioField.addEventListener('input', function() {
            const counter = document.getElementById('bioCounter');
            if (counter) counter.textContent = this.value.length;
        });
    }

    if (interestsField) {
        interestsField.addEventListener('input', function() {
            const counter = document.getElementById('interestsCounter');
            if (counter) counter.textContent = this.value.length;
        });
    }
}

// Initialize on page load
initCharacterCounters();

// Reinitialize after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'form-container') {
        initCharacterCounters();

        // Scroll to first error if present
        const firstError = event.detail.target.querySelector('.invalid-feedback');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Animate photo card after upload
    if (event.detail.target.id && event.detail.target.id.startsWith('photo-card-')) {
        const card = event.detail.target.querySelector('.photo-upload-card');
        if (card) {
            card.classList.add('tw-animate-pulse');
            setTimeout(() => card.classList.remove('tw-animate-pulse'), 1000);
        }
    }
});

// Social photo import functionality
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.import-social-photo-btn');
    if (!btn) return;

    e.preventDefault();

    const accountId = btn.dataset.accountId;
    const slot = parseInt(btn.dataset.slot);
    const originalContent = btn.innerHTML;
    const notification = document.getElementById('social-photo-notification');

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat tw-animate-spin"></i>';

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "crush_lu:import_social_photo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            social_account_id: parseInt(accountId),
            photo_slot: slot
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update photo preview
            const previewId = 'preview-photo-' + slot;
            const previewContainer = document.getElementById(previewId);

            if (previewContainer) {
                if (previewContainer.classList.contains('photo-placeholder')) {
                    // Replace placeholder with image
                    const img = document.createElement('img');
                    img.src = data.photo_url;
                    img.alt = 'Photo ' + slot;
                    img.className = 'photo-preview';
                    img.id = previewId;
                    previewContainer.parentNode.replaceChild(img, previewContainer);

                    // Add badge
                    const container = img.closest('.photo-preview-container');
                    if (container && !container.querySelector('.photo-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'photo-badge tw-bg-green-500';
                        badge.textContent = 'Imported';
                        container.appendChild(badge);
                    }
                } else {
                    // Update existing image
                    previewContainer.src = data.photo_url;
                    const badge = previewContainer.closest('.photo-preview-container')?.querySelector('.photo-badge');
                    if (badge) {
                        badge.textContent = 'Imported';
                        badge.classList.add('tw-bg-green-500');
                    }
                }
            }

            // Show success notification
            if (notification) {
                notification.className = 'mt-2 alert alert-success';
                notification.textContent = 'Photo imported successfully!';
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 3000);
            }
        } else {
            if (notification) {
                notification.className = 'mt-2 alert alert-danger';
                notification.textContent = data.error || 'Failed to import photo';
                notification.style.display = 'block';
            }
        }
    })
    .catch(error => {
        console.error('Error importing photo:', error);
        if (notification) {
            notification.className = 'mt-2 alert alert-danger';
            notification.textContent = 'Network error. Please try again.';
            notification.style.display = 'block';
        }
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    });
});
</script>
{% endblock %}

{% extends 'crush_lu/base.html' %}

{% block title %}Screening Calls - Coach Dashboard{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2 flex items-center gap-3">
            {% include "crush_lu/icons/phone.html" with class="w-5 h-5" %} Screening Calls Dashboard
        </h1>
        <p class="text-lg text-gray-500">Manage phone screenings for new profile submissions</p>
    </div>

    <!-- Pending Screening Calls -->
    <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-8">
        <div class="bg-amber-400 text-gray-900 px-6 py-4">
            <h4 class="font-semibold flex items-center gap-2">
                {% include "crush_lu/icons/hourglass.html" with class="w-5 h-5" %} Pending Screening Calls
                <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full">
                    {{ pending_calls|length }}
                </span>
            </h4>
        </div>
        <div class="p-6">
            {% if pending_calls %}
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">User</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Phone Number</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Profile Started</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Completion Status</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for profile in pending_calls %}
                            <tr x-data="{ showCompleteModal: false, openModal() { this.showCompleteModal = true }, closeModal() { this.showCompleteModal = false } }" class="border-b border-gray-100 hover:bg-gray-50">
                                <td class="py-4 px-2">
                                    <strong>{{ profile.user.first_name }} {{ profile.user.last_name }}</strong><br>
                                    <span class="text-sm text-gray-500">{{ profile.user.email }}</span>
                                </td>
                                <td class="py-4 px-2">
                                    <a href="tel:{{ profile.phone_number }}"
                                       class="inline-flex items-center gap-1 px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded-lg transition-colors">
                                        {% include "crush_lu/icons/phone.html" with class="w-5 h-5" %} {{ profile.phone_number }}
                                    </a>
                                </td>
                                <td class="py-4 px-2">
                                    <span class="text-sm text-gray-500">{{ profile.created_at|timesince }} ago</span>
                                </td>
                                <td class="py-4 px-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800">
                                        {{ profile.get_completion_status_display }}
                                    </span>
                                </td>
                                <td class="py-4 px-2">
                                    <button @click="openModal"
                                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold rounded-lg transition-colors">
                                        {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %} Mark Complete
                                    </button>

                                    <!-- Alpine.js Complete Modal -->
                                    <div x-show="showCompleteModal"
                                         x-cloak
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0"
                                         x-transition:enter-end="opacity-100"
                                         x-transition:leave="transition ease-in duration-150"
                                         x-transition:leave-start="opacity-100"
                                         x-transition:leave-end="opacity-0"
                                         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
                                         @keydown.escape.window="closeModal">
                                        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full"
                                             @click.outside="closeModal"
                                             x-transition:enter="transition ease-out duration-200"
                                             x-transition:enter-start="opacity-0 scale-95"
                                             x-transition:enter-end="opacity-100 scale-100"
                                             x-transition:leave="transition ease-in duration-150"
                                             x-transition:leave-start="opacity-100 scale-100"
                                             x-transition:leave-end="opacity-0 scale-95">
                                            <div class="flex items-center justify-between p-5 border-b border-gray-100">
                                                <h5 class="font-semibold">Complete Screening Call</h5>
                                                <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                                                    {% include "crush_lu/icons/x-mark.html" with class="w-5 h-5" %}
                                                </button>
                                            </div>
                                            <form method="post" action="{% url 'crush_lu:coach_mark_screening_complete' profile.id %}">
                                                {% csrf_token %}
                                                <div class="p-5">
                                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                                        <p class="text-sm text-blue-800">
                                                            <strong>User:</strong> {{ profile.user.first_name }} {{ profile.user.last_name }}<br>
                                                            <strong>Phone:</strong> {{ profile.phone_number }}<br>
                                                            <strong>Email:</strong> {{ profile.user.email }}
                                                        </p>
                                                    </div>

                                                    <div class="mb-4">
                                                        <label for="screening_notes{{ profile.id }}" class="block text-sm font-medium text-gray-700 mb-1">
                                                            Screening Notes *
                                                        </label>
                                                        <textarea name="screening_notes"
                                                                  id="screening_notes{{ profile.id }}"
                                                                  rows="5"
                                                                  placeholder="Notes from the call: impressions, concerns, next steps..."
                                                                  required
                                                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                                                        <p class="text-xs text-gray-500 mt-1">
                                                            Record your impressions and any important information from the call
                                                        </p>
                                                    </div>

                                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start gap-2">
                                                        {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5 text-green-600" %}
                                                        <p class="text-sm text-green-800">
                                                            By completing this screening, the user will be notified that their profile review is in progress.
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="flex justify-end gap-3 p-5 border-t border-gray-100">
                                                    <button type="button" @click="closeModal"
                                                            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                                        Cancel
                                                    </button>
                                                    <button type="submit"
                                                            class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors">
                                                        {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %} Mark as Complete
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-12">
                    {% include "crush_lu/icons/check-circle.html" with class="w-10 h-10 text-green-500" %}
                    <h4 class="text-xl font-semibold mt-4">All caught up!</h4>
                    <p class="text-gray-500">No pending screening calls at the moment.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Completed Screening Calls -->
    <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-8">
        <div class="bg-green-500 text-white px-6 py-4">
            <h4 class="font-semibold flex items-center gap-2">
                {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %} Recently Completed Screenings
            </h4>
        </div>
        <div class="p-6">
            {% if completed_calls %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">User</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Phone</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Completed</th>
                                <th class="text-left py-3 px-2 font-semibold text-gray-700">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for profile in completed_calls %}
                            <tr x-data="{ showNotesModal: false, openNotesModal() { this.showNotesModal = true }, closeNotesModal() { this.showNotesModal = false } }" class="border-b border-gray-100">
                                <td class="py-3 px-2">
                                    <strong>{{ profile.user.first_name }} {{ profile.user.last_name }}</strong>
                                </td>
                                <td class="py-3 px-2">{{ profile.phone_number }}</td>
                                <td class="py-3 px-2">
                                    <span class="text-gray-500">{{ profile.screening_call_scheduled|timesince }} ago</span>
                                </td>
                                <td class="py-3 px-2">
                                    <button @click="openNotesModal"
                                            class="inline-flex items-center gap-1 px-3 py-1.5 border border-gray-300 text-gray-700 text-sm rounded-lg hover:bg-gray-50 transition-colors">
                                        {% include "crush_lu/icons/eye.html" with class="w-5 h-5" %} View Notes
                                    </button>

                                    <!-- Alpine.js Notes Modal -->
                                    <div x-show="showNotesModal"
                                         x-cloak
                                         x-transition:enter="transition ease-out duration-200"
                                         x-transition:enter-start="opacity-0"
                                         x-transition:enter-end="opacity-100"
                                         x-transition:leave="transition ease-in duration-150"
                                         x-transition:leave-start="opacity-100"
                                         x-transition:leave-end="opacity-0"
                                         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
                                         @click.self="closeNotesModal"
                                         @keydown.escape.window="closeNotesModal">
                                        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full"
                                             x-transition:enter="transition ease-out duration-200"
                                             x-transition:enter-start="opacity-0 scale-95"
                                             x-transition:enter-end="opacity-100 scale-100"
                                             x-transition:leave="transition ease-in duration-150"
                                             x-transition:leave-start="opacity-100 scale-100"
                                             x-transition:leave-end="opacity-0 scale-95">
                                            <div class="flex items-center justify-between p-5 border-b border-gray-100">
                                                <h5 class="font-semibold">Screening Notes</h5>
                                                <button @click="closeNotesModal" class="text-gray-400 hover:text-gray-600">
                                                    {% include "crush_lu/icons/x-mark.html" with class="w-5 h-5" %}
                                                </button>
                                            </div>
                                            <div class="p-5">
                                                <p class="mb-2"><strong>User:</strong> {{ profile.user.first_name }} {{ profile.user.last_name }}</p>
                                                <p class="mb-4"><strong>Completed:</strong> {{ profile.screening_call_scheduled|date:"M d, Y g:i A" }}</p>
                                                <hr class="my-4 border-gray-200">
                                                <h6 class="font-semibold mb-2">Notes:</h6>
                                                <p class="text-gray-600">{{ profile.screening_notes|default:"No notes recorded"|linebreaks }}</p>
                                            </div>
                                            <div class="flex justify-end p-5 border-t border-gray-100">
                                                <button @click="closeNotesModal"
                                                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                                    Close
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-gray-500">No completed screenings yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Help Section -->
    <div class="bg-gray-50 rounded-2xl p-6">
        <h5 class="font-semibold flex items-center gap-2 mb-4">
            {% include "crush_lu/icons/information-circle.html" with class="w-5 h-5" %} Screening Call Guidelines
        </h5>
        <ul class="space-y-2 text-gray-700">
            <li class="flex items-start gap-2">
                <span class="text-purple-500 mt-1">•</span>
                Call users within 24-48 hours of profile creation
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-500 mt-1">•</span>
                Verify identity and explain the Crush.lu process
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-500 mt-1">•</span>
                Discuss their goals and expectations
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-500 mt-1">•</span>
                Educate about event-based connections and privacy
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-500 mt-1">•</span>
                Answer any questions they might have
            </li>
            <li class="flex items-start gap-2">
                <span class="text-purple-500 mt-1">•</span>
                Set expectations for profile approval timeline
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% extends 'crush_lu/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Create Your Profile - Crush.lu" %}{% endblock %}

{% block extra_css %}
<!-- intl-tel-input CSS with SRI for security -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.3/build/css/intlTelInput.css"
      integrity="sha384-BmygXwA0e3FeMPv5eKPsAq5JZncm8qElyxhy0qDhzY2cvcZTtTF0O3lG9n+M6JeL"
      crossorigin="anonymous">
<!-- Custom intl-tel-input styling for Crush.lu -->
<link rel="stylesheet" href="{% static 'crush_lu/css/components/intl-tel-input.css' %}">
<!-- Canton Map CSS -->
<link rel="stylesheet" href="{% static 'crush_lu/css/components/canton-map.css' %}">
{% endblock %}

{% block content %}
{# Main Alpine.js component for wizard state management #}
<div x-data="profileWizard"
     data-initial-step="{% if current_step %}{{ current_step }}{% else %}1{% endif %}"
     data-phone-verified="{{ profile.phone_verified|yesno:'true,false'|default:'false' }}"
     data-is-editing="{{ is_editing|lower|default:'false' }}"
     class="profile-creation-wrapper">
    <div class="container py-4 max-w-3xl mx-auto px-4">
        <!-- Progress Header -->
        <div class="text-center mb-8">
            <template x-if="isEditing">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-3">{% trans "Edit Your Profile" %}</h1>
                    <p class="text-gray-500">{% trans "Update your profile information" %}</p>
                </div>
            </template>
            <template x-if="isNotEditing">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold mb-3">{% trans "Welcome to Crush!" %}</h1>
                    <p class="text-gray-500">{% trans "Let's create your profile in just a few steps" %}</p>
                </div>
            </template>

            <!-- Progress Tracker -->
            <div class="flex items-center justify-center mt-6 gap-0">
                <!-- Step 1 -->
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold transition-all duration-300"
                         x-bind:class="step1CircleClass">
                        <span x-show="step1NotCompleted">1</span>
                        <svg x-show="step1Completed" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="text-xs mt-1" x-bind:class="step1TextClass">{% trans "Basic Info" %}</span>
                </div>

                <div class="w-12 h-1 mx-1" x-bind:class="step1ConnectorClass"></div>

                <!-- Step 2 -->
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold transition-all duration-300"
                         x-bind:class="step2CircleClass">
                        <span x-show="step2NotCompleted">2</span>
                        <svg x-show="step2Completed" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="text-xs mt-1" x-bind:class="step2TextClass">{% trans "About You" %}</span>
                </div>

                <div class="w-12 h-1 mx-1" x-bind:class="step2ConnectorClass"></div>

                <!-- Step 3 -->
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold transition-all duration-300"
                         x-bind:class="step3CircleClass">
                        <span x-show="step3NotCompleted">3</span>
                        <svg x-show="step3Completed" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <span class="text-xs mt-1" x-bind:class="step3TextClass">{% trans "Photos" %}</span>
                </div>

                <div class="w-12 h-1 mx-1" x-bind:class="step3ConnectorClass"></div>

                <!-- Step 4 -->
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold transition-all duration-300"
                         x-bind:class="step4CircleClass">
                        4
                    </div>
                    <span class="text-xs mt-1" x-bind:class="step4TextClass">{% trans "Review" %}</span>
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="profileForm" novalidate
              @submit.prevent="handleFormSubmit">
            {% csrf_token %}

            <!-- Global Form Errors (Alpine.js dismissible) -->
            {% if form.non_field_errors %}
            <div x-data="dismissible" x-show="show" x-transition
                 class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 relative">
                {{ form.non_field_errors }}
                <button type="button" @click="dismiss"
                        class="absolute top-2 right-2 text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            {% endif %}

            {% if form.errors %}
            <div x-data="dismissible" x-show="show" x-transition
                 class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 relative">
                <strong class="font-semibold">{% trans "Please fix the following errors:" %}</strong>
                <ul class="mt-2 list-disc list-inside">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>
                                {% if field == '__all__' %}{{ error }}{% else %}<strong>{{ field|title }}:</strong> {{ error }}{% endif %}
                            </li>
                        {% endfor %}
                    {% endfor %}
                </ul>
                <button type="button" @click="dismiss"
                        class="absolute top-2 right-2 text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            {% endif %}

            <!-- Auto-save Indicators (Fixed Position) -->
            <div class="fixed bottom-4 right-4 z-50 space-y-2">
                <!-- Saving Indicator -->
                <div x-show="showAutoSaving" x-transition
                     class="bg-white rounded-full shadow-lg px-4 py-2 flex items-center gap-2">
                    <svg class="w-4 h-4 animate-spin text-purple-500" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm text-gray-600">{% trans "Saving..." %}</span>
                </div>

                <!-- Saved Indicator -->
                <div x-show="showLastSaved" x-transition x-cloak
                     class="bg-white rounded-full shadow-lg px-4 py-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-sm text-gray-600" x-text="lastSavedMessage"></span>
                </div>
            </div>

            <!-- Step 1: Basic Information -->
            <div x-show="isStep1" x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-4"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 class="bg-white rounded-2xl shadow-lg p-6 md:p-8">

                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">üìã</div>
                    <h3 class="text-xl font-semibold">{% trans "Basic Information" %}</h3>
                    <p class="text-gray-500 text-sm">{% trans "Let's start with the essentials" %}</p>
                </div>

                <!-- Phone Number with Verification -->
                <div class="mb-6" id="phone-verification-container"
                     x-data="phoneVerificationComponent"
                     data-verified="{{ profile.phone_verified|yesno:'true,false'|default:'false' }}"
                     data-phone-input-id="{{ form.phone_number.id_for_label }}">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {% include "shared/icons/phone.html" with class="w-5 h-5" %} {% trans "Phone Number" %} *
                        <span x-show="notVerified"
                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 ml-2">
                            {% trans "Verification Required" %}
                        </span>
                        <span x-show="verified" x-cloak
                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 ml-2">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            {% trans "Verified" %}
                        </span>
                    </label>

                    {# Phone input and verify button - stacks on mobile for better UX #}
                    <div class="flex flex-col sm:flex-row gap-2">
                        <div class="flex-1">
                            <input type="tel"
                                   name="phone_number"
                                   id="{{ form.phone_number.id_for_label }}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                                   value="{% if form.phone_number.value %}{{ form.phone_number.value }}{% elif profile %}{{ profile.phone_number|default:'' }}{% endif %}"
                                   x-bind:readonly="verified"
                                   @input="onPhoneInput"
                                   required>
                        </div>
                        <button type="button"
                                x-show="notVerified"
                                @click="startVerification"
                                x-bind:disabled="cannotVerify"
                                class="w-full sm:w-auto px-5 py-3 bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold rounded-lg hover:from-purple-700 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex items-center justify-center gap-2 shadow-lg hover:shadow-xl hover:scale-105 disabled:hover:scale-100"
                                x-bind:class="verifyButtonPulseClass">
                            {% include "shared/icons/shield-check.html" with class="w-5 h-5" %}
                            <span>{% trans "Verify" %}</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        <!-- Change phone number button removed - users must contact support to change verified phone -->
                    </div>

                    <p class="text-sm mt-2" x-bind:class="phoneHintClass">
                        <span x-show="notVerified" class="inline-flex items-center gap-1">
                            <svg class="w-4 h-4 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                            </svg>
                            {% trans "Enter your number and click the Verify button to receive an SMS code" %}
                        </span>
                        <span x-show="verified" x-cloak class="inline-flex items-center gap-1">
                            {% include "shared/icons/information-circle.html" with class="w-4 h-4" %}
                            {% trans "Your phone number is verified" %}
                        </span>
                    </p>

                    {% if form.phone_number.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ form.phone_number.errors.0 }}</p>
                    {% endif %}

                    <!-- Error display -->
                    <div x-show="errorMessage" x-cloak
                         class="mt-2 bg-red-50 border border-red-200 text-red-700 px-3 py-2 rounded-lg text-sm"
                         x-text="errorMessage"></div>

                    <input type="hidden" name="phone_verified" x-bind:value="verifiedValue">
                </div>

                <!-- reCAPTCHA container -->
                <div id="recaptcha-container"></div>

                <!-- Date of Birth - Stepped Picker -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {% include "shared/icons/calendar.html" with class="w-5 h-5" %} {% trans "Date of Birth" %} *
                    </label>
                    <p class="text-sm text-gray-500 mb-3">{% trans "Must be 18+ to join" %}</p>

                    <div x-data="dobPicker"
                         data-months='[{"num":1,"name":"{% trans "January" %}"},{"num":2,"name":"{% trans "February" %}"},{"num":3,"name":"{% trans "March" %}"},{"num":4,"name":"{% trans "April" %}"},{"num":5,"name":"{% trans "May" %}"},{"num":6,"name":"{% trans "June" %}"},{"num":7,"name":"{% trans "July" %}"},{"num":8,"name":"{% trans "August" %}"},{"num":9,"name":"{% trans "September" %}"},{"num":10,"name":"{% trans "October" %}"},{"num":11,"name":"{% trans "November" %}"},{"num":12,"name":"{% trans "December" %}"}]'
                         class="bg-gray-50 rounded-xl p-4 border border-gray-200">

                        <!-- Progress Breadcrumb -->
                        <div class="flex flex-wrap items-center gap-2 mb-4 text-sm">
                            <button type="button" @click="goToStep1"
                                    class="inline-flex items-center gap-1 px-2 py-1 rounded-md transition-colors"
                                    x-bind:class="step1ButtonClass">
                                <span>{% trans "Age Range" %}</span>
                            </button>

                            <div x-show="showAgeRangeBreadcrumb" class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <button type="button" @click="goToStep2"
                                        class="inline-flex items-center gap-1 px-2 py-1 rounded-md transition-colors"
                                        x-bind:class="step2ButtonClass">
                                    <span x-text="yearBreadcrumbText"></span>
                                </button>
                            </div>

                            <div x-show="showYearBreadcrumb" class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <button type="button" @click="goToStep3"
                                        class="inline-flex items-center gap-1 px-2 py-1 rounded-md transition-colors"
                                        x-bind:class="step3ButtonClass">
                                    <span x-text="monthBreadcrumbText"></span>
                                </button>
                            </div>

                            <div x-show="showMonthBreadcrumb" class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <button type="button" @click="goToStep4"
                                        class="inline-flex items-center gap-1 px-2 py-1 rounded-md transition-colors"
                                        x-bind:class="step4ButtonClass">
                                    <span x-text="dayBreadcrumbText"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Step 1: Age Range Selection -->
                        <div x-show="isStep1" x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
                            <p class="text-sm text-gray-600 mb-4">{% trans "What's your age range?" %}</p>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3" data-dob-age-ranges>
                                <!-- Buttons rendered by JavaScript -->
                            </div>
                        </div>

                        <!-- Step 2: Year Selection -->
                        <div x-show="isStep2" x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-cloak>
                            <p class="text-sm text-gray-600 mb-3">{% trans "Select your birth year" %}</p>
                            <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2 max-h-48 overflow-y-auto pr-1" data-dob-years>
                                <!-- Buttons rendered by JavaScript -->
                            </div>
                        </div>

                        <!-- Step 3: Month Selection -->
                        <div x-show="isStep3" x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-cloak>
                            <p class="text-sm text-gray-600 mb-3">{% trans "Select your birth month" %}</p>
                            <div class="grid grid-cols-3 sm:grid-cols-4 gap-2" data-dob-months>
                                <!-- Buttons rendered by JavaScript -->
                            </div>
                        </div>

                        <!-- Step 4: Day Selection -->
                        <div x-show="isStep4" x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-cloak>
                            <p class="text-sm text-gray-600 mb-3">{% trans "Select your birth day" %}</p>
                            <div class="grid grid-cols-7 gap-1.5" data-dob-days>
                                <!-- Buttons rendered by JavaScript -->
                            </div>

                            <!-- Completion Summary -->
                            <div data-dob-summary class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-medium text-green-800" data-dob-formatted></p>
                                    <p class="text-sm text-green-600">{% trans "Date of birth selected" %}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden input for form submission -->
                        <input type="hidden" name="date_of_birth"
                               value="{% if form.date_of_birth.value %}{{ form.date_of_birth.value|date:'Y-m-d' }}{% elif profile.date_of_birth %}{{ profile.date_of_birth|date:'Y-m-d' }}{% endif %}">
                    </div>

                    {% if form.date_of_birth.errors %}
                        <p class="text-sm text-red-600 mt-2 flex items-center gap-1">
                            {% include "shared/icons/exclamation-circle.html" with class="w-4 h-4" %}
                            {{ form.date_of_birth.errors.0 }}
                        </p>
                    {% endif %}
                </div>

                <!-- Gender Selection -->
                <fieldset class="mb-6">
                    <legend class="block text-sm font-medium text-gray-700 mb-2">
                        <span aria-hidden="true">{% include "shared/icons/user.html" with class="w-5 h-5" %}</span> {% trans "Gender" %} <span class="text-red-500" aria-label="required">*</span>
                    </legend>
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <p class="text-sm text-gray-600 mb-4">{% trans "How do you identify?" %}</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" role="radiogroup" aria-label="{% trans "Select your gender" %}">
                            {% for value, label, icon in gender_choices %}
                            <label class="cursor-pointer block">
                                <input type="radio" name="gender" value="{{ value }}" class="peer hidden"
                                       {% if form.gender.value == value or profile.gender == value %}checked{% endif %} required>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">{{ icon }}</span>
                                    <span class="gender-label whitespace-nowrap">{{ label }}</span>
                                </div>
                            </label>
                            {% empty %}
                            <!-- Fallback if gender_choices not provided -->
                            <label class="cursor-pointer block">
                                <input type="radio" name="gender" value="M" class="peer hidden"
                                       {% if form.gender.value == 'M' or profile.gender == 'M' %}checked{% endif %} required>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üë®</span>
                                    <span class="gender-label whitespace-nowrap">{% trans "Male" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="radio" name="gender" value="F" class="peer hidden"
                                       {% if form.gender.value == 'F' or profile.gender == 'F' %}checked{% endif %}>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üë©</span>
                                    <span class="gender-label whitespace-nowrap">{% trans "Female" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="radio" name="gender" value="NB" class="peer hidden"
                                       {% if form.gender.value == 'NB' or profile.gender == 'NB' %}checked{% endif %}>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üßë</span>
                                    <span class="gender-label whitespace-nowrap">{% trans "Non-binary" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="radio" name="gender" value="O" class="peer hidden"
                                       {% if form.gender.value == 'O' or profile.gender == 'O' %}checked{% endif %}>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">‚ú®</span>
                                    <span class="gender-label whitespace-nowrap">{% trans "Other" %}</span>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% if form.gender.errors %}
                        <p class="text-sm text-red-600 mt-2 flex items-center gap-1" role="alert">
                            {% include "shared/icons/exclamation-circle.html" with class="w-4 h-4" %}
                            {{ form.gender.errors.0 }}
                        </p>
                    {% endif %}
                </fieldset>

                <!-- Location (Canton Map) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {% include "shared/icons/map-pin.html" with class="w-5 h-5" %} {% trans "Location in Luxembourg" %} *
                    </label>
                    <p class="text-sm text-gray-500 mb-2">{% trans "Click the map or use the dropdown to select your region" %}</p>

                    <div x-data="cantonMap"
                         data-initial-value="{{ form.location.value|default:profile.location|default:'' }}"
                         data-initial-name="{% if form.location.value %}{{ form.location.value }}{% elif profile.location %}{{ profile.get_location_display }}{% endif %}"
                         data-placeholder="{% trans "Click the map to select your region" %}"
                         class="canton-map-container {% if form.location.errors %}has-error{% endif %}">

                        <!-- Selection Display -->
                        <div class="canton-map-selection-display"
                             x-bind:class="selectedClass">
                            <span class="canton-map-selection-label" x-text="selectionLabel"></span>
                            <span class="canton-map-hover-label" x-show="isHovering" x-text="hoverLabel"></span>
                        </div>

                        <!-- SVG Map -->
                        <div class="canton-map-wrapper">
                            {% include "crush_lu/partials/canton_map_svg.html" %}
                        </div>

                        <!-- Hidden form field (synced by Alpine component) -->
                        {{ form.location }}

                        <!-- Fallback Dropdown (Accessibility) -->
                        <div class="canton-map-fallback">
                            <button type="button"
                                    @click="toggleFallbackDropdown"
                                    class="canton-map-fallback-toggle">
                                {% include "shared/icons/list-bullet.html" with class="w-4 h-4" %}
                                {% trans "Can't use the map? Select from list" %}
                            </button>
                            <div x-show="fallbackDropdownVisible" x-transition class="canton-map-fallback-dropdown">
                                <select @change="handleFallbackSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="">{% trans "Select your region..." %}</option>
                                    <optgroup label="{% trans "Luxembourg Cantons" %}">
                                        <option value="canton-capellen">{% trans "Capellen" %}</option>
                                        <option value="canton-clervaux">{% trans "Clervaux" %}</option>
                                        <option value="canton-diekirch">{% trans "Diekirch" %}</option>
                                        <option value="canton-echternach">{% trans "Echternach" %}</option>
                                        <option value="canton-esch">{% trans "Esch-sur-Alzette" %}</option>
                                        <option value="canton-grevenmacher">{% trans "Grevenmacher" %}</option>
                                        <option value="canton-luxembourg">{% trans "Luxembourg" %}</option>
                                        <option value="canton-mersch">{% trans "Mersch" %}</option>
                                        <option value="canton-redange">{% trans "Redange" %}</option>
                                        <option value="canton-remich">{% trans "Remich" %}</option>
                                        <option value="canton-vianden">{% trans "Vianden" %}</option>
                                        <option value="canton-wiltz">{% trans "Wiltz" %}</option>
                                    </optgroup>
                                    <optgroup label="{% trans "Border Regions" %}">
                                        <option value="border-belgium">{% trans "Belgium (Arlon/Virton area)" %}</option>
                                        <option value="border-germany">{% trans "Germany (Trier/Saarland area)" %}</option>
                                        <option value="border-france">{% trans "France (Thionville/Metz area)" %}</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>

                    {% if form.location.errors %}
                        <div class="canton-map-error mt-2 text-sm text-red-600 flex items-center gap-1">
                            {% include "shared/icons/exclamation-circle.html" with class="w-4 h-4" %}
                            {{ form.location.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Continue Button -->
                <button type="button"
                        @click="saveAndNextStep1"
                        x-bind:disabled="cannotContinueStep1"
                        class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold
                               hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed
                               transition-all duration-300 flex items-center justify-center gap-2"
                        id="step1-continue-btn">
                    <template x-if="isNotSaving">
                        <span class="flex items-center gap-2">
                            {% trans "Continue" %}
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </span>
                    </template>
                    <template x-if="isSavingStep">
                        <span class="flex items-center gap-2">
                            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            {% trans "Saving..." %}
                        </span>
                    </template>
                </button>

                <!-- Save Error Display -->
                <div x-show="hasSaveError" x-cloak
                     class="mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span x-text="saveError"></span>
                    <button type="button" @click="clearSaveError" class="ml-auto text-red-500 hover:text-red-700">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>

                <!-- Warning when phone not verified -->
                <div x-show="notPhoneVerified" x-cloak
                     class="mt-4 bg-amber-50 border border-amber-200 text-amber-800 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    {% trans "Please verify your phone number to continue." %}
                </div>
            </div>

            <!-- Step 2: About You -->
            <div x-show="isStep2" x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-4"
                 x-transition:enter-end="opacity-100 transform translate-x-0" x-cloak
                 class="bg-white rounded-2xl shadow-lg p-6 md:p-8">

                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">‚úçÔ∏è</div>
                    <h3 class="text-xl font-semibold">{% trans "About You" %}</h3>
                    <p class="text-gray-500 text-sm">{% trans "Share what makes you unique (optional)" %}</p>
                </div>

                <!-- Bio -->
                <div class="mb-6" x-data="charCounter" data-initial-count="{% if form.bio.value %}{{ form.bio.value|length }}{% else %}{{ profile.bio|length|default:0 }}{% endif %}" data-max-length="500">
                    <label for="{{ form.bio.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {% include "shared/icons/chat-bubble-left.html" with class="w-5 h-5" %} {% trans "Bio" %}
                        <span class="text-xs text-gray-400 font-normal ml-1">{% trans "Optional" %}</span>
                    </label>
                    <textarea name="bio"
                              id="{{ form.bio.id_for_label }}"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition resize-none"
                              rows="4"
                              maxlength="500"
                              @input="updateCount"
                              placeholder="{% trans "Tell us about yourself... What do you love? What makes you smile?" %}">{{ form.bio.value|default:profile.bio|default:"" }}</textarea>
                    <div class="text-right text-sm text-gray-400 mt-1">
                        <span x-text="charCount"></span>/500 {% trans "characters" %}
                    </div>
                    {% if form.bio.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ form.bio.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Interest Categories -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        {% include "shared/icons/star.html" with class="w-5 h-5" %} {% trans "Interest Categories" %}
                        <span class="text-xs text-gray-400 font-normal ml-1">{% trans "Optional" %}</span>
                    </label>
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <p class="text-sm text-gray-600 mb-4">{% trans "Select all that apply" %}</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                            <label class="cursor-pointer block">
                                <input type="checkbox" name="interest_category" value="sports" class="peer hidden">
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">‚öΩ</span>
                                    <span class="whitespace-nowrap text-xs">{% trans "Sports" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="checkbox" name="interest_category" value="arts" class="peer hidden">
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üé®</span>
                                    <span class="whitespace-nowrap text-xs">{% trans "Arts" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="checkbox" name="interest_category" value="food" class="peer hidden">
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üç∑</span>
                                    <span class="whitespace-nowrap text-xs">{% trans "Food" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="checkbox" name="interest_category" value="outdoors" class="peer hidden">
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üèîÔ∏è</span>
                                    <span class="whitespace-nowrap text-xs">{% trans "Outdoors" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="checkbox" name="interest_category" value="business" class="peer hidden">
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üíº</span>
                                    <span class="whitespace-nowrap text-xs">{% trans "Business" %}</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Custom Interests -->
                <div class="mb-6" x-data="charCounter" data-initial-count="{% if form.interests.value %}{{ form.interests.value|length }}{% else %}{{ profile.interests|length|default:0 }}{% endif %}" data-max-length="300">
                    <label for="{{ form.interests.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {% include "shared/icons/pencil.html" with class="w-5 h-5" %} {% trans "Or write your own interests" %}
                    </label>
                    <textarea name="interests"
                              id="{{ form.interests.id_for_label }}"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition resize-none"
                              rows="2"
                              maxlength="300"
                              @input="updateCount"
                              placeholder="{% trans "e.g., hiking, photography, cooking..." %}">{{ form.interests.value|default:profile.interests|default:"" }}</textarea>
                    <div class="text-right text-sm text-gray-400 mt-1">
                        <span x-text="charCount"></span>/300 {% trans "characters" %}
                    </div>
                </div>

                <!-- Looking For -->
                <fieldset class="mb-6">
                    <legend class="block text-sm font-medium text-gray-700 mb-2">
                        <span aria-hidden="true">{% include "shared/icons/heart.html" with class="w-5 h-5" %}</span> {% trans "What are you looking for?" %} <span class="text-red-500" aria-label="required">*</span>
                    </legend>
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <p class="text-sm text-gray-600 mb-4">{% trans "What brings you here?" %}</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3" role="radiogroup" aria-label="{% trans "Select what you are looking for" %}">
                            <label class="cursor-pointer block">
                                <input type="radio" name="looking_for" value="friends" class="peer hidden"
                                       {% if form.looking_for.value == 'friends' or profile.looking_for == 'friends' %}checked{% endif %} required>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üëã</span>
                                    <span class="whitespace-nowrap">{% trans "Friends" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="radio" name="looking_for" value="dating" class="peer hidden"
                                       {% if form.looking_for.value == 'dating' or profile.looking_for == 'dating' %}checked{% endif %}>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üíï</span>
                                    <span class="whitespace-nowrap">{% trans "Dating" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="radio" name="looking_for" value="both" class="peer hidden"
                                       {% if form.looking_for.value == 'both' or profile.looking_for == 'both' %}checked{% endif %}>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">üåü</span>
                                    <span class="whitespace-nowrap">{% trans "Both" %}</span>
                                </div>
                            </label>
                            <label class="cursor-pointer block">
                                <input type="radio" name="looking_for" value="networking" class="peer hidden"
                                       {% if form.looking_for.value == 'networking' or profile.looking_for == 'networking' %}checked{% endif %}>
                                <div class="w-full h-full min-h-[3.5rem] flex items-center justify-center gap-2 px-3 py-3 rounded-xl text-sm font-medium border-2 transition-all duration-200 hover:scale-105
                                            border-gray-200 bg-white text-gray-700 hover:border-purple-300 hover:bg-purple-50
                                            peer-checked:border-purple-500 peer-checked:bg-purple-100 peer-checked:text-purple-700">
                                    <span class="text-xl flex-shrink-0">ü§ù</span>
                                    <span class="whitespace-nowrap">{% trans "Networking" %}</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    {% if form.looking_for.errors %}
                        <p class="text-sm text-red-600 mt-2 flex items-center gap-1" role="alert">
                            {% include "shared/icons/exclamation-circle.html" with class="w-4 h-4" %}
                            {{ form.looking_for.errors.0 }}
                        </p>
                    {% endif %}
                </fieldset>

                <!-- Navigation Buttons -->
                <div class="flex gap-4 mt-6">
                    <button type="button" @click="prevStep"
                            x-bind:disabled="isSavingStep"
                            class="flex-1 py-4 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold
                                   hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {% trans "Back" %}
                    </button>
                    <button type="button" @click="saveAndNextStep2"
                            x-bind:disabled="isSavingStep"
                            class="flex-1 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold
                                   hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2">
                        <template x-if="isNotSaving">
                            <span class="flex items-center gap-2">
                                {% trans "Continue" %}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </span>
                        </template>
                        <template x-if="isSavingStep">
                            <span class="flex items-center gap-2">
                                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                {% trans "Saving..." %}
                            </span>
                        </template>
                    </button>
                </div>

                <!-- Save Error Display -->
                <div x-show="hasSaveError" x-cloak
                     class="mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span x-text="saveError"></span>
                    <button type="button" @click="clearSaveError" class="ml-auto text-red-500 hover:text-red-700">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Step 3: Photos -->
            <div x-show="isStep3" x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-4"
                 x-transition:enter-end="opacity-100 transform translate-x-0" x-cloak
                 class="bg-white rounded-2xl shadow-lg p-6 md:p-8">

                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">üì∏</div>
                    <h3 class="text-xl font-semibold">{% trans "Add Photos" %}</h3>
                    <p class="text-gray-500 text-sm">{% trans "Upload at least one photo (optional but recommended)" %}</p>
                </div>

                <!-- Photo Upload Grid - smaller gap on mobile for better fit -->
                <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-6"
                     x-data="photoUpload"
                     data-photo-1-exists="{{ profile.photo_1|yesno:'true,false' }}"
                     data-photo-1-url="{% if profile.photo_1 %}{{ profile.photo_1.url }}{% endif %}"
                     data-photo-2-exists="{{ profile.photo_2|yesno:'true,false' }}"
                     data-photo-2-url="{% if profile.photo_2 %}{{ profile.photo_2.url }}{% endif %}"
                     data-photo-3-exists="{{ profile.photo_3|yesno:'true,false' }}"
                     data-photo-3-url="{% if profile.photo_3 %}{{ profile.photo_3.url }}{% endif %}">
                    <!-- Photo 1 -->
                    <div class="relative aspect-square">
                        <input type="file" name="photo_1" id="photo1" accept="image/*" class="hidden"
                               @change="handleFile1">
                        <label for="photo1"
                               class="block w-full h-full border-2 border-dashed border-gray-300 rounded-xl
                                      cursor-pointer hover:border-purple-400 transition-all overflow-hidden
                                      bg-gray-50 hover:bg-purple-50">
                            <div x-show="photo1HasImage" class="w-full h-full">
                                <img x-bind:src="photo1Preview" class="w-full h-full object-cover" alt="Photo preview">
                            </div>
                            <div x-show="photo1NoImage" class="w-full h-full flex flex-col items-center justify-center text-gray-400">
                                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="text-sm">{% trans "Photo" %} 1</span>
                            </div>
                        </label>
                        <button type="button" x-show="photo1HasImage" @click="removePhoto1"
                                class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full
                                       flex items-center justify-center hover:bg-red-600 transition shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Photo 2 -->
                    <div class="relative aspect-square">
                        <input type="file" name="photo_2" id="photo2" accept="image/*" class="hidden"
                               @change="handleFile2">
                        <label for="photo2"
                               class="block w-full h-full border-2 border-dashed border-gray-300 rounded-xl
                                      cursor-pointer hover:border-purple-400 transition-all overflow-hidden
                                      bg-gray-50 hover:bg-purple-50">
                            <div x-show="photo2HasImage" class="w-full h-full">
                                <img x-bind:src="photo2Preview" class="w-full h-full object-cover" alt="Photo preview">
                            </div>
                            <div x-show="photo2NoImage" class="w-full h-full flex flex-col items-center justify-center text-gray-400">
                                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="text-sm">{% trans "Photo" %} 2</span>
                            </div>
                        </label>
                        <button type="button" x-show="photo2HasImage" @click="removePhoto2"
                                class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full
                                       flex items-center justify-center hover:bg-red-600 transition shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Photo 3 -->
                    <div class="relative aspect-square">
                        <input type="file" name="photo_3" id="photo3" accept="image/*" class="hidden"
                               @change="handleFile3">
                        <label for="photo3"
                               class="block w-full h-full border-2 border-dashed border-gray-300 rounded-xl
                                      cursor-pointer hover:border-purple-400 transition-all overflow-hidden
                                      bg-gray-50 hover:bg-purple-50">
                            <div x-show="photo3HasImage" class="w-full h-full">
                                <img x-bind:src="photo3Preview" class="w-full h-full object-cover" alt="Photo preview">
                            </div>
                            <div x-show="photo3NoImage" class="w-full h-full flex flex-col items-center justify-center text-gray-400">
                                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span class="text-sm">{% trans "Photo" %} 3</span>
                            </div>
                        </label>
                        <button type="button" x-show="photo3HasImage" @click="removePhoto3"
                                class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full
                                       flex items-center justify-center hover:bg-red-600 transition shadow-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Photo tip -->
                <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg text-sm mb-6 flex items-start gap-2">
                    <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <strong>{% trans "Tip:" %}</strong> {% trans "Use clear photos where your face is visible. Avoid group photos!" %}
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div class="border-t pt-6">
                    <h5 class="font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                        {% trans "Privacy Settings" %}
                    </h5>

                    <div class="space-y-4">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" name="show_full_name"
                                   {% if form.show_full_name.value or profile.show_full_name %}checked{% endif %}
                                   class="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <div>
                                <span class="font-medium">{% trans "Show my full name" %}</span>
                                <p class="text-sm text-gray-500">{% trans "Otherwise only your first name will be shown" %}</p>
                            </div>
                        </label>

                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" name="show_exact_age"
                                   {% if form.show_exact_age.value is None %}{% if profile.show_exact_age or not profile.id %}checked{% endif %}{% elif form.show_exact_age.value %}checked{% endif %}
                                   class="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <div>
                                <span class="font-medium">{% trans "Show my exact age" %}</span>
                                <p class="text-sm text-gray-500">{% trans "Otherwise show age range (e.g., 25-29)" %}</p>
                            </div>
                        </label>

                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" name="blur_photos"
                                   {% if form.blur_photos.value or profile.blur_photos %}checked{% endif %}
                                   class="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                            <div>
                                <span class="font-medium">{% trans "Blur my photos until mutual interest" %}</span>
                                <p class="text-sm text-gray-500">{% trans "Photos will only be visible after you both connect" %}</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Event Languages -->
                <div class="border-t pt-6 mt-6">
                    <h5 class="font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                        </svg>
                        {% trans "Languages for Events" %}
                    </h5>
                    <p class="text-sm text-gray-500 mb-4">{% trans "Which languages can you speak at in-person events?" %}</p>

                    <div class="flex flex-wrap gap-3">
                        <label class="cursor-pointer">
                            <input type="checkbox" name="event_languages" value="en" class="peer hidden"
                                   data-language="en"
                                   {% if form.event_languages.value and 'en' in form.event_languages.value %}checked{% elif not form.event_languages.value and 'en' in profile.event_languages %}checked{% endif %}>
                            <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium border-2 border-gray-200 bg-white transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 peer-checked:text-purple-700 hover:border-purple-300">
                                üá¨üáß {% trans "English" %}
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="event_languages" value="de" class="peer hidden"
                                   data-language="de"
                                   {% if form.event_languages.value and 'de' in form.event_languages.value %}checked{% elif not form.event_languages.value and 'de' in profile.event_languages %}checked{% endif %}>
                            <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium border-2 border-gray-200 bg-white transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 peer-checked:text-purple-700 hover:border-purple-300">
                                üá©üá™ {% trans "Deutsch" %}
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="event_languages" value="fr" class="peer hidden"
                                   data-language="fr"
                                   {% if form.event_languages.value and 'fr' in form.event_languages.value %}checked{% elif not form.event_languages.value and 'fr' in profile.event_languages %}checked{% endif %}>
                            <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium border-2 border-gray-200 bg-white transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 peer-checked:text-purple-700 hover:border-purple-300">
                                üá´üá∑ {% trans "Fran√ßais" %}
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="checkbox" name="event_languages" value="lu" class="peer hidden"
                                   data-language="lu"
                                   {% if form.event_languages.value and 'lu' in form.event_languages.value %}checked{% elif not form.event_languages.value and 'lu' in profile.event_languages %}checked{% endif %}>
                            <span class="inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium border-2 border-gray-200 bg-white transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 peer-checked:text-purple-700 hover:border-purple-300">
                                üá±üá∫ {% trans "L√´tzebuergesch" %}
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex gap-4 mt-6">
                    <button type="button" @click="prevStep"
                            x-bind:disabled="isSavingStep"
                            class="flex-1 py-4 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold
                                   hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {% trans "Back" %}
                    </button>
                    <button type="button" @click="saveAndNextStep3"
                            x-bind:disabled="isSavingStep"
                            class="flex-1 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold
                                   hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2">
                        <template x-if="isNotSaving">
                            <span class="flex items-center gap-2">
                                {% trans "Continue" %}
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </span>
                        </template>
                        <template x-if="isSavingStep">
                            <span class="flex items-center gap-2">
                                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                {% trans "Saving..." %}
                            </span>
                        </template>
                    </button>
                </div>

                <!-- Save Error Display -->
                <div x-show="hasSaveError" x-cloak
                     class="mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span x-text="saveError"></span>
                    <button type="button" @click="clearSaveError" class="ml-auto text-red-500 hover:text-red-700">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Step 4: Review & Submit -->
            <div x-show="isStep4" x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-4"
                 x-transition:enter-end="opacity-100 transform translate-x-0" x-cloak
                 class="bg-white rounded-2xl shadow-lg p-6 md:p-8">

                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">‚úÖ</div>
                    <h3 class="text-xl font-semibold">{% trans "Review & Submit" %}</h3>
                    <p class="text-gray-500 text-sm">{% trans "Almost done! Review your information" %}</p>
                </div>

                <!-- Review Summary -->
                <div class="bg-gray-50 rounded-xl p-4 mb-6 space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                            {% include "shared/icons/phone.html" with class="w-5 h-5 text-purple-600" %}
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">{% trans "Phone Number" %}</span>
                            <p class="font-medium" x-ref="reviewPhone">{% trans "Not provided" %}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                            {% include "shared/icons/calendar.html" with class="w-5 h-5 text-purple-600" %}
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">{% trans "Date of Birth" %}</span>
                            <p class="font-medium" x-ref="reviewDob">{% trans "Not provided" %}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                            {% include "shared/icons/user.html" with class="w-5 h-5 text-purple-600" %}
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">{% trans "Gender" %}</span>
                            <p class="font-medium" x-ref="reviewGender">{% trans "Not selected" %}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                            {% include "shared/icons/map-pin.html" with class="w-5 h-5 text-purple-600" %}
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">{% trans "Location" %}</span>
                            <p class="font-medium" x-ref="reviewLocation">{% trans "Not selected" %}</p>
                        </div>
                    </div>
                </div>

                <!-- What Happens Next -->
                <div class="mb-6">
                    <h5 class="font-semibold mb-4 flex items-center gap-2">
                        {% include "shared/icons/hourglass.html" with class="w-5 h-5 text-purple-600" %}
                        {% trans "What Happens Next?" %}
                    </h5>

                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-semibold">1</div>
                            <div>
                                <h6 class="font-medium">{% trans "Profile Submitted" %}</h6>
                                <p class="text-sm text-gray-500">{% trans "Your profile is sent to our Crush Coach team" %}</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-semibold">2</div>
                            <div>
                                <h6 class="font-medium">{% trans "Coach Review" %}</h6>
                                <p class="text-sm text-gray-500">{% trans "A coach will review your profile within 24-48 hours" %}</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-semibold">3</div>
                            <div>
                                <h6 class="font-medium">{% trans "Screening Call" %}</h6>
                                <p class="text-sm text-gray-500">{% trans "Your coach will call you to discuss your profile and goals" %}</p>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center flex-shrink-0 font-semibold">4</div>
                            <div>
                                <h6 class="font-medium">{% trans "Profile Approved" %}</h6>
                                <p class="text-sm text-gray-500">{% trans "You can start attending events and making connections!" %}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy note -->
                <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg text-sm mb-6 flex items-start gap-2">
                    <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <strong>{% trans "Privacy First:" %}</strong> {% trans "Your phone number will only be used by your coach for screening. It won't be shared with other members without your consent." %}
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex gap-4">
                    <button type="button" @click="prevStep"
                            class="flex-1 py-4 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold
                                   hover:bg-gray-50 transition-all duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        {% trans "Back" %}
                    </button>
                    <button type="submit"
                            :disabled="isSubmitting"
                            class="flex-1 py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold
                                   hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed
                                   transition-all duration-300 flex items-center justify-center gap-2">
                        <template x-if="isNotSubmitting">
                            <span class="flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% trans "Submit Profile" %}
                            </span>
                        </template>
                        <template x-if="isSubmitting">
                            <span class="flex items-center gap-2">
                                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                {% trans "Submitting..." %}
                            </span>
                        </template>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Phone Verification Modal (Alpine.js) -->
    <div x-data="phoneVerificationModal"
         x-show="isOpen"
         x-cloak
         @open-phone-modal.window="open"
         @close-phone-modal.window="close"
         class="fixed inset-0 z-50 overflow-y-auto"
         role="dialog"
         aria-modal="true">
        <!-- Backdrop -->
        <div x-show="isOpen"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black bg-opacity-50"></div>

        <!-- Modal Content -->
        <div class="flex min-h-screen items-center justify-center p-4">
            <div x-show="isOpen"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 @click.away="close"
                 class="relative bg-white rounded-2xl shadow-xl max-w-md w-full p-6">

                <!-- Close button -->
                <button @click="close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>

                <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    {% include "shared/icons/phone.html" with class="w-5 h-5" %} {% trans "Verify Your Phone" %}
                </h3>

                <!-- Step: Sending -->
                <div x-show="isSendingStep" class="text-center py-8">
                    <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-600">{% trans "Sending verification code..." %}</p>
                </div>

                <!-- Step: Enter Code -->
                <div x-show="isCodeStep" class="text-center">
                    <p class="mb-4">
                        {% trans "We sent a 6-digit code to" %}<br>
                        <strong x-text="maskedPhone"></strong>
                    </p>

                    <!-- OTP Inputs - CSP-compatible: using :value + @input with method names only (no $event) -->
                    <div class="flex justify-center gap-2 mb-4">
                        <input type="text" id="otp-0" x-ref="otp0" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0"
                               :value="otp0" @input="handleOtp0Input" @keydown.backspace="handleOtpBackspace" @paste="handleOtpPaste"
                               class="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                        <input type="text" id="otp-1" x-ref="otp1" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1"
                               :value="otp1" @input="handleOtp1Input" @keydown.backspace="handleOtpBackspace" @paste="handleOtpPaste"
                               class="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                        <input type="text" id="otp-2" x-ref="otp2" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2"
                               :value="otp2" @input="handleOtp2Input" @keydown.backspace="handleOtpBackspace" @paste="handleOtpPaste"
                               class="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                        <input type="text" id="otp-3" x-ref="otp3" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3"
                               :value="otp3" @input="handleOtp3Input" @keydown.backspace="handleOtpBackspace" @paste="handleOtpPaste"
                               class="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                        <input type="text" id="otp-4" x-ref="otp4" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4"
                               :value="otp4" @input="handleOtp4Input" @keydown.backspace="handleOtpBackspace" @paste="handleOtpPaste"
                               class="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                        <input type="text" id="otp-5" x-ref="otp5" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5"
                               :value="otp5" @input="handleOtp5Input" @keydown.backspace="handleOtpBackspace" @paste="handleOtpPaste"
                               class="w-12 h-14 text-center text-xl font-semibold border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                    </div>

                    <!-- Error message -->
                    <div x-show="hasError" class="bg-red-50 text-red-700 px-4 py-2 rounded-lg text-sm mb-4" x-text="error"></div>

                    <button @click="verifyCode"
                            x-bind:disabled="isCodeIncomplete"
                            class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold
                                   hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 transition">
                        {% trans "Verify Code" %}
                    </button>

                    <!-- Resend -->
                    <div class="mt-4 text-sm text-gray-500">
                        <span x-show="cannotResend">
                            {% trans "Resend available in" %} <span x-text="resendCountdown"></span>s
                        </span>
                        <button x-show="canResend"
                                @click="resendCode"
                                class="text-purple-600 hover:text-purple-800 font-medium">
                            {% trans "Resend Code" %}
                        </button>
                    </div>
                </div>

                <!-- Step: Verifying -->
                <div x-show="isVerifyingStep" class="text-center py-8">
                    <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-600">{% trans "Verifying your code..." %}</p>
                </div>

                <!-- Step: Success -->
                <div x-show="isSuccessStep" class="text-center py-8">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h4 class="text-xl font-semibold text-green-700 mb-2">{% trans "Phone Verified!" %}</h4>
                    <p class="text-gray-500">{% trans "Your phone number has been verified successfully." %}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Firebase SDK for phone authentication -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- intl-tel-input JS -->
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.3/build/js/intlTelInput.min.js"></script>

<!-- Firebase Configuration -->
<script nonce="{{ request.csp_nonce }}">
    window.FIREBASE_API_KEY = "{{ firebase_api_key }}";
    window.FIREBASE_AUTH_DOMAIN = "{{ firebase_auth_domain }}";
    window.FIREBASE_PROJECT_ID = "{{ firebase_project_id }}";
</script>

<!-- Phone verification module -->
<script src="{% static 'crush_lu/js/phone-verification.js' %}"></script>

<script nonce="{{ request.csp_nonce }}">
// Initialize global phone verification instance
// Alpine.js components are now defined in alpine-components.js
document.addEventListener('DOMContentLoaded', function() {
    window.phoneVerification = new PhoneVerification({
        phoneInputId: '{{ form.phone_number.id_for_label }}',
        verifyButtonId: 'verify-phone-btn',
        recaptchaContainerId: 'recaptcha-container',
        csrfToken: '{{ csrf_token }}',
        onCodeSent: function(phone) {
            // Find the modal element and call showCodeStep via Alpine
            var modal = document.querySelector('[x-data="phoneVerificationModal"]');
            if (modal && modal._x_dataStack && modal._x_dataStack[0]) {
                modal._x_dataStack[0].showCodeStep(phone);
            }
        },
        onVerified: function(phoneNumber) {
            window.dispatchEvent(new CustomEvent('phone-verified', { detail: phoneNumber }));
        },
        onError: function(error) {
            console.error('Phone verification error:', error);
        }
    });
});

// Listen for verification events
window.addEventListener('phone-verified', function(e) {
    var phoneInput = document.getElementById('{{ form.phone_number.id_for_label }}');
    if (phoneInput) {
        // Use intlTelInput's setNumber() if available, otherwise set directly
        // This ensures the full international number is properly handled
        if (window.itiInstance) {
            window.itiInstance.setNumber(e.detail);
        }
        // Also set the input value directly for form submission
        // (important when intlTelInput is destroyed or not managing the input)
        phoneInput.value = e.detail;
        phoneInput.readOnly = true;
    }

    // Update hidden input
    var hiddenInput = document.querySelector('[name="phone_verified"]');
    if (hiddenInput) hiddenInput.value = 'true';

    // Update continue button
    var continueBtn = document.getElementById('step1-continue-btn');
    if (continueBtn) continueBtn.disabled = false;
});
</script>
{% endblock %}

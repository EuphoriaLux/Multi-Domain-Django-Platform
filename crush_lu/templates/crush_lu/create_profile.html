{% extends 'crush_lu/base.html' %}
{% load static %}

{% block title %}Create Your Profile - Crush.lu{% endblock %}

{% block content %}
<div class="profile-creation-wrapper">
    <div class="container py-4">
        <!-- Progress Header -->
        <div class="progress-header text-center mb-5">
            {% if is_editing %}
                <h1 class="display-6 mb-3">Edit Your Profile üíï</h1>
                <p class="lead text-muted">Update your profile information</p>
            {% else %}
                <h1 class="display-6 mb-3">Welcome to Crush! üíï</h1>
                <p class="lead text-muted">Let's create your profile in just a few steps</p>
            {% endif %}

            <!-- Progress Tracker -->
            <div class="profile-progress-tracker mt-4">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Basic Info</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">About You</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Photos</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Review</div>
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="profileForm" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ form.non_field_errors }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}

            {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>‚ùå Please fix the following errors:</strong>
                    <ul class="mb-0 mt-2">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>
                                    {% if field == '__all__' %}
                                        {{ error }}
                                    {% else %}
                                        <strong>{{ field|title }}:</strong> {{ error }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endif %}

            <!-- Step 1: Basic Information -->
            <div class="form-step active" data-step="1">
                <div class="step-card">
                    <div class="card-icon">üìã</div>
                    <h3 class="card-title">Basic Information</h3>
                    <p class="card-subtitle">Let's start with the essentials</p>

                    <!-- Phone Number with Verification (REQUIRED) -->
                    <div class="form-group-modern mb-4 priority-field" id="phone-verification-container">
                        <label for="{{ form.phone_number.id_for_label }}">
                            <i class="bi bi-phone"></i> Phone Number *
                            <span class="badge bg-danger ms-2" id="phone-required-badge">Verification Required</span>
                            <span class="badge bg-success ms-2 d-none" id="phone-verified-badge">
                                <i class="bi bi-check-circle"></i> Verified
                            </span>
                        </label>

                        <div class="input-group input-group-lg">
                            <input type="tel"
                                   name="phone_number"
                                   id="{{ form.phone_number.id_for_label }}"
                                   class="form-control"
                                   placeholder="+352 XX XX XX XX"
                                   value="{{ profile.phone_number|default:'' }}"
                                   {% if profile.phone_verified %}readonly{% endif %}
                                   required>
                            <button type="button"
                                    class="btn btn-outline-primary {% if profile.phone_verified %}d-none{% endif %}"
                                    id="verify-phone-btn"
                                    {% if not profile.phone_number %}disabled{% endif %}>
                                <i class="bi bi-shield-check"></i> Verify
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary {% if not profile.phone_verified %}d-none{% endif %}"
                                    id="change-phone-btn">
                                <i class="bi bi-pencil"></i> Change
                            </button>
                        </div>

                        <small class="form-text">
                            <i class="bi bi-info-circle text-muted"></i>
                            You must verify your phone number before continuing.
                            We'll send you a 6-digit code via SMS.
                        </small>

                        {% if form.phone_number.errors %}
                            <div class="invalid-feedback d-block">{{ form.phone_number.errors.0 }}</div>
                        {% endif %}

                        <!-- Phone verification error messages -->
                        <div class="alert alert-danger mt-2 d-none" id="phone-verify-error"></div>

                        <!-- Hidden input to track verification status -->
                        <input type="hidden"
                               name="phone_verified"
                               id="phone_verified_input"
                               value="{% if profile.phone_verified %}true{% else %}false{% endif %}">
                    </div>

                    <!-- reCAPTCHA container (invisible) -->
                    <div id="recaptcha-container"></div>

                    <!-- Date of Birth -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.date_of_birth.id_for_label }}">
                            <i class="bi bi-calendar"></i> Date of Birth *
                        </label>
                        {{ form.date_of_birth }}
                        <small class="form-text">Must be 18+ to join</small>
                        {% if form.date_of_birth.errors %}
                            <div class="invalid-feedback d-block">{{ form.date_of_birth.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Gender Selection (Card-based) -->
                    <div class="form-group-modern mb-4">
                        <label class="mb-3">
                            <i class="bi bi-person"></i> Gender *
                        </label>
                        <div class="gender-card-selection">
                            <input type="radio" name="gender" value="M" id="gender_m" class="d-none gender-radio" {% if profile.gender == 'M' %}checked{% endif %} required>
                            <label for="gender_m" class="gender-card">
                                <div class="gender-icon">üë®</div>
                                <div class="gender-label">Male</div>
                            </label>

                            <input type="radio" name="gender" value="F" id="gender_f" class="d-none gender-radio" {% if profile.gender == 'F' %}checked{% endif %}>
                            <label for="gender_f" class="gender-card">
                                <div class="gender-icon">üë©</div>
                                <div class="gender-label">Female</div>
                            </label>

                            <input type="radio" name="gender" value="NB" id="gender_nb" class="d-none gender-radio" {% if profile.gender == 'NB' %}checked{% endif %}>
                            <label for="gender_nb" class="gender-card">
                                <div class="gender-icon">üßë</div>
                                <div class="gender-label">Non-binary</div>
                            </label>

                            <input type="radio" name="gender" value="O" id="gender_o" class="d-none gender-radio" {% if profile.gender == 'O' %}checked{% endif %}>
                            <label for="gender_o" class="gender-card">
                                <div class="gender-icon">‚ú®</div>
                                <div class="gender-label">Other</div>
                            </label>
                        </div>
                        {% if form.gender.errors %}
                            <div class="invalid-feedback d-block">{{ form.gender.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Location -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.location.id_for_label }}">
                            <i class="bi bi-geo-alt"></i> Location in Luxembourg *
                        </label>
                        {{ form.location }}
                        {% if form.location.errors %}
                            <div class="invalid-feedback d-block">{{ form.location.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <button type="button"
                            class="btn btn-crush-primary btn-lg w-100 mt-4 next-step"
                            id="step1-continue-btn"
                            {% if not profile.phone_verified %}disabled{% endif %}>
                        Continue <i class="bi bi-arrow-right"></i>
                    </button>

                    <!-- Warning when button is disabled -->
                    <div class="alert alert-warning mt-3 {% if profile.phone_verified %}d-none{% endif %}" id="phone-verify-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        Please verify your phone number to continue.
                    </div>
                </div>
            </div>

            <!-- Step 2: About You -->
            <div class="form-step" data-step="2">
                <div class="step-card">
                    <div class="card-icon">‚úçÔ∏è</div>
                    <h3 class="card-title">About You</h3>
                    <p class="card-subtitle">Share what makes you unique (optional)</p>

                    <!-- Bio (Optional) -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.bio.id_for_label }}">
                            <i class="bi bi-chat-heart"></i> Bio
                            <span class="badge bg-secondary ms-2">Optional</span>
                        </label>
                        <textarea name="bio"
                                  id="{{ form.bio.id_for_label }}"
                                  class="form-control"
                                  rows="4"
                                  maxlength="500"
                                  placeholder="Tell us about yourself... What do you love? What makes you smile? (Optional)">{{ profile.bio|default:"" }}</textarea>
                        <div class="char-counter">
                            <span id="bioCounter">{{ profile.bio|length|default:"0" }}</span>/500 characters
                        </div>
                        {% if form.bio.errors %}
                            <div class="invalid-feedback d-block">{{ form.bio.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Interest Categories (Card-based) -->
                    <div class="form-group-modern mb-4">
                        <label class="mb-3">
                            <i class="bi bi-star"></i> Interest Categories
                            <span class="badge bg-secondary ms-2">Optional</span>
                        </label>
                        <div class="interest-categories">
                            <input type="checkbox" name="interest_category" value="sports" id="interest_sports" class="d-none interest-checkbox">
                            <label for="interest_sports" class="interest-card">
                                <div class="interest-icon">‚öΩ</div>
                                <div class="interest-label">Sports & Fitness</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="arts" id="interest_arts" class="d-none interest-checkbox">
                            <label for="interest_arts" class="interest-card">
                                <div class="interest-icon">üé®</div>
                                <div class="interest-label">Arts & Culture</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="food" id="interest_food" class="d-none interest-checkbox">
                            <label for="interest_food" class="interest-card">
                                <div class="interest-icon">üç∑</div>
                                <div class="interest-label">Food & Wine</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="outdoors" id="interest_outdoors" class="d-none interest-checkbox">
                            <label for="interest_outdoors" class="interest-card">
                                <div class="interest-icon">üèîÔ∏è</div>
                                <div class="interest-label">Outdoors & Travel</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="business" id="interest_business" class="d-none interest-checkbox">
                            <label for="interest_business" class="interest-card">
                                <div class="interest-icon">üíº</div>
                                <div class="interest-label">Business & Tech</div>
                            </label>
                        </div>
                        <small class="form-text d-block mt-2">Select all that apply, or skip to continue</small>
                    </div>

                    <!-- Custom Interests Text (Optional) -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.interests.id_for_label }}">
                            <i class="bi bi-pencil"></i> Or write your own interests
                        </label>
                        <textarea name="interests"
                                  id="{{ form.interests.id_for_label }}"
                                  class="form-control"
                                  rows="2"
                                  maxlength="300"
                                  placeholder="e.g., hiking, photography, cooking...">{{ profile.interests|default:"" }}</textarea>
                        <div class="char-counter">
                            <span id="interestsCounter">{{ profile.interests|length|default:"0" }}</span>/300 characters
                        </div>
                        {% if form.interests.errors %}
                            <div class="invalid-feedback d-block">{{ form.interests.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Looking For (Card-based) -->
                    <div class="form-group-modern mb-4">
                        <label class="mb-3">
                            <i class="bi bi-heart"></i> What are you looking for? *
                        </label>
                        <div class="looking-for-cards">
                            <input type="radio" name="looking_for" value="friends" id="looking_friends" class="d-none looking-radio" {% if profile.looking_for == 'friends' %}checked{% endif %} required>
                            <label for="looking_friends" class="looking-card">
                                <div class="looking-icon">üëã</div>
                                <div class="looking-label">New Friends</div>
                            </label>

                            <input type="radio" name="looking_for" value="dating" id="looking_dating" class="d-none looking-radio" {% if profile.looking_for == 'dating' %}checked{% endif %}>
                            <label for="looking_dating" class="looking-card">
                                <div class="looking-icon">üíï</div>
                                <div class="looking-label">Dating</div>
                            </label>

                            <input type="radio" name="looking_for" value="both" id="looking_both" class="d-none looking-radio" {% if profile.looking_for == 'both' %}checked{% endif %}>
                            <label for="looking_both" class="looking-card">
                                <div class="looking-icon">üåü</div>
                                <div class="looking-label">Both</div>
                            </label>

                            <input type="radio" name="looking_for" value="networking" id="looking_networking" class="d-none looking-radio" {% if profile.looking_for == 'networking' %}checked{% endif %}>
                            <label for="looking_networking" class="looking-card">
                                <div class="looking-icon">ü§ù</div>
                                <div class="looking-label">Networking</div>
                            </label>
                        </div>
                        {% if form.looking_for.errors %}
                            <div class="invalid-feedback d-block">{{ form.looking_for.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="button-group mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-lg prev-step">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn btn-crush-primary btn-lg next-step">
                            Continue <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Photos -->
            <div class="form-step" data-step="3">
                <div class="step-card">
                    <div class="card-icon">üì∏</div>
                    <h3 class="card-title">Add Photos</h3>
                    <p class="card-subtitle">Upload at least one photo (optional but recommended)</p>

                    <!-- Social Photo Import Section -->
                    {% if social_photos %}
                    <div class="social-import-section mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h6 class="mb-0"><i class="bi bi-cloud-download me-2"></i>Import from Social Accounts</h6>
                            <span class="badge bg-success">Quick Import</span>
                        </div>
                        <p class="text-muted small mb-3">Use your existing profile photos from connected accounts</p>

                        <div class="social-photos-grid">
                            {% for photo in social_photos %}
                            <div class="social-photo-card">
                                <div class="provider-header">
                                    {% if photo.provider == 'facebook' %}
                                    <i class="fab fa-facebook text-primary"></i>
                                    {% elif photo.provider == 'google' %}
                                    <i class="fab fa-google text-danger"></i>
                                    {% elif photo.provider == 'microsoft' %}
                                    <i class="fab fa-microsoft text-info"></i>
                                    {% endif %}
                                    <span>{{ photo.provider_display }}</span>
                                </div>

                                {% if photo.available %}
                                <div class="social-photo-preview-wrapper">
                                    <img src="{{ photo.photo_url }}" alt="{{ photo.provider_display }} photo" class="social-photo-img">
                                </div>
                                <div class="import-buttons-row">
                                    <button type="button" class="btn btn-sm btn-crush-primary import-social-photo-btn"
                                            data-account-id="{{ photo.account_id }}"
                                            data-slot="1"
                                            title="Set as main photo">
                                        <i class="bi bi-star-fill"></i> Main
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary import-social-photo-btn"
                                            data-account-id="{{ photo.account_id }}"
                                            data-slot="2"
                                            title="Import as Photo 2">
                                        #2
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary import-social-photo-btn"
                                            data-account-id="{{ photo.account_id }}"
                                            data-slot="3"
                                            title="Import as Photo 3">
                                        #3
                                    </button>
                                </div>
                                {% else %}
                                <div class="no-photo-available">
                                    <i class="bi bi-image"></i>
                                    <span>{{ photo.reason|default:"No photo available" }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Import notification -->
                        <div id="social-photo-notification" class="mt-3" style="display: none;"></div>
                    </div>
                    <div class="divider-with-text mb-4">
                        <span>or upload your own photos</span>
                    </div>
                    {% endif %}

                    <div class="photo-upload-grid">
                        <!-- Photo 1 -->
                        <div class="photo-upload-box">
                            <input type="file" name="photo_1" id="photo1" accept="image/*" class="d-none photo-input">
                            <label for="photo1" class="photo-label">
                                <div class="photo-preview {% if profile.photo_1 %}has-image{% endif %}" id="preview1">
                                    {% if profile.photo_1 %}
                                        <img src="{{ profile.photo_1.url }}" alt="Photo 1">
                                    {% else %}
                                        <i class="bi bi-camera photo-icon"></i>
                                        <span class="photo-text">Add Photo 1</span>
                                    {% endif %}
                                </div>
                            </label>
                            <button type="button" class="btn btn-sm btn-danger remove-photo {% if not profile.photo_1 %}d-none{% endif %}" data-target="photo1">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>

                        <!-- Photo 2 -->
                        <div class="photo-upload-box">
                            <input type="file" name="photo_2" id="photo2" accept="image/*" class="d-none photo-input">
                            <label for="photo2" class="photo-label">
                                <div class="photo-preview {% if profile.photo_2 %}has-image{% endif %}" id="preview2">
                                    {% if profile.photo_2 %}
                                        <img src="{{ profile.photo_2.url }}" alt="Photo 2">
                                    {% else %}
                                        <i class="bi bi-camera photo-icon"></i>
                                        <span class="photo-text">Add Photo 2</span>
                                    {% endif %}
                                </div>
                            </label>
                            <button type="button" class="btn btn-sm btn-danger remove-photo {% if not profile.photo_2 %}d-none{% endif %}" data-target="photo2">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>

                        <!-- Photo 3 -->
                        <div class="photo-upload-box">
                            <input type="file" name="photo_3" id="photo3" accept="image/*" class="d-none photo-input">
                            <label for="photo3" class="photo-label">
                                <div class="photo-preview {% if profile.photo_3 %}has-image{% endif %}" id="preview3">
                                    {% if profile.photo_3 %}
                                        <img src="{{ profile.photo_3.url }}" alt="Photo 3">
                                    {% else %}
                                        <i class="bi bi-camera photo-icon"></i>
                                        <span class="photo-text">Add Photo 3</span>
                                    {% endif %}
                                </div>
                            </label>
                            <button type="button" class="btn btn-sm btn-danger remove-photo {% if not profile.photo_3 %}d-none{% endif %}" data-target="photo3">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>

                    {% if profile.photo_1 %}
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-check-circle"></i>
                        <strong>Great!</strong> We imported your photo from Facebook. You can keep it or upload a different one.
                    </div>
                    {% else %}
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>Tip:</strong> Use clear photos where your face is visible. Avoid group photos!
                    </div>
                    {% endif %}

                    <!-- Privacy Settings -->
                    <div class="privacy-section mt-4">
                        <h5 class="mb-3"><i class="bi bi-shield-lock"></i> Privacy Settings</h5>

                        <div class="privacy-toggle mb-3">
                            <input type="checkbox" name="show_full_name" id="{{ form.show_full_name.id_for_label }}" class="form-check-input">
                            <label for="{{ form.show_full_name.id_for_label }}" class="form-check-label">
                                Show my full name <small class="text-muted">(otherwise only first name)</small>
                            </label>
                        </div>

                        <div class="privacy-toggle mb-3">
                            <input type="checkbox" name="show_exact_age" id="{{ form.show_exact_age.id_for_label }}" class="form-check-input" checked>
                            <label for="{{ form.show_exact_age.id_for_label }}" class="form-check-label">
                                Show my exact age <small class="text-muted">(otherwise show age range)</small>
                            </label>
                        </div>

                        <div class="privacy-toggle mb-3">
                            <input type="checkbox" name="blur_photos" id="{{ form.blur_photos.id_for_label }}" class="form-check-input">
                            <label for="{{ form.blur_photos.id_for_label }}" class="form-check-label">
                                Blur my photos until mutual interest
                            </label>
                        </div>
                    </div>

                    <div class="button-group mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-lg prev-step">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <button type="button" class="btn btn-crush-primary btn-lg next-step">
                            Continue <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review & Submit -->
            <div class="form-step" data-step="4">
                <div class="step-card">
                    <div class="card-icon">‚úÖ</div>
                    <h3 class="card-title">Review & Submit</h3>
                    <p class="card-subtitle">Almost done! Review your information</p>

                    <div class="review-summary">
                        <div class="summary-item">
                            <i class="bi bi-phone text-primary"></i>
                            <div>
                                <strong>Phone Number:</strong>
                                <span id="review-phone">Not provided</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="bi bi-calendar text-primary"></i>
                            <div>
                                <strong>Date of Birth:</strong>
                                <span id="review-dob">Not provided</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="bi bi-person text-primary"></i>
                            <div>
                                <strong>Gender:</strong>
                                <span id="review-gender">Not selected</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="bi bi-geo-alt text-primary"></i>
                            <div>
                                <strong>Location:</strong>
                                <span id="review-location">Not selected</span>
                            </div>
                        </div>
                    </div>

                    <!-- What Happens Next -->
                    <div class="next-steps-info mt-4">
                        <h5 class="mb-3"><i class="bi bi-hourglass-split"></i> What Happens Next?</h5>

                        <div class="timeline-item">
                            <div class="timeline-marker">1</div>
                            <div class="timeline-content">
                                <strong>Profile Submitted</strong>
                                <p>Your profile is sent to our Crush Coach team</p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-marker">2</div>
                            <div class="timeline-content">
                                <strong>Coach Review</strong>
                                <p>A coach will review your profile within 24-48 hours</p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-marker">3</div>
                            <div class="timeline-content">
                                <strong>Screening Call</strong>
                                <p>Your coach will call you to discuss your profile and goals</p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-marker">4</div>
                            <div class="timeline-content">
                                <strong>Profile Approved</strong>
                                <p>You can start attending events and making connections!</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success mt-4">
                        <i class="bi bi-shield-check"></i>
                        <strong>Privacy First:</strong> Your phone number will only be used by your coach for screening. It won't be shared with other members without your consent.
                    </div>

                    <div class="button-group mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-lg prev-step">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <button type="submit" class="btn btn-crush-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Submit Profile
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Styles are in static/crush_lu/css/components/profile-creation.css and social-photos.css -->

<!-- Phone Verification Modal -->
<div class="modal fade" id="phoneVerifyModal" tabindex="-1" aria-labelledby="phoneVerifyModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="phoneVerifyModalLabel">
                    <i class="bi bi-phone"></i> Verify Your Phone
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Sending code -->
                <div id="verify-step-sending" class="text-center d-none">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Sending...</span>
                    </div>
                    <p>Sending verification code to your phone...</p>
                </div>

                <!-- Step 2: Enter code -->
                <div id="verify-step-code" class="d-none">
                    <p class="text-center mb-3">
                        We sent a 6-digit code to<br>
                        <strong id="verify-phone-display"></strong>
                    </p>

                    <div class="d-flex justify-content-center gap-2 mb-4">
                        <input type="text" class="form-control form-control-lg text-center otp-input"
                               maxlength="1" inputmode="numeric" pattern="[0-9]" style="width: 50px;">
                        <input type="text" class="form-control form-control-lg text-center otp-input"
                               maxlength="1" inputmode="numeric" pattern="[0-9]" style="width: 50px;">
                        <input type="text" class="form-control form-control-lg text-center otp-input"
                               maxlength="1" inputmode="numeric" pattern="[0-9]" style="width: 50px;">
                        <input type="text" class="form-control form-control-lg text-center otp-input"
                               maxlength="1" inputmode="numeric" pattern="[0-9]" style="width: 50px;">
                        <input type="text" class="form-control form-control-lg text-center otp-input"
                               maxlength="1" inputmode="numeric" pattern="[0-9]" style="width: 50px;">
                        <input type="text" class="form-control form-control-lg text-center otp-input"
                               maxlength="1" inputmode="numeric" pattern="[0-9]" style="width: 50px;">
                    </div>

                    <div class="alert alert-danger d-none" id="otp-error"></div>

                    <button type="button" class="btn btn-crush-primary w-100" id="verify-code-btn">
                        Verify Code
                    </button>

                    <div class="text-center mt-3">
                        <span class="text-muted" id="resend-timer">Resend available in <span id="resend-countdown">60</span>s</span>
                        <button type="button" class="btn btn-link d-none" id="resend-code-btn">
                            <i class="bi bi-arrow-repeat"></i> Resend Code
                        </button>
                    </div>
                </div>

                <!-- Step 3: Verifying -->
                <div id="verify-step-verifying" class="text-center d-none">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Verifying...</span>
                    </div>
                    <p>Verifying your code...</p>
                </div>

                <!-- Step 4: Success -->
                <div id="verify-step-success" class="text-center d-none">
                    <div class="text-success mb-3" style="font-size: 4rem;">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h5>Phone Verified!</h5>
                    <p class="text-muted">Your phone number has been verified successfully.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Firebase SDK for phone authentication -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<!-- Phone verification module -->
<script src="{% static 'crush_lu/js/phone-verification.js' %}"></script>

<script>
// Multi-step form management
{% if current_step %}
    // Resume from last completed step - move to NEXT step to continue
    const stepMap = {'not_started': 1, 'step1': 2, 'step2': 3, 'step3': 4, 'completed': 4, 'submitted': 4};
    let currentStep = stepMap['{{ current_step }}'] || 1;

    // Debug logging for troubleshooting
    console.log('Loading profile - completion_status:', '{{ current_step }}');
    console.log('Mapped to step:', currentStep);
{% else %}
    let currentStep = 1;
    console.log('Starting new profile at step 1');
{% endif %}
const totalSteps = 4;
const isEditing = {{ is_editing|lower|default:"false" }};
console.log('Editing mode:', isEditing, 'Has profile:', {% if profile %}true{% else %}false{% endif %});

// Character counters
document.getElementById('{{ form.bio.id_for_label }}')?.addEventListener('input', function() {
    document.getElementById('bioCounter').textContent = this.value.length;
});

document.getElementById('{{ form.interests.id_for_label }}')?.addEventListener('input', function() {
    document.getElementById('interestsCounter').textContent = this.value.length;
});

// Interest categories - combine checked categories with custom text
document.querySelectorAll('.interest-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateInterestsField();
    });
});

function updateInterestsField() {
    const selectedCategories = Array.from(document.querySelectorAll('.interest-checkbox:checked'))
        .map(cb => cb.nextElementSibling.querySelector('.interest-label').textContent);

    const interestsField = document.getElementById('{{ form.interests.id_for_label }}');
    const customText = interestsField.value.trim();

    // If user has custom text, don't override it - categories are supplementary
    // They will be combined during form submission
}

// Photo preview
document.querySelectorAll('.photo-input').forEach(input => {
    input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            const previewId = 'preview' + input.id.slice(-1);
            const preview = document.getElementById(previewId);
            const removeBtn = input.parentElement.querySelector('.remove-photo');

            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                preview.classList.add('has-image');
                removeBtn.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    });
});

// Remove photo
document.querySelectorAll('.remove-photo').forEach(btn => {
    btn.addEventListener('click', function() {
        const targetId = this.dataset.target;
        const input = document.getElementById(targetId);
        const previewId = 'preview' + targetId.slice(-1);
        const preview = document.getElementById(previewId);

        input.value = '';
        preview.innerHTML = `
            <i class="bi bi-camera photo-icon"></i>
            <span class="photo-text">Add Photo ${targetId.slice(-1)}</span>
        `;
        preview.classList.remove('has-image');
        this.classList.add('d-none');
    });
});

// Step navigation
function updateStep(newStep) {
    if (newStep < 1 || newStep > totalSteps) return;

    // Hide current step
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('active');
    document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');

    // Mark completed steps
    if (newStep > currentStep) {
        document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('completed');
    }

    // Show new step
    currentStep = newStep;
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
    document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Update review if on last step
    if (currentStep === 4) {
        updateReview();
    }
}

// Next step buttons
document.querySelectorAll('.next-step').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (validateCurrentStep()) {
            // Save data after each step
            let canProceed = true;

            if (currentStep === 1) {
                canProceed = await saveStep1();
            } else if (currentStep === 2) {
                canProceed = await saveStep2();
            }

            // Only advance to next step if save was successful
            if (canProceed) {
                updateStep(currentStep + 1);
            }
        }
    });
});

// Previous step buttons
document.querySelectorAll('.prev-step').forEach(btn => {
    btn.addEventListener('click', function() {
        updateStep(currentStep - 1);
    });
});

// Validation
function validateCurrentStep() {
    const currentStepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    const requiredFields = currentStepEl.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
        if (field.type === 'radio') {
            const radioGroup = currentStepEl.querySelectorAll(`[name="${field.name}"]`);
            const isChecked = Array.from(radioGroup).some(radio => radio.checked);
            if (!isChecked) {
                isValid = false;
                alert('Please select an option for ' + field.name.replace(/_/g, ' '));
            }
        } else if (!field.value.trim()) {
            isValid = false;
            field.focus();
            alert('Please fill in all required fields');
            return false;
        }
    });

    return isValid;
}

// Update review summary
function updateReview() {
    const phoneNumber = document.querySelector('[name="phone_number"]').value || 'Not provided';
    const dob = document.querySelector('[name="date_of_birth"]').value || 'Not provided';
    const gender = document.querySelector('[name="gender"]:checked')?.nextElementSibling.querySelector('.gender-label')?.textContent || 'Not selected';
    const location = document.querySelector('[name="location"]').value || 'Not selected';

    document.getElementById('review-phone').textContent = phoneNumber;
    document.getElementById('review-dob').textContent = dob;
    document.getElementById('review-gender').textContent = gender;
    document.getElementById('review-location').textContent = location;
}

// Form submission - combine interests before submitting
document.getElementById('profileForm').addEventListener('submit', function(e) {
    // Combine selected interest categories with custom text
    const selectedCategories = Array.from(document.querySelectorAll('.interest-checkbox:checked'))
        .map(cb => cb.nextElementSibling.querySelector('.interest-label').textContent);

    const customInterests = document.querySelector('[name="interests"]').value.trim();

    // Combine categories and custom interests
    let finalInterests = '';
    if (selectedCategories.length > 0) {
        finalInterests = selectedCategories.join(', ');
    }
    if (customInterests) {
        finalInterests = finalInterests ? `${finalInterests}, ${customInterests}` : customInterests;
    }

    // Update the interests field with combined value
    document.querySelector('[name="interests"]').value = finalInterests;

    // Only validate if we're NOT on the final review step (step 4)
    // Step 4 has no required fields, it's just a review
    if (currentStep !== 4 && !validateCurrentStep()) {
        e.preventDefault();
    }
});

// AJAX save functions
async function saveStep1() {
    const data = {
        phone_number: document.querySelector('[name="phone_number"]').value,
        date_of_birth: document.querySelector('[name="date_of_birth"]').value,
        gender: document.querySelector('[name="gender"]:checked')?.value,
        location: document.querySelector('[name="location"]').value
    };

    try {
        const response = await fetch('{% url "crush_lu:save_profile_step1" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            // Show success notification
            showNotification('‚úÖ Basic info saved! A coach will contact you soon.', 'success');

            // Mark step 1 as saved
            localStorage.setItem('crush_profile_step1_saved', 'true');
            return true;  // Success - allow advancing to next step
        } else {
            showNotification('‚ùå Error: ' + result.error, 'error');
            return false;  // Validation failed - stay on current step
        }
    } catch (error) {
        console.error('Error saving Step 1:', error);
        showNotification('‚ùå Network error. Please try again.', 'error');
        return false;  // Error - stay on current step
    }
}

async function saveStep2() {
    // Combine selected interest categories with custom text
    const selectedCategories = Array.from(document.querySelectorAll('.interest-checkbox:checked'))
        .map(cb => cb.nextElementSibling.querySelector('.interest-label').textContent);

    const customInterests = document.querySelector('[name="interests"]').value.trim();

    // Combine categories and custom interests
    let finalInterests = '';
    if (selectedCategories.length > 0) {
        finalInterests = selectedCategories.join(', ');
    }
    if (customInterests) {
        finalInterests = finalInterests ? `${finalInterests}, ${customInterests}` : customInterests;
    }

    const data = {
        bio: document.querySelector('[name="bio"]').value,
        interests: finalInterests,
        looking_for: document.querySelector('[name="looking_for"]:checked')?.value
    };

    try {
        const response = await fetch('{% url "crush_lu:save_profile_step2" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showNotification('‚úÖ About section saved!', 'success');
            return true;  // Success - allow advancing
        } else {
            showNotification('‚ùå Error: ' + (result.error || 'Failed to save'), 'error');
            return false;  // Error - stay on current step
        }
    } catch (error) {
        console.error('Error saving Step 2:', error);
        showNotification('‚ùå Network error. Please try again.', 'error');
        return false;  // Error - stay on current step
    }
}

// Notification system
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Initialize on page load
window.addEventListener('load', async function() {
    // If editing or resuming, mark previous steps as completed and show current step
    if (currentStep > 1) {
        // Mark all previous steps as completed
        for (let i = 1; i < currentStep; i++) {
            document.querySelector(`.progress-step[data-step="${i}"]`)?.classList.add('completed');
        }

        // Hide step 1 and show the current step
        document.querySelector(`.form-step[data-step="1"]`)?.classList.remove('active');
        document.querySelector(`.progress-step[data-step="1"]`)?.classList.remove('active');

        document.querySelector(`.form-step[data-step="${currentStep}"]`)?.classList.add('active');
        document.querySelector(`.progress-step[data-step="${currentStep}"]`)?.classList.add('active');

        showNotification(`üëã Welcome back! Continue with Step ${currentStep}.`, 'info');
    }

    // Check for profile progress (for new profiles)
    if (!isEditing) {
        try {
            const response = await fetch('{% url "crush_lu:get_profile_progress" %}');
            const progress = await response.json();

            if (progress.exists && progress.completion_status !== 'submitted' && currentStep === 1) {
                const stepNum = parseInt(progress.completion_status.replace('step', '')) || 1;
                if (stepNum > 1) {
                    showNotification(`üëã Welcome back! You can continue from Step ${stepNum}.`, 'info');
                }
            }
        } catch (error) {
            console.error('Error checking progress:', error);
        }
    }
});

function getStepNumber(status) {
    const statusMap = {
        'step1': 2,
        'step2': 3,
        'step3': 4,
        'completed': 4
    };
    return statusMap[status] || 1;
}

// Prevent double-submission of the form
const profileForm = document.getElementById('profileForm');
const submitButton = profileForm.querySelector('button[type="submit"]');
let isSubmitting = false;

profileForm.addEventListener('submit', function(e) {
    // Prevent double-click or multiple submissions
    if (isSubmitting) {
        e.preventDefault();
        console.log('‚ö†Ô∏è Duplicate submission prevented');
        return false;
    }

    // Mark as submitting
    isSubmitting = true;

    // Disable submit button and show loading state
    if (submitButton) {
        submitButton.disabled = true;
        const originalHTML = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="bi bi-hourglass-split spinner-border spinner-border-sm me-2"></i> Submitting...';

        // Re-enable after 5 seconds in case of server error
        setTimeout(() => {
            isSubmitting = false;
            submitButton.disabled = false;
            submitButton.innerHTML = originalHTML;
            console.log('‚è±Ô∏è Submit button re-enabled after timeout');
        }, 5000);
    }
});

// Social Photo Import Handler
document.querySelectorAll('.import-social-photo-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.preventDefault();

        const accountId = this.dataset.accountId;
        const slot = parseInt(this.dataset.slot);
        const button = this;
        const originalHTML = button.innerHTML;

        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i>';

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Call import API
        fetch('{% url "crush_lu:import_social_photo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                social_account_id: parseInt(accountId),
                photo_slot: slot
            })
        })
        .then(response => response.json())
        .then(data => {
            const notification = document.getElementById('social-photo-notification');
            notification.style.display = 'block';

            if (data.success) {
                notification.className = 'mt-2 alert alert-success';
                const slotName = slot === 1 ? 'Main Photo' : 'Photo ' + slot;
                notification.innerHTML = '<i class="bi bi-check-circle me-1"></i>Imported to ' + slotName + '!';

                // Update the photo preview
                const previewId = 'preview' + slot;
                const preview = document.getElementById(previewId);
                if (preview && data.photo_url) {
                    preview.classList.add('has-image');
                    preview.innerHTML = '<img src="' + data.photo_url + '" alt="Photo ' + slot + '">';

                    // Show remove button
                    const removeBtn = preview.closest('.photo-upload-box').querySelector('.remove-photo');
                    if (removeBtn) {
                        removeBtn.classList.remove('d-none');
                    }
                }
            } else {
                notification.className = 'mt-2 alert alert-danger';
                notification.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>' + (data.error || 'Error importing photo');
            }

            // Hide notification after 4 seconds
            setTimeout(function() {
                notification.style.display = 'none';
            }, 4000);
        })
        .catch(error => {
            const notification = document.getElementById('social-photo-notification');
            notification.style.display = 'block';
            notification.className = 'mt-2 alert alert-danger';
            notification.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>Network error. Please try again.';
        })
        .finally(function() {
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
    });
});

// ============================================================================
// PHONE VERIFICATION SYSTEM
// ============================================================================

// State
let phoneVerification = null;
let isPhoneVerified = {{ profile.phone_verified|yesno:"true,false"|default:"false" }};
let resendTimer = null;
let resendCountdown = 60;

// Initialize phone verification
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('{{ form.phone_number.id_for_label }}');
    const verifyBtn = document.getElementById('verify-phone-btn');
    const changeBtn = document.getElementById('change-phone-btn');
    const continueBtn = document.getElementById('step1-continue-btn');

    // Enable/disable verify button based on phone input
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            const phone = this.value.trim();
            if (verifyBtn) {
                verifyBtn.disabled = phone.length < 6;
            }
        });
    }

    // Initialize PhoneVerification class
    phoneVerification = new PhoneVerification({
        phoneInputId: '{{ form.phone_number.id_for_label }}',
        verifyButtonId: 'verify-phone-btn',
        recaptchaContainerId: 'recaptcha-container',
        csrfToken: '{{ csrf_token }}',
        onVerified: handlePhoneVerified,
        onError: handlePhoneError,
        onCodeSent: handleCodeSent,
        onStateChange: handleStateChange
    });

    // Verify button click
    if (verifyBtn) {
        verifyBtn.addEventListener('click', async function() {
            await startPhoneVerification();
        });
    }

    // Change phone button click
    if (changeBtn) {
        changeBtn.addEventListener('click', function() {
            resetPhoneVerification();
        });
    }

    // Verify code button click
    const verifyCodeBtn = document.getElementById('verify-code-btn');
    if (verifyCodeBtn) {
        verifyCodeBtn.addEventListener('click', async function() {
            await verifyOTPCode();
        });
    }

    // Resend code button click
    const resendCodeBtn = document.getElementById('resend-code-btn');
    if (resendCodeBtn) {
        resendCodeBtn.addEventListener('click', async function() {
            await resendVerificationCode();
        });
    }

    // OTP input handling (auto-focus next input)
    const otpInputs = document.querySelectorAll('.otp-input');
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            const value = e.target.value;
            if (value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
            // Auto-verify when all digits entered
            if (index === otpInputs.length - 1 && value.length === 1) {
                const code = Array.from(otpInputs).map(i => i.value).join('');
                if (code.length === 6) {
                    verifyOTPCode();
                }
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
        });

        // Allow paste
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text');
            const digits = paste.replace(/\D/g, '').slice(0, 6);
            digits.split('').forEach((digit, i) => {
                if (otpInputs[i]) {
                    otpInputs[i].value = digit;
                }
            });
            if (digits.length === 6) {
                verifyOTPCode();
            }
        });
    });

    // Check verification status on load
    checkPhoneStatus();
});

async function startPhoneVerification() {
    const modal = new bootstrap.Modal(document.getElementById('phoneVerifyModal'));
    showModalStep('sending');
    modal.show();

    const result = await phoneVerification.sendVerificationCode();

    if (!result.success) {
        showModalStep('code');
        showOTPError(result.error);
    }
}

function handleCodeSent(phone) {
    showModalStep('code');
    document.getElementById('verify-phone-display').textContent = maskPhoneNumber(phone);
    startResendTimer();
    // Focus first OTP input
    document.querySelector('.otp-input')?.focus();
}

function handleStateChange(state) {
    console.log('Phone verification state:', state);
}

async function verifyOTPCode() {
    const otpInputs = document.querySelectorAll('.otp-input');
    const code = Array.from(otpInputs).map(i => i.value).join('');

    if (code.length !== 6) {
        showOTPError('Please enter the 6-digit code');
        return;
    }

    showModalStep('verifying');
    const result = await phoneVerification.verifyCode(code);

    if (!result.success) {
        showModalStep('code');
        showOTPError(result.error);
        // Clear OTP inputs for retry
        otpInputs.forEach(i => i.value = '');
        otpInputs[0]?.focus();
    }
}

function handlePhoneVerified(phoneNumber) {
    showModalStep('success');
    isPhoneVerified = true;

    // Update UI
    updatePhoneVerificationUI(phoneNumber);

    // Close modal after delay
    setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('phoneVerifyModal'));
        modal?.hide();
    }, 2000);
}

function handlePhoneError(error) {
    showOTPError(error);
}

function showModalStep(step) {
    const steps = ['sending', 'code', 'verifying', 'success'];
    steps.forEach(s => {
        const el = document.getElementById(`verify-step-${s}`);
        if (el) {
            el.classList.toggle('d-none', s !== step);
        }
    });
}

function showOTPError(message) {
    const errorEl = document.getElementById('otp-error');
    if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.remove('d-none');
    }
}

function updatePhoneVerificationUI(phoneNumber) {
    const phoneInput = document.getElementById('{{ form.phone_number.id_for_label }}');
    const verifyBtn = document.getElementById('verify-phone-btn');
    const changeBtn = document.getElementById('change-phone-btn');
    const continueBtn = document.getElementById('step1-continue-btn');
    const requiredBadge = document.getElementById('phone-required-badge');
    const verifiedBadge = document.getElementById('phone-verified-badge');
    const warningEl = document.getElementById('phone-verify-warning');
    const hiddenInput = document.getElementById('phone_verified_input');

    if (phoneInput) {
        phoneInput.value = phoneNumber;
        phoneInput.readOnly = true;
    }
    if (verifyBtn) verifyBtn.classList.add('d-none');
    if (changeBtn) changeBtn.classList.remove('d-none');
    if (continueBtn) continueBtn.disabled = false;
    if (requiredBadge) requiredBadge.classList.add('d-none');
    if (verifiedBadge) verifiedBadge.classList.remove('d-none');
    if (warningEl) warningEl.classList.add('d-none');
    if (hiddenInput) hiddenInput.value = 'true';

    showNotification('Phone verified successfully!', 'success');
}

function resetPhoneVerification() {
    const phoneInput = document.getElementById('{{ form.phone_number.id_for_label }}');
    const verifyBtn = document.getElementById('verify-phone-btn');
    const changeBtn = document.getElementById('change-phone-btn');
    const continueBtn = document.getElementById('step1-continue-btn');
    const requiredBadge = document.getElementById('phone-required-badge');
    const verifiedBadge = document.getElementById('phone-verified-badge');
    const warningEl = document.getElementById('phone-verify-warning');
    const hiddenInput = document.getElementById('phone_verified_input');

    isPhoneVerified = false;

    if (phoneInput) {
        phoneInput.readOnly = false;
        phoneInput.value = '';
        phoneInput.focus();
    }
    if (verifyBtn) {
        verifyBtn.classList.remove('d-none');
        verifyBtn.disabled = true;
    }
    if (changeBtn) changeBtn.classList.add('d-none');
    if (continueBtn) continueBtn.disabled = true;
    if (requiredBadge) requiredBadge.classList.remove('d-none');
    if (verifiedBadge) verifiedBadge.classList.add('d-none');
    if (warningEl) warningEl.classList.remove('d-none');
    if (hiddenInput) hiddenInput.value = 'false';

    // Reset phone verification instance
    phoneVerification?.reset();
}

async function resendVerificationCode() {
    document.getElementById('resend-code-btn').classList.add('d-none');
    document.getElementById('resend-timer').classList.remove('d-none');
    startResendTimer();

    showModalStep('sending');
    await phoneVerification.sendVerificationCode();
}

function startResendTimer() {
    resendCountdown = 60;
    document.getElementById('resend-countdown').textContent = resendCountdown;
    document.getElementById('resend-timer').classList.remove('d-none');
    document.getElementById('resend-code-btn').classList.add('d-none');

    if (resendTimer) clearInterval(resendTimer);

    resendTimer = setInterval(() => {
        resendCountdown--;
        document.getElementById('resend-countdown').textContent = resendCountdown;

        if (resendCountdown <= 0) {
            clearInterval(resendTimer);
            document.getElementById('resend-timer').classList.add('d-none');
            document.getElementById('resend-code-btn').classList.remove('d-none');
        }
    }, 1000);
}

function maskPhoneNumber(phone) {
    if (phone.length < 8) return phone;
    return phone.slice(0, 7) + '***' + phone.slice(-2);
}

async function checkPhoneStatus() {
    try {
        const status = await phoneVerification.checkStatus();
        if (status.phone_verified && status.phone_number) {
            isPhoneVerified = true;
            updatePhoneVerificationUI(status.phone_number);
        }
    } catch (error) {
        console.error('Failed to check phone status:', error);
    }
}
</script>
{% endblock %}

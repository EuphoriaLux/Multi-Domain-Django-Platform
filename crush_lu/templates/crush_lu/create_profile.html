{% extends 'crush_lu/base.html' %}
{% load static %}

{% block title %}Create Your Profile - Crush.lu{% endblock %}

{% block extra_css %}
<!-- Profile creation styles are in static/crush_lu/css/components/profile-creation.css -->
{% endblock %}

{% block content %}
<div class="profile-creation-wrapper">
    <div class="container py-4">
        <!-- Progress Header -->
        <div class="progress-header text-center mb-5">
            {% if is_editing %}
                <h1 class="display-6 mb-3">Edit Your Profile üíï</h1>
                <p class="lead text-muted">Update your profile information</p>
            {% else %}
                <h1 class="display-6 mb-3">Welcome to Crush! üíï</h1>
                <p class="lead text-muted">Let's create your profile in just a few steps</p>
            {% endif %}

            <!-- Progress Tracker -->
            <div class="profile-progress-tracker mt-4">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Basic Info</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">About You</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Photos</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Review</div>
                </div>
            </div>
        </div>

        <form method="post" enctype="multipart/form-data" id="profileForm" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div x-data="{ show: true }" x-show="show" x-transition class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ form.non_field_errors }}
                    <button @click="show = false" type="button" class="btn-close" aria-label="Dismiss">
                        {% include "crush_lu/icons/x-mark.html" with class="w-4 h-4" aria_hidden="true" %}
                    </button>
                </div>
            {% endif %}

            {% if form.errors %}
                <div x-data="{ show: true }" x-show="show" x-transition class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong aria-hidden="true">‚ùå</strong> Please fix the following errors:
                    <ul class="mb-0 mt-2">
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                <li>
                                    {% if field == '__all__' %}
                                        {{ error }}
                                    {% else %}
                                        <strong>{{ field|title }}:</strong> {{ error }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                    <button @click="show = false" type="button" class="btn-close" aria-label="Dismiss">
                        {% include "crush_lu/icons/x-mark.html" with class="w-4 h-4" aria_hidden="true" %}
                    </button>
                </div>
            {% endif %}

            <!-- Step 1: Basic Information -->
            <div class="form-step active" data-step="1">
                <div class="step-card">
                    <div class="card-icon">üìã</div>
                    <h3 class="card-title">Basic Information</h3>
                    <p class="card-subtitle">Let's start with the essentials</p>

                    <!-- Phone Number with Verification (REQUIRED) -->
                    <div class="form-group-modern mb-4 priority-field" id="phone-verification-container">
                        <label for="{{ form.phone_number.id_for_label }}">
                            {% include "crush_lu/icons/phone.html" with class="w-5 h-5" %} Phone Number *
                            {% if profile.phone_verified %}
                            <span class="badge bg-success ms-2">
                                {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %} Verified
                            </span>
                            {% else %}
                            <span class="badge bg-danger ms-2">Verification Required</span>
                            {% endif %}
                        </label>

                        {% if profile.phone_verified %}
                        <!-- Phone is verified - show readonly -->
                        <div class="phone-input-wrapper">
                            <input type="tel"
                                   name="phone_number"
                                   id="{{ form.phone_number.id_for_label }}"
                                   class="form-control form-control-lg bg-light"
                                   value="{{ profile.phone_number }}"
                                   readonly>
                        </div>
                        <small class="form-text text-success">
                            {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %}
                            Your phone number is verified and locked.
                        </small>
                        {% else %}
                        <!-- Phone not verified - show link to verification page -->
                        <div class="alert alert-warning">
                            <div class="d-flex align-items-center gap-3">
                                <div class="flex-grow-1">
                                    <strong>{% include "crush_lu/icons/shield-check.html" with class="w-5 h-5" %} Phone Verification Required</strong>
                                    <p class="mb-0 mt-1">You must verify your phone number before continuing. This helps us keep our community safe.</p>
                                </div>
                                <a href="{% url 'crush_lu:verify_phone' %}?next={% url 'crush_lu:create_profile' %}"
                                   class="btn btn-warning btn-lg flex-shrink-0">
                                    {% include "crush_lu/icons/phone.html" with class="w-5 h-5" %} Verify Now
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        {% if form.phone_number.errors %}
                            <div class="invalid-feedback d-block">{{ form.phone_number.errors.0 }}</div>
                        {% endif %}

                        <!-- Hidden input to track verification status -->
                        <input type="hidden"
                               name="phone_verified"
                               id="phone_verified_input"
                               value="{% if profile.phone_verified %}true{% else %}false{% endif %}">
                    </div>

                    <!-- Date of Birth -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.date_of_birth.id_for_label }}">
                            {% include "crush_lu/icons/calendar.html" with class="w-5 h-5" %} Date of Birth *
                        </label>
                        {{ form.date_of_birth }}
                        <small class="form-text">Must be 18+ to join</small>
                        {% if form.date_of_birth.errors %}
                            <div class="invalid-feedback d-block">{{ form.date_of_birth.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Gender Selection (Card-based) -->
                    <div class="form-group-modern mb-4">
                        <label class="mb-3">
                            {% include "crush_lu/icons/user.html" with class="w-5 h-5" %} Gender *
                        </label>
                        <div class="gender-card-selection">
                            <input type="radio" name="gender" value="M" id="gender_m" class="d-none gender-radio" {% if profile.gender == 'M' %}checked{% endif %} required>
                            <label for="gender_m" class="gender-card">
                                <div class="gender-icon">üë®</div>
                                <div class="gender-label">Male</div>
                            </label>

                            <input type="radio" name="gender" value="F" id="gender_f" class="d-none gender-radio" {% if profile.gender == 'F' %}checked{% endif %}>
                            <label for="gender_f" class="gender-card">
                                <div class="gender-icon">üë©</div>
                                <div class="gender-label">Female</div>
                            </label>

                            <input type="radio" name="gender" value="NB" id="gender_nb" class="d-none gender-radio" {% if profile.gender == 'NB' %}checked{% endif %}>
                            <label for="gender_nb" class="gender-card">
                                <div class="gender-icon">üßë</div>
                                <div class="gender-label">Non-binary</div>
                            </label>

                            <input type="radio" name="gender" value="O" id="gender_o" class="d-none gender-radio" {% if profile.gender == 'O' %}checked{% endif %}>
                            <label for="gender_o" class="gender-card">
                                <div class="gender-icon">‚ú®</div>
                                <div class="gender-label">Other</div>
                            </label>
                        </div>
                        {% if form.gender.errors %}
                            <div class="invalid-feedback d-block">{{ form.gender.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Location -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.location.id_for_label }}">
                            {% include "crush_lu/icons/map-pin.html" with class="w-5 h-5" %} Location in Luxembourg *
                        </label>
                        {{ form.location }}
                        {% if form.location.errors %}
                            <div class="invalid-feedback d-block">{{ form.location.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <button type="button"
                            class="btn btn-crush-primary btn-lg w-100 mt-4 next-step"
                            id="step1-continue-btn"
                            {% if not profile.phone_verified %}disabled{% endif %}>
                        Continue {% include "crush_lu/icons/arrow-right.html" with class="w-5 h-5" %}
                    </button>

                    <!-- Warning when button is disabled -->
                    <div class="alert alert-warning mt-3 {% if profile.phone_verified %}d-none{% endif %}" id="phone-verify-warning">
                        {% include "crush_lu/icons/exclamation-triangle.html" with class="w-5 h-5" %}
                        Please verify your phone number to continue.
                    </div>
                </div>
            </div>

            <!-- Step 2: About You -->
            <div class="form-step" data-step="2">
                <div class="step-card">
                    <div class="card-icon">‚úçÔ∏è</div>
                    <h3 class="card-title">About You</h3>
                    <p class="card-subtitle">Share what makes you unique (optional)</p>

                    <!-- Bio (Optional) -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.bio.id_for_label }}">
                            {% include "crush_lu/icons/chat-bubble-left.html" with class="w-5 h-5" %} Bio
                            <span class="badge bg-secondary ms-2">Optional</span>
                        </label>
                        <textarea name="bio"
                                  id="{{ form.bio.id_for_label }}"
                                  class="form-control"
                                  rows="4"
                                  maxlength="500"
                                  placeholder="Tell us about yourself... What do you love? What makes you smile? (Optional)">{{ profile.bio|default:"" }}</textarea>
                        <div class="char-counter">
                            <span id="bioCounter">{{ profile.bio|length|default:"0" }}</span>/500 characters
                        </div>
                        {% if form.bio.errors %}
                            <div class="invalid-feedback d-block">{{ form.bio.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Interest Categories (Card-based) -->
                    <div class="form-group-modern mb-4">
                        <label class="mb-3">
                            {% include "crush_lu/icons/star.html" with class="w-5 h-5" %} Interest Categories
                            <span class="badge bg-secondary ms-2">Optional</span>
                        </label>
                        <div class="interest-categories">
                            <input type="checkbox" name="interest_category" value="sports" id="interest_sports" class="d-none interest-checkbox">
                            <label for="interest_sports" class="interest-card">
                                <div class="interest-icon">‚öΩ</div>
                                <div class="interest-label">Sports & Fitness</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="arts" id="interest_arts" class="d-none interest-checkbox">
                            <label for="interest_arts" class="interest-card">
                                <div class="interest-icon">üé®</div>
                                <div class="interest-label">Arts & Culture</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="food" id="interest_food" class="d-none interest-checkbox">
                            <label for="interest_food" class="interest-card">
                                <div class="interest-icon">üç∑</div>
                                <div class="interest-label">Food & Wine</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="outdoors" id="interest_outdoors" class="d-none interest-checkbox">
                            <label for="interest_outdoors" class="interest-card">
                                <div class="interest-icon">üèîÔ∏è</div>
                                <div class="interest-label">Outdoors & Travel</div>
                            </label>

                            <input type="checkbox" name="interest_category" value="business" id="interest_business" class="d-none interest-checkbox">
                            <label for="interest_business" class="interest-card">
                                <div class="interest-icon">üíº</div>
                                <div class="interest-label">Business & Tech</div>
                            </label>
                        </div>
                        <small class="form-text d-block mt-2">Select all that apply, or skip to continue</small>
                    </div>

                    <!-- Custom Interests Text (Optional) -->
                    <div class="form-group-modern mb-4">
                        <label for="{{ form.interests.id_for_label }}">
                            {% include "crush_lu/icons/pencil.html" with class="w-5 h-5" %} Or write your own interests
                        </label>
                        <textarea name="interests"
                                  id="{{ form.interests.id_for_label }}"
                                  class="form-control"
                                  rows="2"
                                  maxlength="300"
                                  placeholder="e.g., hiking, photography, cooking...">{{ profile.interests|default:"" }}</textarea>
                        <div class="char-counter">
                            <span id="interestsCounter">{{ profile.interests|length|default:"0" }}</span>/300 characters
                        </div>
                        {% if form.interests.errors %}
                            <div class="invalid-feedback d-block">{{ form.interests.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Looking For (Card-based) -->
                    <div class="form-group-modern mb-4">
                        <label class="mb-3">
                            {% include "crush_lu/icons/heart.html" with class="w-5 h-5" %} What are you looking for? *
                        </label>
                        <div class="looking-for-cards">
                            <input type="radio" name="looking_for" value="friends" id="looking_friends" class="d-none looking-radio" {% if profile.looking_for == 'friends' %}checked{% endif %} required>
                            <label for="looking_friends" class="looking-card">
                                <div class="looking-icon">üëã</div>
                                <div class="looking-label">New Friends</div>
                            </label>

                            <input type="radio" name="looking_for" value="dating" id="looking_dating" class="d-none looking-radio" {% if profile.looking_for == 'dating' %}checked{% endif %}>
                            <label for="looking_dating" class="looking-card">
                                <div class="looking-icon">üíï</div>
                                <div class="looking-label">Dating</div>
                            </label>

                            <input type="radio" name="looking_for" value="both" id="looking_both" class="d-none looking-radio" {% if profile.looking_for == 'both' %}checked{% endif %}>
                            <label for="looking_both" class="looking-card">
                                <div class="looking-icon">üåü</div>
                                <div class="looking-label">Both</div>
                            </label>

                            <input type="radio" name="looking_for" value="networking" id="looking_networking" class="d-none looking-radio" {% if profile.looking_for == 'networking' %}checked{% endif %}>
                            <label for="looking_networking" class="looking-card">
                                <div class="looking-icon">ü§ù</div>
                                <div class="looking-label">Networking</div>
                            </label>
                        </div>
                        {% if form.looking_for.errors %}
                            <div class="invalid-feedback d-block">{{ form.looking_for.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="button-group mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-lg prev-step">
                            {% include "crush_lu/icons/arrow-left.html" with class="w-5 h-5" %} Back
                        </button>
                        <button type="button" class="btn btn-crush-primary btn-lg next-step">
                            Continue {% include "crush_lu/icons/arrow-right.html" with class="w-5 h-5" %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Photos -->
            <div class="form-step" data-step="3">
                <div class="step-card">
                    <div class="card-icon">üì∏</div>
                    <h3 class="card-title">Add Photos</h3>
                    <p class="card-subtitle">Upload at least one photo (optional but recommended)</p>

                    <!-- Social Photo Import Section -->
                    {% if social_photos %}
                    <div class="social-import-section mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h6 class="mb-0">{% include "crush_lu/icons/cloud-arrow-down.html" with class="w-5 h-5" %}Import from Social Accounts</h6>
                            <span class="badge bg-success">Quick Import</span>
                        </div>
                        <p class="text-muted small mb-3">Use your existing profile photos from connected accounts</p>

                        <div class="social-photos-grid">
                            {% for photo in social_photos %}
                            <div class="social-photo-card">
                                <div class="provider-header">
                                    {% if photo.provider == 'facebook' %}
                                    <i class="fab fa-facebook text-primary"></i>
                                    {% elif photo.provider == 'google' %}
                                    <i class="fab fa-google text-danger"></i>
                                    {% elif photo.provider == 'microsoft' %}
                                    <i class="fab fa-microsoft text-info"></i>
                                    {% endif %}
                                    <span>{{ photo.provider_display }}</span>
                                </div>

                                {% if photo.available %}
                                <div class="social-photo-preview-wrapper">
                                    <img src="{{ photo.photo_url }}" alt="{{ photo.provider_display }} photo" class="social-photo-img">
                                </div>
                                <div class="import-buttons-row">
                                    <button type="button" class="btn btn-sm btn-crush-primary import-social-photo-btn"
                                            data-account-id="{{ photo.account_id }}"
                                            data-slot="1"
                                            title="Set as main photo">
                                        {% include "crush_lu/icons/star.html" with class="w-5 h-5" %} Main
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary import-social-photo-btn"
                                            data-account-id="{{ photo.account_id }}"
                                            data-slot="2"
                                            title="Import as Photo 2">
                                        #2
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-primary import-social-photo-btn"
                                            data-account-id="{{ photo.account_id }}"
                                            data-slot="3"
                                            title="Import as Photo 3">
                                        #3
                                    </button>
                                </div>
                                {% else %}
                                <div class="no-photo-available">
                                    {% include "crush_lu/icons/photo.html" with class="w-5 h-5" %}
                                    <span>{{ photo.reason|default:"No photo available" }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Import notification -->
                        <div id="social-photo-notification" class="mt-3" style="display: none;"></div>
                    </div>
                    <div class="divider-with-text mb-4">
                        <span>or upload your own photos</span>
                    </div>
                    {% endif %}

                    <div class="photo-upload-grid">
                        <!-- Photo 1 -->
                        <div class="photo-upload-box">
                            <input type="file" name="photo_1" id="photo1" accept="image/*" class="d-none photo-input">
                            <label for="photo1" class="photo-label">
                                <div class="photo-preview {% if profile.photo_1 %}has-image{% endif %}" id="preview1">
                                    {% if profile.photo_1 %}
                                        <img src="{{ profile.photo_1.url }}" alt="Photo 1">
                                    {% else %}
                                        {% include "crush_lu/icons/camera.html" with class="w-5 h-5" %}
                                        <span class="photo-text">Add Photo 1</span>
                                    {% endif %}
                                </div>
                            </label>
                            <button type="button" class="btn btn-sm btn-danger remove-photo {% if not profile.photo_1 %}d-none{% endif %}" data-target="photo1">
                                {% include "crush_lu/icons/trash.html" with class="w-5 h-5" %}
                            </button>
                        </div>

                        <!-- Photo 2 -->
                        <div class="photo-upload-box">
                            <input type="file" name="photo_2" id="photo2" accept="image/*" class="d-none photo-input">
                            <label for="photo2" class="photo-label">
                                <div class="photo-preview {% if profile.photo_2 %}has-image{% endif %}" id="preview2">
                                    {% if profile.photo_2 %}
                                        <img src="{{ profile.photo_2.url }}" alt="Photo 2">
                                    {% else %}
                                        {% include "crush_lu/icons/camera.html" with class="w-5 h-5" %}
                                        <span class="photo-text">Add Photo 2</span>
                                    {% endif %}
                                </div>
                            </label>
                            <button type="button" class="btn btn-sm btn-danger remove-photo {% if not profile.photo_2 %}d-none{% endif %}" data-target="photo2">
                                {% include "crush_lu/icons/trash.html" with class="w-5 h-5" %}
                            </button>
                        </div>

                        <!-- Photo 3 -->
                        <div class="photo-upload-box">
                            <input type="file" name="photo_3" id="photo3" accept="image/*" class="d-none photo-input">
                            <label for="photo3" class="photo-label">
                                <div class="photo-preview {% if profile.photo_3 %}has-image{% endif %}" id="preview3">
                                    {% if profile.photo_3 %}
                                        <img src="{{ profile.photo_3.url }}" alt="Photo 3">
                                    {% else %}
                                        {% include "crush_lu/icons/camera.html" with class="w-5 h-5" %}
                                        <span class="photo-text">Add Photo 3</span>
                                    {% endif %}
                                </div>
                            </label>
                            <button type="button" class="btn btn-sm btn-danger remove-photo {% if not profile.photo_3 %}d-none{% endif %}" data-target="photo3">
                                {% include "crush_lu/icons/trash.html" with class="w-5 h-5" %}
                            </button>
                        </div>
                    </div>

                    {% if profile.photo_1 %}
                    <div class="alert alert-success mt-3">
                        {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %}
                        <strong>Great!</strong> We imported your photo from Facebook. You can keep it or upload a different one.
                    </div>
                    {% else %}
                    <div class="alert alert-info mt-3">
                        {% include "crush_lu/icons/information-circle.html" with class="w-5 h-5" %}
                        <strong>Tip:</strong> Use clear photos where your face is visible. Avoid group photos!
                    </div>
                    {% endif %}

                    <!-- Privacy Settings -->
                    <div class="privacy-section mt-4">
                        <h5 class="mb-3">{% include "crush_lu/icons/shield-check.html" with class="w-5 h-5" %} Privacy Settings</h5>

                        <div class="privacy-toggle mb-3">
                            <input type="checkbox" name="show_full_name" id="{{ form.show_full_name.id_for_label }}" class="form-check-input">
                            <label for="{{ form.show_full_name.id_for_label }}" class="form-check-label">
                                Show my full name <small class="text-muted">(otherwise only first name)</small>
                            </label>
                        </div>

                        <div class="privacy-toggle mb-3">
                            <input type="checkbox" name="show_exact_age" id="{{ form.show_exact_age.id_for_label }}" class="form-check-input" checked>
                            <label for="{{ form.show_exact_age.id_for_label }}" class="form-check-label">
                                Show my exact age <small class="text-muted">(otherwise show age range)</small>
                            </label>
                        </div>

                        <div class="privacy-toggle mb-3">
                            <input type="checkbox" name="blur_photos" id="{{ form.blur_photos.id_for_label }}" class="form-check-input">
                            <label for="{{ form.blur_photos.id_for_label }}" class="form-check-label">
                                Blur my photos until mutual interest
                            </label>
                        </div>
                    </div>

                    <div class="button-group mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-lg prev-step">
                            {% include "crush_lu/icons/arrow-left.html" with class="w-5 h-5" %} Back
                        </button>
                        <button type="button" class="btn btn-crush-primary btn-lg next-step">
                            Continue {% include "crush_lu/icons/arrow-right.html" with class="w-5 h-5" %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review & Submit -->
            <div class="form-step" data-step="4">
                <div class="step-card">
                    <div class="card-icon">‚úÖ</div>
                    <h3 class="card-title">Review & Submit</h3>
                    <p class="card-subtitle">Almost done! Review your information</p>

                    <div class="review-summary">
                        <div class="summary-item">
                            {% include "crush_lu/icons/phone.html" with class="w-5 h-5 text-primary" %}
                            <div>
                                <strong>Phone Number:</strong>
                                <span id="review-phone">Not provided</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            {% include "crush_lu/icons/calendar.html" with class="w-5 h-5 text-primary" %}
                            <div>
                                <strong>Date of Birth:</strong>
                                <span id="review-dob">Not provided</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            {% include "crush_lu/icons/user.html" with class="w-5 h-5 text-primary" %}
                            <div>
                                <strong>Gender:</strong>
                                <span id="review-gender">Not selected</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            {% include "crush_lu/icons/map-pin.html" with class="w-5 h-5 text-primary" %}
                            <div>
                                <strong>Location:</strong>
                                <span id="review-location">Not selected</span>
                            </div>
                        </div>
                    </div>

                    <!-- What Happens Next -->
                    <div class="next-steps-info mt-4">
                        <h5 class="mb-3">{% include "crush_lu/icons/hourglass.html" with class="w-5 h-5" %} What Happens Next?</h5>

                        <div class="timeline-item">
                            <div class="timeline-marker">1</div>
                            <div class="timeline-content">
                                <strong>Profile Submitted</strong>
                                <p>Your profile is sent to our Crush Coach team</p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-marker">2</div>
                            <div class="timeline-content">
                                <strong>Coach Review</strong>
                                <p>A coach will review your profile within 24-48 hours</p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-marker">3</div>
                            <div class="timeline-content">
                                <strong>Screening Call</strong>
                                <p>Your coach will call you to discuss your profile and goals</p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-marker">4</div>
                            <div class="timeline-content">
                                <strong>Profile Approved</strong>
                                <p>You can start attending events and making connections!</p>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success mt-4">
                        {% include "crush_lu/icons/shield-check.html" with class="w-5 h-5" %}
                        <strong>Privacy First:</strong> Your phone number will only be used by your coach for screening. It won't be shared with other members without your consent.
                    </div>

                    <div class="button-group mt-4">
                        <button type="button" class="btn btn-outline-secondary btn-lg prev-step">
                            {% include "crush_lu/icons/arrow-left.html" with class="w-5 h-5" %} Back
                        </button>
                        <button type="submit" class="btn btn-crush-primary btn-lg">
                            {% include "crush_lu/icons/check-circle.html" with class="w-5 h-5" %} Submit Profile
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Styles are in static/crush_lu/css/components/profile-creation.css and social-photos.css -->

{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
// Multi-step form management
{% if current_step %}
    // Resume from last completed step - move to NEXT step to continue
    const stepMap = {'not_started': 1, 'step1': 2, 'step2': 3, 'step3': 4, 'completed': 4, 'submitted': 4};
    let currentStep = stepMap['{{ current_step }}'] || 1;

    // Debug logging for troubleshooting
    console.log('Loading profile - completion_status:', '{{ current_step }}');
    console.log('Mapped to step:', currentStep);
{% else %}
    let currentStep = 1;
    console.log('Starting new profile at step 1');
{% endif %}
const totalSteps = 4;
const isEditing = {{ is_editing|lower|default:"false" }};
console.log('Editing mode:', isEditing, 'Has profile:', {% if profile %}true{% else %}false{% endif %});

// Character counters
document.getElementById('{{ form.bio.id_for_label }}')?.addEventListener('input', function() {
    document.getElementById('bioCounter').textContent = this.value.length;
});

document.getElementById('{{ form.interests.id_for_label }}')?.addEventListener('input', function() {
    document.getElementById('interestsCounter').textContent = this.value.length;
});

// Interest categories - combine checked categories with custom text
document.querySelectorAll('.interest-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateInterestsField();
    });
});

function updateInterestsField() {
    const selectedCategories = Array.from(document.querySelectorAll('.interest-checkbox:checked'))
        .map(cb => cb.nextElementSibling.querySelector('.interest-label').textContent);

    const interestsField = document.getElementById('{{ form.interests.id_for_label }}');
    const customText = interestsField.value.trim();

    // If user has custom text, don't override it - categories are supplementary
    // They will be combined during form submission
}

// Photo preview
document.querySelectorAll('.photo-input').forEach(input => {
    input.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            const previewId = 'preview' + input.id.slice(-1);
            const preview = document.getElementById(previewId);
            const removeBtn = input.parentElement.querySelector('.remove-photo');

            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                preview.classList.add('has-image');
                removeBtn.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    });
});

// Remove photo
document.querySelectorAll('.remove-photo').forEach(btn => {
    btn.addEventListener('click', function() {
        const targetId = this.dataset.target;
        const input = document.getElementById(targetId);
        const previewId = 'preview' + targetId.slice(-1);
        const preview = document.getElementById(previewId);

        input.value = '';
        preview.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" /></svg><span class="photo-text">Add Photo ' + targetId.slice(-1) + '</span>';
        preview.classList.remove('has-image');
        this.classList.add('d-none');
    });
});

// Step navigation
function updateStep(newStep) {
    if (newStep < 1 || newStep > totalSteps) return;

    // Hide current step
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('active');
    document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');

    // Mark completed steps
    if (newStep > currentStep) {
        document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('completed');
    }

    // Show new step
    currentStep = newStep;
    document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
    document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Update review if on last step
    if (currentStep === 4) {
        updateReview();
    }
}

// Next step buttons
document.querySelectorAll('.next-step').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (validateCurrentStep()) {
            // Save data after each step
            let canProceed = true;

            if (currentStep === 1) {
                canProceed = await saveStep1();
            } else if (currentStep === 2) {
                canProceed = await saveStep2();
            }

            // Only advance to next step if save was successful
            if (canProceed) {
                updateStep(currentStep + 1);
            }
        }
    });
});

// Previous step buttons
document.querySelectorAll('.prev-step').forEach(btn => {
    btn.addEventListener('click', function() {
        updateStep(currentStep - 1);
    });
});

// Validation
function validateCurrentStep() {
    const currentStepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
    const requiredFields = currentStepEl.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
        if (field.type === 'radio') {
            const radioGroup = currentStepEl.querySelectorAll(`[name="${field.name}"]`);
            const isChecked = Array.from(radioGroup).some(radio => radio.checked);
            if (!isChecked) {
                isValid = false;
                alert('Please select an option for ' + field.name.replace(/_/g, ' '));
            }
        } else if (!field.value.trim()) {
            isValid = false;
            field.focus();
            alert('Please fill in all required fields');
            return false;
        }
    });

    return isValid;
}

// Update review summary
function updateReview() {
    const phoneNumber = document.querySelector('[name="phone_number"]').value || 'Not provided';
    const dob = document.querySelector('[name="date_of_birth"]').value || 'Not provided';
    const gender = document.querySelector('[name="gender"]:checked')?.nextElementSibling.querySelector('.gender-label')?.textContent || 'Not selected';
    const location = document.querySelector('[name="location"]').value || 'Not selected';

    document.getElementById('review-phone').textContent = phoneNumber;
    document.getElementById('review-dob').textContent = dob;
    document.getElementById('review-gender').textContent = gender;
    document.getElementById('review-location').textContent = location;
}

// Form submission - combine interests before submitting
document.getElementById('profileForm').addEventListener('submit', function(e) {
    // Combine selected interest categories with custom text
    const selectedCategories = Array.from(document.querySelectorAll('.interest-checkbox:checked'))
        .map(cb => cb.nextElementSibling.querySelector('.interest-label').textContent);

    const customInterests = document.querySelector('[name="interests"]').value.trim();

    // Combine categories and custom interests
    let finalInterests = '';
    if (selectedCategories.length > 0) {
        finalInterests = selectedCategories.join(', ');
    }
    if (customInterests) {
        finalInterests = finalInterests ? `${finalInterests}, ${customInterests}` : customInterests;
    }

    // Update the interests field with combined value
    document.querySelector('[name="interests"]').value = finalInterests;

    // Only validate if we're NOT on the final review step (step 4)
    // Step 4 has no required fields, it's just a review
    if (currentStep !== 4 && !validateCurrentStep()) {
        e.preventDefault();
    }
});

// AJAX save functions
async function saveStep1() {
    const data = {
        phone_number: document.querySelector('[name="phone_number"]').value,
        date_of_birth: document.querySelector('[name="date_of_birth"]').value,
        gender: document.querySelector('[name="gender"]:checked')?.value,
        location: document.querySelector('[name="location"]').value
    };

    try {
        const response = await fetch('{% url "crush_lu:save_profile_step1" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            // Show success notification
            showNotification('‚úÖ Basic info saved! A coach will contact you soon.', 'success');

            // Mark step 1 as saved
            localStorage.setItem('crush_profile_step1_saved', 'true');
            return true;  // Success - allow advancing to next step
        } else {
            showNotification('‚ùå Error: ' + result.error, 'error');
            return false;  // Validation failed - stay on current step
        }
    } catch (error) {
        console.error('Error saving Step 1:', error);
        showNotification('‚ùå Network error. Please try again.', 'error');
        return false;  // Error - stay on current step
    }
}

async function saveStep2() {
    // Combine selected interest categories with custom text
    const selectedCategories = Array.from(document.querySelectorAll('.interest-checkbox:checked'))
        .map(cb => cb.nextElementSibling.querySelector('.interest-label').textContent);

    const customInterests = document.querySelector('[name="interests"]').value.trim();

    // Combine categories and custom interests
    let finalInterests = '';
    if (selectedCategories.length > 0) {
        finalInterests = selectedCategories.join(', ');
    }
    if (customInterests) {
        finalInterests = finalInterests ? `${finalInterests}, ${customInterests}` : customInterests;
    }

    const data = {
        bio: document.querySelector('[name="bio"]').value,
        interests: finalInterests,
        looking_for: document.querySelector('[name="looking_for"]:checked')?.value
    };

    try {
        const response = await fetch('{% url "crush_lu:save_profile_step2" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showNotification('‚úÖ About section saved!', 'success');
            return true;  // Success - allow advancing
        } else {
            showNotification('‚ùå Error: ' + (result.error || 'Failed to save'), 'error');
            return false;  // Error - stay on current step
        }
    } catch (error) {
        console.error('Error saving Step 2:', error);
        showNotification('‚ùå Network error. Please try again.', 'error');
        return false;  // Error - stay on current step
    }
}

// Notification system
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" aria-label="Dismiss" onclick="this.parentElement.remove()">
            <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
        </button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// Initialize on page load
window.addEventListener('load', async function() {
    // If editing or resuming, mark previous steps as completed and show current step
    if (currentStep > 1) {
        // Mark all previous steps as completed
        for (let i = 1; i < currentStep; i++) {
            document.querySelector(`.progress-step[data-step="${i}"]`)?.classList.add('completed');
        }

        // Hide step 1 and show the current step
        document.querySelector(`.form-step[data-step="1"]`)?.classList.remove('active');
        document.querySelector(`.progress-step[data-step="1"]`)?.classList.remove('active');

        document.querySelector(`.form-step[data-step="${currentStep}"]`)?.classList.add('active');
        document.querySelector(`.progress-step[data-step="${currentStep}"]`)?.classList.add('active');

        showNotification(`üëã Welcome back! Continue with Step ${currentStep}.`, 'info');
    }

    // Check for profile progress (for new profiles)
    if (!isEditing) {
        try {
            const response = await fetch('{% url "crush_lu:get_profile_progress" %}');
            const progress = await response.json();

            if (progress.exists && progress.completion_status !== 'submitted' && currentStep === 1) {
                const stepNum = parseInt(progress.completion_status.replace('step', '')) || 1;
                if (stepNum > 1) {
                    showNotification(`üëã Welcome back! You can continue from Step ${stepNum}.`, 'info');
                }
            }
        } catch (error) {
            console.error('Error checking progress:', error);
        }
    }
});

function getStepNumber(status) {
    const statusMap = {
        'step1': 2,
        'step2': 3,
        'step3': 4,
        'completed': 4
    };
    return statusMap[status] || 1;
}

// Prevent double-submission of the form
const profileForm = document.getElementById('profileForm');
const submitButton = profileForm.querySelector('button[type="submit"]');
let isSubmitting = false;

profileForm.addEventListener('submit', function(e) {
    // Prevent double-click or multiple submissions
    if (isSubmitting) {
        e.preventDefault();
        console.log('‚ö†Ô∏è Duplicate submission prevented');
        return false;
    }

    // Mark as submitting
    isSubmitting = true;

    // Disable submit button and show loading state
    if (submitButton) {
        submitButton.disabled = true;
        const originalHTML = submitButton.innerHTML;
        submitButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block animate-spin"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Submitting...';

        // Re-enable after 5 seconds in case of server error
        setTimeout(() => {
            isSubmitting = false;
            submitButton.disabled = false;
            submitButton.innerHTML = originalHTML;
            console.log('‚è±Ô∏è Submit button re-enabled after timeout');
        }, 5000);
    }
});

// Social Photo Import Handler
document.querySelectorAll('.import-social-photo-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.preventDefault();

        const accountId = this.dataset.accountId;
        const slot = parseInt(this.dataset.slot);
        const button = this;
        const originalHTML = button.innerHTML;

        // Disable button and show loading
        button.disabled = true;
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block animate-spin"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>';

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Call import API
        fetch('{% url "crush_lu:import_social_photo" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                social_account_id: parseInt(accountId),
                photo_slot: slot
            })
        })
        .then(response => response.json())
        .then(data => {
            const notification = document.getElementById('social-photo-notification');
            notification.style.display = 'block';

            if (data.success) {
                notification.className = 'mt-2 alert alert-success';
                const slotName = slot === 1 ? 'Main Photo' : 'Photo ' + slot;
                notification.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Imported to ' + slotName + '!';

                // Update the photo preview
                const previewId = 'preview' + slot;
                const preview = document.getElementById(previewId);
                if (preview && data.photo_url) {
                    preview.classList.add('has-image');
                    preview.innerHTML = '<img src="' + data.photo_url + '" alt="Photo ' + slot + '">';

                    // Show remove button
                    const removeBtn = preview.closest('.photo-upload-box').querySelector('.remove-photo');
                    if (removeBtn) {
                        removeBtn.classList.remove('d-none');
                    }
                }
            } else {
                notification.className = 'mt-2 alert alert-danger';
                notification.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg> ' + (data.error || 'Error importing photo');
            }

            // Hide notification after 4 seconds
            setTimeout(function() {
                notification.style.display = 'none';
            }, 4000);
        })
        .catch(error => {
            const notification = document.getElementById('social-photo-notification');
            notification.style.display = 'block';
            notification.className = 'mt-2 alert alert-danger';
            notification.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" /></svg> Network error. Please try again.';
        })
        .finally(function() {
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
    });
});
</script>
{% endblock %}

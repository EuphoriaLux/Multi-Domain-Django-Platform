{% extends 'crush_lu/base.html' %}
{% load static i18n %}

{% block title %}{% trans "Edit Your Profile - Crush.lu" %}{% endblock %}

{% block extra_css %}
<!-- Profile creation/editing styles (action buttons, photo cards, etc.) -->
<link rel="stylesheet" href="{% static 'crush_lu/css/components/profile-creation.css' %}">
<!-- intl-tel-input CSS with SRI for security -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.3/build/css/intlTelInput.css"
      integrity="sha384-BmygXwA0e3FeMPv5eKPsAq5JZncm8qElyxhy0qDhzY2cvcZTtTF0O3lG9n+M6JeL"
      crossorigin="anonymous">
<!-- Custom intl-tel-input styling for Crush.lu -->
<link rel="stylesheet" href="{% static 'crush_lu/css/components/intl-tel-input.css' %}">
<!-- Canton Map CSS -->
<link rel="stylesheet" href="{% static 'crush_lu/css/components/canton-map.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    {% with missing_fields=profile.get_missing_fields %}
    {% if missing_fields %}
    <!-- Missing Fields Alert -->
    <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-6 rounded-r-lg">
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0 text-amber-500">
                {% include "shared/icons/exclamation-triangle.html" with class="w-6 h-6" %}
            </div>
            <div class="flex-1">
                <h3 class="text-amber-800 font-semibold">{% trans "Your profile is incomplete" %}</h3>
                <p class="text-amber-700 text-sm mt-1">{% trans "Please fill in the following required fields:" %}</p>
                <ul class="mt-2 space-y-1">
                    {% for field in missing_fields %}
                    <li class="text-amber-700 text-sm flex items-center gap-2">
                        <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
                        {{ field.label }}
                        <span class="text-amber-500 text-xs">({% trans "Step" %} {{ field.step }})</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
    {% endwith %}

    <div class="card shadow-sm dark:shadow-gray-900/20">
        <div class="card-body p-6 lg:p-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold mb-2 dark:text-white">{% trans "Edit Your Profile" %}</h1>
                <p class="text-gray-500 dark:text-gray-400">{% trans "Update your information below" %}</p>
                {% if profile.is_approved %}
                    <span class="badge badge-success mt-2">{% trans "Profile Approved" %}</span>
                {% endif %}
            </div>

            <form method="post"
                  enctype="multipart/form-data"
                  id="editProfileForm"
                  hx-post="{% url 'crush_lu:edit_profile' %}"
                  hx-target="#form-container"
                  hx-swap="innerHTML"
                  hx-indicator="#submit-indicator">
                {% csrf_token %}

                <div id="form-container">
                    {% include 'crush_lu/partials/edit_profile_form.html' %}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Styles are in static/crush_lu/css/components/social-photos.css and profile-creation.css -->

{% endblock %}

{% block extra_js %}
<!-- intl-tel-input JS -->
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.3/build/js/intlTelInput.min.js"></script>

<script src="{% static 'crush_lu/js/photo-preview.js' %}"></script>
<script nonce="{{ request.csp_nonce }}">
// Character counters with visual feedback - reinitialize after HTMX swaps
function initCharacterCounters() {
    initCounter('id_bio', 'bioCounter', 'bio-bar', 'bio-counter-container', 500);
    initCounter('id_interests', 'interestsCounter', 'interests-bar', 'interests-counter-container', 300);
}

function initCounter(inputId, counterId, barId, containerId, maxLength) {
    const field = document.getElementById(inputId);
    const counter = document.getElementById(counterId);
    const bar = document.getElementById(barId);
    const container = document.getElementById(containerId);

    if (!field || !counter) return;

    function updateCounter() {
        const length = field.value.length;
        const percentage = (length / maxLength) * 100;

        counter.textContent = length;

        if (bar) {
            bar.style.width = Math.min(percentage, 100) + '%';
        }

        // Remove existing state classes
        if (container) {
            container.classList.remove('char-counter--warning', 'char-counter--danger');

            // Add appropriate state class
            if (percentage >= 95) {
                container.classList.add('char-counter--danger');
            } else if (percentage >= 80) {
                container.classList.add('char-counter--warning');
            }
        }
    }

    field.addEventListener('input', updateCounter);
    updateCounter(); // Initial state
}

// Initialize on page load
initCharacterCounters();

// Reinitialize after HTMX swaps
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'form-container') {
        initCharacterCounters();

        // Scroll to first error if present (Tailwind uses text-red-600 for errors)
        const firstError = event.detail.target.querySelector('.text-red-600');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Animate photo card after upload
    if (event.detail.target.id && event.detail.target.id.startsWith('photo-card-')) {
        const card = event.detail.target.querySelector('.photo-upload-card');
        if (card) {
            card.classList.add('animate-pulse');
            setTimeout(() => card.classList.remove('animate-pulse'), 1000);
        }
    }
});

// Social photo import functionality
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.import-social-photo-btn');
    if (!btn) return;

    e.preventDefault();

    const accountId = btn.dataset.accountId;
    const slot = parseInt(btn.dataset.slot);
    const originalContent = btn.innerHTML;
    const notification = document.getElementById('social-photo-notification');

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>';

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('{% url "api_import_social_photo" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            social_account_id: parseInt(accountId),
            photo_slot: slot
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update photo preview
            const previewId = 'preview-photo-' + slot;
            const previewContainer = document.getElementById(previewId);

            if (previewContainer) {
                if (previewContainer.classList.contains('photo-placeholder')) {
                    // Replace placeholder with image
                    const img = document.createElement('img');
                    img.src = data.photo_url;
                    img.alt = 'Photo ' + slot;
                    img.className = 'photo-preview';
                    img.id = previewId;
                    previewContainer.parentNode.replaceChild(img, previewContainer);

                    // Add badge
                    const container = img.closest('.photo-preview-container');
                    if (container && !container.querySelector('.photo-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'photo-badge bg-green-500';
                        badge.textContent = 'Imported';
                        container.appendChild(badge);
                    }
                } else {
                    // Update existing image
                    previewContainer.src = data.photo_url;
                    const badge = previewContainer.closest('.photo-preview-container')?.querySelector('.photo-badge');
                    if (badge) {
                        badge.textContent = 'Imported';
                        badge.classList.add('bg-green-500');
                    }
                }
            }

            // Show success notification
            if (notification) {
                notification.className = 'mt-2 alert alert-success';
                notification.textContent = 'Photo imported successfully!';
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 3000);
            }
        } else {
            if (notification) {
                notification.className = 'mt-2 alert alert-danger';
                notification.textContent = data.error || 'Failed to import photo';
                notification.style.display = 'block';
            }
        }
    })
    .catch(error => {
        console.error('Error importing photo:', error);
        if (notification) {
            notification.className = 'mt-2 alert alert-danger';
            notification.textContent = 'Network error. Please try again.';
            notification.style.display = 'block';
        }
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    });
});

// Destroy existing intl-tel-input instance to prevent memory leaks
function destroyIntlTelInput() {
    if (window.itiInstance) {
        try {
            window.itiInstance.destroy();
            console.log('intl-tel-input: Previous instance destroyed');
        } catch (e) {
            console.warn('intl-tel-input: Could not destroy previous instance', e);
        }
        window.itiInstance = null;
    }
}

// Initialize intl-tel-input for phone number field
function initIntlTelInput() {
    // Check if library is loaded first
    if (typeof window.intlTelInput !== 'function') {
        console.log('intl-tel-input: Library not loaded yet');
        return;
    }

    // Find the phone input - must be the actual form field with proper ID
    const phoneInput = document.getElementById('id_phone_number');

    // Exit early if no editable phone input exists (e.g., phone is verified and locked)
    if (!phoneInput) {
        console.log('intl-tel-input: No editable phone input found (phone may be verified)');
        return;
    }

    // Double-check it's not readonly/disabled
    if (phoneInput.readOnly || phoneInput.disabled || phoneInput.type === 'hidden') {
        console.log('intl-tel-input: Phone input is readonly/disabled/hidden');
        return;
    }

    // Skip if already initialized on this exact element
    if (phoneInput.dataset.itiInitialized === 'true' && window.itiInstance) {
        console.log('intl-tel-input: Already initialized on this element');
        return;
    }

    // Destroy any existing instance before creating a new one (prevents memory leak)
    destroyIntlTelInput();

    // Reset initialization flag (in case DOM was replaced by HTMX)
    delete phoneInput.dataset.itiInitialized;

    console.log('intl-tel-input: Initializing for phone input:', phoneInput.id);

    // Store pre-filled value
    const prefilledValue = phoneInput.value || '';
    phoneInput.value = '';

    // Track initialization state to prevent race conditions
    let isDestroyed = false;

    try {
        const iti = window.intlTelInput(phoneInput, {
            initialCountry: "lu",  // Use static default to avoid geoIpLookup race conditions
            preferredCountries: ["lu", "de", "fr", "be"],
            onlyCountries: ["lu", "de", "fr", "be", "nl", "ch", "at", "it", "es", "pt", "gb", "ie", "us", "ca", "se", "dz"],
            separateDialCode: true,
            nationalMode: false,
            formatOnDisplay: true,
            autoPlaceholder: "aggressive",
            utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.5.3/build/js/utils.js"
        });

        // Mark as initialized
        phoneInput.dataset.itiInitialized = 'true';
        window.itiInstance = iti;

        // Set pre-filled value after utils load
        iti.promise.then(function() {
            // Check if instance was destroyed during async load
            if (isDestroyed || !window.itiInstance) {
                console.log('intl-tel-input: Instance was destroyed during init');
                return;
            }

            // Matches --intl-tel-input-padding CSS variable in intl-tel-input.css
            phoneInput.style.setProperty('padding-left', '110px', 'important');

            if (prefilledValue) {
                let numberToSet = prefilledValue.trim().replace(/\s/g, '');
                if (!numberToSet.startsWith('+')) {
                    if (numberToSet.startsWith('00')) {
                        numberToSet = '+' + numberToSet.slice(2);
                    } else {
                        numberToSet = '+352' + numberToSet.replace(/^0+/, '');
                    }
                }
                iti.setNumber(numberToSet);
            }
        }).catch(function(err) {
            console.warn('intl-tel-input: Utils loading error', err);
        });

        // Update hidden field with full international number on form submit
        const form = phoneInput.closest('form');
        if (form && !form.dataset.itiSubmitHandler) {
            form.dataset.itiSubmitHandler = 'true';
            form.addEventListener('submit', function() {
                if (window.itiInstance && window.itiInstance.isValidNumber && window.itiInstance.isValidNumber()) {
                    phoneInput.value = window.itiInstance.getNumber();
                }
            });
        }
    } catch (err) {
        console.error('intl-tel-input: Initialization error', err);
    }
}

// Initialize on page load - wait for DOM and library to be ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initIntlTelInput);
} else {
    // DOM already loaded, init immediately
    initIntlTelInput();
}

// Reinitialize after HTMX swaps (in case the form is replaced)
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'form-container') {
        // Small delay to ensure DOM is updated
        setTimeout(initIntlTelInput, 100);
    }
});
</script>
{% endblock %}

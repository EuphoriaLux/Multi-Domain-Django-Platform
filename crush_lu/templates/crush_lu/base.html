<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Crush.lu - Meet New People{% endblock %}</title>

    <!-- Favicon -->
    {% load static %}
    {% load i18n %}
    <link rel="icon" type="image/x-icon" href="{% static 'crush_lu/crush_favicon.ico' %}">

    <!-- SEO: Canonical URL (prevents duplicate content issues) -->
    <link rel="canonical" href="{% block canonical_url %}https://crush.lu{{ request.path }}{% endblock %}">

    <!-- SEO: Hreflang tags for multi-language support -->
    {% block hreflang_tags %}
    <link rel="alternate" hreflang="en" href="https://crush.lu/en{{ request.path|slice:'3:' }}">
    <link rel="alternate" hreflang="de" href="https://crush.lu/de{{ request.path|slice:'3:' }}">
    <link rel="alternate" hreflang="fr" href="https://crush.lu/fr{{ request.path|slice:'3:' }}">
    <link rel="alternate" hreflang="x-default" href="https://crush.lu{{ request.path }}">
    {% endblock %}

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:url" content="https://crush.lu{{ request.path }}">
    <meta property="og:title" content="{% block og_title %}Crush.lu - Meet New People in Luxembourg{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Privacy-first dating platform for Luxembourg. Meet real people at organized events - no endless swiping, just authentic connections.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}https://crush.lu{% static 'crush_lu/crush_social_preview.jpg' %}{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:locale" content="{{ LANGUAGE_CODE|default:'en' }}_{{ LANGUAGE_CODE|default:'EN'|upper }}">
    <meta property="og:site_name" content="Crush.lu">
    <meta property="fb:app_id" content="1170910678282435">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://crush.lu{{ request.path }}">
    <meta property="twitter:title" content="{% block twitter_title %}Crush.lu - Meet New People in Luxembourg{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}Privacy-first dating platform for Luxembourg. Meet real people at organized events - no endless swiping, just authentic connections.{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}https://crush.lu{% static 'crush_lu/crush_social_preview.jpg' %}{% endblock %}">

    <!-- Additional SEO -->
    <meta name="description" content="{% block meta_description %}Privacy-first dating platform for Luxembourg. Coach-curated profiles and event-based meetups for authentic connections.{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}dating luxembourg, meetups luxembourg, singles events, crush.lu, dating events, speed dating luxembourg, singles events luxembourg{% endblock %}">
    <meta name="robots" content="{% block meta_robots %}index, follow{% endblock %}">
    <meta name="author" content="Crush.lu">
    <meta name="geo.region" content="LU">
    <meta name="geo.placename" content="Luxembourg">

    <!-- Schema.org Organization Structured Data (JSON-LD) -->
    {% block structured_data %}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Crush.lu",
        "alternateName": "Crush Luxembourg",
        "url": "https://crush.lu",
        "logo": "https://crush.lu{% static 'crush_lu/icons/icon-512x512.png' %}",
        "description": "Privacy-first dating platform for Luxembourg. Meet real people at organized events - no endless swiping, just authentic connections.",
        "foundingDate": "2024",
        "areaServed": {
            "@type": "Country",
            "name": "Luxembourg"
        },
        "sameAs": [],
        "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "customer service",
            "email": "love@crush.lu",
            "availableLanguage": ["English", "German", "French"]
        }
    }
    </script>
    {% endblock %}

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#9B59B6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Crush.lu">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="{% static 'crush_lu/manifest.json' %}">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'crush_lu/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'crush_lu/icons/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="144x144" href="{% static 'crush_lu/icons/icon-144x144.png' %}">
    <link rel="apple-touch-icon" sizes="128x128" href="{% static 'crush_lu/icons/icon-128x128.png' %}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Crush.lu Custom Styles -->
    <link rel="stylesheet" href="{% static 'crush_lu/css/crush.css' %}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Loading Overlay -->
    <div id="page-loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-heart">üíï</div>
            <div class="loading-text">Loading...</div>
            <div class="loading-subtext">Just a moment</div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            {% if user.is_authenticated %}
                <a class="navbar-brand" href="{% url 'crush_lu:dashboard' %}">üíï Crush.lu</a>
            {% else %}
                <a class="navbar-brand" href="{% url 'crush_lu:home' %}">üíï Crush.lu</a>
            {% endif %}
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if user.is_authenticated %}
                        {# Check if user is a coach #}
                        {% if user.crushcoach and user.crushcoach.is_active %}
                            {# COACH NAVIGATION #}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'crush_lu:coach_dashboard' %}">
                                    <i class="bi bi-speedometer2"></i> Coach Dashboard
                                    {% if pending_screening_count > 0 %}
                                        <span class="badge bg-warning text-dark rounded-pill">{{ pending_screening_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            {% if has_special_journey %}
                            <li class="nav-item">
                                <a class="nav-link special-journey" href="{% url 'crush_lu:journey_map' %}">
                                    <i class="bi bi-star-fill" style="color: gold;"></i> Special Journey
                                    {% if not journey_started %}
                                        <span class="badge bg-warning text-dark">New!</span>
                                    {% endif %}
                                </a>
                            </li>
                            {% endif %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'crush_lu:coach_sessions' %}">
                                    <i class="bi bi-calendar-check"></i> My Sessions
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'crush_lu:event_list' %}">
                                    <i class="bi bi-calendar-event"></i> Events
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="coachToolsDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-tools"></i> Coach Tools
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="{% url 'crush_lu:coach_dashboard' %}">
                                        <i class="bi bi-clipboard-check"></i> Review Queue
                                        {% if pending_screening_count > 0 %}
                                            <span class="badge bg-warning text-dark rounded-pill ms-2">{{ pending_screening_count }}</span>
                                        {% endif %}
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'crush_lu:coach_journey_dashboard' %}">
                                        <i class="bi bi-map"></i> Journey Management
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'crush_lu:coach_sessions' %}">
                                        <i class="bi bi-chat-dots"></i> All Sessions
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'crush_lu:event_list' %}">
                                        <i class="bi bi-calendar3"></i> Manage Events
                                    </a></li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="coachDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle"></i> {{ user.first_name|default:user.username }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="{% url 'crush_lu:logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                                </ul>
                            </li>
                        {% else %}
                            {# DATING USER NAVIGATION #}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'crush_lu:dashboard' %}">
                                    <i class="bi bi-house-heart"></i> Dashboard
                                    {% if profile_needs_action %}
                                        <span class="badge bg-warning text-dark rounded-pill" title="Profile needs revision">!</span>
                                    {% endif %}
                                </a>
                            </li>
                            {% if has_special_journey %}
                            <li class="nav-item">
                                <a class="nav-link special-journey" href="{% url 'crush_lu:journey_map' %}">
                                    <i class="bi bi-star-fill" style="color: gold;"></i> Special Journey
                                    {% if not journey_started %}
                                        <span class="badge bg-warning text-dark">New!</span>
                                    {% endif %}
                                </a>
                            </li>
                            {% endif %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="eventsDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-calendar-event"></i> Events
                                    {% if upcoming_events_count > 0 %}
                                        <span class="badge bg-info rounded-pill">{{ upcoming_events_count }}</span>
                                    {% endif %}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li class="dropdown-header">Upcoming Events</li>
                                    {% if upcoming_events %}
                                        {% for registration in upcoming_events %}
                                            <li>
                                                <a class="dropdown-item" href="{% url 'crush_lu:event_detail' registration.event.id %}">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <strong>{{ registration.event.title|truncatewords:4 }}</strong>
                                                            <br>
                                                            <small class="text-muted">
                                                                {{ registration.event.date_time|date:"M d, g:i A" }}
                                                            </small>
                                                        </div>
                                                        {% if registration.status == 'waitlist' %}
                                                            <span class="badge bg-secondary ms-2">Waitlist</span>
                                                        {% else %}
                                                            <span class="badge bg-success ms-2">‚úì</span>
                                                        {% endif %}
                                                    </div>
                                                </a>
                                            </li>
                                        {% endfor %}
                                        <li><hr class="dropdown-divider"></li>
                                    {% else %}
                                        <li><span class="dropdown-item-text text-muted">No upcoming events</span></li>
                                        <li><hr class="dropdown-divider"></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="{% url 'crush_lu:event_list' %}">
                                        <i class="bi bi-search"></i> Browse All Events
                                    </a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'crush_lu:my_connections' %}">
                                    <i class="bi bi-people"></i> Connections
                                    {% if pending_requests_count > 0 %}
                                        <span class="badge bg-danger rounded-pill">{{ pending_requests_count }}</span>
                                    {% endif %}
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle"></i> {{ user.first_name|default:user.username }}
                                    {% if profile_status == 'pending' %}
                                        <span class="badge bg-info" title="Profile pending review">‚è≥</span>
                                    {% elif profile_status == 'rejected' %}
                                        <span class="badge bg-danger" title="Profile rejected">‚úó</span>
                                    {% elif profile_status == 'revision' %}
                                        <span class="badge bg-warning text-dark" title="Profile needs revision">!</span>
                                    {% elif profile_is_approved %}
                                        <span class="badge bg-success" title="Profile approved">‚úì</span>
                                    {% endif %}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% if user.crushprofile %}
                                        <li class="dropdown-header">
                                            Profile Status:
                                            {% if profile_status == 'pending' %}
                                                <span class="text-info">Pending Review</span>
                                            {% elif profile_status == 'rejected' %}
                                                <span class="text-danger">Rejected</span>
                                            {% elif profile_status == 'revision' %}
                                                <span class="text-warning">Needs Revision</span>
                                            {% elif profile_is_approved %}
                                                <span class="text-success">Approved ‚úì</span>
                                            {% else %}
                                                <span class="text-muted">Not Submitted</span>
                                            {% endif %}
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="{% url 'crush_lu:edit_profile' %}"><i class="bi bi-pencil"></i> Edit Profile</a></li>
                                    {% else %}
                                        <li><a class="dropdown-item" href="{% url 'crush_lu:create_profile' %}"><i class="bi bi-person-plus"></i> Create Profile</a></li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'crush_lu:logout' %}"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                                </ul>
                            </li>
                        {% endif %}
                    {% else %}
                        {# GUEST NAVIGATION #}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'crush_lu:about' %}">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'crush_lu:how_it_works' %}">How It Works</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'crush_lu:event_list' %}">Events</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'crush_lu:login' %}">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link px-3 btn btn-light text-dark rounded-pill" href="{% url 'crush_lu:signup' %}">
                                <strong>Join Now</strong>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main class="container my-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>üíï Crush.lu</h5>
                    <p>Meet new people. Make real connections.</p>
                </div>
                <div class="col-md-3">
                    <h6>Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'crush_lu:about' %}" class="text-white-50">About Us</a></li>
                        <li><a href="{% url 'crush_lu:how_it_works' %}" class="text-white-50">How It Works</a></li>
                        <li><a href="{% url 'crush_lu:event_list' %}" class="text-white-50">Events</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Legal</h6>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'crush_lu:privacy_policy' %}" class="text-white-50">Privacy Policy</a></li>
                        <li><a href="{% url 'crush_lu:terms_of_service' %}" class="text-white-50">Terms of Service</a></li>
                        <li><a href="{% url 'crush_lu:data_deletion' %}" class="text-white-50">Data Deletion</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Privacy First</h6>
                    <p class="text-white-50">Your privacy matters. All profiles are reviewed by our Crush Coaches.</p>
                </div>
            </div>
            <hr class="bg-white-50">
            <div class="text-center">
                <small>&copy; 2025 Crush.lu - Made with üíï in Luxembourg</small>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Sortable.js for drag-and-drop with touch support -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

    <!-- Crush.lu Utilities (CSRF, sanitization, logging) -->
    <script src="{% static 'crush_lu/js/utils.js' %}"></script>

    <!-- PWA Mode Detector (must load early) -->
    <script src="{% static 'crush_lu/js/pwa-detector.js' %}"></script>

    <!-- Page Loading Indicator -->
    <script src="{% static 'crush_lu/js/page-loading.js' %}"></script>

    <!-- Push Notifications (PWA) -->
    <script src="{% static 'crush_lu/js/push-notifications.js' %}"></script>

    <!-- PWA Install Prompt -->
    <script src="{% static 'crush_lu/js/pwa-install.js' %}"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        // Register Workbox service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Register from root path to control entire site
                navigator.serviceWorker.register('/sw-workbox.js', { scope: '/' })
                    .then(function(registration) {
                        console.log('[PWA] Workbox Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            console.log('[PWA] New service worker version found');

                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available, trigger skip waiting
                                    console.log('[PWA] New version available - activating update');
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('[PWA] Service Worker registration failed:', error);
                    });

                // Handle service worker updates - reload when new SW takes control
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', function() {
                    if (!refreshing) {
                        refreshing = true;
                        console.log('[PWA] New service worker activated - reloading page');
                        window.location.reload();
                    }
                });
            });
        }

        // Install prompt handler
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            console.log('[PWA] Install prompt available');

            // Optionally, show a custom install button
            // You could add a UI element here to prompt installation
        });

        window.addEventListener('appinstalled', function() {
            console.log('[PWA] Crush.lu installed as PWA');
            deferredPrompt = null;
        });

        // ============================================================================
        // Network Status Detection - Auto-reload when back online
        // ============================================================================

        let wasOffline = false;
        let serverCheckInterval = null;

        // Function to check if server is reachable
        async function checkServerConnection() {
            try {
                // BYPASS service worker by adding timestamp - forces network request
                const timestamp = new Date().getTime();
                const response = await fetch('/healthz/?_=' + timestamp, {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                console.log('[PWA] Health check response:', response.status);
                return response.ok;
            } catch (e) {
                console.log('[PWA] Health check failed:', e.message);
                return false;
            }
        }

        // Detect when going offline (network interface down)
        window.addEventListener('offline', function() {
            wasOffline = true;
            console.log('[PWA] Network connection lost - you are now offline');
        });

        // Detect when coming back online (network interface up)
        window.addEventListener('online', function() {
            console.log('[PWA] Network connection restored - you are back online');

            if (wasOffline) {
                // Only reload if we were previously offline
                console.log('[PWA] Auto-reloading page with fresh content...');
                setTimeout(function() {
                    window.location.reload();
                }, 500); // Small delay to ensure connection is stable
            }

            wasOffline = false;
        });

        // Monitor service worker messages for offline detection
        if (navigator.serviceWorker) {
            navigator.serviceWorker.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'SERVER_UNREACHABLE') {
                    if (!wasOffline) {
                        wasOffline = true;
                        console.log('[PWA] Server unreachable - working in offline mode');

                        // Start polling to detect when server comes back
                        if (serverCheckInterval) clearInterval(serverCheckInterval);
                        console.log('[PWA] Starting server reconnection polling (every 5 seconds)...');
                        serverCheckInterval = setInterval(async function() {
                            console.log('[PWA] Checking if server is back online...');
                            const isOnline = await checkServerConnection();
                            console.log('[PWA] Server online status:', isOnline);
                            if (isOnline) {
                                console.log('[PWA] ‚úÖ Server is back online - reloading...');
                                clearInterval(serverCheckInterval);
                                wasOffline = false;
                                window.location.reload();
                            }
                        }, 5000); // Check every 5 seconds
                    }
                }
            });
        }

        // Check initial network status on page load
        if (!navigator.onLine) {
            wasOffline = true;
            console.log('[PWA] Starting in offline mode');
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>

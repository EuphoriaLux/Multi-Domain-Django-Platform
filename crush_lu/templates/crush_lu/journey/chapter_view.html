{% extends "crush_lu/journey/journey_base.html" %}
{% load static i18n %}

{% block extra_journey_css %}
<style>
    /* Page-specific: Dynamic background themes based on chapter */
    {% if chapter.background_theme == 'wonderland_night' %}
    body.journey-bg { background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); }
    {% elif chapter.background_theme == 'enchanted_garden' %}
    body.journey-bg { background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 50%, #c471f5 100%); }
    {% elif chapter.background_theme == 'art_gallery' %}
    body.journey-bg { background: linear-gradient(135deg, #1e1e1e 0%, #3a2f2f 50%, #2d2424 100%); }
    {% elif chapter.background_theme == 'carnival' %}
    body.journey-bg { background: linear-gradient(135deg, #4a148c 0%, #d32f2f 50%, #f57c00 100%); }
    {% elif chapter.background_theme == 'starlit_sky' %}
    body.journey-bg { background: linear-gradient(135deg, #000428 0%, #004e92 50%, #000428 100%); }
    {% elif chapter.background_theme == 'magical_door' %}
    body.journey-bg { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%); }
    {% endif %}

    /* Page-specific: Challenge card with completion state (pure CSS - no @apply) */
    .challenge-card {
        position: relative;
        padding: 1.5rem;
        padding-top: 3rem;
        margin-bottom: 1.25rem;
        border-radius: 1rem;
        border: 2px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    .challenge-card:hover {
        transform: translateY(-0.25rem);
        box-shadow: var(--shadow-journey-glow-purple);
    }
    .challenge-card.completed {
        border-color: var(--color-journey-success);
        background: rgba(46, 204, 113, 0.1);
    }

    /* Page-specific: Reward card with golden theme */
    .reward-card {
        padding: 2rem;
        margin-bottom: 1.25rem;
        border-radius: 1rem;
        text-align: center;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        background: rgba(255, 215, 0, 0.1);
        border: 2px solid rgba(255, 215, 0, 0.3);
    }

    /* Page-specific: Final response buttons (Chapter 6) */
    .final-response-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1.25rem 2.5rem;
        border-radius: 30px;
        font-size: 1.25rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        min-width: 280px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    .final-response-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    .final-response-btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5), 0 0 0 4px rgba(255, 255, 255, 0.25);
    }
    .final-response-yes {
        background: linear-gradient(135deg, var(--color-crush-pink), #C850C0);
    }
    .final-response-yes:hover:not(:disabled) {
        transform: translateY(-0.25rem) scale(1.05);
        box-shadow: 0 15px 40px rgba(255, 107, 157, 0.5);
    }
    .final-response-thinking {
        background: linear-gradient(135deg, var(--color-crush-purple), #667eea);
    }
    .final-response-thinking:hover:not(:disabled) {
        transform: translateY(-0.25rem) scale(1.05);
        box-shadow: 0 15px 40px rgba(155, 89, 182, 0.5);
    }

    @media (max-width: 768px) {
        .final-response-btn {
            width: 100%;
            min-width: 0;
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }
    }
</style>
{% endblock %}

{% block journey_content %}
<!-- Back to Map -->
<nav class="text-center mb-6" aria-label="{% trans 'Navigation' %}">
    <a href="{% url 'crush_lu:journey_map' %}" class="journey-nav-btn">
        {% include "shared/icons/arrow-left.html" with class="w-5 h-5" %}
        {% trans "Back to Journey Map" %}
    </a>
</nav>

<!-- Chapter Header -->
<header class="text-center my-10 journey-animate-fade-in">
    <p class="text-lg text-white/70 mb-2.5">
        {% blocktrans with num=chapter.chapter_number total=journey_progress.journey.total_chapters %}Chapter {{ num }} of {{ total }}{% endblocktrans %}
    </p>
    <h1 class="journey-title">{{ chapter.title }}</h1>
    <p class="journey-subtitle">{{ chapter.theme }}</p>
</header>

<!-- Story Introduction -->
<section class="journey-card journey-container-narrow mx-auto journey-animate-fade-in" style="animation-delay: 0.2s;" aria-labelledby="story-heading">
    <h2 id="story-heading" class="sr-only">{% trans "Story Introduction" %}</h2>
    <div class="text-lg md:text-xl leading-relaxed italic text-crush-light">
        {{ chapter.story_introduction|linebreaks }}
    </div>
</section>

<!-- Challenges Section -->
{% if challenges %}
<section class="journey-container-content my-10 journey-animate-fade-in" style="animation-delay: 0.4s;" aria-labelledby="challenges-heading">
    <h2 id="challenges-heading" class="text-2xl md:text-3xl text-center mb-8 text-crush-light">
        {% if is_completed %}
            {% trans "Completed Challenges" %} &#x2705;
        {% else %}
            {% trans "Your Challenges" %}
        {% endif %}
    </h2>

    {% for challenge in challenges %}
    <article class="challenge-card {% if challenge.id in challenge_attempts %}completed{% endif %}">
        {% if challenge.id in challenge_attempts %}
        <div class="absolute top-2.5 right-2.5 bg-crush-success text-white py-1 px-4 rounded-full text-sm font-bold flex items-center gap-1">
            {% include "shared/icons/check-circle.html" with class="w-4 h-4" %}
            {% trans "Completed" %}
        </div>
        {% endif %}

        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <span class="journey-badge">
                {% include "shared/icons/puzzle-piece.html" with class="w-4 h-4" %}
                {{ challenge.get_challenge_type_display }}
            </span>
            <span class="text-lg font-bold text-crush-pink flex items-center gap-1">
                {% include "shared/icons/sparkles.html" with class="w-4 h-4" %}
                {% blocktrans with points=challenge.points_awarded %}{{ points }} points{% endblocktrans %}
            </span>
        </div>

        <p class="text-lg leading-relaxed mb-4">
            {{ challenge.question|truncatewords:30 }}
        </p>

        {% if challenge.id in challenge_attempts %}
            <p class="text-crush-success mt-2.5 flex items-center gap-1">
                {% include "shared/icons/check.html" with class="w-5 h-5" %}
                {% trans "You solved this challenge!" %}
            </p>
        {% else %}
            <a href="{% url 'crush_lu:challenge_view' chapter.chapter_number challenge.id %}"
               class="journey-btn-primary inline-flex items-center gap-2">
                {% trans "Start Challenge" %}
                {% include "shared/icons/arrow-right.html" with class="w-5 h-5" %}
            </a>
        {% endif %}
    </article>
    {% endfor %}
</section>
{% endif %}

<!-- Completion Message -->
{% if is_completed %}
<section class="journey-message-success journey-container-narrow mx-auto my-10 p-10 text-center journey-animate-fade-in" style="animation-delay: 0.6s;" aria-labelledby="completion-heading">
    <div class="text-5xl mb-5" aria-hidden="true">&#127881;</div>
    <h2 id="completion-heading" class="text-2xl font-bold mb-4">{% trans "Chapter Complete!" %}</h2>
    <div class="text-xl leading-relaxed italic my-5">
        {{ chapter.completion_message|linebreaks }}
    </div>

    <!-- Chapter 6 Final Response (Special Handling) -->
    {% if chapter.chapter_number == 6 and not journey_progress.final_response %}
    <div id="finalResponseSection" class="mt-10">
        <div class="bg-crush-pink/10 border-2 border-crush-pink/30 rounded-2xl p-10 mt-8">
            <h3 class="text-2xl md:text-3xl mb-5 text-crush-purple">&#128171; {% trans "The Final Question" %} &#128171;</h3>
            <div class="text-xl leading-relaxed mb-8">
                {{ journey_progress.journey.final_message|linebreaks }}
            </div>
            <p class="text-lg font-bold mb-8">
                {% trans "Will you give this a chance?" %}
            </p>
            <div class="flex gap-5 justify-center flex-wrap">
                <button onclick="submitFinalResponse('yes')" class="final-response-btn final-response-yes" id="btnYes">
                    {% include "shared/icons/heart.html" with class="w-5 h-5" %}
                    {% trans "Yes, let's see where this goes" %} &#128171;
                </button>
                <button onclick="submitFinalResponse('thinking')" class="final-response-btn final-response-thinking" id="btnThinking">
                    {% include "shared/icons/hourglass.html" with class="w-5 h-5" %}
                    {% trans "I need to think about this" %} &#10024;
                </button>
            </div>
            <div id="responseStatus" class="mt-5 text-lg" role="status" aria-live="polite"></div>
        </div>
    </div>
    {% elif chapter.chapter_number == 6 and journey_progress.final_response %}
    <div class="mt-8 p-8 bg-crush-success/10 border-2 border-crush-success/30 rounded-2xl">
        <h3 class="text-xl font-bold mb-4">&#128150; {% trans "Your Response" %}</h3>
        <p class="text-lg">
            {% if journey_progress.final_response == 'yes' %}
                {% trans "You chose:" %} <strong>"{% trans "Yes, let's see where this goes" %} &#128171;"</strong>
            {% else %}
                {% trans "You chose:" %} <strong>"{% trans "I need to think about this" %} &#10024;"</strong>
            {% endif %}
        </p>
        <p class="text-sm opacity-80 mt-2.5">
            {% trans "Responded on" %} {{ journey_progress.final_response_at|date:"F j, Y \a\t g:i A" }}
        </p>
    </div>
    {% endif %}

    <!-- Show Rewards -->
    {% if rewards %}
    <div class="mt-8">
        <h3 class="text-xl font-bold mb-5">&#10024; {% trans "Rewards Unlocked" %} &#10024;</h3>
        {% for reward in rewards %}
        <article class="reward-card">
            <div class="text-5xl mb-4" aria-hidden="true">
                {% if reward.reward_type == 'photo_reveal' %}&#128247;
                {% elif reward.reward_type == 'poem' %}&#128220;
                {% elif reward.reward_type == 'voice_message' %}&#127925;
                {% elif reward.reward_type == 'video_message' %}&#127916;
                {% elif reward.reward_type == 'photo_slideshow' %}&#128444;&#65039;
                {% elif reward.reward_type == 'future_letter' %}&#128140;
                {% else %}&#127873;
                {% endif %}
            </div>
            <h4 class="text-2xl font-bold mb-2.5">{{ reward.title }}</h4>
            <a href="{% url 'crush_lu:reward_view' reward.id %}" class="journey-btn-primary inline-flex items-center gap-2 mt-4">
                {% trans "View Reward" %}
                {% include "shared/icons/gift.html" with class="w-5 h-5" %}
            </a>
        </article>
        {% endfor %}
    </div>
    {% endif %}
</section>
{% endif %}

<!-- Navigation -->
<nav class="flex flex-col md:flex-row justify-between gap-4 journey-container-narrow mx-auto my-10" aria-label="{% trans 'Chapter navigation' %}">
    {% if chapter.chapter_number > 1 %}
        <a href="{% url 'crush_lu:chapter_view' chapter.chapter_number|add:"-1" %}" class="journey-nav-btn">
            {% include "shared/icons/arrow-left.html" with class="w-5 h-5" %}
            {% trans "Previous Chapter" %}
        </a>
    {% else %}
        <div></div>
    {% endif %}

    {% if is_completed and chapter.chapter_number < journey_progress.journey.total_chapters %}
        <a href="{% url 'crush_lu:chapter_view' chapter.chapter_number|add:"1" %}" class="journey-nav-btn">
            {% trans "Next Chapter" %}
            {% include "shared/icons/arrow-right.html" with class="w-5 h-5" %}
        </a>
    {% elif is_completed %}
        <a href="{% url 'crush_lu:journey_map' %}" class="journey-nav-btn">
            {% include "shared/icons/map.html" with class="w-5 h-5" %}
            {% trans "Return to Map" %}
        </a>
    {% else %}
        <div></div>
    {% endif %}
</nav>
{% endblock %}

{% block extra_journey_js %}
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chapter {{ chapter.chapter_number }} loaded');
});

// Final Response Submission (Chapter 6)
function submitFinalResponse(response) {
    var btnYes = document.getElementById('btnYes');
    var btnThinking = document.getElementById('btnThinking');
    var statusDiv = document.getElementById('responseStatus');

    // Disable both buttons
    btnYes.disabled = true;
    btnThinking.disabled = true;

    // Show loading message (use emoji instead of SVG to avoid multi-line string issues)
    statusDiv.innerHTML = '\u23F3 {% trans "Submitting your response..." %}';
    statusDiv.style.color = 'var(--color-crush-pink)';

    fetch('{% url "crush_lu:api_record_final_response" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': CrushUtils.getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ response: response })
    })
    .then(function(apiResponse) { return apiResponse.json(); })
    .then(function(data) {
        if (data.success) {
            // Show success message
            statusDiv.innerHTML = '\u2705 {% trans "Thank you for your response!" %} \uD83D\uDC96';
            statusDiv.style.color = 'var(--color-crush-success)';

            // Reload page after 2 seconds to show the confirmed response
            setTimeout(function() {
                window.location.reload();
            }, 2000);
        } else {
            // Show error
            statusDiv.innerHTML = '\u26A0\uFE0F ' + (data.message || '{% trans "An error occurred. Please try again." %}');
            statusDiv.style.color = 'var(--color-crush-danger)';

            // Re-enable buttons
            btnYes.disabled = false;
            btnThinking.disabled = false;
        }
    })
    .catch(function(error) {
        console.error('Error submitting final response:', error);
        statusDiv.innerHTML = '\u26A0\uFE0F {% trans "Network error. Please check your connection and try again." %}';
        statusDiv.style.color = 'var(--color-crush-danger)';

        // Re-enable buttons
        btnYes.disabled = false;
        btnThinking.disabled = false;
    });
}
</script>
{% endblock %}

{% extends "crush_lu/base.html" %}
{% load static %}

{% block title %}Email Preferences - Crush.lu{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            {% if error %}
            <!-- Invalid token error -->
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-exclamation-circle text-danger" style="font-size: 4rem;"></i>
                    <h2 class="mt-3">Invalid Unsubscribe Link</h2>
                    <p class="text-muted">
                        This unsubscribe link is invalid or has expired.
                    </p>
                    <p>
                        If you need to manage your email preferences, please
                        <a href="{% url 'crush_lu:login' %}">log in to your account</a>
                        and visit your account settings.
                    </p>
                    <a href="{% url 'crush_lu:home' %}" class="btn btn-crush-primary mt-3">
                        <i class="bi bi-house me-2"></i>Go to Homepage
                    </a>
                </div>
            </div>

            {% elif success %}
            <!-- Success message -->
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                    <h2 class="mt-3">Preferences Updated!</h2>

                    {% if email_prefs.unsubscribed_all %}
                    <p class="text-muted">
                        You have been unsubscribed from all Crush.lu emails.
                    </p>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Changed your mind? You can re-subscribe below.
                    </div>
                    <form method="post" class="mt-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="resubscribe">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-bell me-2"></i>Re-subscribe to Emails
                        </button>
                    </form>
                    {% else %}
                    <p class="text-muted">
                        Your email preferences have been updated successfully.
                    </p>
                    {% endif %}

                    <hr class="my-4">
                    <p class="small text-muted mb-0">
                        Want more control?
                        <a href="{% url 'crush_lu:login' %}">Log in</a>
                        to manage all your notification settings.
                    </p>
                </div>
            </div>

            {% else %}
            <!-- Unsubscribe options -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h4 class="mb-0">
                        <i class="bi bi-envelope-slash me-2"></i>Email Preferences
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Hi{% if user.first_name %} {{ user.first_name }}{% endif %}! Choose how you'd like to manage your email preferences:
                    </p>

                    {% if email_prefs.unsubscribed_all %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        You are currently unsubscribed from all emails.
                    </div>

                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="resubscribe">
                        <button type="submit" class="btn btn-crush-primary w-100">
                            <i class="bi bi-bell me-2"></i>Re-subscribe to Emails
                        </button>
                    </form>

                    {% else %}
                    <!-- Current subscription status -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Your current email subscriptions:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                {% if email_prefs.email_profile_updates %}
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                {% else %}
                                <i class="bi bi-x-circle-fill text-muted me-2"></i>
                                {% endif %}
                                Profile Updates
                            </li>
                            <li class="mb-2">
                                {% if email_prefs.email_event_reminders %}
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                {% else %}
                                <i class="bi bi-x-circle-fill text-muted me-2"></i>
                                {% endif %}
                                Event Reminders
                            </li>
                            <li class="mb-2">
                                {% if email_prefs.email_new_connections %}
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                {% else %}
                                <i class="bi bi-x-circle-fill text-muted me-2"></i>
                                {% endif %}
                                New Connections
                            </li>
                            <li class="mb-2">
                                {% if email_prefs.email_new_messages %}
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                {% else %}
                                <i class="bi bi-x-circle-fill text-muted me-2"></i>
                                {% endif %}
                                New Messages
                            </li>
                            <li class="mb-2">
                                {% if email_prefs.email_marketing %}
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                {% else %}
                                <i class="bi bi-x-circle-fill text-muted me-2"></i>
                                {% endif %}
                                Marketing & Promotions
                            </li>
                        </ul>
                    </div>

                    <hr>

                    <!-- Unsubscribe options -->
                    <h6 class="text-muted mb-3">Quick unsubscribe options:</h6>

                    {% if email_prefs.email_marketing %}
                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="unsubscribe_marketing">
                        <button type="submit" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-megaphone-fill me-2"></i>Unsubscribe from Marketing Only
                        </button>
                        <small class="text-muted d-block mt-1">
                            You'll still receive important account and event notifications.
                        </small>
                    </form>
                    {% endif %}

                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="unsubscribe_all">
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-envelope-slash me-2"></i>Unsubscribe from ALL Emails
                        </button>
                        <small class="text-muted d-block mt-1">
                            You won't receive any emails from Crush.lu.
                        </small>
                    </form>
                    {% endif %}

                    <hr>

                    <p class="small text-muted text-center mb-0">
                        <i class="bi bi-gear me-1"></i>
                        For more detailed control,
                        <a href="{% url 'crush_lu:login' %}">log in</a>
                        and visit your
                        <a href="{% url 'crush_lu:account_settings' %}">account settings</a>.
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% extends 'crush_lu/advent/advent_base.html' %}
{% load static i18n %}

{% block title %}{% trans "Scan QR Code" %} - {{ calendar.calendar_title }}{% endblock %}

{% block advent_content %}
<div class="advent-header">
    <a href="{% url 'crush_lu:advent_calendar' %}" class="advent-back-btn">
        {% include "shared/icons/arrow-left.html" with class="w-5 h-5" %} {% trans "Back to Calendar" %}
    </a>
</div>

<div class="advent-content">
    <div class="container">
        <div class="qr-scanner-card">
            <h2 class="text-center mb-4">
                {% include "shared/icons/qr-code.html" with class="w-5 h-5" %} {% trans "Scan QR Code" %}
            </h2>

            <p class="text-center text-gray-600 dark:text-gray-300 mb-4">
                {% trans "Point your camera at the QR code on your physical gift to unlock bonus content!" %}
            </p>

            <!-- QR Scanner Video -->
            <div class="scanner-container">
                <video id="qr-video" playsinline></video>
                <div class="scanner-overlay">
                    <div class="scanner-frame"></div>
                </div>
            </div>

            <!-- Status messages -->
            <div id="scanner-status" class="text-center mt-3">
                <div class="scanning-indicator">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">{% trans "Scanning..." %}</span>
                    </div>
                    <span class="ml-2">{% trans "Looking for QR code..." %}</span>
                </div>
            </div>

            <!-- Manual input fallback -->
            <div class="manual-input mt-4">
                <p class="text-center text-gray-500 dark:text-gray-400 text-sm">
                    {% trans "Camera not working? Enter the code manually:" %}
                </p>
                <form id="manual-code-form" class="flex gap-2">
                    <input type="text" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" id="manual-code"
                           placeholder="{% trans "Enter code from QR" %}" autocomplete="off">
                    <button type="submit" class="btn-crush-primary px-4 py-2">
                        {% include "shared/icons/check.html" with class="w-5 h-5" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .qr-scanner-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        margin: 0 auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    html.dark .qr-scanner-card {
        background: rgba(30, 41, 59, 0.95);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    }

    .scanner-container {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        max-width: 350px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
    }

    #qr-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .scanner-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .scanner-frame {
        width: 70%;
        height: 70%;
        border: 3px solid #c41e3a;
        border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        animation: pulse-frame 2s infinite;
    }

    @keyframes pulse-frame {
        0%, 100% { border-color: #c41e3a; }
        50% { border-color: #ff6b6b; }
    }

    .scanning-indicator {
        display: inline-flex;
        align-items: center;
        color: #666;
    }

    html.dark .scanning-indicator {
        color: #9ca3af;
    }
</style>

<!-- QR Code Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    var statusEl = document.getElementById('scanner-status');
    var videoEl = document.getElementById('qr-video');

    var msgQrDetected = '{% trans "QR Code detected! Redirecting..." %}';
    var msgCameraDenied = '{% trans "Camera access denied. Please use manual input below." %}';
    var msgNoCamera = '{% trans "No camera found. Please use manual input below." %}';
    var msgCameraError = '{% trans "Could not access camera. Please use manual input." %}';

    // Initialize scanner
    var html5QrCode = new Html5Qrcode("qr-video");

    var config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1,
    };

    function onScanSuccess(decodedText, decodedResult) {
        // Stop scanning
        html5QrCode.stop();

        // Clear and safely update status element
        statusEl.textContent = '';
        var successDiv = document.createElement('div');
        successDiv.className = 'text-success';
        var message = document.createElement('div');
        message.className = 'mt-2';
        message.textContent = msgQrDetected;
        successDiv.appendChild(message);
        statusEl.appendChild(successDiv);

        // Extract token from URL or use as-is
        var token = decodedText;
        if (decodedText.includes('/advent/qr/')) {
            // Extract UUID from URL
            var match = decodedText.match(/\/advent\/qr\/([a-f0-9-]+)/i);
            if (match) {
                token = match[1];
            }
        }

        // Redirect to QR scan endpoint
        window.location.href = '{% url "crush_lu:advent_scan_qr" "00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', token);
    }

    function onScanError(errorMessage) {
        // Ignore scan errors (no QR found yet)
    }

    function showWarning(msg) {
        statusEl.textContent = '';
        var warningDiv = document.createElement('div');
        warningDiv.className = 'text-warning';
        warningDiv.textContent = msg;
        statusEl.appendChild(warningDiv);
    }

    // Start scanning
    Html5Qrcode.getCameras().then(function(devices) {
        if (devices && devices.length) {
            // Use back camera if available
            var backCamera = devices.find(function(d) { return d.label.toLowerCase().includes('back'); });
            var cameraId = backCamera ? backCamera.id : devices[0].id;

            html5QrCode.start(
                cameraId,
                config,
                onScanSuccess,
                onScanError
            ).catch(function(err) {
                console.error('Camera error:', err);
                showWarning(msgCameraDenied);
            });
        } else {
            showWarning(msgNoCamera);
        }
    }).catch(function(err) {
        console.error('Camera enumeration error:', err);
        showWarning(msgCameraError);
    });

    // Manual code form
    document.getElementById('manual-code-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var code = document.getElementById('manual-code').value.trim();
        if (code) {
            window.location.href = '{% url "crush_lu:advent_scan_qr" "00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', code);
        }
    });
});
</script>
{% endblock %}

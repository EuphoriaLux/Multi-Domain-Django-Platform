{% extends 'crush_lu/advent/advent_base.html' %}
{% load static %}

{% block title %}Scan QR Code - {{ calendar.calendar_title }}{% endblock %}

{% block advent_content %}
<div class="advent-header">
    <a href="{% url 'crush_lu:advent_calendar' %}" class="advent-back-btn">
        <i class="bi bi-arrow-left"></i> Back to Calendar
    </a>
</div>

<div class="advent-content">
    <div class="container">
        <div class="qr-scanner-card">
            <h2 class="text-center mb-4">
                <i class="bi bi-qr-code-scan"></i> Scan QR Code
            </h2>

            <p class="text-center text-muted mb-4">
                Point your camera at the QR code on your physical gift to unlock bonus content!
            </p>

            <!-- QR Scanner Video -->
            <div class="scanner-container">
                <video id="qr-video" playsinline></video>
                <div class="scanner-overlay">
                    <div class="scanner-frame"></div>
                </div>
            </div>

            <!-- Status messages -->
            <div id="scanner-status" class="text-center mt-3">
                <div class="scanning-indicator">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Scanning...</span>
                    </div>
                    <span class="ms-2">Looking for QR code...</span>
                </div>
            </div>

            <!-- Manual input fallback -->
            <div class="manual-input mt-4">
                <p class="text-center text-muted small">
                    Camera not working? Enter the code manually:
                </p>
                <form id="manual-code-form" class="d-flex gap-2">
                    <input type="text" class="form-control" id="manual-code"
                           placeholder="Enter code from QR" autocomplete="off">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .qr-scanner-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        margin: 0 auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .scanner-container {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        max-width: 350px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
    }

    #qr-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .scanner-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
    }

    .scanner-frame {
        width: 70%;
        height: 70%;
        border: 3px solid #c41e3a;
        border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        animation: pulse-frame 2s infinite;
    }

    @keyframes pulse-frame {
        0%, 100% { border-color: #c41e3a; }
        50% { border-color: #ff6b6b; }
    }

    .scanning-indicator {
        display: inline-flex;
        align-items: center;
        color: #666;
    }
</style>

<!-- QR Code Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusEl = document.getElementById('scanner-status');
    const videoEl = document.getElementById('qr-video');

    // Initialize scanner
    const html5QrCode = new Html5Qrcode("qr-video");

    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1,
    };

    function onScanSuccess(decodedText, decodedResult) {
        // Stop scanning
        html5QrCode.stop();

        statusEl.innerHTML = `
            <div class="text-success">
                <i class="bi bi-check-circle fs-4"></i>
                <div class="mt-2">QR Code detected! Redirecting...</div>
            </div>
        `;

        // Extract token from URL or use as-is
        let token = decodedText;
        if (decodedText.includes('/advent/qr/')) {
            // Extract UUID from URL
            const match = decodedText.match(/\/advent\/qr\/([a-f0-9-]+)/i);
            if (match) {
                token = match[1];
            }
        }

        // Redirect to QR scan endpoint
        window.location.href = `{% url 'crush_lu:advent_scan_qr' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', token);
    }

    function onScanError(errorMessage) {
        // Ignore scan errors (no QR found yet)
    }

    // Start scanning
    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            // Use back camera if available
            const cameraId = devices.find(d => d.label.toLowerCase().includes('back'))?.id || devices[0].id;

            html5QrCode.start(
                cameraId,
                config,
                onScanSuccess,
                onScanError
            ).catch(err => {
                console.error('Camera error:', err);
                statusEl.innerHTML = `
                    <div class="text-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        Camera access denied. Please use manual input below.
                    </div>
                `;
            });
        } else {
            statusEl.innerHTML = `
                <div class="text-warning">
                    <i class="bi bi-camera-video-off"></i>
                    No camera found. Please use manual input below.
                </div>
            `;
        }
    }).catch(err => {
        console.error('Camera enumeration error:', err);
        statusEl.innerHTML = `
            <div class="text-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Could not access camera. Please use manual input.
            </div>
        `;
    });

    // Manual code form
    document.getElementById('manual-code-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const code = document.getElementById('manual-code').value.trim();
        if (code) {
            window.location.href = `{% url 'crush_lu:advent_scan_qr' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', code);
        }
    });
});
</script>
{% endblock %}

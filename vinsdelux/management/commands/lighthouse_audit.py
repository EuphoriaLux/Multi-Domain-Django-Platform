\"\"\"Management command to run Lighthouse audits on VinsDelux pages\"\"\"\n\nimport json\nimport subprocess\nimport tempfile\nimport os\nfrom django.core.management.base import BaseCommand, CommandError\nfrom django.test import Client\nfrom django.urls import reverse\nfrom django.conf import settings\nfrom django.contrib.auth.models import User\nfrom decimal import Decimal\n\nfrom ...models import (\n    VdlProducer, VdlCategory, VdlCoffret, VdlAdoptionPlan, \n    VdlPlot, PlotStatus, WineType\n)\n\n\nclass Command(BaseCommand):\n    help = 'Run Lighthouse audits on VinsDelux pages and generate optimization reports'\n    \n    def add_arguments(self, parser):\n        parser.add_argument(\n            '--pages',\n            nargs='*',\n            default=['plot-selection', 'home', 'coffret-list'],\n            help='Pages to audit (default: plot-selection, home, coffret-list)'\n        )\n        parser.add_argument(\n            '--output-dir',\n            type=str,\n            default='lighthouse-reports',\n            help='Directory to save Lighthouse reports'\n        )\n        parser.add_argument(\n            '--threshold',\n            type=int,\n            default=90,\n            help='Performance score threshold (default: 90)'\n        )\n        parser.add_argument(\n            '--create-test-data',\n            action='store_true',\n            help='Create test data before running audits'\n        )\n    \n    def handle(self, *args, **options):\n        self.stdout.write(self.style.SUCCESS('üç∑ Starting VinsDelux Lighthouse Audit'))\n        \n        # Ensure output directory exists\n        output_dir = options['output_dir']\n        os.makedirs(output_dir, exist_ok=True)\n        \n        # Create test data if requested\n        if options['create_test_data']:\n            self.create_test_data()\n        \n        # Check if Lighthouse CLI is available\n        if not self.check_lighthouse_cli():\n            raise CommandError(\n                'Lighthouse CLI is not installed. Install it with: npm install -g lighthouse'\n            )\n        \n        # Run audits for specified pages\n        pages = options['pages']\n        threshold = options['threshold']\n        results = {}\n        \n        for page in pages:\n            self.stdout.write(f'\\nüìä Auditing {page}...')\n            \n            try:\n                url = self.get_page_url(page)\n                report = self.run_lighthouse_audit(url, output_dir, page)\n                results[page] = report\n                \n                # Analyze results\n                self.analyze_results(page, report, threshold)\n                \n            except Exception as e:\n                self.stdout.write(\n                    self.style.ERROR(f'‚ùå Failed to audit {page}: {str(e)}')\n                )\n                results[page] = {'error': str(e)}\n        \n        # Generate summary report\n        self.generate_summary_report(results, output_dir, threshold)\n        \n        self.stdout.write(\n            self.style.SUCCESS(f'\\n‚úÖ Lighthouse audit completed. Reports saved to {output_dir}/')\n        )\n    \n    def check_lighthouse_cli(self):\n        \"\"\"Check if Lighthouse CLI is available\"\"\"\n        try:\n            result = subprocess.run(\n                ['lighthouse', '--version'],\n                capture_output=True,\n                text=True,\n                timeout=10\n            )\n            return result.returncode == 0\n        except (subprocess.TimeoutExpired, FileNotFoundError):\n            return False\n    \n    def get_page_url(self, page):\n        \"\"\"Get the full URL for a page\"\"\"\n        base_url = getattr(settings, 'TEST_SERVER_URL', 'http://127.0.0.1:8000')\n        \n        url_mapping = {\n            'home': f\"{base_url}{reverse('vinsdelux:home')}\",\n            'plot-selection': f\"{base_url}{reverse('vinsdelux:enhanced_plot_selector')}\",\n            'coffret-list': f\"{base_url}{reverse('vinsdelux:coffret_list')}\",\n            'producer-list': f\"{base_url}{reverse('vinsdelux:producer_list')}\",\n        }\n        \n        # Add dynamic URLs if test data exists\n        try:\n            producer = VdlProducer.objects.first()\n            if producer:\n                url_mapping['producer-detail'] = f\"{base_url}{reverse('vinsdelux:producer_detail', kwargs={'slug': producer.slug})}\"\n            \n            coffret = VdlCoffret.objects.first()\n            if coffret:\n                url_mapping['coffret-detail'] = f\"{base_url}{reverse('vinsdelux:coffret_detail', kwargs={'slug': coffret.slug})}\"\n            \n            adoption_plan = VdlAdoptionPlan.objects.first()\n            if adoption_plan:\n                url_mapping['adoption-plan-detail'] = f\"{base_url}{reverse('vinsdelux:adoption_plan_detail', kwargs={'slug': adoption_plan.slug})}\"\n        \n        except Exception as e:\n            self.stdout.write(self.style.WARNING(f'Could not create dynamic URLs: {e}'))\n        \n        if page not in url_mapping:\n            raise CommandError(f'Unknown page: {page}. Available pages: {\", \".join(url_mapping.keys())}')\n        \n        return url_mapping[page]\n    \n    def run_lighthouse_audit(self, url, output_dir, page_name):\n        \"\"\"Run Lighthouse audit for a specific URL\"\"\"\n        output_file = os.path.join(output_dir, f'{page_name}-lighthouse-report.json')\n        html_file = os.path.join(output_dir, f'{page_name}-lighthouse-report.html')\n        \n        # Lighthouse command with comprehensive audits\n        cmd = [\n            'lighthouse',\n            url,\n            '--output=json',\n            '--output=html',\n            '--output-path=' + output_file.replace('.json', ''),\n            '--chrome-flags=--headless --no-sandbox --disable-dev-shm-usage',\n            '--preset=desktop',\n            '--throttling-method=devtools',\n            '--form-factor=desktop',\n            '--screenEmulation.mobile=false',\n            '--screenEmulation.width=1920',\n            '--screenEmulation.height=1080',\n            '--emulatedUserAgent=\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36\"',\n            '--max-wait-for-load=45000',\n            '--skip-audits=uses-http2',  # Skip HTTP/2 audit for local testing\n        ]\n        \n        try {\n            result = subprocess.run(\n                cmd,\n                capture_output=True,\n                text=True,\n                timeout=120,  # 2 minutes timeout\n                cwd=os.getcwd()\n            )\n            \n            if result.returncode != 0:\n                raise CommandError(f'Lighthouse failed: {result.stderr}')\n            \n            # Load and return the JSON report\n            with open(output_file, 'r') as f:\n                return json.load(f)\n        \n        except subprocess.TimeoutExpired:\n            raise CommandError(f'Lighthouse audit timed out for {url}')\n        except Exception as e:\n            raise CommandError(f'Error running Lighthouse: {str(e)}')\n    \n    def analyze_results(self, page, report, threshold):\n        \"\"\"Analyze Lighthouse results and provide recommendations\"\"\"\n        categories = report.get('categories', {})\n        \n        # Performance metrics\n        performance = categories.get('performance', {})\n        accessibility = categories.get('accessibility', {})\n        best_practices = categories.get('best-practices', {})\n        seo = categories.get('seo', {})\n        \n        scores = {\n            'Performance': performance.get('score', 0) * 100 if performance.get('score') else 0,\n            'Accessibility': accessibility.get('score', 0) * 100 if accessibility.get('score') else 0,\n            'Best Practices': best_practices.get('score', 0) * 100 if best_practices.get('score') else 0,\n            'SEO': seo.get('score', 0) * 100 if seo.get('score') else 0,\n        }\n        \n        self.stdout.write(f'\\nüìà Results for {page}:')\n        for category, score in scores.items():\n            if score >= threshold:\n                status = self.style.SUCCESS(f'‚úÖ {category}: {score:.0f}/100')\n            elif score >= threshold - 10:\n                status = self.style.WARNING(f'‚ö†Ô∏è  {category}: {score:.0f}/100')\n            else:\n                status = self.style.ERROR(f'‚ùå {category}: {score:.0f}/100')\n            \n            self.stdout.write(f'  {status}')\n        \n        # Core Web Vitals\n        audits = report.get('audits', {})\n        \n        # Largest Contentful Paint\n        lcp = audits.get('largest-contentful-paint', {})\n        if lcp.get('numericValue'):\n            lcp_score = lcp['numericValue'] / 1000  # Convert to seconds\n            lcp_status = self.get_web_vital_status('LCP', lcp_score, [2.5, 4.0])\n            self.stdout.write(f'  üéØ LCP: {lcp_score:.2f}s {lcp_status}')\n        \n        # First Input Delay (may not be available in lab)\n        fid = audits.get('max-potential-fid', {})\n        if fid.get('numericValue'):\n            fid_score = fid['numericValue']\n            fid_status = self.get_web_vital_status('Max Potential FID', fid_score, [100, 300])\n            self.stdout.write(f'  üéØ Max Potential FID: {fid_score:.0f}ms {fid_status}')\n        \n        # Cumulative Layout Shift\n        cls = audits.get('cumulative-layout-shift', {})\n        if cls.get('numericValue') is not None:\n            cls_score = cls['numericValue']\n            cls_status = self.get_web_vital_status('CLS', cls_score, [0.1, 0.25])\n            self.stdout.write(f'  üéØ CLS: {cls_score:.3f} {cls_status}')\n        \n        # Performance opportunities\n        opportunities = self.get_performance_opportunities(audits)\n        if opportunities:\n            self.stdout.write(f'\\nüîß Performance Opportunities for {page}:')\n            for opportunity in opportunities[:5]:  # Show top 5\n                savings = opportunity.get('numericValue', 0) / 1000\n                if savings > 0.1:  # Only show if > 100ms potential savings\n                    self.stdout.write(\n                        f'  ‚Ä¢ {opportunity[\"title\"]}: {savings:.2f}s potential savings'\n                    )\n        \n        # Accessibility issues\n        a11y_issues = self.get_accessibility_issues(audits)\n        if a11y_issues:\n            self.stdout.write(f'\\n‚ôø Accessibility Issues for {page}:')\n            for issue in a11y_issues[:3]:  # Show top 3\n                self.stdout.write(f'  ‚Ä¢ {issue[\"title\"]}')\n    \n    def get_web_vital_status(self, metric, value, thresholds):\n        \"\"\"Get status for Core Web Vitals\"\"\"\n        good_threshold, poor_threshold = thresholds\n        \n        if value <= good_threshold:\n            return self.style.SUCCESS('(Good)')\n        elif value <= poor_threshold:\n            return self.style.WARNING('(Needs Improvement)')\n        else:\n            return self.style.ERROR('(Poor)')\n    \n    def get_performance_opportunities(self, audits):\n        \"\"\"Extract performance opportunities from audits\"\"\"\n        opportunity_audits = [\n            'unused-css-rules',\n            'unused-javascript',\n            'modern-image-formats',\n            'efficient-animated-content',\n            'offscreen-images',\n            'render-blocking-resources',\n            'unminified-css',\n            'unminified-javascript',\n            'optimize-images',\n            'properly-size-images',\n            'dom-size',\n        ]\n        \n        opportunities = []\n        for audit_id in opportunity_audits:\n            audit = audits.get(audit_id, {})\n            if audit.get('score') is not None and audit['score'] < 1:\n                opportunities.append(audit)\n        \n        # Sort by potential savings\n        opportunities.sort(\n            key=lambda x: x.get('numericValue', 0),\n            reverse=True\n        )\n        \n        return opportunities\n    \n    def get_accessibility_issues(self, audits):\n        \"\"\"Extract accessibility issues from audits\"\"\"\n        a11y_audits = [\n            'color-contrast',\n            'image-alt',\n            'label',\n            'link-name',\n            'button-name',\n            'aria-labels',\n            'aria-required-attr',\n            'aria-valid-attr-value',\n            'heading-order',\n            'landmark-one-main',\n            'focus-traps',\n        ]\n        \n        issues = []\n        for audit_id in a11y_audits:\n            audit = audits.get(audit_id, {})\n            if audit.get('score') is not None and audit['score'] < 1:\n                issues.append(audit)\n        \n        return issues\n    \n    def generate_summary_report(self, results, output_dir, threshold):\n        \"\"\"Generate a summary report of all audits\"\"\"\n        summary_file = os.path.join(output_dir, 'lighthouse-summary.json')\n        \n        summary = {\n            'audit_timestamp': subprocess.run(\n                ['date', '+%Y-%m-%d %H:%M:%S'],\n                capture_output=True,\n                text=True\n            ).stdout.strip(),\n            'threshold': threshold,\n            'pages': {},\n            'overall_scores': {\n                'performance': 0,\n                'accessibility': 0,\n                'best_practices': 0,\n                'seo': 0\n            }\n        }\n        \n        total_pages = 0\n        \n        for page, report in results.items():\n            if 'error' in report:\n                summary['pages'][page] = {'error': report['error']}\n                continue\n            \n            categories = report.get('categories', {})\n            page_scores = {\n                'performance': categories.get('performance', {}).get('score', 0) * 100,\n                'accessibility': categories.get('accessibility', {}).get('score', 0) * 100,\n                'best_practices': categories.get('best-practices', {}).get('score', 0) * 100,\n                'seo': categories.get('seo', {}).get('score', 0) * 100,\n            }\n            \n            # Core Web Vitals\n            audits = report.get('audits', {})\n            web_vitals = {}\n            \n            lcp = audits.get('largest-contentful-paint', {})\n            if lcp.get('numericValue'):\n                web_vitals['lcp'] = lcp['numericValue'] / 1000\n            \n            cls = audits.get('cumulative-layout-shift', {})\n            if cls.get('numericValue') is not None:\n                web_vitals['cls'] = cls['numericValue']\n            \n            fid = audits.get('max-potential-fid', {})\n            if fid.get('numericValue'):\n                web_vitals['max_potential_fid'] = fid['numericValue']\n            \n            summary['pages'][page] = {\n                'scores': page_scores,\n                'web_vitals': web_vitals,\n                'meets_threshold': all(score >= threshold for score in page_scores.values())\n            }\n            \n            # Add to overall averages\n            total_pages += 1\n            for category, score in page_scores.items():\n                summary['overall_scores'][category] += score\n        \n        # Calculate averages\n        if total_pages > 0:\n            for category in summary['overall_scores']:\n                summary['overall_scores'][category] /= total_pages\n        \n        # Save summary\n        with open(summary_file, 'w') as f:\n            json.dump(summary, f, indent=2)\n        \n        # Print summary\n        self.stdout.write('\\nüìä Overall Summary:')\n        for category, score in summary['overall_scores'].items():\n            if score >= threshold:\n                status = self.style.SUCCESS(f'‚úÖ {category.title()}: {score:.1f}/100')\n            else:\n                status = self.style.WARNING(f'‚ö†Ô∏è  {category.title()}: {score:.1f}/100')\n            self.stdout.write(f'  {status}')\n        \n        # Recommendations\n        self.stdout.write('\\nüí° Optimization Recommendations:')\n        \n        perf_avg = summary['overall_scores']['performance']\n        if perf_avg < threshold:\n            self.stdout.write('  üöÄ Performance Optimizations:')\n            self.stdout.write('     ‚Ä¢ Enable gzip/brotli compression')\n            self.stdout.write('     ‚Ä¢ Implement lazy loading for images')\n            self.stdout.write('     ‚Ä¢ Minimize JavaScript and CSS')\n            self.stdout.write('     ‚Ä¢ Use WebP images with fallbacks')\n            self.stdout.write('     ‚Ä¢ Implement service worker caching')\n        \n        a11y_avg = summary['overall_scores']['accessibility']\n        if a11y_avg < threshold:\n            self.stdout.write('  ‚ôø Accessibility Improvements:')\n            self.stdout.write('     ‚Ä¢ Add alt text to all images')\n            self.stdout.write('     ‚Ä¢ Ensure sufficient color contrast')\n            self.stdout.write('     ‚Ä¢ Add ARIA labels to interactive elements')\n            self.stdout.write('     ‚Ä¢ Implement proper heading hierarchy')\n            self.stdout.write('     ‚Ä¢ Add focus management for modals')\n        \n        seo_avg = summary['overall_scores']['seo']\n        if seo_avg < threshold:\n            self.stdout.write('  üîç SEO Enhancements:')\n            self.stdout.write('     ‚Ä¢ Add meta descriptions to all pages')\n            self.stdout.write('     ‚Ä¢ Implement structured data markup')\n            self.stdout.write('     ‚Ä¢ Optimize title tags')\n            self.stdout.write('     ‚Ä¢ Add canonical URLs')\n            self.stdout.write('     ‚Ä¢ Ensure mobile-friendly design')\n    \n    def create_test_data(self):\n        \"\"\"Create test data for comprehensive auditing\"\"\"\n        self.stdout.write('üìù Creating test data for audits...')\n        \n        # Create producer\n        producer, created = VdlProducer.objects.get_or_create(\n            slug='test-audit-producer',\n            defaults={\n                'name': 'Audit Test Vineyard',\n                'description': 'A test vineyard for Lighthouse auditing',\n                'region': 'Test Region',\n                'vineyard_size': '10 hectares',\n                'elevation': '200m',\n                'is_featured_on_homepage': True\n            }\n        )\n        \n        # Create category\n        category, created = VdlCategory.objects.get_or_create(\n            slug='audit-red-wine',\n            defaults={\n                'name': WineType.RED_WINE,\n                'description': 'Test red wine category',\n                'is_active': True\n            }\n        )\n        \n        # Create coffret\n        coffret, created = VdlCoffret.objects.get_or_create(\n            slug='audit-test-coffret',\n            defaults={\n                'name': 'Audit Test Coffret',\n                'producer': producer,\n                'category': category,\n                'short_description': 'Test coffret for auditing',\n                'full_description': 'A comprehensive test coffret with rich content for Lighthouse auditing.',\n                'price': Decimal('150.00'),\n                'is_available': True\n            }\n        )\n        \n        # Create adoption plan\n        adoption_plan, created = VdlAdoptionPlan.objects.get_or_create(\n            slug='audit-test-plan',\n            defaults={\n                'name': 'Audit Test Plan',\n                'producer': producer,\n                'associated_coffret': coffret,\n                'category': category,\n                'short_description': 'Test adoption plan for auditing',\n                'full_description': 'A comprehensive test adoption plan with detailed information.',\n                'price': Decimal('500.00'),\n                'duration_months': 12,\n                'coffrets_per_year': 2,\n                'includes_visit': True,\n                'is_available': True\n            }\n        )\n        \n        # Create plots\n        for i in range(5):\n            plot, created = VdlPlot.objects.get_or_create(\n                plot_identifier=f'AUDIT-{i:03d}',\n                defaults={\n                    'name': f'Audit Test Plot {i+1}',\n                    'producer': producer,\n                    'coordinates': {\n                        'type': 'Point',\n                        'coordinates': [6.1444 + i * 0.001, 46.1591 + i * 0.001]\n                    },\n                    'plot_size': f'{0.2 + i * 0.1} hectares',\n                    'elevation': f'{450 + i * 10}m',\n                    'soil_type': 'Test soil type',\n                    'sun_exposure': 'South-facing',\n                    'grape_varieties': ['Merlot', 'Cabernet Sauvignon'],\n                    'wine_profile': f'Rich red wine from plot {i+1}',\n                    'base_price': Decimal(f'{2500 + i * 200}.00'),\n                    'status': PlotStatus.AVAILABLE\n                }\n            )\n            \n            if created:\n                plot.adoption_plans.add(adoption_plan)\n        \n        self.stdout.write(self.style.SUCCESS('‚úÖ Test data created successfully'))"
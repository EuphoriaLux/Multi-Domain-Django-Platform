{% extends 'vinsdelux/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}VinsDelux Journey - Test Suite{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/vinsdelux-journey-game.css' %}">
<style>
    .test-suite {
        padding: 40px 20px;
        max-width: 1400px;
        margin: 0 auto;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .test-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .test-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .test-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .test-btn.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .test-btn.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .test-btn.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .test-btn.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .test-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    .test-results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .result-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .result-card.success {
        border-left: 5px solid #4caf50;
    }

    .result-card.error {
        border-left: 5px solid #f44336;
    }

    .result-card.warning {
        border-left: 5px solid #ff9800;
    }

    .result-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: white;
    }

    .status-icon.success {
        background: #4caf50;
    }

    .status-icon.error {
        background: #f44336;
    }

    .status-icon.warning {
        background: #ff9800;
    }

    .test-log {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        max-height: 300px;
        overflow-y: auto;
    }

    .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-radius: 5px;
    }

    .log-entry.error {
        background: #ffebee;
        color: #c62828;
    }

    .log-entry.success {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .log-entry.info {
        background: #e3f2fd;
        color: #1565c0;
    }

    .test-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }

    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
    }

    .stat-label {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
    }

    .console-output {
        background: #1e1e1e;
        color: #fff;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        max-height: 400px;
        overflow-y: auto;
    }

    .console-line {
        margin: 3px 0;
    }

    .console-error {
        color: #ff6b6b;
    }

    .console-success {
        color: #51cf66;
    }

    .console-warning {
        color: #ffd43b;
    }

    .console-info {
        color: #74c0fc;
    }

    #test-iframe {
        width: 100%;
        height: 800px;
        border: none;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="test-suite">
    <div class="test-header">
        <h1>üß™ VinsDelux Journey Test Suite</h1>
        <p class="lead">Comprehensive testing and debugging for the interactive journey game</p>
        
        <div class="test-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-tests">0</div>
                <div class="stat-label">Total Tests</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passed-tests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failed-tests">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="coverage-percent">0%</div>
                <div class="stat-label">Coverage</div>
            </div>
        </div>

        <div class="test-controls">
            <button class="test-btn primary" onclick="runAllTests()">
                üöÄ Run All Tests
            </button>
            <button class="test-btn success" onclick="runUnitTests()">
                ‚úÖ Unit Tests
            </button>
            <button class="test-btn info" onclick="runIntegrationTests()">
                üîÑ Integration Tests
            </button>
            <button class="test-btn warning" onclick="runPerformanceTests()">
                ‚ö° Performance Tests
            </button>
            <button class="test-btn info" onclick="runAccessibilityTests()">
                ‚ôø Accessibility Tests
            </button>
            <button class="test-btn primary" onclick="debugMode()">
                üêõ Debug Mode
            </button>
            <button class="test-btn success" onclick="fixCommonIssues()">
                üîß Auto-Fix Issues
            </button>
            <button class="test-btn warning" onclick="clearTests()">
                üóëÔ∏è Clear Results
            </button>
        </div>
    </div>

    <div class="test-results" id="test-results"></div>

    <div class="console-output" id="console-output">
        <div class="console-line console-info">üñ•Ô∏è Test Console Ready...</div>
    </div>

    <!-- Hidden iframe for testing the actual game -->
    <iframe id="test-iframe" src="{% url 'vinsdelux:journey_interactive_form' %}" style="display:none;"></iframe>
</div>

<script>
class VinsDeluxTestSuite {
    constructor() {
        this.tests = {
            passed: 0,
            failed: 0,
            total: 0
        };
        this.startTime = null;
        this.gameInstance = null;
        this.initConsoleInterceptor();
    }

    initConsoleInterceptor() {
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = (...args) => {
            this.logToConsole('info', args.join(' '));
            originalLog.apply(console, args);
        };
        
        console.error = (...args) => {
            this.logToConsole('error', args.join(' '));
            originalError.apply(console, args);
        };
        
        console.warn = (...args) => {
            this.logToConsole('warning', args.join(' '));
            originalWarn.apply(console, args);
        };
    }

    logToConsole(type, message) {
        const consoleOutput = document.getElementById('console-output');
        const line = document.createElement('div');
        line.className = `console-line console-${type}`;
        const timestamp = new Date().toLocaleTimeString();
        line.textContent = `[${timestamp}] ${message}`;
        consoleOutput.appendChild(line);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    async runTest(testName, testFunction) {
        const startTime = performance.now();
        let result = {
            name: testName,
            status: 'running',
            duration: 0,
            error: null
        };

        try {
            await testFunction();
            result.status = 'passed';
            this.tests.passed++;
            this.logToConsole('success', `‚úÖ ${testName} passed`);
        } catch (error) {
            result.status = 'failed';
            result.error = error.message;
            this.tests.failed++;
            this.logToConsole('error', `‚ùå ${testName} failed: ${error.message}`);
        }

        result.duration = (performance.now() - startTime).toFixed(2);
        this.tests.total++;
        this.updateStats();
        this.displayResult(result);
        return result;
    }

    updateStats() {
        document.getElementById('total-tests').textContent = this.tests.total;
        document.getElementById('passed-tests').textContent = this.tests.passed;
        document.getElementById('failed-tests').textContent = this.tests.failed;
        const coverage = this.tests.total > 0 
            ? Math.round((this.tests.passed / this.tests.total) * 100) 
            : 0;
        document.getElementById('coverage-percent').textContent = coverage + '%';
    }

    displayResult(result) {
        const resultsContainer = document.getElementById('test-results');
        const card = document.createElement('div');
        card.className = `result-card ${result.status}`;
        
        const statusIcon = result.status === 'passed' ? '‚úÖ' : '‚ùå';
        const statusClass = result.status === 'passed' ? 'success' : 'error';
        
        card.innerHTML = `
            <div class="result-title">
                <span class="status-icon ${statusClass}">${statusIcon}</span>
                ${result.name}
            </div>
            <div>Duration: ${result.duration}ms</div>
            ${result.error ? `<div class="test-log">${result.error}</div>` : ''}
        `;
        
        resultsContainer.appendChild(card);
    }

    // Unit Tests
    async testGameInitialization() {
        const iframe = document.getElementById('test-iframe');
        iframe.style.display = 'block';
        
        return new Promise((resolve, reject) => {
            // Wait for iframe to load
            const checkGame = () => {
                try {
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow && iframeWindow.gameInstance) {
                        if (iframeWindow.gameInstance.currentStep === 1) {
                            resolve();
                        } else {
                            reject(new Error('Game did not initialize at step 1'));
                        }
                    } else {
                        // Try again after a short delay
                        setTimeout(() => {
                            const iframeWindow = iframe.contentWindow;
                            if (iframeWindow && iframeWindow.gameInstance) {
                                resolve();
                            } else {
                                reject(new Error('Game instance not found after waiting'));
                            }
                        }, 1000);
                    }
                } catch (e) {
                    reject(new Error('Error accessing iframe: ' + e.message));
                }
            };
            
            if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                checkGame();
            } else {
                iframe.onload = checkGame;
            }
        });
    }

    async testNavigation() {
        const iframe = document.getElementById('test-iframe');
        const iframeWindow = iframe.contentWindow;
        const game = iframeWindow.gameInstance;
        
        if (!game) throw new Error('Game not initialized');
        
        // Test next step
        const initialStep = game.currentStep;
        game.nextStep();
        
        // Allow for validation failure
        if (game.currentStep !== initialStep && game.currentStep !== initialStep + 1) {
            throw new Error('Navigation next step failed');
        }
        
        // Test previous step
        if (game.currentStep > 1) {
            game.previousStep();
            if (game.currentStep !== initialStep) {
                throw new Error('Navigation previous step failed');
            }
        }
    }

    async testPlotSelection() {
        const iframe = document.getElementById('test-iframe');
        const iframeDoc = iframe.contentDocument;
        
        const plotCards = iframeDoc.querySelectorAll('.plot-card');
        if (plotCards.length === 0) {
            throw new Error('No plot cards found');
        }
        
        // Simulate clicking a plot card
        plotCards[0].click();
        
        // Check if plot is selected
        const selectedPlot = iframeDoc.querySelector('.plot-card.selected');
        if (!selectedPlot) {
            throw new Error('Plot selection not working');
        }
    }

    async testDragAndDrop() {
        const iframe = document.getElementById('test-iframe');
        const iframeDoc = iframe.contentDocument;
        const iframeWindow = iframe.contentWindow;
        
        // Navigate to wine builder step
        iframeWindow.gameInstance.goToStep(2);
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const grapeItems = iframeDoc.querySelectorAll('.grape-item');
        const blendContainer = iframeDoc.getElementById('blend-container');
        
        if (!grapeItems.length || !blendContainer) {
            throw new Error('Drag and drop elements not found');
        }
        
        // Simulate drag and drop
        const dragEvent = new DragEvent('dragstart', {
            dataTransfer: new DataTransfer()
        });
        grapeItems[0].dispatchEvent(dragEvent);
        
        const dropEvent = new DragEvent('drop', {
            dataTransfer: dragEvent.dataTransfer
        });
        blendContainer.dispatchEvent(dropEvent);
    }

    async testScoreSystem() {
        const iframe = document.getElementById('test-iframe');
        const iframeWindow = iframe.contentWindow;
        const game = iframeWindow.gameInstance;
        
        const initialScore = game.userScore;
        game.awardPoints(100);
        
        if (game.userScore !== initialScore + 100) {
            throw new Error('Score system not working correctly');
        }
    }

    async testSaveLoad() {
        const iframe = document.getElementById('test-iframe');
        const iframeWindow = iframe.contentWindow;
        const game = iframeWindow.gameInstance;
        
        if (!game) {
            throw new Error('Game instance not found');
        }
        
        // Set some test data
        const originalScore = game.userScore;
        game.userScore = 500;
        game.currentStep = 3;
        game.journeyData.plot = 'test-plot';
        
        // Save progress
        game.saveProgress();
        
        // Test if data was saved to localStorage
        const savedData = localStorage.getItem('vinsdelux_journey');
        if (!savedData) {
            throw new Error('Data not saved to localStorage');
        }
        
        // Parse and verify saved data
        const parsed = JSON.parse(savedData);
        if (parsed.userScore !== 500 || parsed.currentStep !== 3) {
            throw new Error('Save/Load functionality not working correctly');
        }
        
        // Restore original state
        game.userScore = originalScore;
    }

    async testValidation() {
        const iframe = document.getElementById('test-iframe');
        const iframeWindow = iframe.contentWindow;
        const game = iframeWindow.gameInstance;
        
        // Go to step 1
        game.goToStep(1);
        
        // Try to proceed without selecting a plot
        const isValid = game.validateCurrentStep();
        
        if (isValid && !game.journeyData.plot) {
            throw new Error('Validation not working - should require plot selection');
        }
    }

    async testAnimations() {
        const iframe = document.getElementById('test-iframe');
        const iframeDoc = iframe.contentDocument;
        
        const animatedElements = iframeDoc.querySelectorAll('[data-animate]');
        if (animatedElements.length === 0) {
            throw new Error('No animated elements found');
        }
        
        // Check if animations are applied
        animatedElements.forEach(el => {
            const styles = window.getComputedStyle(el);
            if (!styles.transition && !styles.animation) {
                throw new Error('Animation styles not applied');
            }
        });
    }

    async testResponsiveness() {
        const iframe = document.getElementById('test-iframe');
        
        // Test different viewport sizes
        const sizes = [
            { width: 320, height: 568 },  // Mobile
            { width: 768, height: 1024 }, // Tablet
            { width: 1920, height: 1080 } // Desktop
        ];
        
        for (let size of sizes) {
            iframe.style.width = size.width + 'px';
            iframe.style.height = size.height + 'px';
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const iframeDoc = iframe.contentDocument;
            // Check for either journey-container or journey-wrapper
            const mainContainer = iframeDoc.querySelector('.journey-container, .journey-wrapper, .container, body');
            
            if (!mainContainer) {
                throw new Error(`No main container found at ${size.width}x${size.height}`);
            }
            
            // Check if content is visible
            const contentVisible = iframeDoc.querySelector('.journey-step, .step-content, .journey-header, h1, h2');
            if (!contentVisible) {
                throw new Error(`Content not visible at ${size.width}x${size.height}`);
            }
        }
    }

    async testPerformance() {
        const iframe = document.getElementById('test-iframe');
        const iframeWindow = iframe.contentWindow;
        
        const startTime = performance.now();
        
        // Simulate heavy interactions
        for (let i = 0; i < 10; i++) {
            iframeWindow.gameInstance.nextStep();
            iframeWindow.gameInstance.previousStep();
        }
        
        const duration = performance.now() - startTime;
        
        if (duration > 1000) {
            throw new Error(`Performance issue: Operations took ${duration}ms`);
        }
    }

    // Fix common issues
    async fixCommonIssues() {
        this.logToConsole('info', 'üîß Starting auto-fix for common issues...');
        
        const iframe = document.getElementById('test-iframe');
        if (!iframe) {
            this.logToConsole('error', 'Test iframe not found');
            return;
        }
        
        // Ensure iframe is loaded
        await new Promise(resolve => {
            if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
                resolve();
            } else {
                iframe.onload = resolve;
                iframe.src = iframe.src; // Reload if needed
            }
        });
        
        const iframeDoc = iframe.contentDocument;
        const iframeWindow = iframe.contentWindow;
        
        if (!iframeWindow) {
            this.logToConsole('error', 'Cannot access iframe window');
            return;
        }
        
        // Fix 1: Ensure game instance exists
        if (!iframeWindow.gameInstance) {
            this.logToConsole('warning', 'Creating game instance...');
            if (iframeWindow.VinsDeluxJourneyGame) {
                iframeWindow.gameInstance = new iframeWindow.VinsDeluxJourneyGame();
                this.logToConsole('success', 'Game instance created');
            } else {
                this.logToConsole('error', 'VinsDeluxJourneyGame class not found in iframe');
            }
        }
        
        // Fix 2: Ensure all required elements exist
        const requiredElements = [
            '.btn-next', '.btn-prev', '.step-dots', '.journey-step',
            '#user-points', '.progress-fill'
        ];
        
        for (let selector of requiredElements) {
            if (!iframeDoc.querySelector(selector)) {
                this.logToConsole('error', `Missing element: ${selector}`);
                // Could inject missing elements here if needed
            }
        }
        
        // Fix 3: Reset broken state
        if (iframeWindow.gameInstance) {
            iframeWindow.gameInstance.currentStep = 1;
            iframeWindow.gameInstance.userScore = 0;
            iframeWindow.gameInstance.achievements = [];
            iframeWindow.gameInstance.goToStep(1);
            this.logToConsole('success', 'Game state reset');
        }
        
        // Fix 4: Clear localStorage if corrupted
        try {
            const savedData = localStorage.getItem('vinsdelux_journey');
            if (savedData) {
                JSON.parse(savedData);
            }
        } catch (e) {
            localStorage.removeItem('vinsdelux_journey');
            this.logToConsole('warning', 'Cleared corrupted save data');
        }
        
        this.logToConsole('success', '‚úÖ Auto-fix completed');
    }
}

// Initialize test suite
const testSuite = new VinsDeluxTestSuite();

// Test runner functions
async function runAllTests() {
    clearTests();
    testSuite.logToConsole('info', 'üöÄ Running all tests...');
    
    // Ensure iframe is loaded first
    const iframe = document.getElementById('test-iframe');
    iframe.style.display = 'block';
    
    await new Promise(resolve => {
        if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
            setTimeout(resolve, 500); // Give JS time to initialize
        } else {
            iframe.onload = () => setTimeout(resolve, 500);
        }
    });
    
    try {
        await testSuite.runTest('Game Initialization', () => testSuite.testGameInitialization());
        await testSuite.runTest('Navigation System', () => testSuite.testNavigation());
        await testSuite.runTest('Plot Selection', () => testSuite.testPlotSelection());
        await testSuite.runTest('Drag and Drop', () => testSuite.testDragAndDrop());
        await testSuite.runTest('Score System', () => testSuite.testScoreSystem());
        await testSuite.runTest('Save/Load Function', () => testSuite.testSaveLoad());
        await testSuite.runTest('Form Validation', () => testSuite.testValidation());
        await testSuite.runTest('Animations', () => testSuite.testAnimations());
        await testSuite.runTest('Responsiveness', () => testSuite.testResponsiveness());
        await testSuite.runTest('Performance', () => testSuite.testPerformance());
    } catch (error) {
        testSuite.logToConsole('error', `Test suite error: ${error.message}`);
    }
    
    testSuite.logToConsole('info', '‚úÖ All tests completed');
}

async function runUnitTests() {
    clearTests();
    testSuite.logToConsole('info', 'üß™ Running unit tests...');
    
    await testSuite.runTest('Game Initialization', () => testSuite.testGameInitialization());
    await testSuite.runTest('Score System', () => testSuite.testScoreSystem());
    await testSuite.runTest('Save/Load Function', () => testSuite.testSaveLoad());
    await testSuite.runTest('Form Validation', () => testSuite.testValidation());
}

async function runIntegrationTests() {
    clearTests();
    testSuite.logToConsole('info', 'üîÑ Running integration tests...');
    
    await testSuite.runTest('Navigation System', () => testSuite.testNavigation());
    await testSuite.runTest('Plot Selection', () => testSuite.testPlotSelection());
    await testSuite.runTest('Drag and Drop', () => testSuite.testDragAndDrop());
}

async function runPerformanceTests() {
    clearTests();
    testSuite.logToConsole('info', '‚ö° Running performance tests...');
    
    await testSuite.runTest('Performance', () => testSuite.testPerformance());
    await testSuite.runTest('Animations', () => testSuite.testAnimations());
}

async function runAccessibilityTests() {
    clearTests();
    testSuite.logToConsole('info', '‚ôø Running accessibility tests...');
    
    const iframe = document.getElementById('test-iframe');
    iframe.style.display = 'block';
    
    await testSuite.runTest('Keyboard Navigation', async () => {
        const iframeDoc = iframe.contentDocument;
        const focusableElements = iframeDoc.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        
        if (focusableElements.length === 0) {
            throw new Error('No focusable elements found');
        }
    });
    
    await testSuite.runTest('ARIA Labels', async () => {
        const iframeDoc = iframe.contentDocument;
        const buttons = iframeDoc.querySelectorAll('button');
        let missingLabels = 0;
        
        buttons.forEach(btn => {
            if (!btn.textContent.trim() && !btn.getAttribute('aria-label')) {
                missingLabels++;
            }
        });
        
        if (missingLabels > 0) {
            throw new Error(`${missingLabels} buttons missing accessible labels`);
        }
    });
}

function debugMode() {
    const iframe = document.getElementById('test-iframe');
    iframe.style.display = iframe.style.display === 'none' ? 'block' : 'none';
    
    if (iframe.style.display === 'block') {
        testSuite.logToConsole('info', 'üêõ Debug mode: ON - Game iframe visible');
    } else {
        testSuite.logToConsole('info', 'üêõ Debug mode: OFF - Game iframe hidden');
    }
}

function fixCommonIssues() {
    testSuite.fixCommonIssues();
}

function clearTests() {
    document.getElementById('test-results').innerHTML = '';
    testSuite.tests = { passed: 0, failed: 0, total: 0 };
    testSuite.updateStats();
    document.getElementById('console-output').innerHTML = 
        '<div class="console-line console-info">üñ•Ô∏è Test Console Cleared...</div>';
}

// Auto-run basic tests on load
window.addEventListener('load', () => {
    setTimeout(() => {
        testSuite.logToConsole('info', 'üéÆ VinsDelux Journey Test Suite Ready');
        testSuite.logToConsole('info', 'üí° Click "Run All Tests" to start testing');
    }, 1000);
});
</script>
{% endblock %}
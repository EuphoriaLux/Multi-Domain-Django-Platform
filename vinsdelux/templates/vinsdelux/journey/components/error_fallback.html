{% load static i18n %}\n\n<!-- Error Fallback Component -->\n<!-- Elegant error handling with wine-glass loading animations -->\n\n<!-- Network Error Fallback -->\n<div class=\"vdl-error-fallback vdl-network-error d-none\" id=\"network-error-fallback\" \n     role=\"alert\" aria-live=\"assertive\" aria-atomic=\"true\">\n    <div class=\"vdl-error-content\">\n        <div class=\"vdl-error-animation\">\n            <i class=\"fas fa-wine-glass-alt vdl-wine-loading\" aria-hidden=\"true\"></i>\n        </div>\n        <h3 class=\"vdl-error-title\">{% trans \"Connection Issue\" %}</h3>\n        <p class=\"vdl-error-message\">\n            {% trans \"We're having trouble connecting to our servers. Please check your internet connection and try again.\" %}\n        </p>\n        <div class=\"vdl-error-actions\">\n            <button type=\"button\" class=\"vdl-btn vdl-btn-accent\" onclick=\"window.location.reload()\"\n                    aria-describedby=\"retry-description\">\n                <i class=\"fas fa-sync-alt\" aria-hidden=\"true\"></i>\n                {% trans \"Try Again\" %}\n            </button>\n            <div id=\"retry-description\" class=\"sr-only\">{% trans \"Reload the page to try connecting again\" %}</div>\n            \n            <button type=\"button\" class=\"vdl-btn vdl-btn-secondary\" onclick=\"showOfflineMode()\"\n                    aria-describedby=\"offline-description\">\n                <i class=\"fas fa-wifi-slash\" aria-hidden=\"true\"></i>\n                {% trans \"Continue Offline\" %}\n            </button>\n            <div id=\"offline-description\" class=\"sr-only\">{% trans \"Use cached content and limited functionality\" %}</div>\n        </div>\n        <div class=\"vdl-error-details\">\n            <details>\n                <summary>{% trans \"Technical Details\" %}</summary>\n                <div class=\"vdl-technical-info\">\n                    <p><strong>{% trans \"Error Type:\" %}</strong> <span id=\"error-type\">Network Error</span></p>\n                    <p><strong>{% trans \"Timestamp:\" %}</strong> <span id=\"error-timestamp\"></span></p>\n                    <p><strong>{% trans \"User Agent:\" %}</strong> <span id=\"user-agent\"></span></p>\n                </div>\n            </details>\n        </div>\n    </div>\n</div>\n\n<!-- API Error Fallback -->\n<div class=\"vdl-error-fallback vdl-api-error d-none\" id=\"api-error-fallback\" \n     role=\"alert\" aria-live=\"assertive\" aria-atomic=\"true\">\n    <div class=\"vdl-error-content\">\n        <div class=\"vdl-error-animation\">\n            <i class=\"fas fa-exclamation-triangle vdl-pulse-animation\" aria-hidden=\"true\"></i>\n        </div>\n        <h3 class=\"vdl-error-title\">{% trans \"Service Temporarily Unavailable\" %}</h3>\n        <p class=\"vdl-error-message\">\n            {% trans \"Our wine selection service is temporarily unavailable. We're working to restore it as quickly as possible.\" %}\n        </p>\n        <div class=\"vdl-error-actions\">\n            <button type=\"button\" class=\"vdl-btn vdl-btn-accent\" onclick=\"retryOperation()\"\n                    aria-describedby=\"retry-operation-description\">\n                <i class=\"fas fa-redo\" aria-hidden=\"true\"></i>\n                {% trans \"Retry\" %}\n            </button>\n            <div id=\"retry-operation-description\" class=\"sr-only\">{% trans \"Attempt to reload the plot data\" %}</div>\n            \n            <button type=\"button\" class=\"vdl-btn vdl-btn-secondary\" onclick=\"showCachedData()\"\n                    aria-describedby=\"cached-data-description\">\n                <i class=\"fas fa-archive\" aria-hidden=\"true\"></i>\n                {% trans \"View Cached Plots\" %}\n            </button>\n            <div id=\"cached-data-description\" class=\"sr-only\">{% trans \"Show previously loaded plot information\" %}</div>\n        </div>\n        <div class=\"vdl-error-suggestion\">\n            <p><i class=\"fas fa-lightbulb\" aria-hidden=\"true\"></i> \n               {% trans \"You can still browse our wine collections while we restore the plot selection feature.\" %}</p>\n            <a href=\"{% url 'vinsdelux:coffret_list' %}\" class=\"vdl-link\">\n                {% trans \"Browse Wine Collections\" %}\n            </a>\n        </div>\n    </div>\n</div>\n\n<!-- Map Loading Error -->\n<div class=\"vdl-error-fallback vdl-map-error d-none\" id=\"map-error-fallback\" \n     role=\"alert\" aria-live=\"polite\" aria-atomic=\"true\">\n    <div class=\"vdl-error-content\">\n        <div class=\"vdl-error-animation\">\n            <i class=\"fas fa-map-marked-alt vdl-fade-animation\" aria-hidden=\"true\"></i>\n        </div>\n        <h3 class=\"vdl-error-title\">{% trans \"Map Unavailable\" %}</h3>\n        <p class=\"vdl-error-message\">\n            {% trans \"The interactive map could not be loaded. You can still select plots using the list below.\" %}\n        </p>\n        <div class=\"vdl-error-actions\">\n            <button type=\"button\" class=\"vdl-btn vdl-btn-accent\" onclick=\"showPlotList()\"\n                    aria-describedby=\"plot-list-description\">\n                <i class=\"fas fa-list\" aria-hidden=\"true\"></i>\n                {% trans \"View Plot List\" %}\n            </button>\n            <div id=\"plot-list-description\" class=\"sr-only\">{% trans \"Switch to list view of available vineyard plots\" %}</div>\n            \n            <button type=\"button\" class=\"vdl-btn vdl-btn-secondary\" onclick=\"retryMapLoad()\"\n                    aria-describedby=\"retry-map-description\">\n                <i class=\"fas fa-map\" aria-hidden=\"true\"></i>\n                {% trans \"Retry Map\" %}\n            </button>\n            <div id=\"retry-map-description\" class=\"sr-only\">{% trans \"Attempt to reload the interactive map\" %}</div>\n        </div>\n    </div>\n</div>\n\n<!-- JavaScript Disabled Fallback -->\n<noscript>\n    <div class=\"vdl-error-fallback vdl-nojs-fallback\" role=\"alert\">\n        <div class=\"vdl-error-content\">\n            <div class=\"vdl-error-animation\">\n                <i class=\"fas fa-wine-glass\" aria-hidden=\"true\"></i>\n            </div>\n            <h3 class=\"vdl-error-title\">{% trans \"JavaScript Required\" %}</h3>\n            <p class=\"vdl-error-message\">\n                {% trans \"This interactive wine selection experience requires JavaScript to function properly. Please enable JavaScript in your browser or use our alternative selection method.\" %}\n            </p>\n            <div class=\"vdl-error-actions\">\n                <a href=\"{% url 'vinsdelux:coffret_list' %}\" class=\"vdl-btn vdl-btn-accent\">\n                    <i class=\"fas fa-list\" aria-hidden=\"true\"></i>\n                    {% trans \"Browse All Collections\" %}\n                </a>\n                <a href=\"{% url 'vinsdelux:producer_list' %}\" class=\"vdl-btn vdl-btn-secondary\">\n                    <i class=\"fas fa-building\" aria-hidden=\"true\"></i>\n                    {% trans \"View Producers\" %}\n                </a>\n            </div>\n        </div>\n    </div>\n</noscript>\n\n<!-- Offline Mode Interface -->\n<div class=\"vdl-offline-mode d-none\" id=\"offline-mode\" \n     role=\"region\" aria-labelledby=\"offline-title\" aria-describedby=\"offline-description\">\n    <div class=\"vdl-offline-header\">\n        <h3 id=\"offline-title\">{% trans \"Offline Mode\" %}</h3>\n        <p id=\"offline-description\">{% trans \"You're currently browsing offline. Some features may be limited.\" %}</p>\n    </div>\n    \n    <div class=\"vdl-offline-features\">\n        <div class=\"vdl-feature-card\">\n            <i class=\"fas fa-archive vdl-text-gold\" aria-hidden=\"true\"></i>\n            <h4>{% trans \"Cached Plots\" %}</h4>\n            <p>{% trans \"View previously loaded plot information\" %}</p>\n            <button type=\"button\" class=\"vdl-btn vdl-btn-outline\" onclick=\"showCachedPlots()\">\n                {% trans \"View Cached Data\" %}\n            </button>\n        </div>\n        \n        <div class=\"vdl-feature-card\">\n            <i class=\"fas fa-bookmark vdl-text-gold\" aria-hidden=\"true\"></i>\n            <h4>{% trans \"Saved Selections\" %}</h4>\n            <p>{% trans \"Your previous selections are saved locally\" %}</p>\n            <button type=\"button\" class=\"vdl-btn vdl-btn-outline\" onclick=\"loadSavedSelections()\">\n                {% trans \"Load Selections\" %}\n            </button>\n        </div>\n        \n        <div class=\"vdl-feature-card\">\n            <i class=\"fas fa-sync-alt vdl-text-gold\" aria-hidden=\"true\"></i>\n            <h4>{% trans \"Auto Sync\" %}</h4>\n            <p>{% trans \"Changes will sync when connection is restored\" %}</p>\n            <div class=\"vdl-sync-status\">\n                <span id=\"sync-status\" aria-live=\"polite\">{% trans \"Waiting for connection\" %}</span>\n            </div>\n        </div>\n    </div>\n</div>\n\n<!-- Session Expiration Notice -->\n<div class=\"vdl-error-fallback vdl-session-expired d-none\" id=\"session-expired-fallback\" \n     role=\"alert\" aria-live=\"assertive\" aria-atomic=\"true\">\n    <div class=\"vdl-error-content\">\n        <div class=\"vdl-error-animation\">\n            <i class=\"fas fa-clock vdl-tick-animation\" aria-hidden=\"true\"></i>\n        </div>\n        <h3 class=\"vdl-error-title\">{% trans \"Session Expired\" %}</h3>\n        <p class=\"vdl-error-message\">\n            {% trans \"Your session has expired for security reasons. Please log in again to continue with your selection.\" %}\n        </p>\n        <div class=\"vdl-error-actions\">\n            <a href=\"{% url 'account_login' %}\" class=\"vdl-btn vdl-btn-accent\"\n               aria-describedby=\"login-description\">\n                <i class=\"fas fa-sign-in-alt\" aria-hidden=\"true\"></i>\n                {% trans \"Log In\" %}\n            </a>\n            <div id=\"login-description\" class=\"sr-only\">{% trans \"Sign in to your account to continue\" %}</div>\n            \n            <button type=\"button\" class=\"vdl-btn vdl-btn-secondary\" onclick=\"continueAsGuest()\"\n                    aria-describedby=\"guest-description\">\n                <i class=\"fas fa-user\" aria-hidden=\"true\"></i>\n                {% trans \"Continue as Guest\" %}\n            </button>\n            <div id=\"guest-description\" class=\"sr-only\">{% trans \"Continue without an account with limited features\" %}</div>\n        </div>\n    </div>\n</div>\n\n<!-- CSS for Error Fallbacks -->\n<style>\n.vdl-error-fallback {\n    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\n    border: 2px solid var(--vdl-gold);\n    border-radius: 12px;\n    padding: 2rem;\n    margin: 2rem auto;\n    max-width: 600px;\n    text-align: center;\n    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);\n}\n\n.vdl-error-animation {\n    font-size: 4rem;\n    margin-bottom: 1.5rem;\n    color: var(--vdl-gold);\n}\n\n.vdl-error-title {\n    color: var(--vdl-burgundy);\n    font-size: 1.8rem;\n    font-weight: 600;\n    margin-bottom: 1rem;\n}\n\n.vdl-error-message {\n    color: var(--vdl-text);\n    font-size: 1.1rem;\n    line-height: 1.6;\n    margin-bottom: 2rem;\n    max-width: 500px;\n    margin-left: auto;\n    margin-right: auto;\n}\n\n.vdl-error-actions {\n    display: flex;\n    gap: 1rem;\n    justify-content: center;\n    flex-wrap: wrap;\n    margin-bottom: 1.5rem;\n}\n\n.vdl-error-suggestion {\n    background: rgba(var(--vdl-gold-rgb), 0.1);\n    padding: 1rem;\n    border-radius: 8px;\n    margin-top: 1rem;\n}\n\n.vdl-error-suggestion p {\n    margin-bottom: 0.5rem;\n    color: var(--vdl-burgundy);\n}\n\n.vdl-error-details summary {\n    cursor: pointer;\n    color: var(--vdl-burgundy);\n    font-weight: 500;\n    margin-bottom: 1rem;\n}\n\n.vdl-technical-info {\n    background: #f8f9fa;\n    padding: 1rem;\n    border-radius: 4px;\n    text-align: left;\n    font-size: 0.9rem;\n    color: #6c757d;\n}\n\n.vdl-offline-mode {\n    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);\n    border-radius: 12px;\n    padding: 2rem;\n    margin: 2rem 0;\n}\n\n.vdl-offline-header {\n    text-align: center;\n    margin-bottom: 2rem;\n}\n\n.vdl-offline-features {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n    gap: 1.5rem;\n}\n\n.vdl-feature-card {\n    background: white;\n    padding: 1.5rem;\n    border-radius: 8px;\n    text-align: center;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n}\n\n.vdl-feature-card i {\n    font-size: 2rem;\n    margin-bottom: 1rem;\n}\n\n.vdl-feature-card h4 {\n    color: var(--vdl-burgundy);\n    margin-bottom: 0.5rem;\n}\n\n.vdl-sync-status {\n    font-size: 0.9rem;\n    color: var(--vdl-text);\n    margin-top: 0.5rem;\n}\n\n/* Animations */\n.vdl-wine-loading {\n    animation: vdl-wine-pour 2s ease-in-out infinite;\n}\n\n.vdl-pulse-animation {\n    animation: vdl-pulse 1.5s ease-in-out infinite;\n}\n\n.vdl-fade-animation {\n    animation: vdl-fade 2s ease-in-out infinite;\n}\n\n.vdl-tick-animation {\n    animation: vdl-tick 1s ease-in-out infinite;\n}\n\n@keyframes vdl-wine-pour {\n    0%, 100% { transform: rotate(-5deg); opacity: 0.8; }\n    50% { transform: rotate(5deg); opacity: 1; }\n}\n\n@keyframes vdl-pulse {\n    0%, 100% { transform: scale(1); opacity: 0.8; }\n    50% { transform: scale(1.1); opacity: 1; }\n}\n\n@keyframes vdl-fade {\n    0%, 100% { opacity: 0.6; }\n    50% { opacity: 1; }\n}\n\n@keyframes vdl-tick {\n    0%, 100% { transform: rotate(0deg); }\n    50% { transform: rotate(15deg); }\n}\n\n/* Reduced motion support */\n@media (prefers-reduced-motion: reduce) {\n    .vdl-wine-loading,\n    .vdl-pulse-animation,\n    .vdl-fade-animation,\n    .vdl-tick-animation {\n        animation: none;\n    }\n}\n\n/* Mobile responsiveness */\n@media (max-width: 768px) {\n    .vdl-error-fallback {\n        margin: 1rem;\n        padding: 1.5rem;\n    }\n    \n    .vdl-error-actions {\n        flex-direction: column;\n        align-items: stretch;\n    }\n    \n    .vdl-offline-features {\n        grid-template-columns: 1fr;\n    }\n}\n\n/* High contrast mode */\n@media (prefers-contrast: high) {\n    .vdl-error-fallback {\n        border-width: 3px;\n        border-color: #000;\n    }\n    \n    .vdl-error-title {\n        color: #000;\n    }\n}\n\n/* Dark mode support */\n@media (prefers-color-scheme: dark) {\n    .vdl-error-fallback {\n        background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);\n        color: #fff;\n    }\n    \n    .vdl-feature-card {\n        background: #4a5568;\n        color: #fff;\n    }\n    \n    .vdl-technical-info {\n        background: #2d3748;\n        color: #cbd5e0;\n    }\n}\n</style>\n\n<!-- Error Handling JavaScript -->\n<script>\n// Error fallback functions\nfunction showNetworkError(error) {\n    const fallback = document.getElementById('network-error-fallback');\n    fallback.classList.remove('d-none');\n    \n    // Update technical details\n    document.getElementById('error-type').textContent = error.name || 'Network Error';\n    document.getElementById('error-timestamp').textContent = new Date().toLocaleString();\n    document.getElementById('user-agent').textContent = navigator.userAgent;\n    \n    // Announce to screen readers\n    announceToScreenReader('{% trans \"Network error detected. Please check your connection.\" %}');\n}\n\nfunction showAPIError(error) {\n    const fallback = document.getElementById('api-error-fallback');\n    fallback.classList.remove('d-none');\n    \n    // Log error for debugging\n    console.error('API Error:', error);\n    \n    // Announce to screen readers\n    announceToScreenReader('{% trans \"Service temporarily unavailable. You can try again or view cached content.\" %}');\n}\n\nfunction showMapError() {\n    const fallback = document.getElementById('map-error-fallback');\n    fallback.classList.remove('d-none');\n    \n    // Hide map container\n    const mapContainer = document.getElementById('vineyard-map');\n    if (mapContainer) {\n        mapContainer.style.display = 'none';\n    }\n}\n\nfunction showSessionExpired() {\n    const fallback = document.getElementById('session-expired-fallback');\n    fallback.classList.remove('d-none');\n    \n    // Clear any stored session data\n    sessionStorage.clear();\n    \n    // Announce to screen readers\n    announceToScreenReader('{% trans \"Your session has expired. Please log in to continue.\" %}');\n}\n\nfunction showOfflineMode() {\n    const offlineMode = document.getElementById('offline-mode');\n    offlineMode.classList.remove('d-none');\n    \n    // Update sync status\n    updateSyncStatus('{% trans \"Offline\" %}');\n    \n    // Announce to screen readers\n    announceToScreenReader('{% trans \"Now in offline mode. Limited functionality available.\" %}');\n}\n\nfunction retryOperation() {\n    // Hide error fallbacks\n    document.querySelectorAll('.vdl-error-fallback').forEach(el => {\n        el.classList.add('d-none');\n    });\n    \n    // Reload the page or retry specific operations\n    window.location.reload();\n}\n\nfunction retryMapLoad() {\n    const mapContainer = document.getElementById('vineyard-map');\n    const mapError = document.getElementById('map-error-fallback');\n    \n    mapError.classList.add('d-none');\n    \n    // Show loading state\n    mapContainer.innerHTML = '<div class=\"text-center p-4\"><i class=\"fas fa-wine-glass-alt vdl-wine-loading\"></i><br>{% trans \"Loading map...\" %}</div>';\n    \n    // Attempt to reinitialize map\n    setTimeout(() => {\n        try {\n            initializeMap();\n        } catch (error) {\n            showMapError();\n        }\n    }, 1000);\n}\n\nfunction showPlotList() {\n    // Redirect to list view\n    window.location.href = '{% url \"vinsdelux:coffret_list\" %}';\n}\n\nfunction showCachedData() {\n    // Implement cached data display\n    const cachedPlots = getCachedPlots();\n    if (cachedPlots.length > 0) {\n        displayCachedPlots(cachedPlots);\n    } else {\n        announceToScreenReader('{% trans \"No cached plot data available.\" %}');\n    }\n}\n\nfunction continueAsGuest() {\n    // Clear session and continue without authentication\n    sessionStorage.clear();\n    document.getElementById('session-expired-fallback').classList.add('d-none');\n    announceToScreenReader('{% trans \"Continuing as guest. Some features may be limited.\" %}');\n}\n\nfunction updateSyncStatus(status) {\n    const syncStatus = document.getElementById('sync-status');\n    if (syncStatus) {\n        syncStatus.textContent = status;\n    }\n}\n\nfunction getCachedPlots() {\n    try {\n        return JSON.parse(localStorage.getItem('cachedPlots')) || [];\n    } catch (error) {\n        return [];\n    }\n}\n\nfunction displayCachedPlots(plots) {\n    // Implementation for displaying cached plot data\n    console.log('Displaying cached plots:', plots);\n}\n\n// Set up error handlers\nwindow.addEventListener('error', (event) => {\n    if (event.error && event.error.name === 'NetworkError') {\n        showNetworkError(event.error);\n    }\n});\n\nwindow.addEventListener('unhandledrejection', (event) => {\n    if (event.reason && event.reason.status >= 500) {\n        showAPIError(event.reason);\n    }\n});\n\n// Connection status monitoring\nwindow.addEventListener('online', () => {\n    updateSyncStatus('{% trans \"Connected\" %}');\n    // Hide offline mode\n    document.getElementById('offline-mode').classList.add('d-none');\n    announceToScreenReader('{% trans \"Connection restored\" %}');\n});\n\nwindow.addEventListener('offline', () => {\n    updateSyncStatus('{% trans \"Offline\" %}');\n    showOfflineMode();\n});\n</script>"
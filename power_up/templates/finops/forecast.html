{% extends "finops/base_finops.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Cost Forecast - FinOps Hub" %}{% endblock %}

{% block finops_content %}
<div class="space-y-6">
    <!-- Header -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900">{% trans "Cost Forecast" %}</h1>
        <p class="mt-2 text-sm text-gray-600">
            {% trans "Predicted costs for the next" %} {{ forecast_days }} {% trans "days based on historical trends" %}
        </p>
    </div>

    {% if not has_data %}
    <!-- No Data Message -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-yellow-800">{% trans "No Forecast Data Available" %}</h3>
                <div class="mt-2 text-sm text-yellow-700">
                    <p>{% trans "Forecasts haven't been generated yet. This requires at least 30 days of historical data." %}</p>
                    {% if user.is_staff %}
                    <p class="mt-2">{% trans "Staff: Run" %} <code class="bg-yellow-100 px-1 py-0.5 rounded">python manage.py generate_cost_forecasts</code> {% trans "to generate forecasts" %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="text-sm font-medium text-gray-500">{% trans "Avg Daily (Historical)" %}</div>
            <div class="mt-2 text-3xl font-bold text-gray-900">€{{ avg_historical|floatformat:2 }}</div>
        </div>
        <div class="bg-blue-50 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-blue-800">{% trans "Avg Daily (Forecast)" %}</div>
            <div class="mt-2 text-3xl font-bold text-blue-900">€{{ avg_forecast|floatformat:2 }}</div>
            <div class="mt-1 text-sm {% if avg_forecast > avg_historical %}text-red-600{% else %}text-green-600{% endif %}">
                {% if avg_forecast > avg_historical %}
                    +{{ avg_forecast|floatformat:2|add:"-"|add:avg_historical|floatformat:2|stringformat:"s"|slice:"1:" }}
                    ({{ avg_forecast|floatformat:0|add:"-"|add:avg_historical|floatformat:0|mul:100|div:avg_historical|floatformat:0 }}%)
                {% else %}
                    {{ avg_forecast|floatformat:2|add:"-"|add:avg_historical|floatformat:2 }}
                    ({{ avg_forecast|floatformat:0|add:"-"|add:avg_historical|floatformat:0|mul:100|div:avg_historical|floatformat:0 }}%)
                {% endif %}
            </div>
        </div>
        <div class="bg-green-50 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-green-800">{% trans "Total Forecast" %} ({{ forecast_days }}d)</div>
            <div class="mt-2 text-3xl font-bold text-green-900">€{{ total_forecast|floatformat:2 }}</div>
        </div>
        <div class="bg-purple-50 rounded-lg shadow p-6">
            <div class="text-sm font-medium text-purple-800">{% trans "Model Accuracy (R²)" %}</div>
            <div class="mt-2 text-3xl font-bold text-purple-900">{{ model_accuracy|floatformat:3 }}</div>
            <div class="mt-1 text-xs text-purple-700">{% trans "0-1 scale, higher is better" %}</div>
        </div>
    </div>

    <!-- Forecast Chart (Placeholder for Chart.js) -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-900">{% trans "Cost Trend & Forecast" %}</h2>
            <div class="flex space-x-2">
                <a href="?days=30" class="px-3 py-1 text-sm {% if forecast_days == 30 %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} rounded">
                    30d
                </a>
                <a href="?days=90" class="px-3 py-1 text-sm {% if forecast_days == 90 %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} rounded">
                    90d
                </a>
            </div>
        </div>

        <!-- Temporary: Table view until Chart.js is added -->
        <div class="overflow-x-auto">
            <div class="text-sm text-gray-600 mb-4">
                {% trans "Showing historical data (last 30 days) and forecast predictions" %}
            </div>

            <!-- Historical Data Summary -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">{% trans "Recent Historical Costs" %}</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    {% for item in historical|slice:"-5:" %}
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="text-xs text-gray-500">{{ item.period_start|date:"M d" }}</div>
                        <div class="text-lg font-semibold text-gray-900">€{{ item.total_cost|floatformat:2 }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Forecast Data -->
            <div>
                <h3 class="text-lg font-semibold text-blue-800 mb-2">{% trans "Forecasted Costs" %}</h3>
                <div class="grid grid-cols-2 md:grid-cols-7 gap-2">
                    {% for forecast in forecasts|slice:":14" %}
                    <div class="bg-blue-50 p-2 rounded border border-blue-200">
                        <div class="text-xs text-blue-600">{{ forecast.forecast_date|date:"M d" }}</div>
                        <div class="text-sm font-semibold text-blue-900">€{{ forecast.forecast_cost|floatformat:2 }}</div>
                        <div class="text-xs text-blue-600">±{{ forecast.upper_bound|add:"-"|add:forecast.forecast_cost|floatformat:2|stringformat:"s"|slice:"1:" }}</div>
                    </div>
                    {% endfor %}
                </div>

                {% if forecasts|length > 14 %}
                <details class="mt-4">
                    <summary class="text-sm text-blue-600 cursor-pointer hover:text-blue-800">
                        {% trans "Show all" %} {{ forecasts|length }} {% trans "forecasts" %}
                    </summary>
                    <div class="grid grid-cols-2 md:grid-cols-7 gap-2 mt-2">
                        {% for forecast in forecasts|slice:"14:" %}
                        <div class="bg-blue-50 p-2 rounded border border-blue-200">
                            <div class="text-xs text-blue-600">{{ forecast.forecast_date|date:"M d" }}</div>
                            <div class="text-sm font-semibold text-blue-900">€{{ forecast.forecast_cost|floatformat:2 }}</div>
                            <div class="text-xs text-blue-600">±{{ forecast.upper_bound|add:"-"|add:forecast.forecast_cost|floatformat:2|stringformat:"s"|slice:"1:" }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Model Information -->
    <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">{% trans "About the Forecast Model" %}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
            <div>
                <h4 class="font-semibold text-gray-900 mb-1">{% trans "Algorithm" %}</h4>
                <p>{% trans "Linear regression with weekly seasonality adjustment" %}</p>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900 mb-1">{% trans "Training Data" %}</h4>
                <p>{% trans "Last 90 days of historical cost data" %}</p>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900 mb-1">{% trans "Confidence Interval" %}</h4>
                <p>{% trans "95% confidence interval (±1.96 standard errors)" %}</p>
            </div>
            <div>
                <h4 class="font-semibold text-gray-900 mb-1">{% trans "Update Frequency" %}</h4>
                <p>{% trans "Automatically regenerated after each daily data sync" %}</p>
            </div>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

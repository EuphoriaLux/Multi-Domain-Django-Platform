{% extends "crm/base_crm.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block crm_content %}
<!-- Breadcrumb + Header -->
<div class="mb-8">
    <nav class="text-sm mb-3">
        <a href="{% url 'crm:groups_overview' %}" class="text-gray-500 hover:text-powerup-orange transition-colors">&larr; All Groups</a>
    </nav>
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ group.name }}</h1>
            {% if group.description %}
            <p class="text-gray-500 mt-1 max-w-2xl">{{ group.description }}</p>
            {% endif %}
        </div>
        {% if active_contract %}
        <div class="mt-4 md:mt-0 flex items-center gap-3">
            <span class="tier-badge tier-{{ active_contract.plan.plan_type }}">
                <span class="tier-dot"></span>
                {{ active_contract.plan.get_plan_type_display }}
            </span>
            {% if days_remaining is not None %}
            <span class="text-sm font-medium {% if days_remaining <= 30 %}health-danger{% elif days_remaining <= 90 %}health-warning{% else %}health-good{% endif %}">
                {{ days_remaining }}d remaining
            </span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Contract & Plan Summary -->
{% if active_contract %}
<div class="crm-card p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Active Contract</h2>
        <span class="text-xs font-mono text-gray-400">{{ active_contract.contract_number }}</span>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6">
        <div>
            <p class="text-xs text-gray-500 mb-1">Support Hours</p>
            <p class="text-sm font-semibold text-gray-900">{{ active_contract.plan.support_hours }}</p>
        </div>
        <div>
            <p class="text-xs text-gray-500 mb-1">Channels</p>
            <p class="text-sm font-semibold text-gray-900">{{ active_contract.plan.support_channels }}</p>
        </div>
        <div>
            <p class="text-xs text-gray-500 mb-1">Severity</p>
            <p class="text-sm font-semibold text-gray-900">{{ active_contract.plan.severity_levels }}</p>
        </div>
        <div>
            <p class="text-xs text-gray-500 mb-1">Requests / Year</p>
            <p class="text-sm font-semibold text-gray-900">
                {% if active_contract.plan.support_requests_per_year == 0 %}
                    PAYG
                {% else %}
                    {{ active_contract.plan.support_requests_per_year }}
                {% endif %}
            </p>
        </div>
        <div>
            <p class="text-xs text-gray-500 mb-1">Critical Sit</p>
            <p class="text-sm font-semibold {% if active_contract.plan.crit_sit_management %}text-green-600{% else %}text-gray-400{% endif %}">
                {% if active_contract.plan.crit_sit_management %}Yes{% else %}No{% endif %}
            </p>
        </div>
        <div>
            <p class="text-xs text-gray-500 mb-1">Period</p>
            <p class="text-sm font-semibold text-gray-900">{{ active_contract.start_date|date:"M j, Y" }} &ndash; {{ active_contract.end_date|date:"M j, Y" }}</p>
        </div>
        <div>
            <p class="text-xs text-gray-500 mb-1">Auto Renew</p>
            <p class="text-sm font-semibold {% if active_contract.auto_renewal %}text-green-600{% else %}text-gray-400{% endif %}">
                {% if active_contract.auto_renewal %}Yes{% else %}No{% endif %}
            </p>
        </div>
    </div>
    {% if active_contract.plan.products_covered %}
    <div class="mt-4 pt-4 border-t border-gray-100">
        <p class="text-xs text-gray-500 mb-1">Products Covered</p>
        <p class="text-sm text-gray-700">{{ active_contract.plan.products_covered }}</p>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Capacity Gauges -->
{% if active_contract %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <!-- Tenant Usage -->
    <div class="crm-card p-5">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-gray-700">Tenant Usage</h3>
            <span class="text-xs text-gray-400">{{ entities|length }} entities</span>
        </div>
        {% with used=total_tenants max=active_contract.plan.max_tenants %}
        <div class="flex items-end gap-2 mb-2">
            <span class="text-2xl font-bold text-gray-900">{{ used }}</span>
            <span class="text-sm text-gray-400 mb-0.5">/ {{ max }}</span>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-2">
            {% widthratio used max 100 as pct %}
            <div class="h-2 rounded-full transition-all {% if used >= max %}bg-red-500{% elif used > max|floatformat:"0" %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                 style="width: {% widthratio used max 100 %}%"></div>
        </div>
        {% endwith %}
    </div>

    <!-- Contact Usage -->
    <div class="crm-card p-5">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-gray-700">Contact Usage</h3>
        </div>
        {% with used=contacts|length max=active_contract.plan.max_authorized_contacts %}
        <div class="flex items-end gap-2 mb-2">
            <span class="text-2xl font-bold text-gray-900">{{ used }}</span>
            <span class="text-sm text-gray-400 mb-0.5">/ {{ max }}</span>
        </div>
        <div class="w-full bg-gray-100 rounded-full h-2">
            <div class="h-2 rounded-full transition-all {% if used >= max %}bg-red-500{% elif used > max|floatformat:"0" %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                 style="width: {% widthratio used max 100 %}%"></div>
        </div>
        {% endwith %}
    </div>

    <!-- Ticket Quota Usage -->
    <div class="crm-card p-5">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-gray-700">Ticket Quota</h3>
            <span class="text-xs text-gray-400">trailing 12 mo</span>
        </div>
        <div class="flex items-end gap-2 mb-2">
            <span class="text-2xl font-bold text-gray-900">{{ ticket_quota_used }}</span>
            <span class="text-sm text-gray-400 mb-0.5">
                / {% if ticket_quota_max == 0 %}PAYG{% else %}{{ ticket_quota_max }}{% endif %}
            </span>
        </div>
        {% if ticket_quota_max > 0 %}
        <div class="w-full bg-gray-100 rounded-full h-2">
            <div class="h-2 rounded-full transition-all {% if ticket_quota_used >= ticket_quota_max %}bg-red-500{% else %}bg-green-500{% endif %}"
                 style="width: {% widthratio ticket_quota_used ticket_quota_max 100 %}%"></div>
        </div>
        {% else %}
        <div class="w-full bg-gray-100 rounded-full h-2">
            <div class="h-2 rounded-full bg-gray-300" style="width: 100%"></div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Two-Column Layout: Entities/Tenants + Account Managers -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

    <!-- Entities & Tenants (2/3 width) -->
    <div class="lg:col-span-2 space-y-4">
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Entities & Tenants</h2>
        {% for entity in entities %}
        <div class="crm-card">
            <div class="p-4 border-b border-gray-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-900">{{ entity.name }}</h3>
                        {% if entity.description %}
                        <p class="text-xs text-gray-500 mt-0.5">{{ entity.description }}</p>
                        {% endif %}
                    </div>
                    <span class="text-xs text-gray-400">{{ entity.num_tenants }} tenant{{ entity.num_tenants|pluralize }}</span>
                </div>
            </div>
            {% for tenant in entity.tenants.all %}
            <div class="px-4 py-3 {% if not forloop.last %}border-b border-gray-50{% endif %} flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="w-2 h-2 rounded-full {% if tenant.is_active %}bg-green-400{% else %}bg-gray-300{% endif %}"></span>
                    <div>
                        <p class="text-sm font-medium text-gray-800">{{ tenant.company_name }}</p>
                        <p class="text-xs text-gray-400 font-mono">{{ tenant.primary_domain }}</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs px-2 py-0.5 rounded-full
                        {% if tenant.environment_type == 'production' %}bg-green-50 text-green-700
                        {% elif tenant.environment_type == 'sandbox' %}bg-yellow-50 text-yellow-700
                        {% elif tenant.environment_type == 'development' %}bg-blue-50 text-blue-700
                        {% else %}bg-gray-50 text-gray-600{% endif %}">
                        {{ tenant.get_environment_type_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- Account Managers (1/3 width) -->
    <div class="space-y-4">
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Account Managers</h2>
        {% for assignment in managers %}
        <div class="crm-card p-4">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-powerup-orange/10 flex items-center justify-center shrink-0">
                    <svg class="w-5 h-5 text-powerup-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <div class="min-w-0">
                    <p class="text-sm font-semibold text-gray-900">{{ assignment.account_manager.display_name }}</p>
                    {% if assignment.is_primary %}
                    <span class="inline-block text-xs px-1.5 py-0.5 rounded bg-powerup-orange/10 text-powerup-orange font-medium mt-0.5">Primary</span>
                    {% else %}
                    <span class="inline-block text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 font-medium mt-0.5">Backup</span>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1 truncate">{{ assignment.account_manager.email }}</p>
                    {% if assignment.account_manager.phone_dedicated %}
                    <p class="text-xs text-gray-500 truncate">{{ assignment.account_manager.phone_dedicated }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Service Experts -->
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide pt-2">Service Experts</h2>
        {% for assignment in service_experts %}
        <div class="crm-card p-4">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center shrink-0">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="min-w-0">
                    <p class="text-sm font-semibold text-gray-900">{{ assignment.service_expert.display_name }}</p>
                    {% if assignment.is_primary %}
                    <span class="inline-block text-xs px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-600 font-medium mt-0.5">Primary</span>
                    {% else %}
                    <span class="inline-block text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-500 font-medium mt-0.5">Backup</span>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-1 truncate">{{ assignment.service_expert.email }}</p>
                    {% if assignment.service_expert.phone_dedicated %}
                    <p class="text-xs text-gray-500 truncate">{{ assignment.service_expert.phone_dedicated }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="crm-card p-4 text-center text-sm text-gray-400">No service experts assigned.</div>
        {% endfor %}

        <!-- Contract History -->
        {% if contracts|length > 1 %}
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide pt-2">Contract History</h2>
        {% for contract in contracts %}
        <div class="crm-card p-4">
            <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-mono text-gray-400">{{ contract.contract_number }}</span>
                <span class="text-xs px-2 py-0.5 rounded-full font-medium
                    {% if contract.status == 'active' %}bg-green-50 text-green-700
                    {% elif contract.status == 'expired' %}bg-gray-100 text-gray-500
                    {% elif contract.status == 'draft' %}bg-blue-50 text-blue-600
                    {% elif contract.status == 'suspended' %}bg-yellow-50 text-yellow-700
                    {% else %}bg-red-50 text-red-600{% endif %}">
                    {{ contract.get_status_display }}
                </span>
            </div>
            <p class="text-sm font-medium text-gray-800">{{ contract.plan.get_plan_type_display }}</p>
            <p class="text-xs text-gray-500">{{ contract.start_date|date:"M j, Y" }} &ndash; {{ contract.end_date|date:"M j, Y" }}</p>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Recent Tickets -->
<div class="crm-card mb-6">
    <div class="p-5 border-b border-gray-100 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
            Recent Tickets
            <span class="ml-2 text-xs font-normal normal-case text-gray-400">({{ recent_tickets|length }})</span>
        </h2>
        <div class="flex items-center gap-3">
            <a href="{% url 'crm:ticket_create' %}?group={{ group.pk }}" class="inline-flex items-center gap-1.5 bg-powerup-orange text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-orange-600 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                New Ticket
            </a>
            <a href="{% url 'crm:ticket_list' %}?group={{ group.pk }}" class="text-xs text-powerup-orange hover:underline">View all &rarr;</a>
        </div>
    </div>
    {% if recent_tickets %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50">
                    <th class="px-5 py-3">Reference</th>
                    <th class="px-5 py-3">Title</th>
                    <th class="px-5 py-3">Sev</th>
                    <th class="px-5 py-3">Status</th>
                    <th class="px-5 py-3">Assigned To</th>
                    <th class="px-5 py-3">Created</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
                {% for ticket in recent_tickets %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-5 py-3">
                        <a href="{% url 'crm:ticket_detail' pk=ticket.pk %}" class="text-sm font-mono text-powerup-orange hover:underline">{{ ticket.reference_number }}</a>
                    </td>
                    <td class="px-5 py-3">
                        <a href="{% url 'crm:ticket_detail' pk=ticket.pk %}" class="text-sm text-gray-900 hover:text-powerup-orange">{{ ticket.title|truncatewords:10 }}</a>
                    </td>
                    <td class="px-5 py-3">
                        <span class="inline-block text-xs px-2 py-0.5 rounded-full font-semibold sev-{{ ticket.severity }}">{{ ticket.severity }}</span>
                    </td>
                    <td class="px-5 py-3">
                        <span class="inline-block text-xs px-2 py-0.5 rounded-full font-medium status-{{ ticket.status }}">{{ ticket.get_status_display }}</span>
                    </td>
                    <td class="px-5 py-3 text-sm text-gray-600">{{ ticket.assigned_to.display_name|default:"&mdash;" }}</td>
                    <td class="px-5 py-3 text-sm text-gray-500">{{ ticket.created_at|timesince }} ago</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="p-8 text-center text-sm text-gray-400">No tickets yet.</div>
    {% endif %}
</div>

<!-- Authorized Contacts Table -->
<div class="crm-card mb-6">
    <div class="p-5 border-b border-gray-100">
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
            Authorized Contacts
            <span class="ml-2 text-xs font-normal normal-case text-gray-400">({{ contacts|length }})</span>
        </h2>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <th class="px-5 py-3">Name</th>
                    <th class="px-5 py-3">Email</th>
                    <th class="px-5 py-3">Phone</th>
                    <th class="px-5 py-3">Role</th>
                    <th class="px-5 py-3">Tenant Access</th>
                    <th class="px-5 py-3">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
                {% for contact in contacts %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-5 py-3">
                        <p class="text-sm font-medium text-gray-900">{{ contact.display_name }}</p>
                    </td>
                    <td class="px-5 py-3">
                        <p class="text-sm text-gray-600">{{ contact.email }}</p>
                    </td>
                    <td class="px-5 py-3">
                        <p class="text-sm text-gray-600">{{ contact.phone|default:"&mdash;" }}</p>
                    </td>
                    <td class="px-5 py-3">
                        {% for role in contact.roles.all %}
                        <span class="inline-block text-xs px-2 py-0.5 rounded-full font-medium role-{{ role.role }}">
                            {{ role.get_role_display }}
                        </span>
                        {% empty %}
                        <span class="text-xs text-gray-400">&mdash;</span>
                        {% endfor %}
                    </td>
                    <td class="px-5 py-3">
                        <div class="flex flex-wrap gap-1">
                            {% for perm in contact.tenant_permissions.all %}
                            <span class="text-xs px-1.5 py-0.5 rounded bg-gray-100 text-gray-600" title="{{ perm.tenant.company_name }}{% if not perm.can_create_tickets %} (view only){% endif %}">
                                {{ perm.tenant.company_name|truncatewords:3 }}{% if not perm.can_create_tickets %} <span class="text-gray-400">R</span>{% endif %}
                            </span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-5 py-3">
                        {% if contact.is_active %}
                        <span class="w-2 h-2 rounded-full bg-green-400 inline-block"></span>
                        {% else %}
                        <span class="w-2 h-2 rounded-full bg-gray-300 inline-block"></span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

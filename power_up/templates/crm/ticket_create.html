{% extends "crm/base_crm.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block crm_content %}
<!-- Breadcrumb + Header -->
<div class="mb-6">
    <nav class="text-sm mb-3">
        {% if group %}
        <a href="{% url 'crm:group_detail' pk=group.pk %}" class="text-gray-500 hover:text-powerup-orange transition-colors">&larr; {{ group.name }}</a>
        {% else %}
        <a href="{% url 'crm:ticket_list' %}" class="text-gray-500 hover:text-powerup-orange transition-colors">&larr; All Tickets</a>
        {% endif %}
    </nav>
    <h1 class="text-2xl font-bold text-gray-900">New Support Ticket</h1>
</div>

{% if group %}
<!-- Group Context Banner -->
<div class="rounded-lg border border-powerup-orange/20 bg-orange-50 px-5 py-3 mb-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
        <svg class="w-5 h-5 text-powerup-orange shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
        </svg>
        <span class="text-sm font-medium text-gray-800">Creating ticket for <strong>{{ group.name }}</strong></span>
    </div>
    {% if active_contract %}
    <span class="tier-badge tier-{{ active_contract.plan.plan_type }}">
        <span class="tier-dot"></span>
        {{ active_contract.plan.get_plan_type_display }}
    </span>
    {% endif %}
</div>
{% endif %}

<!-- Two Column Layout -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Form (2/3) -->
    <div class="lg:col-span-2">
        <form method="post" class="crm-card p-6">
            {% csrf_token %}
            {% if group %}
            <input type="hidden" name="group" value="{{ group.pk }}">
            {% endif %}

            {% if form.errors %}
            <div class="rounded-lg bg-red-50 text-red-800 px-4 py-3 text-sm mb-6">
                Please correct the errors below.
            </div>
            {% endif %}

            <div class="space-y-5">
                <div>
                    <label for="id_title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    {{ form.title }}
                    {% if form.title.errors %}<p class="text-xs text-red-600 mt-1">{{ form.title.errors.0 }}</p>{% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="id_tenant" class="block text-sm font-medium text-gray-700 mb-1">Tenant</label>
                        <select name="tenant" id="id_tenant" class="{{ form.tenant.field.widget.attrs.class }}"
                                hx-get="{% url 'crm:ticket_requester_options' %}{% if group %}?group={{ group.pk }}{% endif %}"
                                hx-trigger="change"
                                hx-target="#id_requester"
                                hx-include="[name='tenant']">
                            <option value="">---------</option>
                            {% for value, label in form.tenant.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.tenant.value|slugify == value|slugify %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.tenant.errors %}<p class="text-xs text-red-600 mt-1">{{ form.tenant.errors.0 }}</p>{% endif %}
                    </div>
                    <div>
                        <label for="id_requester" class="block text-sm font-medium text-gray-700 mb-1">Requester</label>
                        <select name="requester" id="id_requester" class="{{ form.requester.field.widget.attrs.class }}">
                            <option value="">---------</option>
                            {% for value, label in form.requester.field.choices %}
                                {% if value %}
                                <option value="{{ value }}" {% if form.requester.value|slugify == value|slugify %}selected{% endif %}>{{ label }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        {% if form.requester.errors %}<p class="text-xs text-red-600 mt-1">{{ form.requester.errors.0 }}</p>{% endif %}
                    </div>
                </div>

                <div>
                    <label for="id_description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    {{ form.description }}
                    {% if form.description.errors %}<p class="text-xs text-red-600 mt-1">{{ form.description.errors.0 }}</p>{% endif %}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="id_severity" class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
                        {{ form.severity }}
                    </div>
                    <div>
                        <label for="id_priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        {{ form.priority }}
                    </div>
                    <div>
                        <label for="id_product_category" class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                        {{ form.product_category }}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="id_assigned_to" class="block text-sm font-medium text-gray-700 mb-1">Assign To (Account Manager)</label>
                        {{ form.assigned_to }}
                    </div>
                    <div>
                        <label for="id_assigned_expert" class="block text-sm font-medium text-gray-700 mb-1">Assign Expert (Service)</label>
                        {{ form.assigned_expert }}
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100 flex justify-end gap-3">
                    {% if group %}
                    <a href="{% url 'crm:group_detail' pk=group.pk %}" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Cancel</a>
                    {% else %}
                    <a href="{% url 'crm:ticket_list' %}" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">Cancel</a>
                    {% endif %}
                    <button type="submit" class="bg-powerup-orange text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-orange-600 transition-colors">
                        Create Ticket
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Right: Help Sidebar (1/3) -->
    <div class="space-y-4">
        <div class="crm-card p-5">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Severity Guide</h3>
            <dl class="space-y-3 text-sm">
                <div>
                    <dt class="font-medium text-red-700">Severity A &ndash; Critical</dt>
                    <dd class="text-gray-500 text-xs mt-0.5">Complete business impact. Production system down.</dd>
                </div>
                <div>
                    <dt class="font-medium text-yellow-700">Severity B &ndash; Important</dt>
                    <dd class="text-gray-500 text-xs mt-0.5">Significant impact. Degraded performance or partial outage.</dd>
                </div>
                <div>
                    <dt class="font-medium text-blue-700">Severity C &ndash; Non-critical</dt>
                    <dd class="text-gray-500 text-xs mt-0.5">Minor impact. Questions, guidance, or planned work.</dd>
                </div>
            </dl>
        </div>

        <div class="crm-card p-5">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Tips</h3>
            <ul class="space-y-2 text-xs text-gray-500">
                <li>Select the correct <strong>tenant</strong> &mdash; this determines which group and contract the ticket falls under.</li>
                <li>Severity is constrained by the customer's plan. Bronze plans only support Sev B and C.</li>
                <li>If the ticket requires Microsoft escalation, the case ID can be added after creation.</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'finops_hub/css/finops.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h2">FinOps Hub - Cost Dashboard</h1>
            <p class="text-muted">Azure cost analytics and insights</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group" aria-label="Time period filter">
                <a href="?days=7" class="btn btn-sm btn-outline-primary {% if period.days == 7 %}active{% endif %}">7 days</a>
                <a href="?days=30" class="btn btn-sm btn-outline-primary {% if period.days == 30 %}active{% endif %}">30 days</a>
                <a href="?days=60" class="btn btn-sm btn-outline-primary {% if period.days == 60 %}active{% endif %}">60 days</a>
                <a href="?days=90" class="btn btn-sm btn-outline-primary {% if period.days == 90 %}active{% endif %}">90 days</a>
            </div>
        </div>
    </div>

    <!-- Summary Cards - Row 1 -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-primary h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Cost ({{ period.days }} days)</h6>
                    <h3 class="card-title text-primary">€{{ summary.total_cost|floatformat:2 }}</h3>
                    <small class="text-muted">Avg: €{{ summary.avg_daily_cost|floatformat:2 }}/day</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-success h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Month-to-Date</h6>
                    <h3 class="card-title text-success">€{{ summary.mtd_cost|floatformat:2 }}</h3>
                    <small class="text-muted">{{ period.end|date:"F Y" }}</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-info h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Year-to-Date</h6>
                    <h3 class="card-title text-info">€{{ summary.ytd_cost|floatformat:2 }}</h3>
                    <small class="text-muted">{{ period.end|date:"Y" }}</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-secondary h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Data Imports</h6>
                    <h3 class="card-title">{{ summary.completed_exports }}/{{ summary.total_exports }}</h3>
                    {% if latest_export %}
                    <small class="text-muted">Latest: {{ latest_export.billing_period_start|date:"M Y" }}</small>
                    {% else %}
                    <small class="text-muted">No imports yet</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Cost Trend (Last {{ period.days }} Days)</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chartView" id="dailyView" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="dailyView" onclick="toggleChartView('daily')">Daily</label>

                        <input type="radio" class="btn-check" name="chartView" id="weeklyView" autocomplete="off">
                        <label class="btn btn-outline-primary" for="weeklyView" onclick="toggleChartView('weekly')">Weekly</label>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="costTrendChart" height="80"></canvas>
                    <div class="alert alert-info mt-3 mb-0" role="alert">
                        <small class="d-flex align-items-center">
                            <strong class="me-2">Cost Categories:</strong>
                            <span class="d-flex align-items-center me-3">
                                <span class="legend-box" style="background-color: rgb(54, 162, 235); width: 16px; height: 16px; display: inline-block; margin-right: 6px; border-radius: 2px;"></span>
                                <strong>Usage Cost</strong><span class="ms-1 text-muted">- Pay-as-you-go (VMs, storage, compute)</span>
                            </span>
                            <span class="d-flex align-items-center">
                                <span class="legend-box" style="background-color: rgb(255, 159, 64); width: 16px; height: 16px; display: inline-block; margin-right: 6px; border-radius: 2px;"></span>
                                <strong>Purchase Cost</strong><span class="ms-1 text-muted">- Reservations, commitments</span>
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top Subscriptions</h5>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                    <div id="chartWrapper" style="position: relative; width: 100%; max-width: 300px; height: 300px;">
                        <canvas id="subscriptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Services Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Top Services by Cost</h5>
                    <a href="{% url 'finops_hub:services' %}" class="btn btn-sm btn-outline-primary">View All Services</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">#</th>
                                    <th style="width: 50%;">Service Name</th>
                                    <th style="width: 30%;">Cost Distribution</th>
                                    <th class="text-end" style="width: 15%;">Cost (EUR)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in top_services %}
                                <tr>
                                    <td class="text-muted">{{ forloop.counter }}</td>
                                    <td><strong>{{ service.service_name|default:"Unknown" }}</strong></td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                 style="width: {% widthratio service.cost summary.total_cost 100 %}%"
                                                 aria-valuenow="{{ service.cost }}" aria-valuemin="0" aria-valuemax="{{ summary.total_cost }}">
                                                {% widthratio service.cost summary.total_cost 100 %}%
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end"><strong>€{{ service.cost|floatformat:2 }}</strong></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox"></i> No service data available
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation & Export -->
    <div class="row mt-4">
        <div class="col-md-8">
            <h6 class="text-muted mb-3">Quick Actions</h6>
            <a href="{% url 'finops_hub:subscriptions' %}" class="btn btn-primary me-2 mb-2">
                <i class="bi bi-building"></i> View Subscriptions
            </a>
            <a href="{% url 'finops_hub:services' %}" class="btn btn-primary me-2 mb-2">
                <i class="bi bi-grid"></i> View Services
            </a>
            <a href="{% url 'finops_hub:resources' %}" class="btn btn-primary me-2 mb-2">
                <i class="bi bi-boxes"></i> Explore Resources
            </a>
            <a href="{% url 'finops_hub:import' %}" class="btn btn-secondary me-2 mb-2">
                <i class="bi bi-cloud-download"></i> Import Data
            </a>
            <a href="{% url 'finops_hub:faq' %}" class="btn btn-info mb-2">
                <i class="bi bi-question-circle"></i> FAQ & Data Flow
            </a>
        </div>
        <div class="col-md-4">
            <h6 class="text-muted mb-3">Export Data</h6>
            <div class="dropdown">
                <button class="btn btn-success dropdown-toggle mb-2" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-download"></i> Export CSV
                </button>
                <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                    <li><a class="dropdown-item" href="/finops/api/costs/export-csv/?days={{ period.days }}&format=daily_summary">Daily Summary</a></li>
                    <li><a class="dropdown-item" href="/finops/api/costs/export-csv/?days={{ period.days }}&format=by_service">By Service</a></li>
                    <li><a class="dropdown-item" href="/finops/api/costs/export-csv/?days={{ period.days }}&format=by_resource">By Resource (Top 1000)</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'finops_hub/js/finops_charts.js' %}"></script>
<script>
    let costChart = null;
    let rawCostData = [];
    let currentView = 'daily';

    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        // Cost trend chart
        fetchCostTrend();

        // Subscription pie chart
        const subscriptionData = {{ top_subscriptions|safe }};
        renderSubscriptionChart(subscriptionData);
    });

    function fetchCostTrend() {
        fetch('/finops/api/costs/trend/?days={{ period.days }}')
            .then(response => response.json())
            .then(data => {
                rawCostData = data.daily_costs;
                renderCostTrendChart(rawCostData, 'daily');
            });
    }

    function toggleChartView(view) {
        currentView = view;
        renderCostTrendChart(rawCostData, view);
    }

    function aggregateWeekly(dailyCosts) {
        const weeklyData = {};

        dailyCosts.forEach(day => {
            const date = new Date(day.usage_date);
            // Get Monday of the week
            const monday = new Date(date);
            monday.setDate(date.getDate() - date.getDay() + 1);
            const weekKey = monday.toISOString().split('T')[0];

            if (!weeklyData[weekKey]) {
                weeklyData[weekKey] = {
                    usage_date: weekKey,
                    total_cost: 0,
                    usage_cost: 0,
                    purchase_cost: 0
                };
            }

            weeklyData[weekKey].total_cost += parseFloat(day.total_cost || 0);
            weeklyData[weekKey].usage_cost += parseFloat(day.usage_cost || 0);
            weeklyData[weekKey].purchase_cost += parseFloat(day.purchase_cost || 0);
        });

        return Object.values(weeklyData).sort((a, b) =>
            new Date(a.usage_date) - new Date(b.usage_date)
        );
    }

    function formatDate(dateStr, view) {
        const date = new Date(dateStr);
        if (view === 'weekly') {
            const endDate = new Date(date);
            endDate.setDate(date.getDate() + 6);
            const options = { month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options) + ' - ' +
                   endDate.toLocaleDateString('en-US', options);
        } else {
            const options = { month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
    }

    function renderCostTrendChart(dailyCosts, view = 'daily') {
        const data = view === 'weekly' ? aggregateWeekly(dailyCosts) : dailyCosts;

        const ctx = document.getElementById('costTrendChart').getContext('2d');
        const labels = data.map(d => formatDate(d.usage_date, view));
        const costs = data.map(d => parseFloat(d.total_cost));
        const usageCosts = data.map(d => parseFloat(d.usage_cost || 0));
        const purchaseCosts = data.map(d => parseFloat(d.purchase_cost || 0));

        // Destroy existing chart if it exists
        if (costChart) {
            costChart.destroy();
        }

        costChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Usage Cost',
                        data: usageCosts,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    },
                    {
                        label: 'Purchase Cost',
                        data: purchaseCosts,
                        backgroundColor: 'rgba(255, 159, 64, 0.8)',
                        borderColor: 'rgb(255, 159, 64)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '€' + context.parsed.y.toFixed(2);
                                return label;
                            },
                            footer: function(tooltipItems) {
                                let total = 0;
                                tooltipItems.forEach(function(tooltipItem) {
                                    total += tooltipItem.parsed.y;
                                });
                                return 'Total: €' + total.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '€' + value.toFixed(2);
                            }
                        },
                        title: {
                            display: true,
                            text: 'Cost (EUR)'
                        }
                    }
                }
            }
        });
    }

    function renderSubscriptionChart(subscriptions) {
        const ctx = document.getElementById('subscriptionChart').getContext('2d');
        let labels = subscriptions.map(s => s.sub_account_name || 'Unknown');
        let costs = subscriptions.map(s => parseFloat(s.cost));

        // Generate dynamic colors for all subscriptions
        const colors = [
            'rgba(255, 99, 132, 0.9)',
            'rgba(54, 162, 235, 0.9)',
            'rgba(255, 206, 86, 0.9)',
            'rgba(75, 192, 192, 0.9)',
            'rgba(153, 102, 255, 0.9)',
            'rgba(255, 159, 64, 0.9)',
            'rgba(199, 199, 199, 0.9)',
            'rgba(83, 102, 255, 0.9)',
            'rgba(255, 99, 255, 0.9)',
            'rgba(99, 255, 132, 0.9)'
        ];

        let chartColors = colors.slice(0, costs.length);
        const isSingleSubscription = costs.length === 1;

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: costs,
                    backgroundColor: chartColors,
                    borderWidth: 0,
                    borderAlign: 'inner',
                    hoverBorderWidth: 0,
                    hoverOffset: 4,
                    spacing: 0,
                    borderRadius: 0,
                    offset: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1,
                layout: {
                    padding: {
                        top: 5,
                        bottom: 20,
                        left: 5,
                        right: 5
                    }
                },
                cutout: '60%',
                circumference: 360,
                rotation: 0,
                animation: {
                    animateRotate: true,
                    animateScale: false
                },
                elements: {
                    arc: {
                        borderWidth: 0,
                        borderAlign: 'inner'
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        align: 'center',
                        labels: {
                            padding: 15,
                            font: {
                                size: 11
                            },
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 10,
                            boxHeight: 10,
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '€' + context.parsed.toFixed(2);

                                // Calculate percentage
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                label += ' (' + percentage + '%)';

                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}

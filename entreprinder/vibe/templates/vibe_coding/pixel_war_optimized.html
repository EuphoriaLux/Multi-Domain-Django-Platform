{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Pixel War - Optimized" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vibe_coding/css/pixel_war.css' %}">
<style>
    #canvas-container {
        position: relative;
        width: 100%;
        height: 600px;
        overflow: hidden;
        border: 2px solid #333;
    }
    
    .fps-counter {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: #0f0;
        padding: 5px 10px;
        font-family: monospace;
        font-size: 14px;
        border-radius: 3px;
        z-index: 1000;
    }
    
    .corner-nav {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 1000;
    }
    
    .corner-nav button {
        width: 40px;
        height: 40px;
        border: 2px solid #333;
        background: white;
        cursor: pointer;
        font-size: 18px;
        border-radius: 5px;
        transition: all 0.2s;
    }
    
    .corner-nav button:hover {
        background: #f0f0f0;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>{% trans "Pixel War - Optimized Version" %}</h2>
            <div class="alert alert-info">
                <strong>Performance Improvements:</strong>
                <ul class="mb-0">
                    <li>WebGL rendering (if supported)</li>
                    <li>Spatial indexing with QuadTree</li>
                    <li>Dirty rectangle optimization</li>
                    <li>Smooth corner navigation</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-9">
            <div id="canvas-container">
                <canvas id="pixelCanvas"></canvas>
                <div class="fps-counter">FPS: <span id="fps">0</span></div>
                <div class="corner-nav">
                    <button onclick="pixelWar.navigateToCorner('top-left')" title="Top Left">↖️</button>
                    <button onclick="pixelWar.navigateToCorner('top-right')" title="Top Right">↗️</button>
                    <button onclick="pixelWar.navigateToCorner('center')" title="Center">⊙</button>
                    <button onclick="pixelWar.navigateToCorner('bottom-left')" title="Bottom Left">↙️</button>
                    <button onclick="pixelWar.navigateToCorner('bottom-right')" title="Bottom Right">↘️</button>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{% trans "Color Palette" %}</h5>
                    <div class="color-palette">
                        <button class="color-btn" data-color="#000000" style="background: #000000;"></button>
                        <button class="color-btn" data-color="#FFFFFF" style="background: #FFFFFF;"></button>
                        <button class="color-btn" data-color="#FF0000" style="background: #FF0000;"></button>
                        <button class="color-btn" data-color="#00FF00" style="background: #00FF00;"></button>
                        <button class="color-btn" data-color="#0000FF" style="background: #0000FF;"></button>
                        <button class="color-btn" data-color="#FFFF00" style="background: #FFFF00;"></button>
                        <button class="color-btn" data-color="#FF00FF" style="background: #FF00FF;"></button>
                        <button class="color-btn" data-color="#00FFFF" style="background: #00FFFF;"></button>
                    </div>
                    
                    <div class="mt-3">
                        <h6>{% trans "Controls" %}</h6>
                        <ul class="small">
                            <li>Click: Place pixel</li>
                            <li>Drag: Pan canvas</li>
                            <li>Scroll: Zoom in/out</li>
                            <li>Touch: Mobile gestures</li>
                        </ul>
                    </div>
                    
                    <div class="mt-3">
                        <h6>{% trans "Stats" %}</h6>
                        <div id="stats">
                            <p class="mb-1">Viewport: <span id="viewport-info">-</span></p>
                            <p class="mb-1">Zoom: <span id="zoom-level">1x</span></p>
                            <p class="mb-1">Pixels: <span id="pixel-count">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vibe_coding/js/pixel_war_optimized.js' %}"></script>
<script>
// Configuration
const config = {
    width: {{ canvas.width }},
    height: {{ canvas.height }},
    canvasId: {{ canvas.id }},
    isAuthenticated: {{ user.is_authenticated|lower }},
    registeredCooldown: {{ canvas.registered_cooldown_seconds }},
    anonymousCooldown: {{ canvas.anonymous_cooldown_seconds }},
    registeredPixelsPerMinute: {{ canvas.registered_pixels_per_minute }},
    anonymousPixelsPerMinute: {{ canvas.anonymous_pixels_per_minute }}
};

// Initialize optimized version
const pixelWar = new PixelWarOptimized('pixelCanvas', config);

// Color selection
document.querySelectorAll('.color-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        pixelWar.selectedColor = btn.dataset.color;
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    });
});

// Update stats
setInterval(() => {
    document.getElementById('zoom-level').textContent = pixelWar.viewport.scale.toFixed(1) + 'x';
    document.getElementById('viewport-info').textContent = 
        `${Math.round(pixelWar.viewport.x)}, ${Math.round(pixelWar.viewport.y)}`;
    document.getElementById('pixel-count').textContent = 
        Object.keys(pixelWar.pixelQuadTree.objects).length;
}, 100);
</script>
{% endblock %}
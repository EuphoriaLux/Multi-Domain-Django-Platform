{% extends "base.html" %}
{% load static %}

{% block title %}FinOps Hub - Subscriptions{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'entreprinder/css/pages/finops.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">FinOps Hub - Subscriptions</h1>
            <p class="text-muted">Multi-subscription cost comparison</p>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'finops_hub:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Subscriptions</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Period Info -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Analysis Period</h6>
                    <p class="mb-0">{{ period.start|date:"Y-m-d" }} to {{ period.end|date:"Y-m-d" }}</p>
                    <small class="text-muted">{{ period.days }} days</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Subscriptions</h6>
                    <h3 class="mb-0 text-success">{{ subscriptions_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Cost</h6>
                    <h3 class="mb-0 text-info">€{{ total_cost|floatformat:2 }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-panel">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="days" class="form-label">Time Period</label>
                        <select name="days" id="days" class="form-select">
                            <option value="7" {% if period.days == 7 %}selected{% endif %}>Last 7 days</option>
                            <option value="30" {% if period.days == 30 %}selected{% endif %}>Last 30 days</option>
                            <option value="60" {% if period.days == 60 %}selected{% endif %}>Last 60 days</option>
                            <option value="90" {% if period.days == 90 %}selected{% endif %}>Last 90 days</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Apply Filter</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Subscriptions Chart -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Cost by Subscription</h5>
                </div>
                <div class="card-body">
                    <canvas id="subscriptionBarChart" height="80"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Subscription Distribution</h5>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                    <div id="pieChartWrapper" style="position: relative; width: 100%; max-width: 300px; height: 300px;">
                        <canvas id="subscriptionPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriptions Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Subscription Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Subscription Name</th>
                                    <th class="text-end">Total Cost (EUR)</th>
                                    <th class="text-end">Record Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sub in subscriptions_list %}
                                <tr>
                                    <td>
                                        <strong>{{ sub.sub_account_name|default:"Unknown Subscription" }}</strong>
                                    </td>
                                    <td class="text-end">
                                        <span class="cost-amount">€{{ sub.total_cost|floatformat:2 }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-secondary">{{ sub.record_count }}</span>
                                    </td>
                                    <td>
                                        <a href="{% url 'finops_hub:services' %}?subscription={{ sub.sub_account_name }}"
                                           class="btn btn-sm btn-outline-primary">View Services</a>
                                        <a href="{% url 'finops_hub:resources' %}?subscription={{ sub.sub_account_name }}"
                                           class="btn btn-sm btn-outline-secondary">View Resources</a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox"></i> No subscription data available for this period
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Dashboard -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{% url 'finops_hub:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'entreprinder/js/finops_hub/finops_charts.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const subscriptions = {{ subscriptions|safe }};

        if (subscriptions && subscriptions.length > 0) {
            renderSubscriptionCharts(subscriptions);
        }
    });

    function renderSubscriptionCharts(subscriptions) {
        const labels = subscriptions.map(s => s.sub_account_name);
        const costs = subscriptions.map(s => parseFloat(s.total_cost));

        // Bar Chart
        const barCtx = document.getElementById('subscriptionBarChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Cost (EUR)',
                    data: costs,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '€' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Pie Chart (using doughnut for consistency with dashboard)
        const pieCtx = document.getElementById('subscriptionPieChart').getContext('2d');

        const colors = [
            'rgba(255, 99, 132, 0.9)',
            'rgba(54, 162, 235, 0.9)',
            'rgba(255, 206, 86, 0.9)',
            'rgba(75, 192, 192, 0.9)',
            'rgba(153, 102, 255, 0.9)',
            'rgba(255, 159, 64, 0.9)',
            'rgba(199, 199, 199, 0.9)',
            'rgba(83, 102, 255, 0.9)',
            'rgba(255, 99, 255, 0.9)',
            'rgba(99, 255, 132, 0.9)'
        ];

        const chartColors = colors.slice(0, costs.length);
        const isSingleSubscription = costs.length === 1;

        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: costs,
                    backgroundColor: chartColors,
                    borderWidth: 0,
                    borderAlign: 'inner',
                    hoverBorderWidth: 0,
                    hoverOffset: 4,
                    spacing: 0,
                    borderRadius: 0,
                    offset: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1,
                layout: {
                    padding: {
                        top: 5,
                        bottom: 20,
                        left: 5,
                        right: 5
                    }
                },
                cutout: '60%',
                circumference: 360,
                rotation: 0,
                animation: {
                    animateRotate: true,
                    animateScale: false
                },
                elements: {
                    arc: {
                        borderWidth: 0,
                        borderAlign: 'inner'
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        align: 'center',
                        labels: {
                            padding: 15,
                            font: {
                                size: 11
                            },
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 10,
                            boxHeight: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '€' + context.parsed.toFixed(2);

                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                label += ' (' + percentage + '%)';

                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}

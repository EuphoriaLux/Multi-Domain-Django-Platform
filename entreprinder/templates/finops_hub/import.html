{% extends "base.html" %}
{% load static %}

{% block title %}FinOps Hub - Import Data{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'powerup/css/pages/finops.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">FinOps Hub - Import Data</h1>
            <p class="text-muted">Manage Azure cost data imports</p>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'finops_hub:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Import</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Incomplete Imports Call-to-Action -->
    {% if incomplete_exports %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning border-warning shadow-sm">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                        </svg>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h5 class="alert-heading mb-2">Action Required: Complete Import Setup</h5>
                        <p class="mb-3">
                            <strong>{{ incomplete_exports.count }}</strong> export{{ incomplete_exports.count|pluralize }} completed with 0 records.
                            This usually means the subscription ID is missing from the cost data.
                        </p>
                        <p class="mb-3">
                            <strong>Quick fix:</strong> Add the Azure subscription ID below to enable data import.
                        </p>

                        <div class="table-responsive">
                            <table class="table table-sm table-bordered bg-white mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Subscription Name</th>
                                        <th>Billing Period</th>
                                        <th>Import Date</th>
                                        <th width="120">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for export in incomplete_exports %}
                                    <tr>
                                        <td><strong>{{ export.subscription_name }}</strong></td>
                                        <td>
                                            <small>{{ export.billing_period_start|date:"Y-m-d" }} to {{ export.billing_period_end|date:"Y-m-d" }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ export.import_completed_at|date:"Y-m-d H:i" }}</small>
                                        </td>
                                        <td>
                                            <a href="{% url 'finops_hub:update_subscription_id' export.id %}" class="btn btn-sm btn-primary">
                                                Add ID
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Import Instructions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Import Commands</h5>
                </div>
                <div class="card-body">
                    <h6>Production: Import from Azure Blob Storage</h6>
                    <pre class="bg-light p-3 rounded"><code>python manage.py import_cost_data</code></pre>

                    <h6 class="mt-3">Options:</h6>
                    <ul>
                        <li><code>--subscription PartnerLed-power_up</code> - Filter by subscription</li>
                        <li><code>--force</code> - Re-import already processed exports</li>
                        <li><code>--limit 5</code> - Process only first 5 exports</li>
                        <li><code>--batch-size 1000</code> - Records per batch</li>
                    </ul>

                    <h6 class="mt-3">Testing: Import Local CSV</h6>
                    <pre class="bg-light p-3 rounded"><code>python manage.py import_local_csv part_0_0001.csv --subscription "Test"</code></pre>

                    <h6 class="mt-3">Daily Sync (Recommended)</h6>
                    <pre class="bg-light p-3 rounded"><code>python manage.py sync_daily_costs</code></pre>
                    <p class="text-muted">This imports new data and refreshes aggregations.</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Configuration</h5>
                </div>
                <div class="card-body">
                    <h6>Required Environment Variables</h6>
                    <ul class="list-unstyled">
                        <li><code>AZURE_ACCOUNT_NAME</code></li>
                        <li><code>AZURE_ACCOUNT_KEY</code></li>
                    </ul>

                    <h6 class="mt-3">Azure Container</h6>
                    <p class="mb-1"><strong>Container:</strong> msexports</p>
                    <p class="mb-0 text-muted small">Path: partnerled/{subscription}/...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Imports -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Import History</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Subscription</th>
                                    <th>Billing Period</th>
                                    <th>Records</th>
                                    <th>Status</th>
                                    <th>Started</th>
                                    <th>Completed</th>
                                    <th>Blob Path</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for import in recent_imports %}
                                <tr>
                                    <td>{{ import.subscription_name }}</td>
                                    <td>
                                        <small>{{ import.billing_period_start|date:"Y-m-d" }} to {{ import.billing_period_end|date:"Y-m-d" }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ import.records_imported }}</span>
                                    </td>
                                    <td>
                                        {% if import.import_status == 'completed' %}
                                        <span class="export-status export-status-completed">Completed</span>
                                        {% elif import.import_status == 'failed' %}
                                        <span class="export-status export-status-failed">Failed</span>
                                        {% elif import.import_status == 'processing' %}
                                        <span class="export-status export-status-pending">Processing</span>
                                        {% else %}
                                        <span class="export-status export-status-pending">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ import.import_started_at|date:"Y-m-d H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if import.import_completed_at %}
                                        <small>{{ import.import_completed_at|date:"Y-m-d H:i" }}</small>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ import.blob_path|truncatechars:50 }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">No import history available</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{% url 'finops_hub:dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
        </div>
    </div>
</div>
{% endblock %}

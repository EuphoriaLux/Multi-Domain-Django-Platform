{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load vite_tags %}

{% block title %}{{ page_title }} - TypeScript Version{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'powerup/css/pages/pixel_war.css' %}">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    /* Override base template container constraints for Pixel Wars */
    main.container {
        max-width: 100% !important;
        padding: 0 !important;
        margin-top: 0 !important;
    }
    
    @media (min-width: 1024px) {
        main.container {
            width: 100vw !important;
            max-width: 100vw !important;
        }
    }

    /* TypeScript version specific styles */
    .version-badge {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #007acc;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .touch-mode-btn-ts {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
    }

    .touch-mode-btn-ts:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .touch-mode-btn-ts.precision {
        background: #ff9800;
    }

    .debug-panel {
        position: fixed;
        top: 50px;
        right: 10px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        max-width: 200px;
        display: none;
        z-index: 1000;
    }

    .debug-panel.visible {
        display: block;
    }

    /* Performance indicator */
    .perf-indicator {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 12px;
        font-family: monospace;
        z-index: 1000;
    }

    .perf-indicator.good { color: #4caf50; }
    .perf-indicator.warning { color: #ff9800; }
    .perf-indicator.bad { color: #f44336; }
</style>
{% endblock %}

{% block content %}
<!-- Version Badge -->
<div class="version-badge">
    TypeScript üöÄ
</div>

<!-- Performance Indicator -->
<div class="perf-indicator" id="perfIndicator">
    FPS: --
</div>

<!-- Debug Panel -->
<div class="debug-panel" id="debugPanel">
    <h4>Debug Info</h4>
    <div id="debugContent">Click 'D' to toggle debug info</div>
</div>

<div class="pixel-war-container">
    <header class="pixel-war-header">
        <h1>üé® Lux Pixel War</h1>
        <p class="subtitle">{% trans "TypeScript Edition - Enhanced Mobile Navigation!" %}</p>
    </header>

    <div class="mobile-container">
        <!-- Mobile Top Controls Bar (Hidden on Desktop) -->
        <div class="mobile-controls-bar" id="mobileTopControls" style="display: none;">
            <div class="controls-row">
                <button id="mobileMenuToggle" class="menu-toggle-btn" aria-label="Toggle menu">
                    <span class="menu-icon">‚ò∞</span>
                </button>
                <div class="quick-color-selector">
                    <button class="quick-color" data-color="#FF0000" style="background: #FF0000"></button>
                    <button class="quick-color" data-color="#00FF00" style="background: #00FF00"></button>
                    <button class="quick-color" data-color="#0000FF" style="background: #0000FF"></button>
                    <button class="quick-color" data-color="#FFFF00" style="background: #FFFF00"></button>
                    <button class="quick-color" data-color="#000000" style="background: #000000"></button>
                    <button class="quick-color" data-color="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ccc;"></button>
                </div>
                <div class="status-indicator">
                    <span id="mobilePixelsRemaining" class="pixels-counter">0</span>
                </div>
            </div>
        </div>
        
        <!-- Controls Sidebar (Desktop) / Slide Menu (Mobile) -->
        <div class="controls-sidebar" id="controlsSidebar">
            <!-- Color Selection -->
            <div class="color-section">
                <h3>{% trans "Choose Color" %}</h3>
                <div class="color-palette">
                    <div class="color-grid">
                        <button class="color-btn" data-color="#FF0000" style="background-color: #FF0000" aria-label="Red"></button>
                        <button class="color-btn" data-color="#FFA500" style="background-color: #FFA500" aria-label="Orange"></button>
                        <button class="color-btn" data-color="#FFFF00" style="background-color: #FFFF00" aria-label="Yellow"></button>
                        <button class="color-btn" data-color="#00FF00" style="background-color: #00FF00" aria-label="Green"></button>
                        <button class="color-btn" data-color="#00FFFF" style="background-color: #00FFFF" aria-label="Cyan"></button>
                        <button class="color-btn" data-color="#0000FF" style="background-color: #0000FF" aria-label="Blue"></button>
                        <button class="color-btn" data-color="#FF00FF" style="background-color: #FF00FF" aria-label="Magenta"></button>
                        <button class="color-btn" data-color="#800080" style="background-color: #800080" aria-label="Purple"></button>
                        <button class="color-btn" data-color="#FFC0CB" style="background-color: #FFC0CB" aria-label="Pink"></button>
                        <button class="color-btn" data-color="#A52A2A" style="background-color: #A52A2A" aria-label="Brown"></button>
                        <button class="color-btn" data-color="#808080" style="background-color: #808080" aria-label="Gray"></button>
                        <button class="color-btn" data-color="#90EE90" style="background-color: #90EE90" aria-label="Light Green"></button>
                        <button class="color-btn" data-color="#FFD700" style="background-color: #FFD700" aria-label="Gold"></button>
                        <button class="color-btn" data-color="#4169E1" style="background-color: #4169E1" aria-label="Royal Blue"></button>
                        <button class="color-btn" data-color="#FFFFFF" style="background-color: #FFFFFF" aria-label="White"></button>
                        <button class="color-btn" data-color="#000000" style="background-color: #000000" aria-label="Black"></button>
                    </div>
                    <div class="custom-color">
                        <label for="colorPicker">{% trans "Custom:" %}</label>
                        <input type="color" id="colorPicker" value="#000000" aria-label="Custom color picker">
                    </div>
                </div>
            </div>

            <!-- Info Cards -->
            <div class="info-section">
                <div class="info-card">
                    <h3>{% trans "Canvas Info" %}</h3>
                    <p>
                        <span>{% trans "Size:" %}</span>
                        <span id="canvasSize">{{ canvas.width }} √ó {{ canvas.height }}</span>
                    </p>
                    <p>
                        <span>{% trans "Version:" %}</span>
                        <span class="status-active">TypeScript</span>
                    </p>
                    <p>
                        <span>{% trans "Status:" %}</span>
                        <span id="status" class="status-active">
                            {% if canvas.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                        </span>
                    </p>
                </div>
                
                <div class="info-card">
                    <h3>{% trans "Controls" %}</h3>
                    <div class="control-help">
                        <p><strong>üì± Mobile:</strong></p>
                        <ul>
                            <li>üëÜ Tap to place pixels</li>
                            <li>üñêÔ∏è Drag to pan around</li>
                            <li>ü§è Pinch to zoom</li>
                            <li>üîÑ Button to switch modes</li>
                        </ul>
                        <p><strong>üñ•Ô∏è Desktop:</strong></p>
                        <ul>
                            <li>Click to place pixels</li>
                            <li>Drag to pan</li>
                            <li>Wheel to zoom</li>
                            <li>Arrow keys to navigate</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Canvas -->
            <div class="canvas-section">
                <div class="canvas-wrapper">
                    <!-- Desktop Controls -->
                    <div class="desktop-canvas-controls">
                        <div class="zoom-controls">
                            <button id="zoomIn" class="zoom-btn desktop-only" aria-label="Zoom in">‚ûï</button>
                            <button id="zoomOut" class="zoom-btn desktop-only" aria-label="Zoom out">‚ûñ</button>
                            <button id="zoomReset" class="zoom-btn desktop-only" aria-label="Reset zoom">üîÑ</button>
                        </div>
                    </div>
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="pixelCanvas" 
                                width="1000" 
                                height="1000" 
                                data-canvas-id="{{ canvas.id }}"
                                data-grid-width="{{ canvas.width }}"
                                data-grid-height="{{ canvas.height }}"
                                role="img"
                                aria-label="Pixel canvas grid">
                        </canvas>
                    </div>
                    
                    <!-- Mobile Canvas Controls (Hidden on Desktop) -->
                    <div class="mobile-canvas-controls" style="display: none;">
                        <div class="zoom-control-bar">
                            <button id="zoomOutMobile" class="zoom-btn" aria-label="Zoom out">
                                <span>‚àí</span>
                            </button>
                            <div class="zoom-indicator">
                                <span id="zoomLevel">100%</span>
                            </div>
                            <button id="zoomInMobile" class="zoom-btn" aria-label="Zoom in">
                                <span>+</span>
                            </button>
                        </div>
                        
                        <div class="canvas-tools">
                            <button id="centerViewBtn" class="tool-btn" aria-label="Center view">
                                <span class="tool-icon">‚äô</span>
                            </button>
                            <button id="fitToGridBtn" class="tool-btn" aria-label="Fit to grid">
                                <span class="tool-icon">‚õ∂</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Toast -->
<div id="notification" class="notification" role="alert" aria-live="assertive"></div>

{% endblock %}

{% block extra_js %}
<script>
    const CANVAS_CONFIG = {
        id: {{ canvas.id }},
        gridWidth: {{ canvas.width }},
        gridHeight: {{ canvas.height }},
        canvasWidth: 1000,
        canvasHeight: 1000,
        pixelSize: 10, // 1000/100 = 10 pixels per grid cell
        anonymousCooldown: {{ canvas.anonymous_cooldown_seconds }},
        registeredCooldown: {{ canvas.registered_cooldown_seconds }},
        anonymousPixelsPerMinute: {{ canvas.anonymous_pixels_per_minute }},
        registeredPixelsPerMinute: {{ canvas.registered_pixels_per_minute }},
        isAuthenticated: {% if is_authenticated %}true{% else %}false{% endif %}
    };
</script>

{% comment %} Load TypeScript Pixel War implementation {% endcomment %}
{% vite_asset 'pixel-war-ts-app' %}

<script>
    // Setup responsive controls after page loads
    (function() {
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
        
        function setupControls() {
            if (isMobile) {
                // Show mobile controls
                document.querySelectorAll('.mobile-controls-bar, .mobile-canvas-controls').forEach(function(el) {
                    if (el) el.style.display = '';
                });
                // Hide desktop controls
                document.querySelectorAll('.desktop-canvas-controls').forEach(function(el) {
                    if (el) el.style.display = 'none';
                });
            } else {
                // Hide mobile controls on desktop
                document.querySelectorAll('.mobile-controls-bar, .mobile-canvas-controls').forEach(function(el) {
                    if (el) el.style.display = 'none';
                });
                // Show desktop controls
                document.querySelectorAll('.desktop-canvas-controls').forEach(function(el) {
                    if (el) el.style.display = '';
                });
            }
        }
        
        // Setup controls when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupControls);
        } else {
            setupControls();
        }
        
        // Handle responsive changes
        window.addEventListener('resize', function() {
            var newIsMobile = window.innerWidth < 768;
            if (newIsMobile !== isMobile) {
                location.reload(); // Reload to switch between mobile/desktop layout
            }
        });
    })();

    // Debug and performance monitoring
    document.addEventListener('DOMContentLoaded', function() {
        // Performance indicator
        const perfIndicator = document.getElementById('perfIndicator');
        const debugPanel = document.getElementById('debugPanel');
        const debugContent = document.getElementById('debugContent');
        
        // Update performance display
        function updatePerformance() {
            if (window.pixelWarTS) {
                const metrics = window.pixelWarTS.getPerformanceMetrics();
                perfIndicator.textContent = `FPS: ${metrics.fps}`;
                
                // Color code performance
                perfIndicator.className = 'perf-indicator';
                if (metrics.fps >= 55) {
                    perfIndicator.classList.add('good');
                } else if (metrics.fps >= 30) {
                    perfIndicator.classList.add('warning');
                } else {
                    perfIndicator.classList.add('bad');
                }
            }
        }
        
        setInterval(updatePerformance, 1000);
        
        // Debug panel toggle (press 'D' key)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'd' || e.key === 'D') {
                debugPanel.classList.toggle('visible');
                if (debugPanel.classList.contains('visible')) {
                    updateDebugInfo();
                }
            }
        });
        
        function updateDebugInfo() {
            if (window.pixelWarTS) {
                const debugInfo = window.pixelWarTS.getDebugInfo();
                debugContent.innerHTML = `
                    <strong>Viewport:</strong><br>
                    Zoom: ${debugInfo.viewport.zoom.current.toFixed(3)}<br>
                    Offset: ${debugInfo.viewport.current.offsetX.toFixed(2)}, ${debugInfo.viewport.current.offsetY.toFixed(2)}<br>
                    <br>
                    <strong>Performance:</strong><br>
                    FPS: ${debugInfo.performance.fps}<br>
                    Frames: ${debugInfo.performance.frameCount}<br>
                    Animating: ${debugInfo.performance.isAnimating}<br>
                    <br>
                    <strong>Input:</strong><br>
                    Touches: ${debugInfo.input.touches.length}<br>
                    Mode: ${debugInfo.input.touchMode}<br>
                    State: ${debugInfo.input.gestureState}
                `;
            }
        }
        
        // Mobile controls integration
        const centerViewBtn = document.getElementById('centerViewBtn');
        const fitToGridBtn = document.getElementById('fitToGridBtn');
        const zoomInMobile = document.getElementById('zoomInMobile');
        const zoomOutMobile = document.getElementById('zoomOutMobile');
        
        if (centerViewBtn) {
            centerViewBtn.addEventListener('click', function() {
                if (window.pixelWarTS) {
                    window.pixelWarTS.resetView();
                }
            });
        }
        
        if (fitToGridBtn) {
            fitToGridBtn.addEventListener('click', function() {
                if (window.pixelWarTS) {
                    window.pixelWarTS.fitToGrid();
                }
            });
        }
        
        if (zoomInMobile) {
            zoomInMobile.addEventListener('click', function() {
                if (window.pixelWarTS) {
                    window.pixelWarTS.adjustZoom(0.2);
                }
            });
        }
        
        if (zoomOutMobile) {
            zoomOutMobile.addEventListener('click', function() {
                if (window.pixelWarTS) {
                    window.pixelWarTS.adjustZoom(-0.2);
                }
            });
        }
    });
</script>
{% endblock %}
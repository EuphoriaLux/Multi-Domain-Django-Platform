{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load vite_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vibe_coding/css/pixel_war.css' %}">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    /* Override base template container constraints for Pixel Wars */
    main.container {
        max-width: 100% !important;
        padding: 0 !important;
        margin-top: 0 !important;
    }
    
    @media (min-width: 1024px) {
        main.container {
            width: 100vw !important;
            max-width: 100vw !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pixel-war-container">
    <header class="pixel-war-header">
        <h1>ðŸŽ¨ Lux Pixel War</h1>
        <p class="subtitle">{% trans "Collaborate or compete - Every pixel counts!" %}</p>
    </header>

    <div class="mobile-container">
        <!-- Mobile Top Controls Bar (Hidden on Desktop) -->
        <div class="mobile-controls-bar" id="mobileTopControls" style="display: none;">
            <div class="controls-row">
                <button id="mobileMenuToggle" class="menu-toggle-btn" aria-label="Toggle menu">
                    <span class="menu-icon">â˜°</span>
                </button>
                <div class="quick-color-selector">
                    <button class="quick-color" data-color="#FF0000" style="background: #FF0000"></button>
                    <button class="quick-color" data-color="#00FF00" style="background: #00FF00"></button>
                    <button class="quick-color" data-color="#0000FF" style="background: #0000FF"></button>
                    <button class="quick-color" data-color="#FFFF00" style="background: #FFFF00"></button>
                    <button class="quick-color" data-color="#000000" style="background: #000000"></button>
                    <button class="quick-color" data-color="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ccc;"></button>
                    <button class="quick-color-more" id="moreColorsBtn">+</button>
                </div>
                <div class="status-indicator">
                    <span id="mobilePixelsRemaining" class="pixels-counter">0</span>
                </div>
            </div>
        </div>
        
        <!-- Controls Sidebar (Desktop) / Slide Menu (Mobile) -->
        <div class="controls-sidebar" id="controlsSidebar">
            <!-- Color Selection -->
            <div class="color-section">
                <h3>{% trans "Choose Color" %}</h3>
                <div class="color-palette">
                    <div class="color-grid">
                        <button class="color-btn" data-color="#FF0000" style="background-color: #FF0000" aria-label="Red"></button>
                        <button class="color-btn" data-color="#FFA500" style="background-color: #FFA500" aria-label="Orange"></button>
                        <button class="color-btn" data-color="#FFFF00" style="background-color: #FFFF00" aria-label="Yellow"></button>
                        <button class="color-btn" data-color="#00FF00" style="background-color: #00FF00" aria-label="Green"></button>
                        <button class="color-btn" data-color="#00FFFF" style="background-color: #00FFFF" aria-label="Cyan"></button>
                        <button class="color-btn" data-color="#0000FF" style="background-color: #0000FF" aria-label="Blue"></button>
                        <button class="color-btn" data-color="#FF00FF" style="background-color: #FF00FF" aria-label="Magenta"></button>
                        <button class="color-btn" data-color="#800080" style="background-color: #800080" aria-label="Purple"></button>
                        <button class="color-btn" data-color="#FFC0CB" style="background-color: #FFC0CB" aria-label="Pink"></button>
                        <button class="color-btn" data-color="#A52A2A" style="background-color: #A52A2A" aria-label="Brown"></button>
                        <button class="color-btn" data-color="#808080" style="background-color: #808080" aria-label="Gray"></button>
                        <button class="color-btn" data-color="#90EE90" style="background-color: #90EE90" aria-label="Light Green"></button>
                        <button class="color-btn" data-color="#FFD700" style="background-color: #FFD700" aria-label="Gold"></button>
                        <button class="color-btn" data-color="#4169E1" style="background-color: #4169E1" aria-label="Royal Blue"></button>
                        <button class="color-btn" data-color="#FFFFFF" style="background-color: #FFFFFF" aria-label="White"></button>
                        <button class="color-btn" data-color="#000000" style="background-color: #000000" aria-label="Black"></button>
                    </div>
                    <div class="custom-color">
                        <label for="colorPicker">{% trans "Custom:" %}</label>
                        <input type="color" id="colorPicker" value="#000000" aria-label="Custom color picker">
                    </div>
                </div>
            </div>

            <!-- Info Cards -->
            <div class="info-section">
                <div class="info-card">
                    <h3>{% trans "Canvas Info" %}</h3>
                    <p>
                        <span>{% trans "Size:" %}</span>
                        <span id="canvasSize">{{ canvas.width }} Ã— {{ canvas.height }}</span>
                    </p>
                    <p>
                        <span>{% trans "Status:" %}</span>
                        <span id="status" class="status-active">
                            {% if canvas.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                        </span>
                    </p>
                    
                    <div class="cooldown-info">
                        <h4>{% trans "Pixel Limits" %}</h4>
                        {% if is_authenticated %}
                            <div class="user-tier registered">
                                <span class="tier-badge">{% trans "Member" %}</span>
                                <strong>{{ canvas.registered_pixels_per_minute }} pixels/min</strong>
                                <small>{% trans "Cooldown:" %} {{ canvas.registered_cooldown_seconds }}s</small>
                            </div>
                        {% else %}
                            <div class="user-tier anonymous">
                                <span class="tier-badge">{% trans "Guest" %}</span>
                                <strong>{{ canvas.anonymous_pixels_per_minute }} pixels/min</strong>
                                <small>{% trans "Cooldown:" %} {{ canvas.anonymous_cooldown_seconds }}s</small>
                            </div>
                            <div class="register-incentive">
                                <p class="incentive-text">
                                    <strong>{% trans "Want more pixels?" %}</strong>
                                    <span class="highlight">{{ canvas.registered_pixels_per_minute }} pixels/min</span>
                                </p>
                                <a href="{% url 'account_signup' %}" class="btn-register">{% trans "Join Now" %}</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>{% trans "Your Stats" %}</h3>
                    {% if is_authenticated %}
                        <p>
                            <span>{% trans "Player:" %}</span>
                            <span class="username">{{ request.user.username }}</span>
                        </p>
                        {% if user_stats %}
                            <p>
                                <span>{% trans "Total:" %}</span>
                                <span class="stat-value">{{ user_stats.total_pixels_placed }}</span>
                            </p>
                        {% endif %}
                    {% else %}
                        <p>
                            <span>{% trans "Player:" %}</span>
                            <span class="username">{% trans "Guest" %}</span>
                        </p>
                        <p class="login-prompt">{% trans "Login to track stats!" %}</p>
                    {% endif %}
                    <p>
                        <span>{% trans "Color:" %}</span>
                        <span id="selectedColor" style="display: inline-block; width: 20px; height: 20px; background-color: #000000; border: 1px solid #ccc; border-radius: 4px;"></span>
                    </p>
                    <p>
                        <span>{% trans "Next in:" %}</span>
                        <span id="cooldownTimer" style="font-weight: bold;">Ready</span>
                    </p>
                    <p>
                        <span>{% trans "Remaining:" %}</span>
                        <span id="pixelsRemaining" style="font-weight: bold;">-</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Canvas -->
            <div class="canvas-section">
                <div class="canvas-wrapper">
                    <!-- Desktop Controls -->
                    <div class="desktop-canvas-controls">
                        <div class="zoom-controls">
                            <button id="zoomInDesktop" class="zoom-btn desktop-only" aria-label="Zoom in">âž•</button>
                            <button id="zoomOutDesktop" class="zoom-btn desktop-only" aria-label="Zoom out">âž–</button>
                            <button id="zoomResetDesktop" class="zoom-btn desktop-only" aria-label="Reset zoom">ðŸ”„</button>
                        </div>
                        <div class="nav-controls">
                            <button id="navTopLeft" class="nav-btn desktop-only" aria-label="Go to top-left" title="Top-left corner">â†–</button>
                            <button id="navTopRight" class="nav-btn desktop-only" aria-label="Go to top-right" title="Top-right corner">â†—</button>
                            <button id="navBottomLeft" class="nav-btn desktop-only" aria-label="Go to bottom-left" title="Bottom-left corner">â†™</button>
                            <button id="navBottomRight" class="nav-btn desktop-only" aria-label="Go to bottom-right" title="Bottom-right corner">â†˜</button>
                        </div>
                    </div>
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="pixelCanvas" 
                                width="{{ canvas.width }}" 
                                height="{{ canvas.height }}" 
                                data-canvas-id="{{ canvas.id }}"
                                role="img"
                                aria-label="Pixel canvas grid">
                        </canvas>
                        <div class="pixel-tooltip" id="pixelTooltip" role="tooltip"></div>
                        <div class="pixel-crosshair" id="pixelCrosshair"></div>
                    </div>
                    
                    <!-- Mobile Canvas Controls (Hidden on Desktop) -->
                    <div class="mobile-canvas-controls" style="display: none;">
                        <div class="corner-nav-grid">
                            <button class="corner-nav-btn" data-corner="top-left" aria-label="Top left corner">
                                <span class="corner-icon">â†–</span>
                            </button>
                            <button class="corner-nav-btn" data-corner="top-right" aria-label="Top right corner">
                                <span class="corner-icon">â†—</span>
                            </button>
                            <button class="corner-nav-btn" data-corner="center" aria-label="Center view">
                                <span class="corner-icon">âŠ™</span>
                            </button>
                            <button class="corner-nav-btn" data-corner="bottom-left" aria-label="Bottom left corner">
                                <span class="corner-icon">â†™</span>
                            </button>
                            <button class="corner-nav-btn" data-corner="bottom-right" aria-label="Bottom right corner">
                                <span class="corner-icon">â†˜</span>
                            </button>
                        </div>
                        
                        <div class="zoom-control-bar">
                            <button id="zoomOut" class="zoom-btn" aria-label="Zoom out">
                                <span>âˆ’</span>
                            </button>
                            <div class="zoom-indicator">
                                <span id="zoomLevel">100%</span>
                            </div>
                            <button id="zoomIn" class="zoom-btn" aria-label="Zoom in">
                                <span>+</span>
                            </button>
                        </div>
                        
                        <div class="canvas-tools">
                            <button id="gridToggle" class="tool-btn" aria-label="Toggle grid">
                                <span class="tool-icon">âŠž</span>
                            </button>
                            <button id="crosshairToggle" class="tool-btn" aria-label="Toggle crosshair">
                                <span class="tool-icon">âŠ•</span>
                            </button>
                            <button id="minimapToggle" class="tool-btn" aria-label="Toggle minimap">
                                <span class="tool-icon">ðŸ—º</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Feed -->
        <div class="activity-section">
            <h3>{% trans "Recent Activity" %}</h3>
            <div id="activityList" class="activity-list" role="log" aria-live="polite">
                <p class="loading">{% trans "Loading activity..." %}</p>
            </div>
        </div>
    </div>
    
    <!-- Mobile Slide-out Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
</div>

<!-- Mobile Bottom Action Bar (Hidden on Desktop) -->
<div class="mobile-action-bar" id="mobileActionBar" style="display: none;">
    <div class="action-bar-content">
        <div class="selected-color-display">
            <span class="label">Color:</span>
            <div id="selectedColorMobile" class="color-preview"></div>
        </div>
        <button id="placePixelBtn" class="place-pixel-btn" disabled>
            <span class="btn-text">Place Pixel</span>
            <span class="cooldown-text" id="cooldownDisplay">Ready</span>
        </button>
        <div class="pixels-info">
            <span class="label">Pixels:</span>
            <span id="pixelsRemainingMobile">0</span>
        </div>
    </div>
</div>

<!-- Fullscreen Toggle Button (Desktop Only) -->
<button id="fullscreenToggle" class="fullscreen-toggle" aria-label="Toggle fullscreen canvas" title="Toggle fullscreen canvas">
    â›¶
</button>

<!-- Notification Toast -->
<div id="notification" class="notification" role="alert" aria-live="assertive"></div>

{% endblock %}

{% block extra_js %}
<script>
    const CANVAS_CONFIG = {
        id: {{ canvas.id }},
        width: {{ canvas.width }},
        height: {{ canvas.height }},
        anonymousCooldown: {{ canvas.anonymous_cooldown_seconds }},
        registeredCooldown: {{ canvas.registered_cooldown_seconds }},
        anonymousPixelsPerMinute: {{ canvas.anonymous_pixels_per_minute }},
        registeredPixelsPerMinute: {{ canvas.registered_pixels_per_minute }},
        isAuthenticated: {% if is_authenticated %}true{% else %}false{% endif %}
    };
</script>
{% comment %} Load Pixel War using Vite build system {% endcomment %}
{% vite_asset 'pixel-war-refactored' %}

{% comment %} Pixel War initialization happens automatically via bundled script {% endcomment %}

<script>
    // Setup responsive controls after page loads
    (function() {
        var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
        
        function setupControls() {
            if (isMobile) {
                // Show mobile controls
                document.querySelectorAll('.mobile-controls-bar, .mobile-canvas-controls, .mobile-action-bar').forEach(function(el) {
                    if (el) el.style.display = '';
                });
                // Hide desktop controls
                document.querySelectorAll('.desktop-canvas-controls').forEach(function(el) {
                    if (el) el.style.display = 'none';
                });
            } else {
                // Hide mobile controls on desktop
                document.querySelectorAll('.mobile-controls-bar, .mobile-canvas-controls, .mobile-action-bar').forEach(function(el) {
                    if (el) el.style.display = 'none';
                });
                // Show desktop controls
                document.querySelectorAll('.desktop-canvas-controls').forEach(function(el) {
                    if (el) el.style.display = '';
                });
            }
        }
        
        // Setup controls when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupControls);
        } else {
            setupControls();
        }
        
        // Handle responsive changes
        window.addEventListener('resize', function() {
            var newIsMobile = window.innerWidth < 768;
            if (newIsMobile !== isMobile) {
                location.reload(); // Reload to switch between mobile/desktop layout
            }
        });
    })();
</script>
{% endblock %}